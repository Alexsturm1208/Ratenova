<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Planavo</title>
<link rel="icon" type="image/png" href="https://kdbuduwztmxxykfvqbie.supabase.co/storage/v1/object/public/public-assets/Plamavo%20Icon.png" sizes="32x32">
<style>
@import url('https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap');

:root{
  --bg:#050816;
  --bgS:#070b18;
  --bgC:#0b1120;
  --bgH:#111827;
  --bgE:#111827;
  --em:#16A34A;
  --emD:#15803D;
  --emM:#14532D;
  --emG:rgba(22,163,74,0.16);
  --emG2:rgba(22,163,74,0.06);
  --ba:rgba(22,163,74,0.32);
  --sk:#0EA5E9;
  --skG:rgba(14,165,233,0.12);
  --co:#F97373;
  --coG:rgba(248,113,113,0.16);
  --inc:#EAB308;
  --incG:rgba(234,179,8,0.12);
  --am:#FACC15;
  --amG:rgba(250,204,21,0.12);
  --t:#E5E7EB;
  --ts:#9CA3AF;
  --tm:#6B7280;
  --tf:#020617;
  --b:rgba(148,163,184,0.25);
  --bl:rgba(148,163,184,0.38);
  --ff-display:'Bricolage Grotesque',sans-serif;
  --ff-body:'DM Sans',sans-serif;
}
/* ‚îÄ‚îÄ Designer Dropdown ‚îÄ‚îÄ */
.dd-container{position:relative;width:100%}
.dd-trigger{width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border:1px solid var(--b);border-radius:12px;color:var(--t);font-family:var(--ff-body);font-size:14px;cursor:pointer;transition:all 0.2s;text-align:left}
.dd-trigger:hover{border-color:var(--tm);background:var(--bgH)}
.dd-trigger.active{border-color:var(--em);box-shadow:0 0 0 3px var(--emG2);background:var(--bgH)}
.dd-menu{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--bgC);border:1px solid var(--b);border-radius:14px;padding:6px;box-shadow:0 10px 30px rgba(0,0,0,0.5);z-index:100;display:none;max-height:320px;overflow-y:auto}
.dd-menu.show{display:block;animation:ddFadeIn 0.15s ease-out}
.dd-item{width:100%;display:flex;align-items:center;gap:12px;padding:10px 12px;border:none;background:transparent;color:var(--t);font-family:var(--ff-body);text-align:left;border-radius:8px;cursor:pointer;transition:background 0.15s}
.dd-item:hover{background:var(--bgH)}
.dd-item.selected{background:var(--emG2);color:var(--em)}
.dd-item .dd-icon{font-size:18px;color:var(--tm);display:flex;align-items:center;justify-content:center;width:24px;height:24px;background:rgba(255,255,255,0.03);border-radius:6px}
.dd-item.selected .dd-icon{color:var(--em);background:rgba(22,163,74,0.1)}
.dd-info{display:flex;flex-direction:column;gap:1px}
.dd-title{font-size:14px;font-weight:600}
.dd-sub{font-size:11px;color:var(--tm)}
@keyframes ddFadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}

*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--t);font-family:var(--ff-body);font-weight:400;overflow-x:hidden;min-height:100vh}
h1,h2,h3,h4,.font-display,.kpi-num{font-family:var(--ff-display);font-weight:800}
::selection{background:var(--emG);color:var(--em)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--b);border-radius:4px}
button{font-family:var(--ff-body);cursor:pointer}
input{font-family:var(--ff-body)}
input::placeholder{color:var(--tm)}
input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(0.5)}
select option{background:var(--bgC);color:var(--t)}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.layout{display:flex;min-height:100vh}
.sidebar{width:240px;position:fixed;top:0;left:0;bottom:0;background:var(--bgS);border-right:1px solid var(--b);display:flex;flex-direction:column;padding:24px 0;z-index:100}
.sidebar-logo{padding:0 22px 28px;display:flex;align-items:center}
.sidebar-logo img{max-width:160px;height:auto;display:block}
.sidebar-nav{flex:none}
.nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:11px 20px;border:none;background:transparent;color:var(--ts);font-family:var(--ff-body);font-size:14px;font-weight:400;border-left:3px solid transparent;transition:all 0.15s}
.nav-btn:hover{color:var(--t);background:rgba(255,255,255,0.02)}
.nav-btn.active{background:var(--bgH);color:var(--em);font-weight:600;border-left-color:var(--em)}
.nav-btn .icon{font-size:17px;width:22px;text-align:center}
.sidebar-settings{padding:0 16px 12px;margin-top:auto}
.sidebar-tools{padding:12px 16px 12px;display:flex;flex-direction:column;gap:4px;margin-top:16px;border-top:1px solid var(--b)}
.sidebar-bottom{padding:0 16px}
.main{flex:1;margin-left:240px;padding:32px 36px;max-width:1140px}

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card{background:var(--bgC);border-radius:16px;padding:20px;border:1px solid var(--b);transition:all 0.25s cubic-bezier(0.16,1,0.3,1)}
.card.clickable:hover{border-color:var(--ba);background:var(--bgH);transform:translateY(-3px);box-shadow:0 0 40px rgba(22,163,74,0.18)}
.card.glow{box-shadow:0 0 40px rgba(22,163,74,0.22);border-color:var(--ba)}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn{padding:11px 22px;font-size:14px;font-weight:500;font-family:var(--ff-body);border-radius:11px;display:inline-flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s ease;border:none}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn:active{transform:scale(0.98)}
.btn-primary{background:linear-gradient(135deg,var(--emD),var(--em));color:#020617;font-weight:600;box-shadow:0 6px 28px rgba(22,163,74,0.3)}
.btn-ghost{background:var(--emG);color:var(--em);border:1px solid var(--ba)}
.btn-outline{background:transparent;color:var(--t);border:1px solid var(--bl)}
.btn-danger{background:var(--coG);color:var(--co);border:1px solid rgba(248,113,113,0.3)}
.btn-sm{padding:8px 14px;font-size:13px;border-radius:10px}
.btn-lg{padding:15px 28px;font-size:15px}
.btn-full{width:100%}

/* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:500;padding:4px 10px;border-radius:100px;letter-spacing:0.3px;line-height:1}
.badge-dot{width:6px;height:6px;border-radius:50%}

/* ‚îÄ‚îÄ Form fields ‚îÄ‚îÄ */
.field{margin-bottom:16px}
.field label{display:block;font-size:12px;font-weight:500;color:var(--ts);margin-bottom:6px;letter-spacing:0.4px;font-family:var(--ff-body)}
.field .input-wrap{display:flex;align-items:center;background:var(--bgE);border:1px solid var(--b);border-radius:10px;padding:0 14px;transition:border-color 0.2s,box-shadow 0.2s;position:relative}
.field .input-wrap:focus-within{border-color:var(--ba);box-shadow:0 0 0 3px var(--emG)}
.field .input-wrap:has(select):after{content:'‚ñæ';position:absolute;right:12px;color:var(--tm);pointer-events:none;font-size:12px}
.field .input-wrap select{appearance:none;-webkit-appearance:none;-moz-appearance:none;border:none;background:transparent;color:var(--t);padding:13px 28px 13px 0;font-size:14px;width:100%}
.field input{flex:1;border:none;outline:none;padding:13px 0;font-size:14px;color:var(--t);background:transparent}
.field .suffix{font-size:14px;color:var(--tm);margin-left:8px;font-weight:500}
.custom-select{cursor:pointer}
.custom-select .cs-value{flex:1;padding:13px 0;color:var(--t);font-size:14px}
.custom-select .cs-list{position:absolute;left:12px;right:12px;top:calc(100% + 8px);background:linear-gradient(180deg,var(--bgC),var(--bgS));border:1px solid var(--b);border-radius:12px;padding:8px;box-shadow:0 12px 36px rgba(0,0,0,0.6);display:none;z-index:50}
.custom-select[aria-expanded="true"] .cs-list{display:block}
.custom-select .cs-item{display:block;width:100%;text-align:left;padding:10px 12px;border-radius:8px;background:transparent;border:none;color:var(--t);cursor:pointer;font-family:var(--ff-body)}
.custom-select .cs-item:hover{background:rgba(255,255,255,0.03)}
.custom-select .cs-item.active{background:var(--emG);color:var(--em)}

/* ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ */
.pbar{height:4px;background:var(--b);border-radius:2px;overflow:hidden}
.pbar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--emD),var(--em));transition:width 0.8s cubic-bezier(0.16,1,0.3,1)}

/* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.65);padding:20px;animation:fadeIn 0.2s ease}
.modal{background:var(--bgS);border-radius:20px;padding:28px;width:100%;max-width:460px;max-height:88vh;overflow:auto;border:1px solid var(--bl);box-shadow:0 40px 100px rgba(0,0,0,0.6);animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1)}
.modal.wide{max-width:560px}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.modal-head h3{font-size:17px;font-weight:700;font-family:var(--ff-display)}
.modal-close{width:32px;height:32px;border-radius:10px;border:1px solid var(--b);background:var(--bgE);color:var(--ts);font-size:16px;display:flex;align-items:center;justify-content:center}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:3000;background:var(--bgE);color:var(--em);border:1px solid var(--ba);padding:12px 24px;border-radius:14px;font-size:14px;font-weight:500;box-shadow:0 24px 64px rgba(0,0,0,0.4);display:flex;align-items:center;gap:8px;animation:slideUp 0.3s ease}
.toast-dot{width:8px;height:8px;border-radius:50%;background:var(--em);box-shadow:0 0 8px var(--em)}

/* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
.hero{background:linear-gradient(135deg,var(--bgC) 0%,rgba(22,163,74,0.08) 100%);border-radius:20px;padding:28px;border:1px solid var(--ba);margin-bottom:20px;position:relative;overflow:hidden}
.hero-orb1{position:absolute;top:-80px;right:-80px;width:220px;height:220px;border-radius:50%;background:radial-gradient(circle,rgba(22,163,74,0.14) 0%,transparent 70%)}
.hero-orb2{position:absolute;bottom:-60px;left:30%;width:160px;height:160px;border-radius:50%;background:radial-gradient(circle,rgba(56,189,248,0.06) 0%,transparent 70%)}

/* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
.confetti-piece{position:absolute;top:-16px;border-radius:2px}
.preset-btn{padding:6px 12px;border-radius:8px;font-size:12px;font-weight:500;border:1px solid var(--b);background:var(--bgE);color:var(--ts);transition:all 0.15s}
.preset-btn.active{background:var(--emG);color:var(--em);border-color:var(--ba)}
.emoji-btn{width:38px;height:38px;border-radius:10px;font-size:17px;border:2px solid var(--b);background:var(--bgE);display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.emoji-btn.active{border-color:var(--em);background:var(--emG)}
.chip{padding:8px 14px;border-radius:100px;font-size:12px;font-weight:500;border:1px solid var(--b);background:var(--bgC);color:var(--ts);transition:all 0.2s}
.chip.active{background:var(--emG);color:var(--em);border-color:var(--ba)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.flex-col{display:flex;flex-direction:column;gap:8px}

/* ‚îÄ‚îÄ Mobile nav ‚îÄ‚îÄ */
.mobile-nav{position:fixed;bottom:0;left:0;right:0;z-index:900;background:var(--bgS);border-top:1px solid var(--b);display:none;justify-content:space-around;align-items:center;padding:6px 0 8px}
.mobile-nav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 16px;border:none;background:transparent;color:var(--ts);font-size:10px;font-family:var(--ff-body)}
.mobile-nav-btn.active{color:var(--em);font-weight:600}
.mobile-fab{width:44px;height:44px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--emD),var(--em));color:#020617;font-size:22px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(22,163,74,0.3)}

/* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
.auth-root{position:fixed;inset:0;z-index:5000;background:radial-gradient(1200px 600px at 80% -10%,rgba(22,163,74,0.12),transparent 60%),radial-gradient(900px 500px at -10% 110%,rgba(14,165,233,0.08),transparent 60%),var(--bg);display:none;align-items:center;justify-content:center;padding:24px}
.auth-wrap{width:100%;max-width:860px;margin:0 auto;padding:12px;display:block}
.auth-card{background:linear-gradient(160deg,var(--bgS),var(--bgC));border:1px solid var(--b);border-radius:20px;padding:36px;box-shadow:0 24px 60px rgba(0,0,0,0.6);max-width:420px;margin:0 auto}
.auth-tabs{display:flex;gap:8px;background:transparent;border:none;padding:0;margin-bottom:18px}
.auth-tabs button{border:1px solid transparent;background:transparent;color:var(--ts);padding:10px 14px;border-radius:100px;font-weight:600;cursor:pointer;font-family:var(--ff-body)}
.auth-tabs button.active{background:linear-gradient(135deg,var(--emD),var(--em));color:#020617;box-shadow:0 6px 18px rgba(22,163,74,0.28)}
.auth-row{display:flex;justify-content:space-between;align-items:center;margin:10px 0 14px}
.auth-link{background:none;border:none;color:var(--em);font-size:13px;font-weight:600;cursor:pointer;font-family:var(--ff-body)}
.auth-muted{color:var(--ts);font-size:13px}
.auth-notice{margin-top:12px;padding:10px 12px;border-radius:10px;font-size:13px}
.auth-ok{background:rgba(22,163,74,0.12);border:1px solid var(--ba);color:#bbf7d0}
.auth-err{background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);color:#FFB3AB}
.auth-hidden{display:none}
.auth-logo{display:flex;justify-content:center;align-items:center;margin:0 0 36px}
.auth-logo img{max-width:420px;height:auto}

/* ‚îÄ‚îÄ Master ‚îÄ‚îÄ */
.master-root{display:none;min-height:100vh;background:var(--bg);padding:24px}
.master-shell{max-width:1400px;margin:0 auto}
.master-top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:18px}
.master-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.master-grid{display:grid;grid-template-columns:1.15fr 1fr;gap:12px}
.master-card{background:linear-gradient(155deg,var(--bgC),var(--bgS));border:1px solid var(--b);border-radius:16px;padding:16px}
.master-list{display:flex;flex-direction:column;gap:10px;max-height:55vh;overflow:auto}
.master-login{max-width:440px;margin:10vh auto 0}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media(max-width:899px){.sidebar{display:none}.main{margin-left:0;padding:20px 16px 80px}.mobile-nav{display:flex}.grid2{grid-template-columns:1fr}.hero{padding:20px}}
@media(max-width:920px){.auth-wrap{max-width:360px}.auth-logo img{max-width:280px}}
@media(max-width:980px){.master-grid{grid-template-columns:1fr}}

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(16px) scale(0.98)}to{opacity:1;transform:none}}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(800deg);opacity:0}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(22,163,74,0.14)}50%{box-shadow:0 0 40px rgba(22,163,74,0.26)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
</style>
</head>
<body>
<div id="authRoot" class="auth-root">
  <div class="auth-wrap">
    <div class="auth-logo"><img id="authLogo" alt="Planavo"></div>
    <section class="auth-card">
      <h2 style="margin:0 0 12px;font-size:22px">Willkommen zur√ºck</h2>
      <div class="auth-tabs">
        <button id="tabLogin" class="active" type="button">Login</button>
        <button id="tabRegister" type="button">Registrieren</button>
      </div>
      <form id="formLogin">
        <div class="field"><label>E-Mail</label><div class="input-wrap"><input id="loginEmail" type="email" required placeholder="name@firma.de"></div></div>
        <div class="field"><label>Passwort</label><div class="input-wrap"><input id="loginPassword" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div></div>
        <div class="auth-row"><span class="auth-muted">Bestandskunde</span><button id="forgotLink" class="auth-link" type="button">Passwort vergessen?</button></div>
        <button class="btn btn-primary" type="submit">Einloggen</button>
      </form>
      <form id="formRegister" class="auth-hidden">
        <div class="field"><label>Vollst√§ndiger Name</label><div class="input-wrap"><input id="regName" type="text" required placeholder="Max Mustermann"></div></div>
        <div class="field"><label>E-Mail</label><div class="input-wrap"><input id="regEmail" type="email" required placeholder="name@firma.de"></div></div>
        <div class="field"><label>Passwort</label><div class="input-wrap"><input id="regPassword" type="password" required minlength="6" placeholder="mind. 6 Zeichen"></div></div>
        <div style="background:linear-gradient(135deg,var(--emG),rgba(56,189,248,0.08));border:1px solid var(--ba);border-radius:12px;padding:12px 14px;margin-bottom:16px;display:flex;align-items:center;gap:10px">
          <span style="font-size:20px">üéÅ</span>
          <div><p style="font-size:13px;font-weight:700;color:var(--em);margin:0">30 Tage Pro kostenlos</p><p style="font-size:12px;color:var(--tm);margin:2px 0 0">Alle Features, danach Basic oder Upgrade.</p></div>
        </div>
        <p style="font-size:12px;color:var(--tm);margin:0 0 12px;line-height:1.6">Mit der Registrierung stimmst du unseren <a href="https://planavo.de/agb" target="_blank" rel="noopener" style="color:var(--em);font-weight:600;cursor:pointer;text-decoration:underline" onclick="event.stopPropagation()">AGB</a> zu.</p>
        <button class="btn btn-primary" type="submit">Konto erstellen</button>
      </form>
      
      <div id="authNotice" class="auth-hidden"></div>
    </section>
    <div style="text-align:center;margin-top:20px;padding-bottom:8px">
      <p style="font-size:12px;color:var(--tf);margin:0 0 10px">&copy; 2026 Planavo &ndash; Alexander Falco Sturm</p>
      <div style="display:flex;justify-content:center;gap:20px;flex-wrap:wrap">
        <a href="https://planavo.de/agb" target="_blank" rel="noopener" style="font-size:12px;color:var(--tm);text-decoration:none" onmouseover="this.style.color='var(--em)'" onmouseout="this.style.color='var(--tm)'">AGB</a>
        <a href="https://planavo.de/datenschutz" target="_blank" rel="noopener" style="font-size:12px;color:var(--tm);text-decoration:none" onmouseover="this.style.color='var(--em)'" onmouseout="this.style.color='var(--tm)'">Datenschutz</a>
        <a href="https://planavo.de/impressum" target="_blank" rel="noopener" style="font-size:12px;color:var(--tm);text-decoration:none" onmouseover="this.style.color='var(--em)'" onmouseout="this.style.color='var(--tm)'">Impressum</a>
      </div>
    </div>
  </div>
</div>
<div id="masterRoot" class="master-root"></div>
<div class="layout">
  <div class="sidebar"><div class="sidebar-logo"><img id="sidebarLogo" alt="Planavo"></div><div class="sidebar-nav" id="sidebarNav"></div><div class="sidebar-tools" id="sidebarTools"></div><div class="sidebar-settings" id="sidebarSettings"></div><div class="sidebar-bottom" id="sidebarBottom"></div></div>
  <div class="main" id="mainContent"></div>
</div>
<div class="mobile-nav" id="mobileNav"></div>
<div id="modalContainer"></div>
<div id="toastContainer"></div>
<div id="confettiContainer" style="position:fixed;inset:0;z-index:3000;pointer-events:none;overflow:hidden;display:none"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Paddle loaded dynamically -->
<script>
let debts=[];
let currentPage="dashboard",selectedDebtId=null,currentFilter="all",selectedEmoji="üìÑ";window._contractDetail=null;window._contractFilter="all";
const isMasterMode=new URLSearchParams(window.location.search).get("master")==="1";
const fmt=n=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n)+" ‚Ç¨";
const fmt2=n=>new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n)+" ‚Ç¨";
const fD=d=>{try{return new Date(d+"T00:00:00").toLocaleDateString("de-DE",{day:"numeric",month:"short"})}catch(e){return d}};
const fDL=d=>{try{return new Date(d+"T00:00:00").toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"})}catch(e){return d}};
const CONTRACT_CATS = [
    {v:'Versicherung',i:'üõ°Ô∏è'},{v:'Streaming',i:'üé¨'},{v:'Internet',i:'üåê'},
    {v:'Strom',i:'‚ö°'},{v:'Gas',i:'üî•'},{v:'Handy',i:'üì±'},
    {v:'Fitness',i:'üí™'},{v:'Software',i:'üíª'},{v:'Bank',i:'üè¶'},
    {v:'Miete',i:'üè†'},{v:'Auto',i:'üöó'},{v:'Sonstiges',i:'üìÑ'}
];
const getContractIcon = (cat) => (CONTRACT_CATS.find(c => c.v === cat) || {i:'üìÑ'}).i;
const pc=(p,o)=>o===0?100:Math.round(p/o*100);const dU=d=>Math.ceil((new Date(d+"T00:00:00")-new Date())/864e5);
const gS=d=>{if(d.paid>=d.original)return"done";const nd=effDue(d)||d.due;const dy=dU(nd);return dy<0?"overdue":dy===0?"today":dy<=5?"soon":"ok"};
const sI={ok:{l:"Aktuell",c:"var(--em)",bg:"var(--emG)"},soon:{l:"Bald f√§llig",c:"var(--am)",bg:"var(--amG)"},today:{l:"Heute f√§llig",c:"var(--co)",bg:"var(--coG)"},overdue:{l:"Handlungsbedarf",c:"var(--co)",bg:"var(--coG)"},done:{l:"Erledigt",c:"var(--em)",bg:"var(--emG)"}};
const clarificationMeta={neu:{l:"Neu",c:"#93C5FD",bg:"rgba(147,197,253,0.12)"},in_pruefung:{l:"In Pr√ºfung",c:"#EAB308",bg:"rgba(234,179,8,0.12)"},rueckfrage_offen:{l:"R√ºckfrage offen",c:"#F59E0B",bg:"rgba(245,158,11,0.14)"},vereinbarung_in_verhandlung:{l:"Verhandlung",c:"#0EA5E9",bg:"rgba(14,165,233,0.14)"},vereinbart:{l:"Vereinbart",c:"var(--em)",bg:"rgba(22,163,74,0.18)"},abgelehnt_oder_streit:{l:"Streitfall",c:"var(--co)",bg:"rgba(248,113,113,0.16)"},geschlossen:{l:"Geschlossen",c:"var(--ts)",bg:"rgba(148,163,184,0.14)"}};
const paymentMeta={keine_zahlung_faellig:{l:"Keine Zahlung f√§llig",c:"var(--ts)",bg:"rgba(148,163,184,0.14)"},faellig_einmalig:{l:"Einmalig f√§llig",c:"#EAB308",bg:"rgba(234,179,8,0.12)"},ratenplan_aktiv:{l:"Ratenplan aktiv",c:"#0EA5E9",bg:"rgba(14,165,233,0.14)"},stundung_aktiv:{l:"Stundung aktiv",c:"#A78BFA",bg:"rgba(167,139,250,0.16)"},ueberfaellig:{l:"Handlungsbedarf",c:"var(--co)",bg:"rgba(248,113,113,0.16)"},bezahlt:{l:"Bezahlt",c:"var(--em)",bg:"rgba(22,163,74,0.18)"}};
const clarificationOptions=[["neu","Neu"],["vereinbarung_in_verhandlung","In Verhandlung"],["vereinbart","Vereinbart"],["abgelehnt_oder_streit","Streitfall"],["geschlossen","Geschlossen"]];
const paymentOptions=[["ratenplan_aktiv","Ratenplan aktiv"],["faellig_einmalig","F√§llig"],["ueberfaellig","Handlungsbedarf"],["bezahlt","Bezahlt"]];
const encs=["Du bist auf dem richtigen Weg.","Jede Rate z√§hlt ‚Äì bleib dran.","Schritt f√ºr Schritt zur Entlastung.","Du hast mehr geschafft als du denkst.","Kontrolle f√ºhlt sich gut an."];
const tdy=()=>{const d=new Date();const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,"0");const da=String(d.getDate()).padStart(2,"0");return`${y}-${m}-${da}`};
function toNum(v){const s=String(v||"").trim().replace(/\./g,"").replace(/,/g,".");const n=parseFloat(s);return Number.isFinite(n)?n:0}
function toEur(v){try{return new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(v)||0)}catch(e){return String(v||"")}}
function fmtEurField(el){if(!el)return;el.value=toEur(toNum(el.value))}
function statusBadge(meta,key,prefix){const k=meta[key]?key:Object.keys(meta)[0],s=meta[k];return`<span class="badge" style="color:${s.c};background:${s.bg}"><span class="badge-dot" style="background:${s.c};box-shadow:0 0 6px ${s.c}"></span>${prefix}: ${s.l}</span>`}
function getClarificationStatus(d){return clarificationMeta[d.clarificationStatus]?d.clarificationStatus:"neu"}
function inferPaymentStatus(d){if(d.paid>=d.original)return"bezahlt";if(d.rate>0)return"ratenplan_aktiv";const dueState=gS(d);if(dueState==="today"||dueState==="overdue")return"ueberfaellig";return"faellig_einmalig"}
function getPaymentStatus(d){return paymentMeta[d.paymentStatus]?d.paymentStatus:inferPaymentStatus(d)}
function normalizeDebtStatuses(){debts=debts.map(d=>({...d,clarificationStatus:getClarificationStatus(d),paymentStatus:getPaymentStatus(d)}))}
function setStatus(prefix,kind,value){const input=document.getElementById(`${prefix}${kind}`);if(!input)return;input.value=value;document.querySelectorAll(`button[data-status='${prefix}${kind}']`).forEach(b=>{const a=b.dataset.value===value;b.classList.toggle("btn-ghost",a);b.classList.toggle("btn-outline",!a);});}
function autoUpdateDebtStatuses(d,opt={}){if(!d)return;const respectManual=!!opt.respectManual;const cs=getClarificationStatus(d);if(d.paid>=d.original){d.paymentStatus="bezahlt";if(cs!=="abgelehnt_oder_streit")d.clarificationStatus="geschlossen";return;}if(respectManual&&paymentMeta[d.paymentStatus])return;if(d.paymentStatus==="stundung_aktiv")return;if(d.rate>0){d.paymentStatus="ratenplan_aktiv";return;}if(["neu","in_pruefung","rueckfrage_offen","vereinbarung_in_verhandlung"].includes(cs)){d.paymentStatus="keine_zahlung_faellig";return;}const dueState=gS(d);d.paymentStatus=(dueState==="today"||dueState==="overdue")?"ueberfaellig":"faellig_einmalig";}
function gT(){const o=debts.reduce((s,d)=>s+d.original,0),p=debts.reduce((s,d)=>s+d.paid,0),r=o-p,m=debts.filter(d=>d.paid<d.original).reduce((s,d)=>s+d.rate,0),sorted=[...debts].filter(d=>d.paid<d.original).sort((a,b)=>new Date(effDue(a)||a.due)-new Date(effDue(b)||b.due));return{o,p,r,m,pct:pc(p,o),next:sorted[0]||null}}
function bdg(st){const s=sI[st]||sI.ok;return`<span class="badge" style="color:${s.c};background:${s.bg}"><span class="badge-dot" style="background:${s.c};box-shadow:0 0 6px ${s.c}"></span>${s.l}</span>`}
function pb(p,h=4){return`<div class="pbar" style="height:${h}px"><div class="pbar-fill" style="width:${Math.min(p,100)}%"></div></div>`}
function addMonthsISO(ds,m=1){if(!ds)return ds;try{let[y,mo,da]=ds.split("-").map(Number);mo+=m;while(mo>12){mo-=12;y++}while(mo<1){mo+=12;y--}const last=new Date(y,mo,0).getDate();const d=Math.min(da,last);return`${y}-${String(mo).padStart(2,"0")}-${String(d).padStart(2,"0")}`}catch(e){return ds}}
function normIban(s){try{return(String(s||"").replace(/[^A-Za-z0-9]/g,"").toUpperCase())}catch(e){return String(s||"")}}
function formatIbanSpaced(s){const r=normIban(s);if(!r)return"";let out=[];for(let i=0;i<r.length;i+=4){out.push(r.slice(i,i+4))}return out.join(" ")}
function maskIban(s){
  const r=normIban(s);if(!r)return"";
  if(r.length<=8)return r;
  const head=r.slice(0,4),tail=r.slice(-4),midLen=r.length-8;
  let groups=[];for(let i=0;i<midLen;i+=4){const n=Math.min(4,midLen-i);groups.push("*".repeat(n).padEnd(4,"*"))}
  return [head,...groups,tail].join(" ").replace(/\s+/g," ").trim();
}
function maskFromHint(h){const parts=String(h||"").split(":");const head=parts[0]||"",last=parts[1]||"";if(head&&last)return `${head} **** **** **** ${last}`;return "‚Äì"}
function getMaskedIban(d){if(d&&d.bankIban)return maskIban(d.bankIban);return maskFromHint(d&&d.iban_hint)}
function b64e(buf){return btoa(String.fromCharCode.apply(null,new Uint8Array(buf)))}
function b64d(str){const bin=atob(str);const arr=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);return arr.buffer}
async function getIbanKey(){let raw=localStorage.getItem("iban_key");if(!raw){const k=new Uint8Array(32);crypto.getRandomValues(k);raw=b64e(k);localStorage.setItem("iban_key",raw)}const keyBytes=b64d(raw);return await crypto.subtle.importKey("raw",keyBytes,"AES-GCM",false,["encrypt","decrypt"])}
async function encryptText(txt){const key=await getIbanKey();const iv=new Uint8Array(12);crypto.getRandomValues(iv);const enc=new TextEncoder().encode(txt);const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc);return`v1:${b64e(iv)}:${b64e(ct)}`}
async function decryptText(data){try{if(!data||!data.startsWith("v1:"))return data;const[,ivB,ctB]=data.split(":");const key=await getIbanKey();const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(b64d(ivB))},key,b64d(ctB));return new TextDecoder().decode(pt)}catch(e){return""}}

function effDue(d){
  if(!d||d.paid>=d.original)return null;
  if(!(d.rate>0))return d.due||"";
  let ds=d.due||"";
  if(!ds)return ds;
  const today=new Date(tdy()+"T00:00:00");
  for(let i=0;i<48;i++){
    const due=new Date(ds+"T00:00:00");
    if(!Number.isFinite(due.getTime()))return ds;
    const prev=new Date(due);prev.setMonth(prev.getMonth()-1);
    const rem=Math.max(d.original-d.paid,0);
    const need=Math.max(0,Math.min(d.rate||0,rem));
    if(!(need>0))return ds;
    const cyclePaid=(d.history||[])
      .filter(h=>h&&h.date)
      .map(h=>({date:new Date(String(h.date).slice(0,10)+"T00:00:00"),amount:Number(h.amount)}))
      .filter(h=>Number.isFinite(h.date?.getTime?.())&&h.date>prev&&h.date<=today&&Number.isFinite(h.amount))
      .reduce((s,h)=>s+h.amount,0);
    if(cyclePaid>=need){
      const next=addMonthsISO(ds,1);
      if(!next||next===ds)return ds;
      ds=next;
      continue;
    }
    return ds;
  }
  return ds;
}
function rng(pct,sz=140,sw=8){const r=(sz-sw*2)/2,ci=2*Math.PI*r;return`<svg width="${sz}" height="${sz}"><defs><linearGradient id="rg${sz}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--em)"/><stop offset="100%" stop-color="var(--sk)"/></linearGradient><filter id="gl${sz}"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><circle cx="${sz/2}" cy="${sz/2}" r="${r}" fill="none" stroke="var(--b)" stroke-width="${sw}"/><circle cx="${sz/2}" cy="${sz/2}" r="${r}" fill="none" stroke="url(#rg${sz})" stroke-width="${sw}" stroke-linecap="round" stroke-dasharray="${ci}" stroke-dashoffset="${ci-(pct/100)*ci}" transform="rotate(-90 ${sz/2} ${sz/2})" filter="url(#gl${sz})" style="transition:stroke-dashoffset 1.2s cubic-bezier(0.16,1,0.3,1)"/></svg>`}
function flash(m){const c=document.getElementById("toastContainer");c.innerHTML=`<div class="toast"><span class="toast-dot"></span>${m}</div>`;setTimeout(()=>c.innerHTML="",2800)}
function showConfetti(){const c=document.getElementById("confettiContainer");c.style.display="block";const cols=["var(--em)","#38BDF8","#FBBF24","var(--co)","#A78BFA","#FB7185"];let h="";for(let i=0;i<40;i++)h+=`<div class="confetti-piece" style="left:${Math.random()*100}%;width:${5+Math.random()*7}px;height:${5+Math.random()*4}px;background:${cols[i%6]};animation:confettiFall ${1.5+Math.random()*1.5}s ease-in ${Math.random()*0.5}s forwards"></div>`;c.innerHTML=h;setTimeout(()=>{c.style.display="none";c.innerHTML=""},3500)}
const navI=[{id:"dashboard",l:"√úberblick",i:"‚óâ"},{id:"budget",l:"Ein & Ausgaben",i:"üí∂"},{id:"contracts",l:"Vertr√§ge",i:"üìÑ"},{id:"debts",l:"Verpflichtungen",i:"‚ò∞"},{id:"timeline",l:"Verlauf",i:"‚óî"}];
// ‚ïê‚ïê‚ïê PLAN-SYSTEM ‚ïê‚ïê‚ïê
const PRO_PRICE="4,99 ‚Ç¨";
const BASIC_DEBT_LIMIT=3;
const proPages=new Set(["agree","contracts","cancelAssist"]);
function isTrialActive(){const t=user.trialEnd||null;return!!(t&&new Date()<new Date(t));}
function trialDaysLeft(){const t=user.trialEnd||null;if(!t)return 0;return Math.max(0,Math.ceil((new Date(t)-new Date())/864e5));}
function isProPlan(){const p=(user.plan||"").trim().toLowerCase();if(p==="pro"||p==="business"||p==="enterprise")return true;if(isTrialActive())return true;return false;}
function isBasicPlan(){return!isProPlan();}
function isProFeaturePage(p){return proPages.has(p);}
function canAddDebt(){return isProPlan()||debts.length<BASIC_DEBT_LIMIT;}
function openUpgradeModal(featureName){
  const trialExpired=user.trialEnd&&!isTrialActive();
  document.getElementById("modalContainer").innerHTML=`<div class="overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()" style="max-width:420px;text-align:center;padding:32px">
    <div style="font-size:52px;margin-bottom:12px">‚≠ê</div>
    <h3 style="font-size:20px;font-weight:800;margin:0 0 8px">Pro-Plan erforderlich</h3>
    <p style="font-size:14px;color:var(--tm);margin:0 0 20px;line-height:1.6">${featureName?`<strong style="color:var(--t)">${featureName}</strong> ist nur im Pro-Plan verf√ºgbar.`:""} ${trialExpired?"Deine 30-t√§gige Testphase ist abgelaufen.":""}</p>
    <div style="background:linear-gradient(135deg,rgba(22,163,74,0.16),rgba(14,165,233,0.10));border:1px solid var(--ba);border-radius:16px;padding:20px;margin-bottom:20px">
      <p style="font-size:32px;font-weight:800;margin:0 0 2px;color:var(--em)">4,99 ‚Ç¨<span style="font-size:14px;font-weight:400;color:var(--tm)">/Monat</span></p>
      <p style="font-size:12px;color:var(--tm);margin:0">Alle Features, keine Einschr√§nkungen</p>
    </div>
    <div style="text-align:left;margin-bottom:20px">
      ${["‚úÖ Unbegrenzte Verpflichtungen","‚úÖ Vereinbarungsvorlagen & Briefe","‚úÖ Vertragsverwaltung","‚úÖ K√ºndigungsassistent","‚úÖ Vollst√§ndiger Verlauf & Export"].map(f=>`<p style="font-size:13px;margin:5px 0;color:var(--ts)">${f}</p>`).join("")}
    </div>
    <button class="btn btn-primary btn-full btn-lg" onclick="closeModal();openPaddleCheckout()">Jetzt upgraden ‚Üí</button>
    <button class="btn btn-outline btn-full" style="margin-top:8px" onclick="closeModal()">Sp√§ter</button>
    <p style="font-size:11px;color:var(--tf);margin:10px 0 0">Mit dem Upgrade stimmst du den <a href="https://planavo.de/agb" target="_blank" style="color:var(--tm)">AGB</a> zu.</p>
  </div></div>`;
}
function renderNav(){
  const pro=isProPlan();
  const trial=isTrialActive();
  const daysLeft=trialDaysLeft();
  const sidebarNav=document.getElementById("sidebarNav");
  if(sidebarNav)sidebarNav.innerHTML=navI.map(n=>{
    const locked=isProFeaturePage(n.id)&&!pro;
    return `<button class="nav-btn ${currentPage===n.id||(currentPage==="detail"&&n.id==="debts")?"active":""}" onclick="goTo('${n.id}')"><span class="icon">${n.i}</span>${n.l}${locked?'<span style="margin-left:auto;font-size:10px;opacity:0.5">üîí</span>':''}</button>`;
  }).join("");
  const t=document.getElementById("sidebarTools");
  if(t)t.innerHTML=`<p style="font-size:10px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 6px;padding:0 10px">Tools</p><button class="nav-btn ${currentPage==="agree"?"active":""}" onclick="goTo('agree')" style="width:100%"><span class="icon">‚úé</span>Vereinbarungen${!pro?'<span style="margin-left:auto;font-size:10px;opacity:0.5">üîí</span>':''}</button><button class="nav-btn ${currentPage==="cancelAssist"?"active":""}" onclick="goTo('cancelAssist')" style="width:100%"><span class="icon">‚úâ</span>K√ºndigung${!pro?'<span style="margin-left:auto;font-size:10px;opacity:0.5">üîí</span>':''}</button>`;
  const s=document.getElementById("sidebarSettings");
  if(s)s.innerHTML=`<button class="nav-btn ${currentPage==="settings"?"active":""}" onclick="goTo('settings')" style="width:100%;border-radius:10px"><span class="icon">‚öô</span>Einstellungen</button><button class="nav-btn ${currentPage==="pricing"?"active":""}" onclick="goTo('pricing')" style="width:100%;border-radius:10px"><span class="icon">‚≠ê</span>Pl√§ne & Preise</button><button class="nav-btn ${currentPage==="agb"?"active":""}" onclick="goTo('agb')" style="width:100%;border-radius:10px"><span class="icon">üìã</span>AGB</button>${trial&&daysLeft<=7?`<div style="margin:6px 0 0;padding:8px 10px;border-radius:10px;background:var(--amG);border:1px solid rgba(251,191,36,0.3);font-size:11px;color:var(--am);font-weight:600">‚è∞ Noch ${daysLeft} Tage Testphase</div>`:""}`;
  document.getElementById("mobileNav").innerHTML=navI.map(n=>`<button class="mobile-nav-btn ${currentPage===n.id||(currentPage==="detail"&&n.id==="debts")?"active":""}" onclick="goTo('${n.id}')"><span style="font-size:20px">${n.i}</span>${n.l}</button>`).join("")+`<button class="mobile-nav-btn ${currentPage==="settings"?"active":""}" onclick="goTo('settings')"><span style="font-size:20px">‚öô</span>Einst.</button><button class="mobile-fab" onclick="openAdd()">Ôºã</button>`;
  renderUser();
}
function goTo(p){if(isProFeaturePage(p)&&!isProPlan()){openUpgradeModal(p==="agree"?"Vereinbarungen":p==="contracts"?"Vertragsverwaltung":"K√ºndigungsassistent");return;}currentPage=p;if(p!=="detail")selectedDebtId=null;renderNav();renderPage();}
function openDetail(id){selectedDebtId=id;currentPage="detail";renderNav();renderPage()}
function renderPage(){
  // Persistent contract deadline banner
  const acuteCt=typeof contracts!=='undefined'?contracts.filter(c=>{const d=contractDaysLeft(c);return d!==null&&d<=7&&c.status!=="cancelled";}).length:0;
  const existingBanner=document.getElementById('contractAlertBanner');
  if(acuteCt>0&&currentPage!=='contracts'){
    if(!existingBanner){
      const banner=document.createElement('div');
      banner.id='contractAlertBanner';
      banner.style.cssText='position:fixed;top:0;left:0;right:0;z-index:500;background:linear-gradient(135deg,#7f1d1d,#991b1b);color:#fff;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:13px;font-weight:600';
      banner.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><span style="font-size:18px">üö®</span><span>${acuteCt} K√ºndigungsfrist${acuteCt>1?'en':''} l√§uft in ‚â§7 Tagen ab!</span></div><div style="display:flex;gap:8px"><button onclick="window._contractFilter='urgent';goTo('contracts')" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:#fff;padding:5px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700">Jetzt pr√ºfen</button><button onclick="document.getElementById('contractAlertBanner')?.remove()" style="background:none;border:none;color:#fff;cursor:pointer;font-size:18px;padding:0 4px">‚úï</button></div>`;
      document.body.prepend(banner);
    }
  } else if(existingBanner){
    existingBanner.remove();
  }
if(isProFeaturePage(currentPage)&&!isProPlan()){openUpgradeModal();currentPage="dashboard";}const m=document.getElementById("mainContent");if(currentPage==="dashboard")m.innerHTML=rDash();else if(currentPage==="debts")m.innerHTML=rDebts();else if(currentPage==="detail")m.innerHTML=rDet();else if(currentPage==="budget")m.innerHTML=rBudget();else if(currentPage==="contracts")m.innerHTML=rContracts();else if(currentPage==="cancelAssist")m.innerHTML=rCancelAssistant();else if(currentPage==="agree")m.innerHTML=rAgree();else if(currentPage==="timeline")m.innerHTML=rTime();else if(currentPage==="settings"){m.innerHTML=rSettings();setTimeout(()=>{try{renderSnapshotList()}catch(e){}},0)}else if(currentPage==="pricing")m.innerHTML=rPricing();else if(currentPage==="agb")m.innerHTML=rAgbPage();else if(currentPage==="master")m.innerHTML=rMasterPanel();setTimeout(()=>{document.querySelectorAll("[data-ring]").forEach(el=>{const p=el.dataset.ring,s=el.dataset.size||140,w=el.dataset.sw||8;el.innerHTML=rng(0,+s,+w);setTimeout(()=>el.innerHTML=rng(+p,+s,+w),50)})},10)}

let user={loggedIn:false,name:"",firstName:"",lastName:"",plan:"Basis",trialEnd:null,email:"",addressStreet:"",addressZip:"",addressCity:"",phone:""};
const STORAGE_USER="sfUser";
const SUPABASE_URL="https://kdbuduwztmxxykfvqbie.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_ZZpjQ4Lqcqd2uVpGrSthcQ_nnCYSGPv";
const SNAPSHOT_BUCKET="snapshots";
// ‚ïê‚ïê‚ïê PADDLE CONFIG ‚ïê‚ïê‚ïê
const PADDLE_CLIENT_TOKEN="live_33cdf046a6d3ae7563fe7e0cfdd";
const PADDLE_PRICE_ID="pri_01khwzkwms683acky5fccrwzzf";
const PADDLE_ENV="production"; // "sandbox" zum Testen
let paddleReady=false;
function initPaddle(){
  if(!window.Paddle){console.warn("Paddle not loaded");return;}
  try{
    Paddle.Environment.set(PADDLE_ENV);
    Paddle.Initialize({
      token: PADDLE_CLIENT_TOKEN,
      eventCallback: function(data){
        if(data.name==="checkout.completed"){
          handlePaddleSuccess(data.data);
        }
      }
    });
    paddleReady=true;
    console.log("Paddle initialized ‚úì");
  }catch(e){console.error("Paddle init error",e);}
}
async function handlePaddleSuccess(checkoutData){
  // After successful checkout: set plan to Pro in Supabase
  if(!supabaseClient||!currentUserId){flash("Zahlung erfolgreich! Bitte neu einloggen.");return;}
  const email=checkoutData?.customer?.email||user.email||null;
  const paddleSubId=checkoutData?.subscription?.id||null;
  const trialEnd=new Date();
  trialEnd.setFullYear(trialEnd.getFullYear()+1); // Pro f√ºr 1 Jahr (Paddle verwaltet Abo)
  try{
    await supabaseClient.from("user_profiles").update({
      plan:"Pro",
      trial_end:null,
      updated_at:new Date().toISOString()
    }).eq("id",currentUserId);
    user.plan="Pro";
    user.trialEnd=null;
    saveUser();
    flash("üéâ Willkommen im Pro-Plan!");
    renderNav();
    renderUser();
    renderPage();
    closeModal();
  }catch(e){flash("Zahlung erfolgreich ‚Äì bitte Seite neu laden.");}
}
function openPaddleCheckout(){
  if(!paddleReady||!window.Paddle){
    flash("Checkout wird geladen...");
    loadPaddleScript().then(()=>{initPaddle();setTimeout(openPaddleCheckout,800);}).catch(()=>flash("Checkout nicht verf√ºgbar ‚Äì bitte Seite neu laden."));
    return;
  }
  try{
    Paddle.Checkout.open({
      items:[{priceId:PADDLE_PRICE_ID,quantity:1}],
      customer:{email:user.email||undefined},
      customData:{userId:currentUserId||undefined},
      settings:{
        displayMode:"overlay",
        theme:"dark",
        locale:"de",
        successUrl:window.location.href
      }
    });
  }catch(e){
    console.error("Paddle checkout error",e);
    flash("Checkout konnte nicht ge√∂ffnet werden. Bitte versuche es erneut.");
  }
}
let supabaseClient=null;
let currentUserId=null;
let stateSaveTimer=null;
function supaPublicAsset(name){return `${SUPABASE_URL}/storage/v1/object/public/public-assets/${encodeURIComponent(name)}`}
function splitNameParts(n){const p=(n||"").trim().split(/\s+/).filter(Boolean);return{firstName:p[0]||"",lastName:p.slice(1).join(" ")}}
function loadUser(){try{const raw=localStorage.getItem("sfUser");if(raw){const u=JSON.parse(raw);if(u&&typeof u==="object"){const parts=splitNameParts(u.name||"");user.loggedIn=!!u.loggedIn;user.name=u.name||"";user.firstName=u.firstName||parts.firstName;user.lastName=u.lastName||parts.lastName;user.plan=u.plan||"Basis";user.trialEnd=u.trialEnd||null;user.email=u.email||"";user.addressStreet=u.addressStreet||"";user.addressZip=u.addressZip||"";user.addressCity=u.addressCity||"";user.phone=u.phone||""}}}catch(e){}}
function saveUser(){try{localStorage.setItem("sfUser",JSON.stringify(user))}catch(e){}}
function setSession(userData){const parts=splitNameParts(userData.name||"");const sfUser={loggedIn:true,name:userData.name||"Benutzer",firstName:userData.firstName||parts.firstName,lastName:userData.lastName||parts.lastName,plan:userData.plan||"Basis",trialEnd:userData.trialEnd||null,email:userData.email||"",addressStreet:userData.addressStreet||"",addressZip:userData.addressZip||"",addressCity:userData.addressCity||"",phone:userData.phone||""};try{localStorage.setItem(STORAGE_USER,JSON.stringify(sfUser))}catch(e){}user.loggedIn=true;user.name=sfUser.name;user.firstName=sfUser.firstName;user.lastName=sfUser.lastName;user.plan=sfUser.plan;user.trialEnd=sfUser.trialEnd||null;user.email=sfUser.email;user.addressStreet=sfUser.addressStreet;user.addressZip=sfUser.addressZip;user.addressCity=sfUser.addressCity;user.phone=sfUser.phone}
function hasSupabaseConfig(){return !!(SUPABASE_URL&&SUPABASE_ANON_KEY&&!SUPABASE_URL.includes("YOUR_PROJECT_ID")&&!SUPABASE_ANON_KEY.includes("YOUR_SUPABASE_ANON_KEY"))}
async function initSupabaseClient(){if(!window.supabase||!window.supabase.createClient||!hasSupabaseConfig())return false;supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);return true}
async function loadCloudProfile(userId,authUser){
  if(!supabaseClient)return;
  const md=authUser.user_metadata||{};
  const nameFromAuth=md.full_name||[md.first_name||"",md.last_name||""].join(" ").trim()||authUser.email||"Benutzer";
  const fallback={name:nameFromAuth,firstName:md.first_name||splitNameParts(nameFromAuth).firstName,lastName:md.last_name||splitNameParts(nameFromAuth).lastName,email:authUser.email||"",plan:md.plan||"Basis",addressStreet:"",addressZip:"",addressCity:"",phone:""};
  const {data}=await supabaseClient.from("user_profiles").select("first_name,last_name,plan,trial_end,address_street,address_zip,address_city,phone").eq("id",userId).maybeSingle();
  const merged={...fallback,firstName:data?.first_name||fallback.firstName,lastName:data?.last_name||fallback.lastName,plan:data?.plan||fallback.plan,trialEnd:data?.trial_end||null,addressStreet:data?.address_street||"",addressZip:data?.address_zip||"",addressCity:data?.address_city||"",phone:data?.phone||""};
  merged.name=[merged.firstName,merged.lastName].join(" ").trim()||fallback.name;
  setSession(merged);
}
async function upsertCloudProfile(){
  if(!supabaseClient||!currentUserId)return;
  await supabaseClient.from("user_profiles").upsert({id:currentUserId,email:user.email||null,first_name:user.firstName||null,last_name:user.lastName||null,plan:user.plan||"Basis",trial_end:user.trialEnd||null,address_street:user.addressStreet||null,address_zip:user.addressZip||null,address_city:user.addressCity||null,phone:user.phone||null,updated_at:new Date().toISOString()});
}
async function loadCloudState(){
  if(!supabaseClient||!currentUserId)return;
  const {data}=await supabaseClient.from("app_state").select("debts,budget_items,budget_month,contracts").eq("user_id",currentUserId).maybeSingle();
  if(data){
    if(Array.isArray(data.debts))debts=data.debts;
    if(Array.isArray(data.budget_items))budgetItems=data.budget_items;
    if(Array.isArray(data.contracts))contracts=data.contracts;
    if(typeof data.budget_month==="string"&&data.budget_month)currentBudgetMonth=data.budget_month;
    normalizeDebtStatuses();
  }else{
    await saveCloudState();
  }
}
async function saveCloudState(){
  if(!supabaseClient||!currentUserId)return;
  await supabaseClient.from("app_state").upsert({user_id:currentUserId,debts:debts,budget_items:budgetItems,budget_month:currentBudgetMonth,contracts:contracts,updated_at:new Date().toISOString()});
}
function saveLocalState(){try{localStorage.setItem("debts",JSON.stringify(debts));localStorage.setItem("budgetItems",JSON.stringify(budgetItems));localStorage.setItem("contracts",JSON.stringify(contracts));localStorage.setItem("budgetMonth",String(currentBudgetMonth))}catch(e){}}
function backupUserId(){return currentUserId||"local"}
function snapshotKey(){return `sfSnapshots:${backupUserId()}`}
function createBackupPayload(){return{version:1,createdAt:new Date().toISOString(),userId:backupUserId(),data:{debts, budgetItems, contracts, budgetMonth: currentBudgetMonth}}}
function downloadBackup(){const payload=createBackupPayload();const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`ratenova-backup-${new Date().toISOString().slice(0,10)}.json`;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);flash("Backup heruntergeladen ‚úì")}
function handleBackupFileChange(e){const f=(e?.target?.files||[])[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const obj=JSON.parse(r.result);restoreFromBackup(obj)}catch(err){flash("Ung√ºltige Backup-Datei ‚úó")}};r.readAsText(f);e.target.value=""}
function validateBackupPayload(obj){if(!obj||obj.version!==1||!obj.data)return false;const d=obj.data;if(!Array.isArray(d.debts)||!Array.isArray(d.budgetItems)||!Array.isArray(d.contracts))return false;return true}
function restoreFromBackup(obj){if(!validateBackupPayload(obj)){flash("Backup ung√ºltig ‚úó");return;}debts=Array.isArray(obj.data.debts)?obj.data.debts:[];budgetItems=Array.isArray(obj.data.budgetItems)?obj.data.budgetItems:[];contracts=Array.isArray(obj.data.contracts)?obj.data.contracts:[];currentBudgetMonth=typeof obj.data.budgetMonth==="string"&&obj.data.budgetMonth?obj.data.budgetMonth:currentBudgetMonth;normalizeDebtStatuses();saveLocalState();scheduleCloudSave();renderNav();renderPage();flash("Backup wiederhergestellt ‚úì")}
function listSnapshotsLocal(){try{const raw=localStorage.getItem(snapshotKey());const arr=JSON.parse(raw||"[]");return Array.isArray(arr)?arr:[]}catch(e){return[]}}
function saveSnapshotsLocal(arr){try{localStorage.setItem(snapshotKey(),JSON.stringify(arr))}catch(e){}}
function cleanupSnapshotsLocal(){const now=Date.now();let arr=listSnapshotsLocal();arr=arr.filter(s=>{const ageMs=now-(new Date(s.createdAt).getTime());return ageMs<=7*864e5});while(arr.length>5)arr.pop();saveSnapshotsLocal(arr);return arr}
function addSnapshotLocal(kind="auto"){const payload=createBackupPayload();payload.kind=kind;const arr=listSnapshotsLocal();arr.unshift(payload);const cleaned=cleanupSnapshotsLocal();try{saveSnapshotsLocal(cleaned);return true}catch(e){return false}}
async function fetchSnapshotsCloud(){if(!supabaseClient||!currentUserId)return null;try{const {data,error}=await supabaseClient.from("user_snapshots").select("id,created_at,kind,storage_path").eq("user_id",currentUserId).order("created_at",{ascending:false});if(error)throw error;return Array.isArray(data)?data:[]}catch(e){return null}}
async function createSnapshotCloud(kind="auto"){if(!supabaseClient||!currentUserId)return false;try{const payload=createBackupPayload();payload.kind=kind;const blob=new Blob([JSON.stringify(payload)],{type:"application/json"});const ts=Date.now();const path=`${currentUserId}/${ts}-${kind}.json`;const up=await supabaseClient.storage.from(SNAPSHOT_BUCKET).upload(path,blob,{contentType:"application/json"});if(up.error)throw up.error;await supabaseClient.from("user_snapshots").insert({user_id:currentUserId,kind,storage_path:path,created_at:new Date().toISOString(),size:blob.size});return true}catch(e){console.warn("Cloud snapshot error:",e.message||e);return false}}
async function enforceSnapshotRetentionCloud(){if(!supabaseClient||!currentUserId)return;try{const list=await fetchSnapshotsCloud();if(!Array.isArray(list))return;const now=Date.now();const toDelete=[];list.forEach((s,idx)=>{const ageMs=now-(new Date(s.created_at).getTime());if(ageMs>7*864e5)toDelete.push(s);});if(list.length>5){toDelete.push(...list.slice(5));}if(toDelete.length){const paths=toDelete.map(s=>s.storage_path);await supabaseClient.storage.from(SNAPSHOT_BUCKET).remove(paths);for(const s of toDelete){await supabaseClient.from("user_snapshots").delete().eq("user_id",currentUserId).eq("storage_path",s.storage_path)}}}catch(e){console.warn("Retention cleanup error:",e.message||e)}}
async function autoSnapshot(kind="auto",notify=false){let ok=false;if(supabaseClient&&currentUserId){ok=await createSnapshotCloud(kind);if(ok)await enforceSnapshotRetentionCloud()}if(!ok){addSnapshotLocal(kind);cleanupSnapshotsLocal()}if(notify)flash("Zur Sicherheit wurde ein Sicherungspunkt erstellt.");if(currentPage==="settings")setTimeout(renderSnapshotList,0)}
async function restoreSnapshotCloud(path){if(!supabaseClient||!currentUserId)return;try{const {data,error}=await supabaseClient.storage.from(SNAPSHOT_BUCKET).download(path);if(error)throw error;const txt=await data.text();const obj=JSON.parse(txt);restoreFromBackup(obj)}catch(e){flash("Wiederherstellung fehlgeschlagen ‚úó")}}
async function deleteSnapshotCloud(path){if(!supabaseClient||!currentUserId)return;try{await supabaseClient.storage.from(SNAPSHOT_BUCKET).remove([path]);await supabaseClient.from("user_snapshots").delete().eq("user_id",currentUserId).eq("storage_path",path);renderSnapshotList();flash("Snapshot gel√∂scht ‚úì")}catch(e){flash("L√∂schen fehlgeschlagen ‚úó")}}
function restoreSnapshotLocal(i){const arr=listSnapshotsLocal();if(!arr[i])return;restoreFromBackup(arr[i])}
function deleteSnapshotLocal(i){const arr=listSnapshotsLocal();if(!arr[i])return;arr.splice(i,1);saveSnapshotsLocal(cleanupSnapshotsLocal());renderSnapshotList();flash("Snapshot gel√∂scht ‚úì")}
async function renderSnapshotList(){const host=document.getElementById("snapshotList");if(!host)return;host.innerHTML='<p style="font-size:12px;color:var(--tm);margin:0">Lade Sicherungspunkte‚Ä¶</p>';const cloud=await fetchSnapshotsCloud();if(Array.isArray(cloud)){const rows=cloud.map((s,idx)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-top:${idx===0?'1px solid var(--b)':'none'};border-bottom:1px solid var(--b)"><div><span style="font-size:12px;color:var(--ts)">${new Date(s.created_at).toLocaleString('de-DE')}</span><span style="font-size:11px;color:var(--tm);margin-left:8px">${s.kind==='daily'?'Automatisch (t√§glich)':'Automatisch'}</span></div><div style="display:flex;gap:6px"><button class="btn btn-outline btn-sm" onclick="restoreSnapshotCloud('${s.storage_path}')">Wiederherstellen</button><button class="btn btn-ghost btn-sm" onclick="deleteSnapshotCloud('${s.storage_path}')">L√∂schen</button></div></div>`).join("");host.innerHTML=`<p style="font-size:12px;color:var(--tm);margin:0 0 8px">Sicherungspunkte (max 5 ¬∑ 7 Tage)</p>${rows||'<p style="font-size:12px;color:var(--tm);margin:0">Keine Sicherungspunkte vorhanden.</p>'}`;return}const local=listSnapshotsLocal();const rows=local.map((s,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-top:${i===0?'1px solid var(--b)':'none'};border-bottom:1px solid var(--b)"><div><span style="font-size:12px;color:var(--ts)">${new Date(s.createdAt).toLocaleString('de-DE')}</span><span style="font-size:11px;color:var(--tm);margin-left:8px">${(s.kind||'auto')==='daily'?'Automatisch (t√§glich)':'Automatisch'}</span></div><div style="display:flex;gap:6px"><button class="btn btn-outline btn-sm" onclick="restoreSnapshotLocal(${i})">Wiederherstellen</button><button class="btn btn-ghost btn-sm" onclick="deleteSnapshotLocal(${i})">L√∂schen</button></div></div>`).slice(0,5).join("");host.innerHTML=`<p style="font-size:12px;color:var(--tm);margin:0 0 8px">Sicherungspunkte (lokal ¬∑ max 5 ¬∑ 7 Tage)</p>${rows||'<p style="font-size:12px;color:var(--tm);margin:0">Keine Sicherungspunkte vorhanden.</p>'}`}
async function ensureDailySnapshot(){const last=localStorage.getItem("sfLastSnapshotDate")||"";const t=new Date().toISOString().slice(0,10);if(last!==t){await autoSnapshot("daily",false);localStorage.setItem("sfLastSnapshotDate",t)}}
function loadLocalState(){try{const ld=readJsonLocal("debts",null);const lb=readJsonLocal("budgetItems",null);const lc=readJsonLocal("contracts",null);const lm=localStorage.getItem("budgetMonth");if(Array.isArray(ld))debts=ld;if(Array.isArray(lb))budgetItems=lb;if(Array.isArray(lc))contracts=lc;if(typeof lm==="string"&&lm)currentBudgetMonth=lm;normalizeDebtStatuses()}catch(e){}}
function scheduleCloudSave(){
  saveLocalState(); // Sofort lokal speichern ‚Äì niemals verlieren
  if(!supabaseClient||!currentUserId)return;
  clearTimeout(stateSaveTimer);
  // 2 Sekunden Debounce ‚Äì danach sicher in Cloud speichern
  stateSaveTimer=setTimeout(()=>{saveCloudState().catch(()=>{})},2000);
}
// Beim Tab schlie√üen/aktualisieren: sofort speichern, nicht warten
window.addEventListener("beforeunload",()=>{
  if(supabaseClient&&currentUserId){
    saveLocalState();
    saveCloudState().catch(()=>{});
  }
});

// ‚îÄ‚îÄ Auto-Logout nach Inaktivit√§t ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AUTO_LOGOUT_MS = 30 * 60 * 1000; // 30 Minuten
const AUTO_LOGOUT_WARN_MS = 28 * 60 * 1000; // Warnung nach 28 Minuten
let autoLogoutTimer = null;
let autoLogoutWarnTimer = null;

function resetAutoLogout(){
  if(!user.loggedIn) return;
  clearTimeout(autoLogoutTimer);
  clearTimeout(autoLogoutWarnTimer);
  autoLogoutWarnTimer = setTimeout(()=>{
    if(!user.loggedIn) return;
    flash("‚ö†Ô∏è Du wirst in 2 Minuten automatisch ausgeloggt.");
  }, AUTO_LOGOUT_WARN_MS);
  autoLogoutTimer = setTimeout(async()=>{
    if(!user.loggedIn) return;
    flash("üîí Automatisch ausgeloggt (Inaktivit√§t).");
    await logoutUser();
  }, AUTO_LOGOUT_MS);
}

["mousemove","keydown","click","touchstart","scroll"].forEach(ev=>{
  document.addEventListener(ev, ()=>{ if(user.loggedIn) resetAutoLogout(); }, {passive:true});
});
function readJsonLocal(key,fallback){try{const raw=localStorage.getItem(key);if(!raw)return fallback;const parsed=JSON.parse(raw);return parsed??fallback}catch(e){return fallback}}
async function migrateLegacyLocalData(authUser){
  if(!supabaseClient||!currentUserId)return;
  const markerKey=`sfMigrated:${currentUserId}`;
  if(localStorage.getItem(markerKey)==="1")return;

  const legacySession=readJsonLocal("sfUser",null);
  const legacyUsers=readJsonLocal("sfUsers",[]);
  const legacyBudget=readJsonLocal("budgetItems",null);
  const legacyDebts=readJsonLocal("debts",null);
  const legacyContracts=readJsonLocal("contracts",null);
  const legacyMonth=localStorage.getItem("budgetMonth")||currentBudgetMonth;
  const email=(authUser?.email||"").toLowerCase();
  const legacyByEmail=Array.isArray(legacyUsers)?legacyUsers.find(u=>((u?.email||"").toLowerCase()===email)):null;
  const legacyProfile=legacyByEmail||legacySession||null;

  let profileTouched=false;
  if(legacyProfile&&typeof legacyProfile==="object"){
    const parts=splitNameParts(legacyProfile.name||"");
    user.firstName=legacyProfile.firstName||parts.firstName||user.firstName;
    user.lastName=legacyProfile.lastName||parts.lastName||user.lastName;
    user.name=[user.firstName,user.lastName].join(" ").trim()||legacyProfile.name||user.name;
    user.plan=legacyProfile.plan||user.plan;
    user.addressStreet=legacyProfile.addressStreet||user.addressStreet;
    user.addressZip=legacyProfile.addressZip||user.addressZip;
    user.addressCity=legacyProfile.addressCity||user.addressCity;
    user.phone=legacyProfile.phone||user.phone;
    profileTouched=true;
  }

  let stateMigrated=false;
  const {data:cloudState}=await supabaseClient.from("app_state").select("debts,budget_items,budget_month,contracts").eq("user_id",currentUserId).maybeSingle();
  const cloudHasState=!!(cloudState&&((Array.isArray(cloudState.debts)&&cloudState.debts.length>0)||(Array.isArray(cloudState.budget_items)&&cloudState.budget_items.length>0)||(Array.isArray(cloudState.contracts)&&cloudState.contracts.length>0)));
  const localHasState=!!((Array.isArray(legacyDebts)&&legacyDebts.length>0)||(Array.isArray(legacyBudget)&&legacyBudget.length>0)||(Array.isArray(legacyContracts)&&legacyContracts.length>0));
  if(localHasState&&!cloudHasState){
    const debtsToSave=Array.isArray(legacyDebts)?legacyDebts:[];
    const budgetToSave=Array.isArray(legacyBudget)?legacyBudget:[];
    const contractsToSave=Array.isArray(legacyContracts)?legacyContracts:[];
    await supabaseClient.from("app_state").upsert({user_id:currentUserId,debts:debtsToSave,budget_items:budgetToSave,budget_month:legacyMonth||currentBudgetMonth,contracts:contractsToSave,updated_at:new Date().toISOString()});
    stateMigrated=true;
  }

  if(profileTouched)await upsertCloudProfile();
  localStorage.setItem(markerKey,"1");
  if(stateMigrated)flash("Lokale Daten wurden einmalig in die Cloud migriert ‚úì");
}
async function ensureAppAuth(){
  if(!supabaseClient)return false;
  const {data:{session}}=await supabaseClient.auth.getSession();
  if(!session||!session.user)return false;
  currentUserId=session.user.id;
  await loadCloudProfile(currentUserId,session.user);
  await migrateLegacyLocalData(session.user);
  await loadCloudState();
  purgeCurrentUserSeedBudget();
  return true;
}
function authShowNotice(msg,type){const n=document.getElementById("authNotice");if(!n)return;n.className=`auth-notice ${type==="ok"?"auth-ok":"auth-err"}`;n.textContent=msg}
function authHideNotice(){const n=document.getElementById("authNotice");if(!n)return;n.className="auth-hidden";n.textContent=""}
function authSwitch(tab){const tabs={login:document.getElementById("tabLogin"),register:document.getElementById("tabRegister")},forms={login:document.getElementById("formLogin"),register:document.getElementById("formRegister")};Object.entries(tabs).forEach(([k,b])=>b&&b.classList.toggle("active",k===tab));Object.entries(forms).forEach(([k,f])=>f&&f.classList.toggle("auth-hidden",k!==tab));authHideNotice()}
function showAuthPage(tab="login"){const a=document.getElementById("authRoot"),l=document.querySelector(".layout"),m=document.getElementById("mobileNav");if(a)a.style.display="flex";if(l)l.style.display="none";if(m)m.style.display="none";authSwitch(tab)}
function hideAuthPage(){const a=document.getElementById("authRoot"),l=document.querySelector(".layout"),m=document.getElementById("mobileNav");if(a)a.style.display="none";if(l)l.style.display="flex";if(m)m.style.display=""}
async function completeLoginFromSession(sessionUser,isNewReg=false){
  currentUserId=sessionUser.id;
  await loadCloudProfile(currentUserId,sessionUser);
  await migrateLegacyLocalData(sessionUser);
  resetAutoLogout(); // Auto-Logout Timer starten
  // Set 30-day trial for new registrations if not yet set
  if(isNewReg&&!user.trialEnd){
    const trialEnd=new Date();trialEnd.setDate(trialEnd.getDate()+30);
    user.trialEnd=trialEnd.toISOString();
  }
  await upsertCloudProfile();
  await loadCloudState();
  purgeCurrentUserSeedBudget();
  saveUser();
  hideAuthPage();
  renderNav();
  renderUser();
  renderPage();
  if(isNewReg&&user.trialEnd){flash("üéâ 30 Tage Pro-Testphase gestartet! Viel Spa√ü.");}
}
function initAuthUI(){
  const tL=document.getElementById("tabLogin"),tR=document.getElementById("tabRegister");
  if(!tL||!tR)return;
  const logo=document.getElementById("authLogo");
  if(logo){logo.src="https://kdbuduwztmxxykfvqbie.supabase.co/storage/v1/object/public/public-assets/Plamavo_Logo.png";logo.onerror=()=>{logo.style.display="none"}}
  const sLogo=document.getElementById("sidebarLogo");
  if(sLogo){sLogo.src="https://kdbuduwztmxxykfvqbie.supabase.co/storage/v1/object/public/public-assets/Plamavo_Logo_nur_Text.png";sLogo.onerror=()=>{sLogo.style.display="none"}}
  tL.onclick=()=>authSwitch("login");tR.onclick=()=>authSwitch("register");
  document.querySelectorAll("[data-switch]").forEach(btn=>btn.addEventListener("click",()=>authSwitch(btn.dataset.switch)));
  document.getElementById("formLogin").addEventListener("submit",async(e)=>{e.preventDefault();if(!supabaseClient){authShowNotice("Supabase nicht konfiguriert.","err");return;}const email=document.getElementById("loginEmail").value.trim().toLowerCase(),password=document.getElementById("loginPassword").value;const {data,error}=await supabaseClient.auth.signInWithPassword({email,password});if(error||!data.user){authShowNotice("Login fehlgeschlagen. E-Mail oder Passwort falsch.","err");return;}await completeLoginFromSession(data.user)});
  document.getElementById("formRegister").addEventListener("submit",async(e)=>{e.preventDefault();if(!supabaseClient){authShowNotice("Supabase nicht konfiguriert.","err");return;}const name=document.getElementById("regName").value.trim(),parts=splitNameParts(name),email=document.getElementById("regEmail").value.trim().toLowerCase(),password=document.getElementById("regPassword").value,plan=(document.getElementById("regPlan")?.value||"Basis").trim();const {data,error}=await supabaseClient.auth.signUp({email,password,options:{data:{first_name:parts.firstName,last_name:parts.lastName,full_name:name,plan},emailRedirectTo:window.location.origin}});if(error){authShowNotice(error.message||"Registrierung fehlgeschlagen.","err");return;}if(!data.session){authShowNotice("Registrierung erfolgt. Bitte E-Mail best√§tigen.","ok");return;}
    await completeLoginFromSession(data.user,true)});
  const fLink=document.getElementById("forgotLink");
  if(fLink){
    fLink.onclick=async()=>{
      let mail=(document.getElementById("loginEmail")?.value||"").trim().toLowerCase();
      if(!mail){mail=prompt("Bitte E-Mail eingeben, um das Passwort zur√ºckzusetzen:");if(!mail){authShowNotice("E-Mail erforderlich.","err");return;}}
      if(!supabaseClient){authShowNotice("Supabase nicht konfiguriert.","err");return;}
      try{const {error}=await supabaseClient.auth.resetPasswordForEmail(mail,{redirectTo:window.location.href});if(error){authShowNotice("Reset fehlgeschlagen. Pr√ºfe die E-Mail.","err");return;}authShowNotice("Reset-Link wurde per E-Mail versendet.","ok");}catch(e){authShowNotice("Fehler beim Senden des Links.","err");}
    }
  }
  // init custom dropdowns (.custom-select)
  document.querySelectorAll('.custom-select').forEach(cs=>{
    const valueEl=cs.querySelector('.cs-value');
    const list=cs.querySelector('.cs-list');
    const items=Array.from(cs.querySelectorAll('.cs-item'));
    const hidden=cs.querySelector('input[type="hidden"]');
    const openClose=(open)=>{cs.setAttribute('aria-expanded',open?'true':'false');if(list)list.setAttribute('aria-hidden',(!open).toString());};
    // click value to toggle
    valueEl?.addEventListener('click',()=>{const isOpen=cs.getAttribute('aria-expanded')==='true';openClose(!isOpen)});
    // click items
    items.forEach(it=>it.addEventListener('click',()=>{const v=it.dataset.value||it.textContent.trim(); if(hidden)hidden.value=v; valueEl.textContent=v; items.forEach(x=>x.classList.toggle('active',x===it)); openClose(false);}));
    // keyboard
    cs.addEventListener('keydown',e=>{
      const open=cs.getAttribute('aria-expanded')==='true';
      const idx=items.findIndex(i=>i.classList.contains('active'));
      if(e.key==='ArrowDown'){e.preventDefault(); if(!open){openClose(true);} else {const next=items[(idx+1)>=items.length?0:idx+1]; next.focus();}}
      if(e.key==='ArrowUp'){e.preventDefault(); if(!open){openClose(true);} else {const prev=items[(idx-1)<0?items.length-1:idx-1]; prev.focus();}}
      if(e.key==='Enter'){e.preventDefault(); if(!open){openClose(true);} else {const focused=document.activeElement; if(focused.classList && focused.classList.contains('cs-item')){focused.click();}}}
      if(e.key==='Escape'){openClose(false)}
    });
    // close on outside click
    document.addEventListener('click',ev=>{if(!cs.contains(ev.target))openClose(false)});
  });
}
function buildVerificationEmailHTML(confirmationURL){
  const logo=supaPublicAsset("Planavo Logo_ mit Text.png");
  return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><title>Planavo ‚Äì E-Mail best√§tigen</title></head><body style="margin:0;background:var(--bg);color:#111;font-family:Segoe UI,Arial,sans-serif">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background:var(--bg);padding:32px 0">
    <tr><td align="center">
      <table role="presentation" width="600" cellspacing="0" cellpadding="0" style="max-width:600px;background:#111318;border-radius:16px;border:1px solid #1f2330;box-shadow:0 12px 32px rgba(0,0,0,0.35)">
        <tr><td style="padding:24px 24px 0" align="center"><img src="${logo}" alt="Planavo" style="max-width:200px;height:auto;border:none"></td></tr>
        <tr><td style="padding:8px 24px 0" align="center"><h1 style="margin:0;font-size:22px;color:#e7f5ef">Bitte best√§tige deine E‚ÄëMail-Adresse</h1></td></tr>
        <tr><td style="padding:12px 28px" align="center"><p style="margin:0;font-size:14px;color:#9aa3b2;line-height:1.6">Willkommen bei Planavo! Klicke auf den Button, um dein Konto zu aktivieren und loszulegen.</p></td></tr>
        <tr><td style="padding:8px 28px 24px" align="center">
          <a href="${confirmationURL}" style="display:inline-block;background:var(--em);color:#062b1e;text-decoration:none;font-weight:700;padding:12px 20px;border-radius:10px">E‚ÄëMail best√§tigen</a>
        </td></tr>
        <tr><td style="padding:0 28px 24px" align="center"><p style="margin:0;font-size:12px;color:#667085">Falls der Button nicht funktioniert, kopiere diesen Link in deinen Browser:</p><p style="margin:8px 0 0;font-size:12px;color:#8ea5b4;word-break:break-all">${confirmationURL}</p></td></tr>
        <tr><td style="padding:16px 24px 24px" align="center"><p style="margin:0;font-size:12px;color:#667085">¬© ${new Date().getFullYear()} Planavo ‚Äì Sicher und vertraulich</p></td></tr>
      </table>
    </td></tr>
  </table></div>
</div></div>

</div>
</body></html>`;
}
function openVerificationEmailPreview(){
  const html=buildVerificationEmailHTML(window.location.origin+"/?confirm=example");
  document.getElementById("modalContainer").innerHTML=`<div class="overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()" style="max-width:760px">
    <div class="modal-head"><h3>Verifizierungs‚ÄëMail Vorlage</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>
    <div style="margin-bottom:12px"><button class="btn btn-outline btn-sm" onclick="copyVerificationEmailHTML()">HTML kopieren</button></div>
    <iframe srcdoc='${html.replace(/'/g,"&#39;")}' style="width:100%;height:520px;border:1px solid var(--b);border-radius:12px;background:var(--bg)"></iframe>
  </div></div>`;
}
function copyVerificationEmailHTML(){
  const html=buildVerificationEmailHTML("{{ .ConfirmationURL }}");
  navigator.clipboard.writeText(html).then(()=>flash("HTML kopiert ‚úì")).catch(()=>flash("Kopieren fehlgeschlagen"));
}
function renderUser(){
  const el=document.getElementById("sidebarBottom");
  if(!el)return;
  if(!user.loggedIn){
    el.innerHTML=`<div class="card" style="padding:12px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><div style="width:34px;height:34px;border-radius:10px;background:var(--bgE);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0">üë§</div><div><p style="font-size:12px;color:var(--tm);margin:0">Nicht eingeloggt</p></div></div><button class="btn btn-primary btn-sm btn-full" style="padding:8px 10px" onclick="openLogin()">Anmelden</button></div>`;
    return;
  }
  const trial=isTrialActive();
  const daysLeft=trialDaysLeft();
  const pro=isProPlan();
  const planLabel=trial?`Pro <span style="font-size:9px;background:var(--amG);color:var(--am);padding:2px 6px;border-radius:10px;border:1px solid rgba(251,191,36,0.3)">TEST ${daysLeft}d</span>`:pro?"Pro":"Basic";
  const upgradeBtn=!pro&&!trial?`<button class="btn btn-ghost btn-sm btn-full" style="padding:7px 10px;margin-bottom:6px" onclick="openPaddleCheckout()">‚≠ê Upgrade auf Pro</button>`:"";
  el.innerHTML=`<div class="card" style="padding:12px">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
      <div style="width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--emD),var(--em));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0">${(user.name||"").trim().slice(0,1).toUpperCase()||"üë§"}</div>
      <div style="min-width:0">
        <p style="font-size:13px;font-weight:700;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${user.name||"Benutzer"}</p>
        <p style="font-size:11px;color:var(--ts);margin:2px 0 0">Plan: <strong style="color:var(--em)">${planLabel}</strong></p>
      </div>
    </div>
    ${upgradeBtn}
    <button class="btn btn-danger btn-sm btn-full" style="padding:8px 10px" onclick="logoutUser()">Logout</button>
  </div>`;
}
function openLogin(){showAuthPage("login")}
function saveLogin(){openLogin()}
async function logoutUser(){try{if(supabaseClient)await supabaseClient.auth.signOut()}catch(e){}currentUserId=null;user={loggedIn:false,name:"",firstName:"",lastName:"",plan:"Basis",email:"",addressStreet:"",addressZip:"",addressCity:"",phone:""};saveUser();showAuthPage("login")}

const MASTER_USERNAME="master";
const MASTER_AUTH_EMAIL="master@planavo.local";
let masterState={loggedIn:false,tab:"users",users:[],states:[],selectedUserId:null,impersonating:false,original:null,error:"",query:"",deleteConfirm:null};
function openMasterPanel(){window.location.href=`${window.location.pathname}?master=1`}
function exitMasterPanel(){window.location.href=window.location.pathname}
function renderMasterView(){if(isMasterMode)renderMasterStandalone();else renderPage()}
async function masterLogin(){
  const u=(document.getElementById("mUser")?.value||"").trim().toLowerCase();
  const p=(document.getElementById("mPass")?.value||"").trim();
  if(!supabaseClient){masterState.error="Supabase nicht verbunden";renderMasterView();return;}
  if(u!==MASTER_USERNAME||!p){masterState.error="Login fehlgeschlagen";renderMasterView();return;}
  const {data,error}=await supabaseClient.auth.signInWithPassword({email:MASTER_AUTH_EMAIL,password:p});
  if(error||!data?.user){masterState.error="Login fehlgeschlagen";renderMasterView();return;}
  const userEmail=(data.user.email||"").trim().toLowerCase();
  const {data:profile}=await supabaseClient.from("user_profiles").select("role").eq("id",data.user.id).maybeSingle();
  const roleOk=(profile?.role||"")==="master";
  const emailOk=userEmail===MASTER_AUTH_EMAIL.toLowerCase();
  if(!roleOk&&!emailOk){
    try{await supabaseClient.auth.signOut()}catch(e){}
    masterState.error="Keine Berechtigung f√ºr Master-Panel";
    renderMasterView();
    return;
  }
  masterState.loggedIn=true;masterState.error="";masterState.tab="stats";
  await loadMasterData();
  renderMasterView();
}
async function masterLogout(){try{if(supabaseClient)await supabaseClient.auth.signOut()}catch(e){}masterState={loggedIn:false,tab:"users",users:[],states:[],selectedUserId:null,impersonating:false,original:null,error:"",query:"",deleteConfirm:null};exitMasterPanel()}
async function loadMasterData(){
  if(!supabaseClient){masterState.error="Supabase nicht verbunden";return;}
  const [{data:users,error:uErr},{data:states,error:sErr}]=await Promise.all([
    supabaseClient.from("user_profiles").select("id,email,first_name,last_name,plan,trial_end,address_street,address_zip,address_city,phone,updated_at,is_blocked,admin_note"),
    supabaseClient.from("app_state").select("user_id,debts,budget_items,contracts,updated_at")
  ]);
  if(uErr||sErr){
    const fmt=(e,table)=>e?`${table}: ${e.message||"Fehler"}${e.code?` [${e.code}]`:""}`:"";
    masterState.error=`Master-Panel Lesefehler. ${fmt(uErr,"user_profiles")} ${fmt(sErr,"app_state")}`.trim();
    return;
  }
  masterState.users=users||[];
  masterState.states=states||[];
  if(!masterState.selectedUserId&&masterState.users.length)masterState.selectedUserId=masterState.users[0].id;
  if(masterState.selectedUserId&&!masterState.users.some(u=>u.id===masterState.selectedUserId))masterState.selectedUserId=masterState.users[0]?.id||null;
  masterState.error="";
}
const mNum=v=>{const n=Number(v);return Number.isFinite(n)?n:0};
const mEsc=v=>String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
function masterStateMap(){const map={};masterState.states.forEach(s=>{if(s&&s.user_id)map[s.user_id]=s});return map}
function masterUserMetrics(u,stateMap){
  const s=stateMap[u.id]||{};
  const debtList=Array.isArray(s.debts)?s.debts:[];
  const budgetList=Array.isArray(s.budget_items)?s.budget_items:[];
  const contractList=Array.isArray(s.contracts)?s.contracts:[];
  let income=0,expense=0,sales=0,debtOpen=0,debtMonthly=0,contractMonthly=0,contractYearly=0,entries=0;
  budgetList.forEach(b=>{
    const amount=mNum(b?.amount);
    if(!amount)return;
    entries++;
    if(b.type==="income"){
      income+=amount;
      const sig=`${b.category||""} ${b.note||""}`.toLowerCase();
      if(/verkauf|umsatz|rechnung|auftrag|shop|sale/.test(sig))sales+=amount;
    }else if(b.type==="expense"){
      expense+=amount;
    }
  });
  debtList.forEach(d=>{
    const original=mNum(d?.original),paid=mNum(d?.paid),rate=mNum(d?.rate),open=Math.max(0,original-paid);
    debtOpen+=open;
    if(open>0)debtMonthly+=Math.max(0,rate);
  });
  contractList.forEach(c=>{
    contractMonthly+=Math.max(0,mNum(c?.monthlyCost));
    contractYearly+=Math.max(0,mNum(contractAnnualCost(c||{})));
  });
  return{user:u,state:s,income,expense,sales,balance:income-expense,debtOpen,debtMonthly,contractMonthly,contractYearly,entries,debtCount:debtList.length,contractCount:contractList.length,updatedAt:s?.updated_at||u?.updated_at||null};
}
function masterMetricsList(){
  const map=masterStateMap();
  return masterState.users.map(u=>masterUserMetrics(u,map));
}
function masterStats(){
  const metrics=masterMetricsList();
  const total=masterState.users.length;
  const withState=metrics.filter(m=>m.entries+m.debtCount+m.contractCount>0).length;
  const totalDebts=metrics.reduce((a,m)=>a+m.debtCount,0);
  const totalContracts=metrics.reduce((a,m)=>a+m.contractCount,0);
  const totalIncome=metrics.reduce((a,m)=>a+m.income,0);
  const totalExpense=metrics.reduce((a,m)=>a+m.expense,0);
  const totalSales=metrics.reduce((a,m)=>a+m.sales,0);
  const debtExposure=metrics.reduce((a,m)=>a+m.debtOpen,0);
  const monthlyObligation=metrics.reduce((a,m)=>a+m.debtMonthly+m.contractMonthly,0);
  return{total,withState,totalDebts,totalContracts,totalIncome,totalExpense,totalSales,debtExposure,monthlyObligation,metrics};
}

// ‚îÄ‚îÄ‚îÄ Custom Confirm Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const confirmModal = {
  _resolve: null,
  show(msg, { title="Best√§tigung", okText="Best√§tigen", okColor="#ef4444", icon="‚ö†Ô∏è" }={}){
    document.getElementById("confirmMessage").textContent = msg;
    document.getElementById("confirmTitle").textContent   = title;
    document.getElementById("confirmOkBtn").textContent   = okText;
    document.getElementById("confirmOkBtn").style.background = okColor;
    document.getElementById("confirmIcon").textContent    = icon;
    document.getElementById("confirmIcon").style.background  = okColor + "26";
    const el = document.getElementById("confirmModal");
    el.style.display = "flex";
    return new Promise(res => { this._resolve = res; });
  },
  resolve(){ this._close(true); },
  reject(){  this._close(false); },
  _close(val){
    document.getElementById("confirmModal").style.display = "none";
    if(this._resolve) this._resolve(val);
    this._resolve = null;
  }
};
document.addEventListener("DOMContentLoaded", () => {
  });

async function masterResetUserState(id){
  if(!supabaseClient)return;
  if(!await confirmModal.show("Alle Nutzerdaten (Verbindlichkeiten, Ein-/Ausgaben, Vertr√§ge) f√ºr diesen Kunden zur√ºcksetzen?",{title:"Nutzerdaten zur√ºcksetzen",okText:"Zur√ºcksetzen",okColor:"#f59e0b",icon:"‚ö†Ô∏è"}))return;
  const {error}=await supabaseClient.from("app_state").upsert({user_id:id,debts:[],budget_items:[],contracts:[],updated_at:new Date().toISOString()});
  if(error){flash("Reset fehlgeschlagen");return;}
  flash("Nutzerdaten zur√ºckgesetzt ‚úì");
  await loadMasterData();
  renderMasterView();
}
async function masterSyncUserProfileToState(id){
  if(!supabaseClient)return;
  const userData=masterState.users.find(u=>u.id===id);
  if(!userData){flash("Nutzer nicht gefunden");return;}
  const {error}=await supabaseClient.from("user_profiles").upsert({id,email:userData.email||null,first_name:userData.first_name||null,last_name:userData.last_name||null,plan:userData.plan||"Basis",address_street:userData.address_street||null,address_zip:userData.address_zip||null,address_city:userData.address_city||null,phone:userData.phone||null,updated_at:new Date().toISOString()});
  if(error){flash("Profil-Sync fehlgeschlagen");return;}
  flash("Profil synchronisiert ‚úì");
  await loadMasterData();
  renderMasterView();
}
async function masterCreateCustomer(){
  if(!supabaseClient){flash("Supabase nicht verbunden");return;}
  const firstName=(document.getElementById("mcFirst")?.value||"").trim();
  const lastName=(document.getElementById("mcLast")?.value||"").trim();
  const email=(document.getElementById("mcEmail")?.value||"").trim().toLowerCase();
  const password=(document.getElementById("mcPass")?.value||"").trim();
  const plan=(document.getElementById("mcPlan")?.value||"Basic").trim()||"Basic";
  if(!email||!password){flash("E-Mail und Passwort sind Pflicht");return;}
  if(password.length<6){flash("Passwort muss mindestens 6 Zeichen haben");return;}
  const {data:sessionData}=await supabaseClient.auth.getSession();
  const masterSession=sessionData?.session||null;
  const {data,error}=await supabaseClient.auth.signUp({email,password,options:{data:{first_name:firstName,last_name:lastName,full_name:[firstName,lastName].join(" ").trim(),plan}}});
  if(error){flash(`Anlage fehlgeschlagen: ${error.message||"Fehler"}`);if(masterSession?.access_token&&masterSession?.refresh_token){try{await supabaseClient.auth.setSession({access_token:masterSession.access_token,refresh_token:masterSession.refresh_token})}catch(e){}}return;}
  const newUserId=data?.user?.id;
  if(!newUserId){
    flash("Kunde angelegt, aber ohne User-ID (E-Mail-Best√§tigung pr√ºfen)");
    if(masterSession?.access_token&&masterSession?.refresh_token){try{await supabaseClient.auth.setSession({access_token:masterSession.access_token,refresh_token:masterSession.refresh_token})}catch(e){}}
    return;
  }
  const trialEndDate=new Date();trialEndDate.setDate(trialEndDate.getDate()+30);const profilePayload={id:newUserId,email,first_name:firstName||null,last_name:lastName||null,plan,trial_end:trialEndDate.toISOString(),updated_at:new Date().toISOString()};
  const statePayload={user_id:newUserId,debts:[],budget_items:[],contracts:[],budget_month:new Date().toISOString().slice(0,7),updated_at:new Date().toISOString()};
  const [{error:pErr},{error:sErr}]=await Promise.all([
    supabaseClient.from("user_profiles").upsert(profilePayload),
    supabaseClient.from("app_state").upsert(statePayload)
  ]);
  if(masterSession?.access_token&&masterSession?.refresh_token){
    try{await supabaseClient.auth.setSession({access_token:masterSession.access_token,refresh_token:masterSession.refresh_token})}catch(e){}
  }
  if(pErr||sErr){flash(`Sync fehlgeschlagen: ${pErr?.message||sErr?.message||"Fehler"}`);return;}
  ["mcFirst","mcLast","mcEmail","mcPass","mcPlan"].forEach(id=>{const el=document.getElementById(id);if(el)el.value=id==="mcPlan"?"Basis":"";});
  await loadMasterData();
  renderMasterView();
  flash("Kunde in Supabase angelegt und synchronisiert ‚úì");
}
async function masterApplyPlanPreset(id,plan){
  const input=document.getElementById(`muPlan-${id}`);
  if(input)input.value=plan;
  await masterSaveUser(id);
}
function rMasterUsersPanel(st){
  const q=(masterState.query||"").trim().toLowerCase();
  const filtered=masterState.users.filter(u=>!q||`${u.first_name||""} ${u.last_name||""} ${u.email||""} ${u.plan||""}`.toLowerCase().includes(q));
  const selected=masterState.users.find(x=>x.id===masterState.selectedUserId)||null;
  const selectedMetric=selected?(st.metrics.find(x=>x.user.id===selected.id)||masterUserMetrics(selected,masterStateMap())):null;

  const planOptions=["Basis","Pro","Business","Enterprise"].map(p=>`<option value="${p}">${p}</option>`).join("");

  const usersList=filtered.map(u=>{
    const isSelected=masterState.selectedUserId===u.id;
    const isBlocked=!!(u.is_blocked);
    const name=([u.first_name||"",u.last_name||""].join(" ").trim()||u.email||"Nutzer");
    return `<div onclick="masterState.selectedUserId='${u.id}';renderMasterView()" style="cursor:pointer;padding:10px 12px;border-radius:10px;border:1px solid ${isSelected?'var(--ba)':'var(--b)'};background:${isSelected?'var(--emG2)':'transparent'};margin-bottom:6px;display:flex;align-items:center;gap:10px;transition:all 0.15s">
      <div style="width:34px;height:34px;border-radius:10px;background:${isBlocked?'var(--coG)':'linear-gradient(135deg,var(--emD),var(--em))'};display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:${isBlocked?'var(--co)':'#fff'};flex-shrink:0">${isBlocked?'üîí':name.slice(0,1).toUpperCase()}</div>
      <div style="flex:1;min-width:0">
        <p style="font-size:13px;font-weight:700;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:${isBlocked?'var(--ts)':'var(--t)'}">${mEsc(name)}${isBlocked?' <span style="font-size:10px;color:var(--co)">[GESPERRT]</span>':''}</p>
        <p style="font-size:11px;color:var(--tm);margin:2px 0 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${mEsc(u.email||"-")} ¬∑ <span style="color:var(--sk)">${mEsc(u.plan||"Basis")}</span></p>
      </div>
      ${isSelected?'<span style="color:var(--em);font-size:16px">‚Ä∫</span>':''}
    </div>`;
  }).join("")||`<p style="font-size:13px;color:var(--tm);padding:16px 0">Keine Nutzer gefunden.</p>`;

  let manageCard=`<div class="master-card" style="text-align:center;padding:32px"><p style="font-size:24px;margin:0 0 8px">üëà</p><p style="font-size:13px;color:var(--tm)">Kunden links ausw√§hlen</p></div>`;
  if(selected){
    const isBlocked=!!(selected.is_blocked);
    const isDeleteConfirm=masterState.deleteConfirm===selected.id;
    manageCard=`<div class="master-card">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;padding-bottom:16px;border-bottom:1px solid var(--b)">
        <div style="width:46px;height:46px;border-radius:14px;background:${isBlocked?'var(--coG)':'linear-gradient(135deg,var(--emD),var(--em))'};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:${isBlocked?'var(--co)':'#fff'};flex-shrink:0">${isBlocked?'üîí':mEsc(([selected.first_name||"",selected.last_name||""].join(" ").trim()||selected.email||"?").slice(0,1).toUpperCase())}</div>
        <div style="flex:1">
          <h3 style="font-size:16px;font-weight:800;margin:0">${mEsc(([selected.first_name||"",selected.last_name||""].join(" ").trim()||selected.email||"Nutzer"))}</h3>
          <p style="font-size:12px;color:var(--tm);margin:2px 0 0">${mEsc(selected.email||"-")}</p>
        </div>
        ${isBlocked?'<span class="badge" style="color:var(--co);background:var(--coG)">üîí GESPERRT</span>':'<span class="badge" style="color:var(--em);background:var(--emG)">‚óè Aktiv</span>'}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:18px">
        <div style="background:var(--bgE);border-radius:10px;padding:10px;border:1px solid var(--b)"><p style="font-size:11px;color:var(--tm);margin:0">Einnahmen</p><p style="font-size:18px;font-weight:800;margin:4px 0 0;color:var(--em)">${fmt(selectedMetric?.income||0)}</p></div>
        <div style="background:var(--bgE);border-radius:10px;padding:10px;border:1px solid var(--b)"><p style="font-size:11px;color:var(--tm);margin:0">Ausgaben</p><p style="font-size:18px;font-weight:800;margin:4px 0 0;color:var(--co)">${fmt(selectedMetric?.expense||0)}</p></div>
        <div style="background:var(--bgE);border-radius:10px;padding:10px;border:1px solid var(--b)"><p style="font-size:11px;color:var(--tm);margin:0">Offen</p><p style="font-size:18px;font-weight:800;margin:4px 0 0;color:var(--am)">${fmt(selectedMetric?.debtOpen||0)}</p></div>
      </div>

      <p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.6px;margin:0 0 10px">Pers√∂nliche Daten</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div class="field" style="margin-bottom:0"><label>Vorname</label><div class="input-wrap"><input id="muFirst-${selected.id}" value="${mEsc(selected.first_name||"")}"></div></div>
        <div class="field" style="margin-bottom:0"><label>Nachname</label><div class="input-wrap"><input id="muLast-${selected.id}" value="${mEsc(selected.last_name||"")}"></div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 120px 1fr;gap:10px;margin-bottom:12px">
        <div class="field" style="margin-bottom:0"><label>Stra√üe</label><div class="input-wrap"><input id="muStreet-${selected.id}" value="${mEsc(selected.address_street||"")}"></div></div>
        <div class="field" style="margin-bottom:0"><label>PLZ</label><div class="input-wrap"><input id="muZip-${selected.id}" value="${mEsc(selected.address_zip||"")}"></div></div>
        <div class="field" style="margin-bottom:0"><label>Ort</label><div class="input-wrap"><input id="muCity-${selected.id}" value="${mEsc(selected.address_city||"")}"></div></div>
      </div>
      <div class="field" style="margin-bottom:12px"><label>Telefon</label><div class="input-wrap"><input id="muPhone-${selected.id}" value="${mEsc(selected.phone||"")}"></div></div><div class="field" style="margin-bottom:12px"><label>Testphase bis (trial_end)</label><div class="input-wrap"><input id="muTrial-${selected.id}" type="date" value="${selected.trial_end?new Date(selected.trial_end).toISOString().split('T')[0]:''}"></div></div>

      <p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.6px;margin:12px 0 10px;padding-top:12px;border-top:1px solid var(--b)">Abo-Plan</p>
      <div class="field" style="margin-bottom:8px"><div class="input-wrap" style="padding:0 14px">
        <select id="muPlan-${selected.id}" style="appearance:none;-webkit-appearance:none;border:none;background:transparent;color:var(--t);padding:13px 28px 13px 0;font-size:15px;width:100%;outline:none;cursor:pointer">
          ${["Basic","Pro"].map(p=>`<option value="${p}" ${(selected.plan||"Basic")===p?"selected":""}>${p}</option>`).join("")}
        </select>
        <span style="color:var(--tm);pointer-events:none;font-size:12px">‚ñæ</span>
      </div></div>
      <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">
        ${["Basic","Pro"].map(p=>`<button class="chip ${(selected.plan||"Basic")===p?"active":""}" onclick="document.getElementById('muPlan-${selected.id}').value='${p}';renderMasterView()" style="font-size:11px;padding:5px 12px">${p}</button>`).join("")}
      </div>

      <p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.6px;margin:0 0 10px;padding-top:12px;border-top:1px solid var(--b)">Admin-Notiz (intern)</p>
      <div class="field" style="margin-bottom:16px"><div class="input-wrap"><input id="muNote-${selected.id}" value="${mEsc(selected.admin_note||"")}" placeholder="Interne Notizen f√ºr diesen Nutzer..."></div></div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
        <button class="btn btn-primary btn-sm" onclick="masterSaveUser('${selected.id}')">üíæ √Ñnderungen speichern</button>
        <button class="btn btn-outline btn-sm" onclick="masterOpenUserSurface('${selected.id}')">üëÅ Oberfl√§che √∂ffnen</button>
        <button class="btn btn-outline btn-sm" onclick="masterSyncUserProfileToState('${selected.id}')">üîÑ Profil-Sync</button>
        <button class="btn btn-outline btn-sm" onclick="masterResetUserState('${selected.id}')">üóë Daten zur√ºcksetzen</button>
      </div>

      <div style="border-top:1px solid var(--b);padding-top:14px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-sm" style="${isBlocked?'background:var(--emG);color:var(--em);border:1px solid var(--ba)':'background:var(--amG);color:var(--am);border:1px solid rgba(251,191,36,0.3)'}" onclick="masterBlockUser('${selected.id}')">${isBlocked?'üîì Nutzer entsperren':'üîí Nutzer sperren'}</button>
        <button class="btn btn-danger btn-sm" onclick="masterDeleteUser('${selected.id}')" style="${isDeleteConfirm?'background:var(--co);color:#fff;':''}">‚ö†Ô∏è ${isDeleteConfirm?'BEST√ÑTIGEN ‚Äì Endg√ºltig l√∂schen':'Nutzer l√∂schen'}</button>
        ${isDeleteConfirm?`<button class="btn btn-outline btn-sm" onclick="masterState.deleteConfirm=null;renderMasterView()">Abbrechen</button>`:''}
      </div>
    </div>`;
  }

  return `<div style="display:grid;grid-template-columns:300px 1fr;gap:14px;align-items:start">
    <div>
      <div class="master-card" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="font-size:15px;font-weight:700;margin:0">Kunden (${masterState.users.length})</h3>
          <button class="btn btn-ghost btn-sm" onclick="masterState.tab='create';renderMasterView()">Ôºã Neu</button>
        </div>
        <div class="input-wrap" style="margin-bottom:12px"><input placeholder="Suchen..." value="${mEsc(masterState.query)}" oninput="masterState.query=this.value;renderMasterView()" style="flex:1;border:none;outline:none;padding:10px 0;font-size:14px;color:var(--t);background:transparent"></div>
        <div style="max-height:60vh;overflow-y:auto;padding-right:2px">${usersList}</div>
      </div>
    </div>
    <div>${manageCard}</div>
  </div>`;
}
async function masterSaveUser(id){
  const get=(k)=>document.getElementById(`${k}-${id}`)?.value?.trim()||"";
  const first=get("muFirst"),last=get("muLast"),plan=get("muPlan"),street=get("muStreet"),zip=get("muZip"),city=get("muCity"),phone=get("muPhone");
  const adminNote=document.getElementById(`muNote-${id}`)?.value?.trim()||"";
  const trialRaw=document.getElementById(`muTrial-${id}`)?.value||"";
  const trialEnd=trialRaw?new Date(trialRaw).toISOString():null;
  if(!supabaseClient)return;
  const {error}=await supabaseClient.from("user_profiles").upsert({id,first_name:first,last_name:last,plan:plan||"Basic",trial_end:trialEnd,address_street:street,address_zip:zip,address_city:city,phone,admin_note:adminNote||null,updated_at:new Date().toISOString()});
  if(error){flash("Speichern fehlgeschlagen");return;}
  flash("Nutzerdaten gespeichert ‚úì");
  await loadMasterData();
  renderMasterView();
}
async function masterBlockUser(id){
  if(!supabaseClient)return;
  const u=masterState.users.find(x=>x.id===id);
  const isBlocked=!!(u?.is_blocked);
  const action=isBlocked?"entsperren":"sperren";
  if(!await confirmModal.show(`Nutzer wirklich ${action}?`,{title:"Aktion best√§tigen",okText:"Best√§tigen",okColor:"#f59e0b",icon:"‚ö†Ô∏è"}))return;
  const {error}=await supabaseClient.from("user_profiles").update({is_blocked:!isBlocked,updated_at:new Date().toISOString()}).eq("id",id);
  if(error){flash("Aktion fehlgeschlagen: "+error.message);return;}
  flash(isBlocked?"Nutzer entsperrt ‚úì":"Nutzer gesperrt üîí");
  await loadMasterData();
  renderMasterView();
}
async function masterDeleteUser(id){
  if(masterState.deleteConfirm!==id){
    masterState.deleteConfirm=id;
    renderMasterView();
    flash("‚ö†Ô∏è Nochmals klicken zum endg√ºltigen L√∂schen");
    return;
  }
  if(!supabaseClient)return;
  masterState.deleteConfirm=null;
  // Delete app_state and profile (Auth user requires service key, we delete profile data)
  await Promise.all([
    supabaseClient.from("app_state").delete().eq("user_id",id),
    supabaseClient.from("user_profiles").delete().eq("id",id)
  ]);
  if(masterState.selectedUserId===id)masterState.selectedUserId=null;
  flash("Nutzerdaten gel√∂scht ‚úì");
  await loadMasterData();
  renderMasterView();
}
async function masterSetUserPlan(id,plan){
  const u=masterState.users.find(x=>x.id===id);
  if(!u)return;
  u.plan=plan||"Basis";
  await masterSaveUser(id);
}
async function masterOpenUserSurface(id){
  if(!supabaseClient)return;
  const profile=masterState.users.find(u=>u.id===id);
  const state=masterState.states.find(s=>s.user_id===id);
  if(!profile||!state){flash("Keine Daten f√ºr Nutzer");return;}
  if(!masterState.impersonating){
    masterState.original={user:JSON.parse(JSON.stringify(user)),debts:JSON.parse(JSON.stringify(debts)),budgetItems:JSON.parse(JSON.stringify(budgetItems)),contracts:JSON.parse(JSON.stringify(contracts)),month:currentBudgetMonth};
  }
  masterState.impersonating=true;
  user.loggedIn=true;user.email=profile.email||"";user.firstName=profile.first_name||"";user.lastName=profile.last_name||"";user.name=[user.firstName,user.lastName].join(" ").trim()||profile.email||"Nutzer";user.plan=profile.plan||"Basis";user.addressStreet=profile.address_street||"";user.addressZip=profile.address_zip||"";user.addressCity=profile.address_city||"";user.phone=profile.phone||"";
  debts=Array.isArray(state.debts)?state.debts:[];
  budgetItems=Array.isArray(state.budget_items)?state.budget_items:[];
  contracts=Array.isArray(state.contracts)?state.contracts:[];
  normalizeDebtStatuses();
  if(isMasterMode){
    const mr=document.getElementById("masterRoot");if(mr)mr.style.display="none";
    const ly=document.querySelector(".layout");if(ly)ly.style.display="flex";
    const mn=document.getElementById("mobileNav");if(mn)mn.style.display="";
  }
  currentPage="dashboard";
  renderNav();
  renderPage();
  flash(`Kundenoberfl√§che ge√∂ffnet: ${user.name}`);
}
function masterStopImpersonation(){
  if(!masterState.impersonating||!masterState.original)return;
  user=masterState.original.user;
  debts=masterState.original.debts;
  budgetItems=masterState.original.budgetItems;
  contracts=masterState.original.contracts;
  currentBudgetMonth=masterState.original.month;
  masterState.impersonating=false;
  masterState.original=null;
  if(isMasterMode){
    const ly=document.querySelector(".layout");if(ly)ly.style.display="none";
    const mn=document.getElementById("mobileNav");if(mn)mn.style.display="none";
    const mr=document.getElementById("masterRoot");if(mr)mr.style.display="block";
    renderMasterStandalone();
  }else{
    currentPage="master";
    renderNav();
    renderPage();
  }
  flash("Zur√ºck im Master-Panel");
}
function rMasterCreatePanel(){
  return `<div class="master-card" style="max-width:560px">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
      <button onclick="masterState.tab='users';renderMasterView()" style="background:none;border:none;color:var(--tm);cursor:pointer;font-size:22px;line-height:1">‚Üê</button>
      <h3 style="font-size:18px;font-weight:800;margin:0">Neuen Kunden anlegen</h3>
    </div>
    <p style="font-size:12px;color:var(--tm);margin:0 0 16px;line-height:1.6">Legt einen Auth-Nutzer an und synchronisiert Profil + App-State direkt in Supabase.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="field"><label>Vorname</label><div class="input-wrap"><input id="mcFirst" placeholder="Max"></div></div>
      <div class="field"><label>Nachname</label><div class="input-wrap"><input id="mcLast" placeholder="Mustermann"></div></div>
    </div>
    <div class="field"><label>E-Mail *</label><div class="input-wrap"><input id="mcEmail" type="email" placeholder="kunde@domain.de"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="field"><label>Passwort * (min. 6 Zeichen)</label><div class="input-wrap"><input id="mcPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div></div>
      <div class="field"><label>Startplan</label>
        <div class="input-wrap" style="padding:0 14px">
          <select id="mcPlan" style="appearance:none;-webkit-appearance:none;border:none;background:transparent;color:var(--t);padding:13px 28px 13px 0;font-size:15px;width:100%;outline:none;cursor:pointer">
            <option value="Basic">Basic (kostenlos)</option>
            <option value="Pro">Pro (4,99 ‚Ç¨/Monat)</option>
          </select>
          <span style="color:var(--tm);pointer-events:none;font-size:12px">‚ñæ</span>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:6px">
      <button class="btn btn-outline" style="flex:1" onclick="masterState.tab='users';renderMasterView()">Abbrechen</button>
      <button class="btn btn-primary" style="flex:1" onclick="masterCreateCustomer()">‚úì Kundenkonto anlegen</button>
    </div>
  </div>`;
}

function rMasterPanel(){
  if(!masterState.loggedIn){
    return `<div class="master-login"><div class="master-card" style="background:linear-gradient(160deg,var(--bgS),var(--bgC))">
      <p style="font-size:11px;font-weight:700;letter-spacing:.8px;color:#86E8C0;margin:0 0 6px">RATENOVA ADMIN</p>
      <h1 style="font-size:26px;font-weight:800;margin:0 0 6px">Master Login</h1>
      <p style="font-size:13px;color:var(--tm);margin:0 0 20px">Separater Zugang f√ºr interne Verwaltung.</p>
      <div class="field"><label>Benutzername</label><div class="input-wrap"><input id="mUser" placeholder="master" onkeydown="if(event.key==='Enter')masterLogin()"></div></div>
      <div class="field"><label>Passwort</label><div class="input-wrap"><input id="mPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')masterLogin()"></div></div>
      ${masterState.error?`<p style="font-size:12px;color:var(--co);margin:0 0 12px;padding:10px;background:var(--coG);border-radius:8px;border:1px solid rgba(248,113,113,0.3)">${masterState.error}</p>`:""}
      <div style="display:flex;gap:10px"><button class="btn btn-outline" style="flex:1" onclick="exitMasterPanel()">‚Üê Zur App</button><button class="btn btn-primary" style="flex:1" onclick="masterLogin()">Einloggen</button></div>
    </div></div>`;
  }

  const st=masterStats();
  const tab=masterState.tab;

  const navItems=[
    {id:"stats",icon:"‚óâ",label:"√úbersicht"},
    {id:"users",icon:"üë•",label:"Kunden"},
    {id:"create",icon:"Ôºã",label:"Neu anlegen"},
    {id:"finance",icon:"‚Ç¨",label:"Finanzen"},
    {id:"plans",icon:"‚≠ê",label:"Abo-Pl√§ne"},
    {id:"system",icon:"‚öô",label:"System"},
  ];

  const sidebar=`<div style="width:200px;flex-shrink:0;background:var(--bgS);border-radius:16px;border:1px solid var(--b);padding:16px 0;display:flex;flex-direction:column;min-height:70vh">
    <div style="padding:0 16px 16px;border-bottom:1px solid var(--b);margin-bottom:8px">
      <p style="font-size:10px;font-weight:700;letter-spacing:.8px;color:#86E8C0;margin:0 0 2px">ADMIN PANEL</p>
      <p style="font-size:13px;font-weight:800;margin:0;color:var(--t)">Master</p>
    </div>
    ${navItems.map(n=>`<button onclick="masterState.tab='${n.id}';renderMasterView()" style="display:flex;align-items:center;gap:9px;width:100%;padding:10px 16px;border:none;border-right:2px solid ${tab===n.id?'var(--em)':'transparent'};background:${tab===n.id?'var(--emG2)':'transparent'};color:${tab===n.id?'var(--em)':'var(--tm)'};font-size:13px;font-weight:${tab===n.id?'700':'400'};cursor:pointer;text-align:left;transition:all 0.15s">
      <span style="font-size:15px;width:20px;text-align:center">${n.icon}</span>${n.label}
    </button>`).join("")}
    <div style="flex:1"></div>
    <div style="padding:12px 16px;border-top:1px solid var(--b);margin-top:8px;display:flex;flex-direction:column;gap:6px">
      ${masterState.impersonating?`<button class="btn btn-ghost btn-sm btn-full" onclick="masterStopImpersonation()">‚Üê Ansicht schlie√üen</button>`:""}
      <button class="btn btn-outline btn-sm btn-full" onclick="loadMasterData().then(()=>renderMasterView())">üîÑ Aktualisieren</button>
      <button class="btn btn-danger btn-sm btn-full" onclick="masterLogout()">Logout</button>
    </div>
  </div>`;

  const statsView=`<div>
    <h2 style="font-size:20px;font-weight:800;margin:0 0 16px">System√ºbersicht</h2>
    <div class="master-kpis" style="margin-bottom:12px">
      <div class="master-card"><p style="font-size:11px;color:var(--tm);margin:0">Kunden gesamt</p><p style="font-size:30px;font-weight:800;margin:6px 0 0">${st.total}</p></div>
      <div class="master-card"><p style="font-size:11px;color:var(--tm);margin:0">Aktive Datens√§tze</p><p style="font-size:30px;font-weight:800;margin:6px 0 0">${st.withState}</p></div>
      <div class="master-card"><p style="font-size:11px;color:var(--tm);margin:0">Einnahmen gesamt</p><p style="font-size:30px;font-weight:800;margin:6px 0 0;color:var(--em)">${fmt(st.totalIncome)}</p></div>
      <div class="master-card"><p style="font-size:11px;color:var(--tm);margin:0">Ausgaben gesamt</p><p style="font-size:30px;font-weight:800;margin:6px 0 0;color:var(--co)">${fmt(st.totalExpense)}</p></div>
    </div>
    <div class="master-kpis">
      <div class="master-card"><p style="font-size:11px;color:var(--tm);margin:0">Verkaufs-Einnahmen</p><p style="font-size:30px;font-weight:800;margin:6px 0 0;color:#7DE6BE">${fmt(st.totalSales)}</p></div>
      <div class="master-card"><p style="font-size:11px;color:var(--tm);margin:0">Offene Verbindlichkeiten</p><p style="font-size:30px;font-weight:800;margin:6px 0 0;color:var(--am)">${fmt(st.debtExposure)}</p></div>
      <div class="master-card"><p style="font-size:11px;color:var(--tm);margin:0">Monatl. Verpflichtung</p><p style="font-size:30px;font-weight:800;margin:6px 0 0">${fmt(st.monthlyObligation)}</p></div>
      <div class="master-card"><p style="font-size:11px;color:var(--tm);margin:0">Vertr√§ge / Schulden</p><p style="font-size:30px;font-weight:800;margin:6px 0 0">${st.totalContracts} / ${st.totalDebts}</p></div>
    </div>
    <div class="master-card" style="margin-top:12px">
      <h3 style="font-size:15px;font-weight:700;margin:0 0 12px">Alle Kunden auf einen Blick</h3>
      <div style="overflow:auto"><table style="width:100%;border-collapse:collapse;min-width:700px">
        <thead><tr>
          <th style="text-align:left;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Name / E-Mail</th>
          <th style="text-align:left;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Plan</th>
          <th style="text-align:right;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Einnahmen</th>
          <th style="text-align:right;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Ausgaben</th>
          <th style="text-align:right;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Offen</th>
          <th style="text-align:center;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Status</th>
        </tr></thead>
        <tbody>${st.metrics.map(m=>{const isBlocked=!!(m.user.is_blocked);return`<tr style="opacity:${isBlocked?'0.6':'1'}">
          <td style="padding:8px 10px;border-bottom:1px solid var(--b)">
            <p style="font-size:13px;font-weight:700;margin:0">${mEsc(([m.user.first_name||"",m.user.last_name||""].join(" ").trim()||m.user.email||"Nutzer"))}</p>
            <p style="font-size:11px;color:var(--tm);margin:0">${mEsc(m.user.email||"-")}</p>
          </td>
          <td style="padding:8px 10px;border-bottom:1px solid var(--b)"><span style="font-size:12px;font-weight:700;color:var(--sk)">${mEsc(m.user.plan||"Basic")}${m.user.trial_end&&new Date(m.user.trial_end)>new Date()?'<span style="color:var(--am);font-size:9px;margin-left:4px">TRIAL</span>':'' }</span></td>
          <td style="padding:8px 10px;border-bottom:1px solid var(--b);text-align:right;color:var(--em);font-weight:700">${fmt(m.income)}</td>
          <td style="padding:8px 10px;border-bottom:1px solid var(--b);text-align:right;color:var(--co);font-weight:700">${fmt(m.expense)}</td>
          <td style="padding:8px 10px;border-bottom:1px solid var(--b);text-align:right;color:var(--am);font-weight:700">${fmt(m.debtOpen)}</td>
          <td style="padding:8px 10px;border-bottom:1px solid var(--b);text-align:center">
            ${isBlocked?'<span style="font-size:11px;font-weight:700;color:var(--co);background:var(--coG);padding:3px 8px;border-radius:20px">üîí Gesperrt</span>':'<span style="font-size:11px;font-weight:700;color:var(--em);background:var(--emG);padding:3px 8px;border-radius:20px">‚óè Aktiv</span>'}
          </td>
        </tr>`}).join("")||`<tr><td colspan="6" style="padding:20px;text-align:center;color:var(--tm)">Keine Kunden.</td></tr>`}</tbody>
      </table></div>
    </div>
  </div>`;

  const q=(masterState.query||"").trim().toLowerCase();
  const filtered=st.metrics.filter(m=>!q||`${m.user.first_name||""} ${m.user.last_name||""} ${m.user.email||""} ${m.user.plan||""}`.toLowerCase().includes(q));
  const financeView=`<div>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px">
      <h2 style="font-size:20px;font-weight:800;margin:0">Finanz√ºbersicht</h2>
      <div class="input-wrap" style="max-width:280px"><input placeholder="Suche Kunde / E-Mail / Plan" value="${mEsc(masterState.query)}" oninput="masterState.query=this.value;renderMasterView()" style="flex:1;border:none;outline:none;padding:10px 0;font-size:14px;color:var(--t);background:transparent"></div>
    </div>
    <div class="master-card"><div style="overflow:auto"><table style="width:100%;border-collapse:collapse;min-width:900px">
      <thead><tr>
        <th style="text-align:left;padding:10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Kunde</th>
        <th style="text-align:right;padding:10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Einnahmen</th>
        <th style="text-align:right;padding:10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Verk√§ufe</th>
        <th style="text-align:right;padding:10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Ausgaben</th>
        <th style="text-align:right;padding:10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Saldo</th>
        <th style="text-align:right;padding:10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Offen</th>
        <th style="text-align:right;padding:10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Monatl. Last</th>
        <th style="text-align:right;padding:10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Vertr√§ge/Jahr</th>
      </tr></thead>
      <tbody>${filtered.map(m=>`<tr>
        <td style="padding:10px;border-bottom:1px solid var(--b)">
          <div style="font-size:13px;font-weight:700">${mEsc(([m.user.first_name||"",m.user.last_name||""].join(" ").trim()||m.user.email||"Nutzer"))}</div>
          <div style="font-size:11px;color:var(--tm)">${mEsc(m.user.email||"-")} ¬∑ <span style="color:var(--sk)">${mEsc(m.user.plan||"Basis")}</span></div>
        </td>
        <td style="padding:10px;border-bottom:1px solid var(--b);text-align:right;color:var(--em);font-weight:700">${fmt(m.income)}</td>
        <td style="padding:10px;border-bottom:1px solid var(--b);text-align:right;color:#7DE6BE;font-weight:700">${fmt(m.sales)}</td>
        <td style="padding:10px;border-bottom:1px solid var(--b);text-align:right;color:var(--co);font-weight:700">${fmt(m.expense)}</td>
        <td style="padding:10px;border-bottom:1px solid var(--b);text-align:right;font-weight:700;color:${m.balance>=0?'var(--em)':'var(--co)'}">${fmt(m.balance)}</td>
        <td style="padding:10px;border-bottom:1px solid var(--b);text-align:right">${fmt(m.debtOpen)}</td>
        <td style="padding:10px;border-bottom:1px solid var(--b);text-align:right">${fmt(m.debtMonthly+m.contractMonthly)}</td>
        <td style="padding:10px;border-bottom:1px solid var(--b);text-align:right">${fmt(m.contractYearly)}</td>
      </tr>`).join("")||`<tr><td colspan="8" style="padding:18px;text-align:center;color:var(--tm)">Keine passenden Kunden.</td></tr>`}</tbody>
    </table></div></div>
  </div>`;

  const usersView=rMasterUsersPanel(st);

  const plansMap={};masterState.users.forEach(u=>{const p=u.plan||"Basis";plansMap[p]=(plansMap[p]||0)+1;});
  const plansView=`<div>
    <h2 style="font-size:20px;font-weight:800;margin:0 0 16px">Abo-Plan Verwaltung</h2>
    <div style="display:grid;grid-template-columns:220px 1fr;gap:14px;align-items:start">
      <div class="master-card">
        <h3 style="font-size:14px;font-weight:700;margin:0 0 12px">Verteilung</h3>
        ${Object.keys(plansMap).length?Object.entries(plansMap).map(([k,v])=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--b)">
          <span style="font-size:13px;color:var(--sk);font-weight:600">${mEsc(k)}</span>
          <strong style="font-size:15px">${v}</strong>
        </div>`).join(""):`<p style="font-size:13px;color:var(--tm)">Keine Daten.</p>`}
      </div>
      <div class="master-card">
        <h3 style="font-size:14px;font-weight:700;margin:0 0 12px">Plan pro Nutzer √§ndern</h3>
        <div style="overflow:auto"><table style="width:100%;border-collapse:collapse;min-width:500px">
          <thead><tr>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Name</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">E-Mail</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Plan</th>
            <th style="text-align:right;padding:8px 10px;border-bottom:1px solid var(--b);font-size:11px;color:var(--ts)">Aktion</th>
          </tr></thead>
          <tbody>${masterState.users.map(u=>`<tr>
            <td style="padding:8px 10px;border-bottom:1px solid var(--b);font-size:13px;font-weight:600">${mEsc(([u.first_name||"",u.last_name||""].join(" ").trim()||"Nutzer"))}</td>
            <td style="padding:8px 10px;border-bottom:1px solid var(--b);font-size:12px;color:var(--tm)">${mEsc(u.email||"-")}</td>
            <td style="padding:8px 10px;border-bottom:1px solid var(--b);width:180px">
              <div class="input-wrap" style="padding:0 12px">
                <select id="muPlan-${u.id}" style="appearance:none;-webkit-appearance:none;border:none;background:transparent;color:var(--t);padding:8px 24px 8px 0;font-size:13px;width:100%;outline:none;cursor:pointer">
                  ${["Basic","Pro"].map(p=>`<option value="${p}" ${(u.plan||"Basic")===p?"selected":""}>${p}</option>`).join("")}
                </select>
                <span style="color:var(--tm);pointer-events:none;font-size:11px">‚ñæ</span>
              </div>
            </td>
            <td style="padding:8px 10px;border-bottom:1px solid var(--b);text-align:right"><button class="btn btn-primary btn-sm" onclick="masterSaveUser('${u.id}')">Speichern</button></td>
          </tr>`).join("")||`<tr><td colspan="4" style="padding:16px;text-align:center;color:var(--tm)">Keine Nutzer.</td></tr>`}</tbody>
        </table></div>
      </div>
    </div>
  </div>`;

  const systemView=`<div>
    <h2 style="font-size:20px;font-weight:800;margin:0 0 16px">System</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="master-card">
        <h3 style="font-size:14px;font-weight:700;margin:0 0 12px">Systemstatus</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--bgE);border:1px solid var(--b)">
            <span style="font-size:13px;color:var(--tm)">Supabase Client</span>
            <span style="font-size:14px;font-weight:700;color:${supabaseClient?'var(--em)':'var(--co)'}">${supabaseClient?'‚úì Verbunden':'‚úï Fehler'}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--bgE);border:1px solid var(--b)">
            <span style="font-size:13px;color:var(--tm)">Master Session</span>
            <span style="font-size:14px;font-weight:700;color:${masterState.loggedIn?'var(--em)':'var(--co)'}">${masterState.loggedIn?'‚úì Aktiv':'‚úï Inaktiv'}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--bgE);border:1px solid var(--b)">
            <span style="font-size:13px;color:var(--tm)">Datens√§tze geladen</span>
            <span style="font-size:14px;font-weight:700">${masterState.states.length}</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--bgE);border:1px solid var(--b)">
            <span style="font-size:13px;color:var(--tm)">Letztes Update</span>
            <span style="font-size:13px;font-weight:600">${new Date().toLocaleString("de-DE")}</span>
          </div>
        </div>
      </div>
      <div class="master-card">
        <h3 style="font-size:14px;font-weight:700;margin:0 0 12px">Admin Aktionen</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-outline btn-sm btn-full" onclick="loadMasterData().then(()=>renderMasterView())">üîÑ Daten neu laden</button>
          <button class="btn btn-outline btn-sm btn-full" onclick="masterState.tab='finance';renderMasterView()">üí∞ Zu Finanzen</button>
          <button class="btn btn-outline btn-sm btn-full" onclick="masterState.tab='users';renderMasterView()">üë• Zu Kunden</button>
          <button class="btn btn-ghost btn-sm btn-full" onclick="openVerificationEmailPreview()">üìß E-Mail Vorlage anzeigen</button>
          <button class="btn btn-danger btn-sm btn-full" style="margin-top:8px" onclick="masterLogout()">Logout</button>
        </div>
      </div>
    </div>
  </div>`;

  const contentMap={stats:statsView,users:usersView,create:rMasterCreatePanel(),finance:financeView,plans:plansView,system:systemView};
  const content=contentMap[tab]||usersView;

  return `<div style="display:flex;gap:16px;align-items:flex-start">
    ${sidebar}
    <div style="flex:1;min-width:0">
      ${masterState.error?`<div class="master-card" style="border-color:rgba(248,113,113,0.35);margin-bottom:12px;padding:12px 16px"><p style="font-size:13px;color:var(--co);margin:0">‚ö†Ô∏è ${masterState.error}</p></div>`:""}
      ${content}
    </div>
  </div>`;
}
function renderMasterStandalone(){const root=document.getElementById("masterRoot");if(!root)return;root.innerHTML=`<div class="master-shell">${rMasterPanel()}</div>`}




function showAgbModal(){
  const agbContent=rAgbPage();
  document.getElementById("modalContainer").innerHTML=`<div class="overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()" style="max-width:700px;max-height:85vh;overflow:auto">
    <div class="modal-head" style="position:sticky;top:0;background:var(--bgC);z-index:10;padding-bottom:12px">
      <h3>AGB</h3>
      <button class="modal-close" onclick="closeModal()">&#x2715;</button>
    </div>
    ${agbContent}
  </div></div>`;
}

function rAgbPage(){
  return `<div style="max-width:760px">
    <div style="margin-bottom:28px">
      <h1 style="font-size:28px;font-weight:800;margin:0 0 6px">Allgemeine Gesch√§ftsbedingungen</h1>
      <p style="font-size:13px;color:var(--tm);margin:0">Stand: 20. Februar 2026 &middot; Ratenova</p>
    </div>
    ${[
      ["1. Geltungsbereich","Diese AGB gelten f√ºr die Nutzung der webbasierten Plattform Ratenova (nachfolgend: Dienst). Mit der Registrierung akzeptiert der Nutzer diese AGB."],
      ["2. Leistungsbeschreibung","Ratenova ist eine digitale Anwendung zur Verwaltung von Verbindlichkeiten, Ein- und Ausgaben sowie Vertr√§gen f√ºr Privatpersonen. Der Anbieter stellt den Dienst als Software-as-a-Service bereit und beh√§lt sich vor, den Funktionsumfang jederzeit zu √§ndern."],
      ["3. Nutzerkonto & Registrierung","Die Nutzung erfordert eine Registrierung mit g√ºltiger E-Mail-Adresse. Der Nutzer ist verpflichtet, seine Zugangsdaten vertraulich zu behandeln. Eine Weitergabe des Kontos an Dritte ist nicht gestattet."],
      ["4. Kostenlose Nutzung & Abonnement","Ratenova bietet einen kostenlosen Basic-Plan sowie einen kostenpflichtigen Pro-Plan (4,99 Euro/Monat) an. Nach der Registrierung erh√§lt jeder neue Nutzer eine 30-t√§gige kostenlose Testphase des Pro-Plans. Nach Ablauf wechselt das Konto automatisch in den Basic-Plan, sofern kein Abonnement abgeschlossen wurde. Mit dem Abschluss best√§tigst du, mindestens 18 Jahre alt zu sein."],
      ["5. Zahlung & Abrechnung","Die Zahlungsabwicklung erfolgt √ºber Paddle.com (Paddle Payments Ltd., 15 Scale Space, 58 Wood Lane, London, W12 7RZ, UK). Der Anbieter hat keinen Zugriff auf Zahlungsdaten. Alle Preise verstehen sich inkl. gesetzlicher MwSt."],
      ["6. K√ºndigung & Widerruf","Das Pro-Abonnement kann jederzeit zum Ende des laufenden Abrechnungszeitraums gek√ºndigt werden, √ºber das Paddle-Kundenportal oder per E-Mail. Verbrauchern steht ein gesetzliches Widerrufsrecht von 14 Tagen ab Vertragsschluss zu, sofern der Dienst noch nicht vollst√§ndig in Anspruch genommen wurde."],
      ["7. Datenschutz","Die Erhebung und Verarbeitung personenbezogener Daten erfolgt gem√§ss unserer Datenschutzerkl√§rung unter planavo.de/datenschutz. Daten werden auf Servern von Supabase (EU-Region) gespeichert. Eine Weitergabe an Dritte erfolgt nur zur Vertragserf√ºllung (z.B. Paddle)."],
      ["8. Verf√ºgbarkeit & Haftung","Der Anbieter √ºbernimmt keine Garantie f√ºr ununterbrochene Verf√ºgbarkeit. Die Haftung ist auf grobe Fahrl√§ssigkeit und Vorsatz beschr√§nkt. F√ºr Datenverluste oder mittelbare Sch√§den wird keine Haftung √ºbernommen."],
      ["9. Nutzungspflichten","Der Nutzer verpflichtet sich, den Dienst nur f√ºr legale Zwecke zu nutzen. Bei Verdacht auf Missbrauch beh√§lt sich der Anbieter vor, Konten ohne Vorwarnung zu sperren."],
      ["10. √Ñnderungen der AGB","√Ñnderungen werden dem Nutzer mindestens 14 Tage vor Inkrafttreten per E-Mail mitgeteilt. Bei Nichtbeachtung der Frist gelten die neuen AGB als akzeptiert."],
      ["11. Schlussbestimmungen","Es gilt das Recht der Bundesrepublik Deutschland. Sollten einzelne Bestimmungen unwirksam sein, bleibt die Wirksamkeit der √ºbrigen unber√ºhrt."],
    ].map(([title,text])=>`
      <div class="card" style="margin-bottom:12px;padding:20px 24px">
        <h3 style="font-size:15px;font-weight:700;margin:0 0 10px;color:var(--em)">${title}</h3>
        <p style="font-size:14px;color:var(--ts);margin:0;line-height:1.8">${text}</p>
      </div>
    `).join("")}
    <div class="card" style="padding:20px 24px;border-color:var(--ba);background:var(--emG2)">
      <h3 style="font-size:14px;font-weight:700;margin:0 0 8px">Kontakt</h3>
      <p style="font-size:13px;color:var(--tm);margin:0;line-height:1.8">
        Ratenova<br>
        E-Mail: <a href="mailto:info@ratenova.de" style="color:var(--em)">info@ratenova.de</a><br>
        Web: <a href="https://ratenova.de" target="_blank" style="color:var(--em)">ratenova.de</a>
      </p>
    </div>
    <p style="font-size:11px;color:var(--tf);text-align:center;margin:20px 0 0">
      &copy; ${new Date().getFullYear()} Ratenova &middot;
      <a href="https://planavo.de/datenschutz" target="_blank" style="color:var(--tm)">Datenschutz</a> &middot;
      <a href="https://planavo.de/impressum" target="_blank" style="color:var(--tm)">Impressum</a>
    </p>
  </div>`;
}
function rPricing(){
  const pro=isProPlan();
  const trial=isTrialActive();
  const daysLeft=trialDaysLeft();
  const trialExpired=user.trialEnd&&!trial;
  const trialBanner=trial?`<div style="background:linear-gradient(135deg,var(--amG),rgba(56,189,248,0.1));border:1px solid rgba(251,191,36,0.35);border-radius:16px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px"><span style="font-size:24px">‚è∞</span><div><p style="font-size:14px;font-weight:700;color:var(--am);margin:0">Testphase aktiv ‚Äì noch ${daysLeft} Tage</p><p style="font-size:12px;color:var(--tm);margin:2px 0 0">Du nutzt aktuell alle Pro-Features kostenlos.</p></div></div>`:trialExpired?`<div style="background:var(--coG);border:1px solid rgba(248,113,113,0.3);border-radius:16px;padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:12px"><span style="font-size:24px">‚ö†Ô∏è</span><div><p style="font-size:14px;font-weight:700;color:var(--co);margin:0">Testphase abgelaufen</p><p style="font-size:12px;color:var(--tm);margin:2px 0 0">Upgrade auf Pro um alle Features weiter zu nutzen.</p></div></div>`:"";
  
  const planCard=(name,price,features,highlight,isCurrent)=>`<div style="border-radius:20px;border:${highlight?"2px solid var(--em)":"1px solid var(--b)"};background:${highlight?"linear-gradient(145deg,rgba(22,163,74,0.14),var(--bgC))":"var(--bgC)"};padding:28px;position:relative;${highlight?"box-shadow:0 0 40px rgba(22,163,74,0.24)":""}">
    ${highlight?'<div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--emD),var(--em));color:#fff;padding:4px 16px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap">EMPFOHLEN</div>':""}
    ${isCurrent?'<div style="position:absolute;top:16px;right:16px;background:var(--emG);color:var(--em);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700">‚úì Aktuell</div>':""}
    <p style="font-size:13px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 6px">${name}</p>
    <p style="font-size:40px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:0 0 4px;color:${highlight?"var(--em)":"var(--t)"}">${price}<span style="font-size:14px;font-weight:400;color:var(--tm)">${price==="Kostenlos"?"":"&thinsp;/&thinsp;Monat"}</span></p>
    <p style="font-size:12px;color:var(--tm);margin:0 0 24px">${price==="Kostenlos"?"F√ºr immer gratis":"Monatlich k√ºndbar"}</p>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:28px">${features.map(([f,ok])=>`<div style="display:flex;align-items:center;gap:10px;font-size:13px;color:${ok?"var(--t)":"var(--tf)"}"><span style="font-size:15px;flex-shrink:0">${ok?"‚úÖ":"‚ùå"}</span>${f}</div>`).join("")}</div>
    ${!isCurrent?`<button class="btn btn-full ${highlight?"btn-primary":"btn-outline"}" onclick="openPaddleCheckout()">
      ${highlight?"Jetzt upgraden ‚Üí":"Aktuell nutzen"}
    </button>`:`<div class="btn btn-full btn-ghost" style="pointer-events:none">‚úì Dein aktueller Plan</div>`}
  </div>`;

  const basicFeatures=[
    ["Bis zu 3 Verbindlichkeiten",true],
    ["Dashboard & √úbersicht",true],
    ["Zahlungshistorie",true],
    ["Ein- & Ausgaben (Basis)",true],
    ["Vereinbarungsvorlagen",false],
    ["Vertragsverwaltung",false],
    ["K√ºndigungsassistent",false],
    ["Zeitverlauf & Export",false],
  ];
  const proFeatures=[
    ["Unbegrenzte Verbindlichkeiten",true],
    ["Dashboard & √úbersicht",true],
    ["Zahlungshistorie",true],
    ["Ein- & Ausgaben (vollst√§ndig)",true],
    ["Vereinbarungsvorlagen & Briefe",true],
    ["Vertragsverwaltung",true],
    ["K√ºndigungsassistent",true],
    ["Zeitverlauf & Export",true],
  ];

  const isCurrentlyPro=pro&&!(trial);
  const isCurrentlyBasic=!pro&&!trial;
  const isCurrentlyTrial=trial;

  return `<div style="max-width:820px">
    <div style="margin-bottom:24px">
      <h1 style="font-size:28px;font-weight:800;margin:0 0 6px">Pl√§ne & Preise</h1>
      <p style="font-size:14px;color:var(--tm);margin:0">Einfach, transparent, monatlich k√ºndbar.</p>
    </div>
    ${trialBanner}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:32px">
      ${planCard("Basic","Kostenlos",basicFeatures,false,isCurrentlyBasic)}
      ${planCard("Pro","4,99 ‚Ç¨",proFeatures,true,isCurrentlyPro||isCurrentlyTrial)}
    </div>
    <p style="font-size:12px;color:var(--tm);text-align:center;margin:0 0 16px">Mit dem Kauf stimmst du unseren <a href="https://planavo.de/agb" target="_blank" style="color:var(--em);font-weight:600">Allgemeinen Gesch√§ftsbedingungen</a> zu. Monatlich k√ºndbar.</p>
    <div class="card" style="padding:20px">
      <h3 style="font-size:15px;font-weight:700;margin:0 0 12px">H√§ufige Fragen</h3>
      ${[
        ["Was passiert nach der 30-Tage-Testphase?","Dein Konto wechselt automatisch in den kostenlosen Basic-Plan. Deine Daten bleiben erhalten, aber Pro-Features werden gesperrt."],
        ["Wie kann ich upgraden?","Klicke auf Jetzt upgraden und schlie√üe den Checkout ab ‚Äì dein Plan wird sofort aktiviert."],
        ["Kann ich jederzeit k√ºndigen?","Der Pro-Plan ist monatlich k√ºndbar. Nach der K√ºndigung beh√§ltst du den Pro-Zugang bis zum Ende des Abrechnungszeitraums."],
        ["Sind meine Daten sicher?","Ja. Alle Daten werden verschl√ºsselt in unserer Supabase-Datenbank gespeichert."],["Allgemeine Gesch√§ftsbedingungen","Unsere AGB findest du unter planavo.de/agb"],
      ].map(([q,a])=>`<div style="padding:14px 0;border-bottom:1px solid var(--b)"><p style="font-size:13px;font-weight:700;margin:0 0 4px">${q}</p><p style="font-size:13px;color:var(--tm);margin:0;line-height:1.6">${a}</p></div>`).join("")}
    </div>
  </div>`;
}

function rSettings(){
  if(!user.loggedIn){
    return `<div class="card" style="text-align:center;padding:28px"><p style="font-size:18px;font-weight:700;margin:0 0 8px">Einstellungen</p><p style="font-size:13px;color:var(--tm);margin:0 0 14px">Bitte logge dich ein, um deine Benutzerdaten zu verwalten.</p><button class="btn btn-primary btn-sm" onclick="openLogin()">Anmelden</button></div>`;
  }
  const trial=isTrialActive(),daysLeft=trialDaysLeft(),pro=isProPlan();
  const manageSubBtn=pro&&!trial?`<div style="margin-bottom:14px"><button class="btn btn-outline btn-sm" onclick="if(window.Paddle&&paddleReady){Paddle.Retain&&Paddle.Retain.initCancellationFlow?Paddle.Retain.initCancellationFlow():window.open('https://customer.paddle.com','_blank')}else{window.open('https://customer.paddle.com','_blank')}">‚öô Abo verwalten / k√ºndigen</button></div>`:"";
  const planBanner=trial?`<div style="background:var(--amG);border:1px solid rgba(251,191,36,0.3);border-radius:14px;padding:14px 18px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">‚è∞</span><div><p style="font-size:13px;font-weight:700;color:var(--am);margin:0">Pro-Testphase ‚Äì noch ${daysLeft} Tage</p><p style="font-size:12px;color:var(--tm);margin:0">Danach wechselst du automatisch auf Basic.</p></div></div><button class="btn btn-sm" style="background:var(--am);color:#000;font-weight:700;white-space:nowrap" onclick="goTo('pricing')">Upgraden</button></div>`:!pro?`<div style="background:var(--bgE);border:1px solid var(--b);border-radius:14px;padding:14px 18px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">üîì</span><div><p style="font-size:13px;font-weight:700;margin:0">Du nutzt den Basic-Plan</p><p style="font-size:12px;color:var(--tm);margin:0">Upgrade f√ºr unbegrenzte Features ab 4,99 ‚Ç¨/Monat.</p></div></div><button class="btn btn-ghost btn-sm" onclick="openPaddleCheckout()">‚≠ê Upgrade auf Pro</button></div>`:"";
  const proSub=pro&&!trial;
  return `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:12px"><h1 style="font-size:24px;font-weight:800;margin:0">Einstellungen</h1><span class="badge" style="background:var(--emG);color:var(--em)"><span class="badge-dot" style="background:var(--em)"></span>Konto</span></div>${planBanner}

  <div class="card" style="margin-bottom:14px;padding:14px 16px;background:var(--bgE)"><p style="font-size:12px;font-weight:700;color:var(--ts);margin:0 0 8px;text-transform:uppercase;letter-spacing:0.8px">Benutzerdaten</p><p style="font-size:13px;color:var(--tm);margin:0;line-height:1.6">Hier verwaltest du deine pers√∂nlichen Einstellungen wie Adresse und Kontaktdaten.</p></div>
  <div class="card" style="padding:18px;margin-bottom:14px">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="field"><label>Vorname</label><div class="input-wrap"><input id="setFirstName" value="${(user.firstName||"").replace(/"/g,'&quot;')}" placeholder="Max"></div></div>
      <div class="field"><label>Nachname</label><div class="input-wrap"><input id="setLastName" value="${(user.lastName||"").replace(/"/g,'&quot;')}" placeholder="Mustermann"></div></div>
    </div>
    <div class="field"><label>E-Mail</label><div class="input-wrap"><input id="setEmail" value="${(user.email||"").replace(/"/g,'&quot;')}" readonly></div></div>
    <div class="field"><label>Adresse</label><div class="input-wrap"><input id="setStreet" value="${(user.addressStreet||"").replace(/"/g,'&quot;')}" placeholder="Stra√üe und Hausnummer"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="field"><label>PLZ</label><div class="input-wrap"><input id="setZip" value="${(user.addressZip||"").replace(/"/g,'&quot;')}" placeholder="12345"></div></div>
      <div class="field"><label>Ort</label><div class="input-wrap"><input id="setCity" value="${(user.addressCity||"").replace(/"/g,'&quot;')}" placeholder="M√ºnchen"></div></div>
    </div>
    <div class="field"><label>Telefon</label><div class="input-wrap"><input id="setPhone" value="${(user.phone||"").replace(/"/g,'&quot;')}" placeholder="+49 ..."></div></div>
    <button class="btn btn-primary" onclick="saveSettings()">‚úì Einstellungen speichern</button>
  </div>

  <div class="card" style="padding:18px;margin-bottom:14px">
    <p style="font-size:12px;font-weight:700;color:var(--ts);margin:0 0 12px;text-transform:uppercase;letter-spacing:1px">Daten-Backup & Wiederherstellung</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn btn-primary btn-sm" onclick="downloadBackup()">Backup herunterladen</button>
      <label class="btn btn-outline btn-sm" style="cursor:pointer">Backup wiederherstellen<input id="backupFileInput" type="file" accept="application/json" style="display:none" onchange="handleBackupFileChange(event)"></label>
    </div>
    <div id="snapshotList"><p style="font-size:12px;color:var(--tm);margin:0">Sicherungspunkte werden geladen‚Ä¶</p></div>
  </div>

  ${proSub?`
  <div class="card" style="margin-bottom:14px;padding:0;overflow:hidden">
    <div style="padding:14px 18px;background:var(--bgE);border-bottom:1px solid var(--b)">
      <p style="font-size:12px;font-weight:700;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.8px">‚≠ê Aboverwaltung</p>
    </div>
    <div style="padding:18px">
      <div style="display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;background:var(--emG2);border:1px solid var(--ba);margin-bottom:16px">
        <div style="width:40px;height:40px;border-radius:12px;background:var(--emG);border:1px solid var(--ba);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">‚≠ê</div>
        <div style="flex:1">
          <p style="font-size:14px;font-weight:700;color:var(--em);margin:0">Ratenova Pro ‚Äì Aktiv</p>
          <p style="font-size:12px;color:var(--tm);margin:2px 0 0">Unbegrenzte Verbindlichkeiten ¬∑ alle Features ¬∑ PDF-Export</p>
        </div>
      </div>
      <p style="font-size:13px;color:var(--tm);margin:0 0 14px;line-height:1.6">Dein Abonnement l√§uft √ºber Paddle. Du kannst es jederzeit k√ºndigen ‚Äì du beh√§ltst den Zugang bis zum Ende des aktuellen Abrechnungszeitraums.</p>
      <button class="btn btn-outline btn-sm" onclick="openCancelSubModal()">Abo k√ºndigen</button>
    </div>
  </div>`:""}

  <div class="card" style="margin-bottom:14px;padding:0;overflow:hidden;border-color:rgba(239,68,68,0.25)">
    <div style="padding:14px 18px;background:rgba(239,68,68,0.06);border-bottom:1px solid rgba(239,68,68,0.2)">
      <p style="font-size:12px;font-weight:700;color:#ef4444;margin:0;text-transform:uppercase;letter-spacing:0.8px">‚ö† Gefahrenzone</p>
    </div>
    <div style="padding:18px">
      <div style="margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--b)">
        <p style="font-size:14px;font-weight:700;margin:0 0 4px;color:#ef4444">Alle Daten l√∂schen</p>
        <p style="font-size:13px;color:var(--tm);margin:0 0 12px;line-height:1.6">L√∂scht alle Verbindlichkeiten, Zahlungshistorien, Budget‚ÄëEintr√§ge und Vertr√§ge unwiderruflich. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.</p>
        <button class="btn btn-danger btn-sm" onclick="openDeleteDataModal()">üóë Alle Daten l√∂schen</button>
      </div>
      <div>
        <p style="font-size:14px;font-weight:700;margin:0 0 4px;color:#ef4444">Account dauerhaft l√∂schen</p>
        <p style="font-size:13px;color:var(--tm);margin:0 0 12px;line-height:1.6">L√∂scht deinen Account und alle damit verbundenen Daten unwiderruflich. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.</p>
        <button class="btn btn-sm" style="background:rgba(239,68,68,0.12);color:#ef4444;border:1px solid rgba(239,68,68,0.3)" onclick="openDeleteAccountModal()">üóë Account l√∂schen</button>
      </div>
    </div>
  </div>
  `;
}

function saveSettings(){
  if(!user.loggedIn){openLogin();return;}
  const firstName=(document.getElementById("setFirstName")?.value||"").trim();
  const lastName=(document.getElementById("setLastName")?.value||"").trim();
  const street=(document.getElementById("setStreet")?.value||"").trim();
  const zip=(document.getElementById("setZip")?.value||"").trim();
  const city=(document.getElementById("setCity")?.value||"").trim();
  const phone=(document.getElementById("setPhone")?.value||"").trim();

  user.firstName=firstName;
  user.lastName=lastName;
  user.name=[firstName,lastName].join(" ").trim()||user.name||"Benutzer";
  user.addressStreet=street;
  user.addressZip=zip;
  user.addressCity=city;
  user.phone=phone;
  saveUser();
  upsertCloudProfile().catch(()=>{});
  scheduleCloudSave();
  try{localStorage.setItem(STORAGE_USER,JSON.stringify(user))}catch(e){}
  renderNav();
  renderPage();
  flash("Einstellungen gespeichert ‚úì");
}

function openCancelSubModal(){
  document.getElementById("modalContainer").innerHTML=`
  <div class="overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:460px">
      <div class="modal-head">
        <h3>Abo k√ºndigen</h3>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div style="padding:4px 0 8px">
        <div style="padding:14px;border-radius:12px;background:var(--amG);border:1px solid rgba(251,191,36,0.3);margin-bottom:16px;display:flex;gap:10px;align-items:flex-start">
          <span style="font-size:18px">‚è∞</span>
          <div>
            <p style="font-size:13px;font-weight:700;color:var(--am);margin:0 0 2px">Zugang bleibt aktiv</p>
            <p style="font-size:12px;color:var(--tm);margin:0;line-height:1.5">Nach der K√ºndigung hast du bis zum Ende deines aktuellen Abrechnungszeitraums noch vollen Pro-Zugang.</p>
          </div>
        </div>
        <p style="font-size:13px;color:var(--tm);margin:0 0 20px;line-height:1.6">Dein Abo wird √ºber Paddle verwaltet. Klicke unten um den K√ºndigungsprozess zu starten:</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-outline" onclick="closeModal()">Abbrechen</button>
          <button class="btn btn-sm" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;font-weight:700;border:none;padding:10px 18px;border-radius:10px;cursor:pointer" onclick="closeModal();if(window.Paddle&&paddleReady&&Paddle.Retain&&Paddle.Retain.initCancellationFlow){Paddle.Retain.initCancellationFlow()}else{window.open('https://customer.paddle.com','_blank')}">Abo jetzt k√ºndigen ‚Üí</button>
        </div>
      </div>
    </div>
  </div>`;
}

function openDeleteAccountModal(){
  document.getElementById("modalContainer").innerHTML=`
  <div class="overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:460px">
      <div class="modal-head" style="border-bottom-color:rgba(239,68,68,0.25)">
        <h3 style="color:#ef4444">Account l√∂schen</h3>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div style="padding:4px 0 8px">
        <div style="padding:14px;border-radius:12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);margin-bottom:16px">
          <p style="font-size:13px;font-weight:700;color:#ef4444;margin:0 0 6px">‚ö† Diese Aktion ist unwiderruflich</p>
          <p style="font-size:12px;color:var(--tm);margin:0;line-height:1.7">Folgendes wird dauerhaft gel√∂scht:<br>¬∑ Alle Verbindlichkeiten und Zahlungshistorie<br>¬∑ Alle Vertr√§ge und Budgetdaten<br>¬∑ Dein Profil und alle Einstellungen<br>¬∑ Dein gesamter Account bei Ratenova</p>
        </div>
        <p style="font-size:13px;color:var(--tm);margin:0 0 14px;line-height:1.6">Zur Best√§tigung bitte deine E-Mail-Adresse eingeben:</p>
        <div class="field" style="margin-bottom:16px">
          <div class="input-wrap" style="border-color:rgba(239,68,68,0.4)">
            <input id="deleteConfirmEmail" placeholder="${user.email||'deine@email.de'}" style="flex:1;border:none;outline:none;background:transparent;color:var(--t);font-size:14px">
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-outline" onclick="closeModal()">Abbrechen</button>
          <button class="btn btn-sm" style="background:#ef4444;color:#fff;font-weight:700;border:none;padding:10px 18px;border-radius:10px;cursor:pointer" onclick="confirmDeleteAccount()">Account unwiderruflich l√∂schen</button>
        </div>
      </div>
    </div>
  </div>`;
}

function openDeleteDataModal(){
  document.getElementById("modalContainer").innerHTML=`
  <div class="overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:460px">
      <div class="modal-head" style="border-bottom-color:rgba(239,68,68,0.25)">
        <h3 style="color:#ef4444">Alle Daten l√∂schen</h3>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div style="padding:4px 0 8px">
        <div style="padding:14px;border-radius:12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);margin-bottom:16px">
          <p style="font-size:13px;font-weight:700;color:#ef4444;margin:0 0 6px">‚ö† Unwiderrufliche Aktion</p>
          <p style="font-size:12px;color:var(--tm);margin:0;line-height:1.7">Dies l√∂scht dauerhaft:<br>¬∑ Alle Verbindlichkeiten und Zahlungshistorie<br>¬∑ Alle Vertr√§ge<br>¬∑ Alle Budget‚ÄëEintr√§ge<br>¬∑ Einstellungen bleiben erhalten</p>
        </div>
        <p style="font-size:13px;color:var(--tm);margin:0 0 14px;line-height:1.6">Zur Best√§tigung bitte <strong>L√ñSCHEN</strong> eingeben:</p>
        <div class="field" style="margin-bottom:16px">
          <div class="input-wrap" style="border-color:rgba(239,68,68,0.4)">
            <input id="deleteConfirmText" placeholder="L√ñSCHEN" style="flex:1;border:none;outline:none;background:transparent;color:var(--t);font-size:14px;text-transform:uppercase">
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-outline" onclick="closeModal()">Abbrechen</button>
          <button class="btn btn-sm" style="background:#ef4444;color:#fff;font-weight:700;border:none;padding:10px 18px;border-radius:10px;cursor:pointer" onclick="confirmDeleteData()">Alle Daten l√∂schen</button>
        </div>
      </div>
    </div>
  </div>`;
}

async function confirmDeleteData(){
  const input=(document.getElementById("deleteConfirmText")?.value||"").trim().toUpperCase();
  if(input!=="L√ñSCHEN"){flash("Bitte 'L√ñSCHEN' eingeben zur Best√§tigung ‚úó");return;}
  closeModal();
  flash("Daten werden gel√∂scht‚Ä¶");
  try{
    await autoSnapshot("full_wipe",false);
    debts=[];contracts=[];budgetItems=[];
    saveLocalState();
    if((window.supabaseClient||window.supabase)&&currentUserId){
      try{
        const sb=(window.supabaseClient||window.supabase);
        await sb.from("app_state").upsert({user_id:currentUserId,debts:[],contracts:[],budget_items:[],updated_at:new Date().toISOString()},{onConflict:"user_id"});
      }catch(e){}
    }
    renderNav();
    renderPage();
    flash("Alle Daten gel√∂scht ‚úì");
  }catch(e){
    console.error("Delete data error:",e);
    flash("L√∂schen fehlgeschlagen ‚úó");
  }
}

async function confirmDeleteAccount(){
  const input=(document.getElementById("deleteConfirmEmail")?.value||"").trim().toLowerCase();
  const expected=(user.email||"").trim().toLowerCase();
  if(!input||input!==expected){flash("E-Mail stimmt nicht √ºberein ‚úó");return;}
  closeModal();
  flash("Account wird gel√∂scht‚Ä¶");
  
  let authDeleted = false;
  try{
    if(supabaseClient&&currentUserId){
      const uid = currentUserId;
      
      // 1. Profil- und App-Daten l√∂schen (mit korrekten Tabellennamen)
      await Promise.all([
        supabaseClient.from("user_profiles").delete().eq("id", uid),
        supabaseClient.from("app_state").delete().eq("user_id", uid),
      ]);
      
      // 2. Auth-User √ºber hyper-api Edge Function l√∂schen
      // (nur die Edge Function mit Service Role Key kann auth.users l√∂schen)
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const res = await fetch(
          "https://kdbuduwztmxxykfvqbie.supabase.co/functions/v1/hyper-api",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkYnVkdXd6dG14eHlrZnZxYmllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5MDc1NzAsImV4cCI6MjA1NTQ4MzU3MH0.bGVL8kkRdZ_RRE6sElUWLYQsKb3j9QLTRSXqcrnXTHI",
              "x-master-secret": "planavo-master-2026"
            },
            body: JSON.stringify({ action: "delete_user", user_id: uid })
          }
        );
        if(res.ok) authDeleted = true;
      } catch(e){ console.warn("Edge Function delete fehlgeschlagen:", e); }
      
      // 3. Ausloggen
      await supabaseClient.auth.signOut();
    }
  }catch(e){console.error("Delete error:",e);}
  
  // 4. Lokalen State komplett l√∂schen
  try{localStorage.clear();sessionStorage.clear();}catch(e){}
  debts=[];contracts=[];budgetItems=[];
  currentUserId=null;
  user={loggedIn:false,name:"",firstName:"",lastName:"",email:"",plan:"Basis",addressStreet:"",addressZip:"",addressCity:"",phone:""};
  
  // 5. Feedback
  const msg = authDeleted 
    ? "Account vollst√§ndig gel√∂scht. Auf Wiedersehen!" 
    : "Daten gel√∂scht. Auf Wiedersehen! (Login-Account wird vom System entfernt)";
  setTimeout(()=>{flash(msg);showAuthPage("login");},500);
}

function dashContractWidget(){
  if(!contracts||contracts.length===0)return "";
  const ci=function(cat){var m={"Versicherung":"üõ°Ô∏è","Streaming":"üé¨","Internet":"üåê","Strom":"‚ö°","Gas":"üî•","Handy":"üì±","Fitness":"üí™","Software":"üíª","Bank":"üè¶","Miete":"üè†","Auto":"üöó"};return m[cat]||"üìÑ";};
  const acute=contracts.filter(function(c){var d=contractDaysLeft(c);return d!==null&&d<=7&&c.status!=="cancelled";});
  const urgent=contracts.filter(function(c){var d=contractDaysLeft(c);return d!==null&&d>7&&d<=30&&c.status!=="cancelled";});
  const cancelled=contracts.filter(function(c){return c.status==="cancelled";});
  if(acute.length===0&&urgent.length===0&&cancelled.length===0)return "";
  var h="<div style=\"margin-top:20px\">";
  h+="<div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:14px\">";
  h+="<h3 style=\"font-size:15px;font-weight:700;margin:0\">üìã Vertragsfristen</h3>";
  h+="<button style=\"background:none;border:none;color:var(--em);font-size:13px;font-weight:600;cursor:pointer\" onclick=\"goTo(&apos;contracts&apos;)\">Alle ‚Üí</button></div>";
  if(acute.length){
    h+="<p style=\"font-size:10px;font-weight:700;color:var(--co);text-transform:uppercase;letter-spacing:1px;margin:0 0 6px\">üö® Akut ‚Äì sofort handeln</p>";
    acute.forEach(function(c){
      var days=contractDaysLeft(c);
      h+="<div style=\"background:var(--coG);border:1px solid var(--co);border-radius:12px;padding:12px 14px;margin-bottom:6px;display:flex;align-items:center;gap:12px\">";
      h+="<span style=\"font-size:20px\">"+ci(c.category)+"</span>";
      h+="<div style=\"flex:1\"><p style=\"font-size:13px;font-weight:700;margin:0\">"+c.name+"</p>";
      h+="<p style=\"font-size:12px;color:var(--tm);margin:2px 0 0\">"+(c.provider||"")+" ¬∑ "+(days===0?"Heute!":days+" Tage")+"</p></div>";
      h+="<button class=\"btn btn-sm\" style=\"background:var(--co);color:#fff;border:none;white-space:nowrap\" onclick=\"window._contractDetail="+c.id+";goTo(&apos;contracts&apos;)\">K√ºndigen ‚Üí</button></div>";
    });
  }
  if(urgent.length){
    h+="<p style=\"font-size:10px;font-weight:700;color:var(--am);text-transform:uppercase;letter-spacing:1px;margin:8px 0 6px\">‚ö†Ô∏è Bald f√§llig</p>";
    urgent.forEach(function(c){
      h+="<div style=\"background:var(--bgE);border:1px solid var(--b);border-radius:12px;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;gap:12px;cursor:pointer\" onclick=\"window._contractDetail="+c.id+";goTo(&apos;contracts&apos;)\">";
      h+="<span style=\"font-size:18px\">"+ci(c.category)+"</span>";
      h+="<div style=\"flex:1\"><p style=\"font-size:13px;font-weight:600;margin:0\">"+c.name+"</p><p style=\"font-size:12px;color:var(--tm);margin:2px 0 0\">"+(c.provider||"")+"</p></div>";
      h+="<span style=\"font-size:13px;font-weight:700;color:var(--am)\">"+contractDaysLeft(c)+" Tage</span></div>";
    });
  }
  if(cancelled.length){
    h+="<p style=\"font-size:10px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:8px 0 6px\">‚úÖ Gek√ºndigt</p>";
    cancelled.slice(0,2).forEach(function(c){
      h+="<div style=\"background:var(--bgE);border:1px solid var(--b);border-radius:12px;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;gap:12px;opacity:0.6\">";
      h+="<span style=\"font-size:18px\">"+ci(c.category)+"</span>";
      h+="<div style=\"flex:1\"><p style=\"font-size:13px;font-weight:600;margin:0;text-decoration:line-through\">"+c.name+"</p><p style=\"font-size:12px;color:var(--tm);margin:2px 0 0\">"+(c.provider||"")+"</p></div>";
      h+="<span style=\"font-size:11px;color:var(--ts)\">Gek√ºndigt</span></div>";
    });
  }
  h+="</div>";
  return h;
}
function dashVerpflichtungenWidget(){
  const open=debts.filter(function(d){return d.paid<d.original;});
  if(!open.length)return "";
  var h="<div style=\"margin-top:4px\"><div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px\">";
  h+="<h3 style=\"font-size:15px;font-weight:700;margin:0\">‚ò∞ Verpflichtungen</h3>";
  h+="<button style=\"background:none;border:none;color:var(--em);font-size:13px;font-weight:600;cursor:pointer\" onclick=\"goTo('debts')\">Alle ‚Üí</button></div>";
  h+="<div class=\"flex-col\">";
  open.slice(0,3).forEach(function(d){
    var st=gS(d),p=pc(d.paid,d.original);
    h+="<div class=\"card clickable\" onclick=\"openDetail("+d.id+")\"><div style=\"display:flex;align-items:center;gap:14px\">";
    h+="<div style=\"width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--bgE),var(--bgC));border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0\">"+d.emoji+"</div>";
    h+="<div style=\"flex:1;min-width:0\"><div style=\"display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:4px\">";
    h+="<p style=\"font-size:14px;font-weight:600;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap\">"+d.name+"</p>"+bdg(st)+"</div>";
    h+="<div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:8px\">";
    h+="<span style=\"font-size:12px;color:var(--tm)\">"+fmt(d.original-d.paid)+" offen</span>";
    h+="<span style=\"font-size:12px;font-weight:700;color:var(--em)\">"+p+"%</span></div>";
    h+=pb(p);
    h+="<div style=\"display:flex;gap:8px;margin-top:10px\"><button class=\"btn btn-ghost btn-sm\" onclick=\"showTransfer("+d.id+");event.stopPropagation()\">√úberweisung</button><button class=\"btn btn-ghost btn-sm\" onclick=\"setReminder("+d.id+");event.stopPropagation()\">Erinnerung</button><button class=\"btn btn-ghost btn-sm\" onclick=\"openPay("+d.id+");event.stopPropagation()\">Bezahlt</button></div>";
    h+="</div></div></div>";
  });
  h+="</div></div>";
  return h;
}

function dashManagementOverviewWidget(){
  try{
    const activeDebts=debts.filter(d=>d.paid<d.original).length;
    const activeContracts=contracts.filter(c=>c.status!=='cancelled').length;
    const m=currentBudgetMonth;
    const actionableDebts=debts.filter(d=>{const dd=effDue(d)||d.due;return d.paid<d.original&&dd&&dd.slice(0,7)===m}).length;
    const actionableContracts=contracts.filter(c=>{const dead=contractEffectiveDeadline(c);return c.status!=='cancelled'&&dead&&dead.slice(0,7)===m}).length;
    const actionable=actionableDebts+actionableContracts;
    var h="<div class=\"card\" style=\"margin:-4px 0 16px;padding:14px 18px\">";
    h+="<div style=\"display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px\"><div style=\"display:flex;align-items:center;gap:8px\"><span style=\"font-size:18px\">üß≠</span><p style=\"font-size:13px;font-weight:700;color:var(--t);margin:0\">Management‚Äë√úberblick</p></div></div>";
    h+="<div style=\"display:grid;grid-template-columns:repeat(3,1fr);gap:10px\">";
    h+="<div style=\"padding:12px;border-radius:12px;background:var(--bgE);border:1px solid var(--b)\"><p style=\"font-size:11px;color:var(--tm);margin:0\">Verpflichtungen</p><p style=\"font-size:22px;font-weight:800;font-family:'Bricolage Grotesque',sans-serif;margin:5px 0 0\">"+activeDebts+"</p></div>";
    h+="<div style=\"padding:12px;border-radius:12px;background:var(--bgE);border:1px solid var(--b)\"><p style=\"font-size:11px;color:var(--tm);margin:0\">Aktive Vertr√§ge</p><p style=\"font-size:22px;font-weight:800;font-family:'Bricolage Grotesque',sans-serif;margin:5px 0 0\">"+activeContracts+"</p></div>";
    h+="<div style=\"padding:12px;border-radius:12px;background:var(--emG);border:1px solid var(--ba)\"><p style=\"font-size:11px;color:var(--tm);margin:0\">Handlungsbedarf "+m+"</p><p style=\"font-size:22px;font-weight:800;font-family:'Bricolage Grotesque',sans-serif;margin:5px 0 0;color:var(--em)\">"+actionable+"</p></div>";
    h+="</div></div>";
    return h;
  }catch(e){console.error(e);return "";}
}

function dashMonthlyLoadWidget(){
  try{
    const B=calcBudgetStats();
    const ratio=B.inc>0?Math.round((B.debtExp/B.inc)*100):0;
    var h="<div class=\"card\" style=\"margin-bottom:12px;padding:12px 18px\">";
    h+="<div style=\"display:flex;justify-content:space-between;align-items:center;gap:10px\"><div>";
    h+="<p style=\"font-size:11px;color:var(--tm);margin:0;text-transform:uppercase;letter-spacing:1px\">Monats√ºbersicht</p>";
    h+="<p style=\"font-size:18px;font-weight:800;margin:2px 0 8px\">"+fmt(B.debtExp)+"/Monat <span style=\"font-size:12px;color:var(--tm);font-weight:600\">("+ratio+"% der Einnahmen)</span></p>";
    h+=pb(ratio,6);
    h+="<p style=\"font-size:12px;color:var(--tm);margin:6px 0 0\">Verpflichtungen im Verh√§ltnis zu Einkommen in "+B.monthLabel+"</p>";
    h+="</div><button style=\"background:none;border:none;color:var(--em);font-size:13px;font-weight:600;cursor:pointer\" onclick=\"goTo('budget')\">Details ‚Üí</button></div></div>";
    return h;
  }catch(e){console.error(e);return "";}
}

function dashMonthlyLoadInline(){
  try{
    const B=calcBudgetStats();
    const ratio=B.inc>0?Math.round((B.debtExp/B.inc)*100):0;
    return `<div style="margin:8px 0 12px;display:flex;gap:8px;flex-wrap:wrap"><span class="chip">Monatsbelastung: ${fmt(B.debtExp)} (${ratio}% der Einnahmen)</span></div>`;
  }catch(e){console.error(e);return "";}
}

function dashPeriodTasksWidget(){
  try{
    const m=currentBudgetMonth;
    const monthEnd=m+"-31";
    const dueDebts=debts.filter(d=>{const dd=effDue(d)||d.due;return d.paid<d.original&&dd&&dd.slice(0,7)===m}).map(d=>{const nd=effDue(d)||d.due;return {type:"Zahlung f√§llig",icon:d.emoji||"üí∂",name:d.name,when:nd,days:dU(nd),onClick:`openDetail(${d.id})`};});
    const deadlineContracts=contracts.filter(c=>{const dead=contractEffectiveDeadline(c);return c.status!=='cancelled'&&dead&&dead.slice(0,7)===m}).map(c=>{const dead=contractEffectiveDeadline(c);return {type:"K√ºndigungsfrist",icon:"üìã",name:c.name,when:dead,days:dU(dead),onClick:`window._contractDetail=${c.id};goTo('contracts')`};});
    const items=[...dueDebts,...deadlineContracts].sort((a,b)=>{if(!a.when&&!b.when)return 0;if(!a.when)return 1;if(!b.when)return -1;return new Date(a.when)-new Date(b.when)}).slice(0,dashboardCompact?3:8);
    var h="<div style=\"margin-top:12px\">";
    h+="<div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px\">";
    h+="<h3 style=\"font-size:15px;font-weight:700;margin:0\">üìù Zu erledigen</h3>";
    h+="</div>";
    if(items.length===0){
      h+="<div class=\"card\" style=\"padding:16px;text-align:center;color:var(--tm)\">Keine Aufgaben im aktuellen Monat</div>";
      h+="</div>";
      return h;
    }
    h+="<div class=\"flex-col\">";
    items.forEach(function(it){
      const stat=it.days===0?"Heute":(it.days<0?("√úberf√§llig "+Math.abs(it.days)+" T"):("In "+it.days+" T"));
      h+="<div class=\"card clickable\" onclick=\""+it.onClick+"\" style=\"padding:12px 14px\"><div style=\"display:flex;align-items:center;gap:12px\">";
      h+="<div style=\"width:44px;height:44px;border-radius:12px;background:var(--bgE);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:20px\">"+it.icon+"</div>";
      h+="<div style=\"flex:1;min-width:0\">";
      h+="<p style=\"font-size:14px;font-weight:600;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap\">"+it.name+"</p>";
      h+="<p style=\"font-size:12px;color:var(--tm);margin:2px 0 0\">"+it.type+" ¬∑ "+fD(it.when)+" ¬∑ "+stat+"</p>";
      h+="</div>";
      h+="<span style=\"color:var(--tm);font-size:18px\">‚Ä∫</span>";
      h+="</div></div>";
    });
    h+="</div></div>";
    return h;
  }catch(e){console.error(e);return "";}
}
function dashTodayTasksWidget(){
  const list=debts.filter(d=>d.paid<d.original).map(d=>{const nd=effDue(d)||d.due;return {d,nd,dy:nd?dU(nd):9999}}).filter(x=>isFinite(x.dy)&&x.dy<=2).sort((a,b)=>a.dy-b.dy);
  var h="<div style=\"margin-top:12px\">";
  h+="<div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:12px\">";
  h+="<h3 style=\"font-size:15px;font-weight:700;margin:0\">üìÖ Heute zu erledigen</h3>";
  h+="</div>";
  if(list.length===0){
    h+="<div class=\"card\" style=\"padding:16px;text-align:center;color:var(--tm)\">Keine Aufgaben f√ºr heute</div>";
    h+="</div>";
    return h;
  }
  h+="<div class=\"flex-col\">";
  list.forEach(function(x){
    const d=x.d,dy=x.dy,nd=x.nd;
    const stat=dy===0?"Heute":(dy<0?("√úberf√§llig "+Math.abs(dy)+" T"):("In "+dy+" T"));
    h+="<div class=\"card\" style=\"padding:12px 14px\"><div style=\"display:flex;align-items:center;gap:12px\">";
    h+="<div style=\"width:44px;height:44px;border-radius:12px;background:"+(dy<=0?"var(--coG)":"var(--amG)")+";display:flex;align-items:center;justify-content:center;font-size:20px\">"+d.emoji+"</div>";
    h+="<div style=\"flex:1;min-width:0\">";
    h+="<p style=\"font-size:14px;font-weight:600;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap\">"+d.name+"</p>";
    h+="<p style=\"font-size:12px;color:var(--tm);margin:2px 0 0\">"+fmt(d.rate>0?Math.min(d.rate,Math.max(d.original-d.paid,0)):(Math.max(d.original-d.paid,0)))+" ¬∑ "+fD(nd)+" ¬∑ "+stat+"</p>";
    h+="</div>";
    h+="<div style=\"display:flex;gap:8px;flex-wrap:wrap\">";
    h+="<button class=\"btn btn-ghost btn-sm\" onclick=\"showTransfer("+d.id+");event.stopPropagation()\">√úberweisung</button>";
    h+="<button class=\"btn btn-ghost btn-sm\" onclick=\"setReminder("+d.id+");event.stopPropagation()\">Erinnerung</button>";
    h+="<button class=\"btn btn-ghost btn-sm\" onclick=\"openPay("+d.id+");event.stopPropagation()\">Bezahlt</button>";
    h+="</div>";
    h+="</div></div>";
  });
  h+="</div></div>";
  return h;
}

function showTransfer(id){
  const d=debts.find(x=>x.id===id);
  if(!d){return;}
  const haveBank=(d.bankIban||d.iban_enc||d.bankRef||d.bankBic||d.bankName);
  if(!haveBank){openDetail(id);return;}
  const rem=Math.max((d.original||0)-(d.paid||0),0);
  const amt=d.rate>0?Math.min(d.rate,rem):rem;
  const amtStr=(Number.isFinite(amt)?amt.toFixed(2):String(amt||0));
  const html="<div class=\"overlay\" onclick=\"closeModal()\"><div class=\"modal\" onclick=\"event.stopPropagation()\" style=\"max-width:560px\">"
    +"<div class=\"modal-head\"><h3>√úberweisung ¬∑ "+(d.name||"")+"</h3><button class=\"modal-close\" onclick=\"closeModal()\">‚úï</button></div>"
    +"<div class=\"field\"><label>Betrag</label><div class=\"input-wrap\"><input id=\"trfAmt\" type=\"number\" step=\"0.01\" value=\""+amtStr+"\"/><span class=\"suffix\">‚Ç¨</span></div></div>"
    +(d.bankName?("<div class=\"field\"><label>Kontoinhaber</label><div class=\"input-wrap\"><input value=\""+d.bankName+"\" readonly></div></div>"):"")
    +((d.bankIban||d.iban_enc||d.iban_hint)?("<div class=\"field\"><label>IBAN</label><div class=\"input-wrap\" style=\"display:flex;gap:8px;align-items:center\"><input id=\"trfIban\" value=\""+(d.bankIban?maskIban(d.bankIban):getMaskedIban(d))+"\" readonly data-full=\""+(d.bankIban?encodeURIComponent(d.bankIban):("enc:"+(d.iban_enc||"")))+"\" data-reveal=\"0\" style=\"flex:1\"/><button class=\"btn btn-ghost btn-sm\" id=\"trfReveal\" onclick=\"toggleIbanReveal()\" type=\"button\" title=\"IBAN anzeigen\">üëÅÔ∏è</button></div></div>"):"")
    +(d.bankBic?("<div class=\"field\"><label>BIC</label><div class=\"input-wrap\"><input value=\""+d.bankBic+"\" readonly></div></div>"):"")
    +(d.bankRef?("<div class=\"field\"><label>Verwendungszweck</label><div class=\"input-wrap\"><input value=\""+d.bankRef+"\" readonly></div></div>"):"")
    +"<div style=\"display:flex;gap:8px;margin-top:12px\">"
    +"<button class=\"btn btn-outline\" id=\"trfCopy\" data-iban=\"\" onclick=\"copyIban()\">üìã IBAN kopieren</button>"
    +(d.bankRef?"<button class=\"btn btn-outline\" data-ref=\""+encodeURIComponent(d.bankRef||"")+"\" onclick=\"navigator.clipboard.writeText(decodeURIComponent(this.dataset.ref)).then(()=>flash('Verwendungszweck kopiert ‚úì'))\">üìã Zweck kopieren</button>":"")
    +"<button class=\"btn\" onclick=\"openPay("+id+");closeModal()\">‚úì Als bezahlt erfassen</button></div>"
    +"</div></div>";
  document.getElementById("modalContainer").innerHTML=html;
}

async function toggleIbanReveal(){
  const inp=document.getElementById("trfIban");
  const btn=document.getElementById("trfReveal");
  const copy=document.getElementById("trfCopy");
  if(!inp){return;}
  const tag=inp.dataset.full||"";
  const revealed=inp.dataset.reveal==="1";
  if(revealed){
    const cur=decodeURIComponent(tag.startsWith("enc:")?"":tag||"");
    inp.value=cur?maskIban(cur):(inp.value||"");
    inp.dataset.reveal="0";
    if(btn) btn.textContent="üëÅÔ∏è";
    if(copy){ copy.setAttribute("data-iban",""); }
  }else{
    let fullPlain="";
    if(tag.startsWith("enc:")){
      const encStr=tag.slice(4);
      fullPlain=await decryptText(encStr);
      inp.dataset.full=encodeURIComponent(fullPlain);
    }else{
      fullPlain=decodeURIComponent(tag||"");
    }
    const normalized=normIban(fullPlain);
    inp.value=formatIbanSpaced(normalized);
    inp.dataset.reveal="1";
    if(btn) btn.textContent="üôà";
    if(copy){ copy.setAttribute("data-iban",encodeURIComponent(normalized)); }
  }
}

function copyIban(){
  const inp=document.getElementById("trfIban");
  const btn=document.getElementById("trfCopy");
  if(!inp||!btn){return;}
  if(inp.dataset.reveal!=="1"){
    flash("Zum Kopieren zuerst IBAN anzeigen üëÅÔ∏è");
    return;
  }
  const full=btn.getAttribute("data-iban")||"";
  const val=decodeURIComponent(full||"");
  if(!val){flash("Keine IBAN verf√ºgbar");return;}
  navigator.clipboard.writeText(val).then(()=>flash("IBAN kopiert ‚úì")).catch(()=>flash("Kopieren nicht m√∂glich"));
}

function setReminder(id){
  const d=debts.find(x=>x.id===id);
  if(!d){return;}
  const nd=effDue(d)||d.due||new Date().toISOString().slice(0,10);
  const dt=nd.replace(/-/g,"");
  const uid=Date.now()+"-"+id+"@ratenova";
  const now=new Date();const ts=now.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
  const sum=("Zahlung: "+(d.name||""));
  const desc=("Erinnerung f√ºr Zahlung ¬∑ Betrag: "+fmt(d.rate>0?Math.min(d.rate,Math.max(d.original-d.paid,0)):Math.max(d.original-d.paid,0)));
  const ics=[
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//Ratenova//Planavo//DE",
    "BEGIN:VEVENT",
    "UID:"+uid,
    "DTSTAMP:"+ts,
    "DTSTART;VALUE=DATE:"+dt,
    "SUMMARY:"+sum,
    "DESCRIPTION:"+desc,
    "END:VEVENT",
    "END:VCALENDAR"
  ].join("\\r\\n");
  const blob=new Blob([ics],{type:"text/calendar;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="Erinnerung_"+(d.name||"Zahlung")+".ics";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1000);
  flash("Kalender‚ÄëErinnerung erstellt ‚úì");
}
function rDash(){const T=gT(),enc=encs[Math.floor(Date.now()/864e5)%encs.length],B=calcBudgetStats();const nd=T.next?(effDue(T.next)||T.next.due):null;const nxt=T.next?`<div class="card clickable" onclick="openDetail(${T.next.id})" style="border-left:3px solid ${dU(nd)<=2?"var(--co)":"var(--am)"}"><div style="display:flex;align-items:center;gap:14px"><div style="width:44px;height:44px;border-radius:12px;background:${dU(nd)<=2?"var(--coG)":"var(--amG)"};display:flex;align-items:center;justify-content:center;font-size:20px">${T.next.emoji}</div><div style="flex:1"><p style="font-size:14px;font-weight:600;margin:0">${dU(nd)===0?"Heute f√§llig":dU(nd)<0?"Handlungsbedarf":`In ${dU(nd)} Tagen f√§llig`}</p><p style="font-size:13px;color:var(--tm);margin:2px 0 0">${T.next.name} ¬∑ ${fmt(T.next.rate)}</p></div><span style="color:var(--tm);font-size:20px">‚Ä∫</span></div></div>`:"";
return`<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;flex-wrap:wrap;gap:12px"><div><p style="font-size:13px;color:var(--tm);margin:0 0 4px">${new Date().toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"})}</p><h1 style="font-size:32px;font-weight:800;margin:0 0 6px">Guten Tag, ${user.firstName||user.name.split(" ")[0]||"dort"}</h1><p style="font-size:14px;color:var(--tm);margin:0">${enc}</p></div><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-ghost btn-sm" onclick="toggleDashboardCompact()" style="margin-top:6px">${dashboardCompact?"Kompakt ‚úì":"Kompakt"}</button><button class="btn btn-ghost btn-sm" onclick="printOverview()" style="margin-top:6px">üñ®Ô∏è √úbersicht drucken</button></div></div>${dashboardCompact?"":dashManagementOverviewWidget()}
<div class="hero"><div class="hero-orb1"></div><div class="hero-orb2"></div><div style="display:flex;gap:24px;align-items:center;flex-wrap:wrap;position:relative"><div style="flex:1;min-width:220px"><p style="font-size:12px;color:var(--tm);margin:0 0 6px;text-transform:uppercase;letter-spacing:1.5px;font-weight:600">Saldo ${B.monthLabel}</p><p style="font-size:48px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:0 0 2px;line-height:1;letter-spacing:-1px;color:${B.bal>=0?'var(--em)':'var(--co)'}">${fmt(B.bal)}</p><p style="font-size:13px;color:var(--tm);margin:0 0 20px">${B.bal>=0?'Positiver Monatsabschluss':'Ausgaben √ºbersteigen Einnahmen'}</p><div style="display:flex;gap:28px;flex-wrap:wrap"><div><p style="font-size:11px;color:var(--tm);margin:0;text-transform:uppercase;letter-spacing:1px">Einnahmen</p><p style="font-size:17px;font-weight:700;margin:3px 0 0;color:var(--em)">${fmt(B.inc)}</p></div><div><p style="font-size:11px;color:var(--tm);margin:0;text-transform:uppercase;letter-spacing:1px">Ausgaben</p><p style="font-size:17px;font-weight:700;margin:3px 0 0;color:var(--co)">${fmt(B.exp)}</p></div>${T.r>0?`<div><p style="font-size:11px;color:var(--tm);margin:0;text-transform:uppercase;letter-spacing:1px">Verpflichtungen</p><p style="font-size:17px;font-weight:700;margin:3px 0 0">${fmt(T.r)}</p></div>`:''}</div></div><div style="position:relative;flex-shrink:0"><svg width="150" height="150" viewBox="0 0 150 150"><circle cx="75" cy="75" r="65" fill="none" stroke="var(--bgE)" stroke-width="9"/><circle cx="75" cy="75" r="65" fill="none" stroke="${B.bal>=0?'var(--em)':'var(--co)'}" stroke-width="9" stroke-linecap="round" stroke-dasharray="${2*Math.PI*65}" stroke-dashoffset="${B.inc>0?2*Math.PI*65*(1-Math.min(1,B.exp/B.inc)):2*Math.PI*65}" transform="rotate(-90 75 75)" style="transition:stroke-dashoffset 0.6s ease"/></svg><div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center"><p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:0;color:${B.bal>=0?'var(--em)':'var(--co)'}">${B.inc>0?Math.round((1-B.exp/B.inc)*100)+'%':'‚Äì'}</p><p style="font-size:10px;color:var(--tm);margin:2px 0 0">gespart</p></div></div></div></div>
<div class="grid2" style="margin-bottom:20px">${nxt}<div class="card"><div style="display:flex;align-items:center;gap:14px"><div style="width:44px;height:44px;border-radius:12px;background:var(--emG);display:flex;align-items:center;justify-content:center;font-size:20px">üéØ</div><div><p style="font-size:14px;font-weight:600;color:var(--em);margin:0">Entlastet in ~${Math.ceil(T.r/T.m)} Monaten</p><p style="font-size:13px;color:var(--tm);margin:2px 0 0">Weiter so!</p></div></div></div></div>
<div class="card" style="margin-bottom:16px;padding:16px 18px;border-color:${B.bal>=0?'var(--ba)':'rgba(248,113,113,0.3)'}"><div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">üí∂</span><p style="font-size:13px;font-weight:700;color:var(--t);margin:0">Ein & Ausgaben</p><span style="font-size:12px;color:var(--tm)">${B.monthLabel}</span></div><button style="background:none;border:none;color:var(--em);font-size:13px;font-weight:600;cursor:pointer" onclick="goTo('budget')">Details ‚Üí</button></div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"><div style="padding:12px;border-radius:12px;background:var(--bgE);border:1px solid var(--b)"><p style="font-size:11px;color:var(--tm);margin:0">Einnahmen</p><p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:5px 0 0;color:var(--em)">${fmt(B.inc)}</p></div><div style="padding:12px;border-radius:12px;background:var(--bgE);border:1px solid var(--b)"><p style="font-size:11px;color:var(--tm);margin:0">Ausgaben</p><p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:5px 0 0;color:var(--co)">${fmt(B.exp)}</p></div><div style="padding:12px;border-radius:12px;background:${B.bal>=0?'var(--emG)':'rgba(248,113,113,0.08)'};border:1px solid ${B.bal>=0?'var(--ba)':'rgba(248,113,113,0.3)'}"><p style="font-size:11px;color:var(--tm);margin:0">Saldo</p><p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:5px 0 0;color:${B.bal>=0?'var(--em)':'var(--co)'}">${fmt(B.bal)}</p></div></div></div>
${dashboardCompact?dashMonthlyLoadInline():dashMonthlyLoadWidget()}
${dashContractWidget()}
${dashPeriodTasksWidget()}
${dashVerpflichtungenWidget()}
`}

function rDebts(){
  const basicLimit=!isProPlan()&&debts.length>=BASIC_DEBT_LIMIT;
  const limitBanner=basicLimit?`<div style="background:linear-gradient(135deg,var(--amG),rgba(56,189,248,0.06));border:1px solid rgba(251,191,36,0.35);border-radius:14px;padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:12px"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">üîí</span><div><p style="font-size:13px;font-weight:700;color:var(--am);margin:0">Limit von ${BASIC_DEBT_LIMIT} Eintr√§gen erreicht</p><p style="font-size:12px;color:var(--tm);margin:0">Upgrade auf Pro f√ºr unbegrenzte Verpflichtungen.</p></div></div><button class="btn btn-sm" style="background:linear-gradient(135deg,var(--emD),var(--em));color:#fff;white-space:nowrap" onclick="openPaddleCheckout()">‚≠ê Upgrade</button></div>`:"";

  const fs=[
    {id:"all",l:"Alle",c:debts.length},
    {id:"active",l:"Aktiv",c:debts.filter(d=>d.paid<d.original).length},
    {id:"clarify",l:"Kl√§rung",c:debts.filter(d=>["neu","in_pruefung","rueckfrage_offen","vereinbarung_in_verhandlung"].includes(getClarificationStatus(d))).length},
    {id:"done",l:"Erledigt",c:debts.filter(d=>d.paid>=d.original).length}
  ];
  const list=debts.filter(d=>{
    if(currentFilter==="active")return d.paid<d.original;
    if(currentFilter==="clarify")return["neu","in_pruefung","rueckfrage_offen","vereinbarung_in_verhandlung"].includes(getClarificationStatus(d));
    if(currentFilter==="done")return d.paid>=d.original;
    return true;
  });
  list.sort((a,b)=>{const ad=a&&a.due?new Date(a.due):null;const bd=b&&b.due?new Date(b.due):null;if(!ad&&!bd)return 0;if(!ad)return 1;if(!bd)return -1;return ad-bd;});
  return`${limitBanner}<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:12px"><h1 style="font-size:24px;font-weight:800;margin:0">Alle Verbindlichkeiten</h1><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-outline btn-sm" onclick="exportChecklistPDF()">üñ®Ô∏è PDF‚ÄëCheckliste</button><button class="btn btn-primary btn-sm" onclick="openAdd()" ${basicLimit?"disabled style=\"opacity:0.5;cursor:not-allowed;\"":""}>Ôºã Hinzuf√ºgen</button></div></div>
  <div style="display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap">${fs.map(f=>`<button class="chip ${currentFilter===f.id?"active":""}" onclick="currentFilter='${f.id}';renderPage()">${f.l} (${f.c})</button>`).join("")}</div>
  <div class="flex-col">${list.map(d=>{const nd=effDue(d),st=gS(d),p=pc(d.paid,d.original),dy=dU(nd||d.due),cs=getClarificationStatus(d),ps=getPaymentStatus(d);return`<div class="card clickable" onclick="openDetail(${d.id})" style="padding:18px"><div style="display:flex;align-items:center;gap:16px"><div style="width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--bgE),var(--bgC));border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${d.emoji}</div><div style="flex:1"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><p style="font-size:15px;font-weight:600;margin:0">${d.name}</p>${bdg(st)}</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">${statusBadge(clarificationMeta,cs,"Kl√§rung")}${statusBadge(paymentMeta,ps,"Zahlung")}</div><div style="display:flex;gap:20px;margin-bottom:8px;flex-wrap:wrap"><span style="font-size:13px;color:var(--tm)">Offen: <strong style="color:var(--t)">${fmt(d.original-d.paid)}</strong></span><span style="font-size:13px;color:var(--tm)">Rate: <strong style="color:var(--t)">${fmt(d.rate)}/Mo</strong></span>${d.paid<d.original?`<span style="font-size:13px;color:var(--tm)">F√§llig: <strong style="color:${dy<=2?"var(--co)":"var(--t)"}">${fD(nd||d.due)}</strong></span>`:""}</div>${pb(p,5)}</div><span style="color:var(--tf);font-size:22px;flex-shrink:0">‚Ä∫</span></div></div>`}).join("")}${list.length===0?'<div style="text-align:center;padding:48px 0"><p style="font-size:36px;margin:0 0 8px">‚ú®</p><p style="font-size:16px;font-weight:600">Keine Verbindlichkeiten</p></div>':""}</div>`}

function rDet(){const d=debts.find(x=>x.id===selectedDebtId);if(!d)return`<div style="text-align:center;padding:60px"><button class="btn btn-primary" onclick="goTo('debts')">Zur√ºck</button></div>`;const rem=d.original-d.paid,p=pc(d.paid,d.original),done=rem<=0,st=gS(d),mL=d.rate>0?Math.ceil(rem/d.rate):0;const hT=d.history.reduce((s,h)=>s+h.amount,0);
return`<button onclick="goTo('debts')" style="background:none;border:none;color:var(--tm);font-size:13px;display:flex;align-items:center;gap:6px;margin-bottom:24px;padding:0">‚Üê Zur√ºck</button><div class="grid2" style="gap:20px"><div>
<div class="card ${done?"":"glow"}" style="margin-bottom:16px;text-align:center;padding:28px"><div style="font-size:40px;margin-bottom:8px">${d.emoji}</div><h2 style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:0 0 6px">${d.name}</h2>${bdg(st)}<div style="display:inline-block;position:relative;margin:28px 0 20px"><div data-ring="${p}" data-size="170" data-sw="10"></div><div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center"><p style="font-size:40px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:0;color:var(--em);line-height:1">${p}%</p><p style="font-size:12px;color:var(--tm);margin:4px 0 0">${done?"Geschafft! üéâ":"getilgt"}</p></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:16px 0 0;border-top:1px solid var(--b)"><div><p style="font-size:11px;color:var(--tm);margin:0;text-transform:uppercase">Gesamt</p><p style="font-size:20px;font-weight:700;margin:4px 0 0">${fmt(d.original)}</p></div><div><p style="font-size:11px;color:var(--tm);margin:0;text-transform:uppercase">Bezahlt</p><p style="font-size:20px;font-weight:700;margin:4px 0 0;color:var(--em)">${fmt(d.paid)}</p></div><div><p style="font-size:11px;color:var(--tm);margin:0;text-transform:uppercase">Offen</p><p style="font-size:20px;font-weight:700;margin:4px 0 0;color:${rem>0?"var(--co)":"var(--em)"}">${fmt(rem)}</p></div></div></div>
${!done?`<button class="btn btn-primary btn-lg btn-full" style="margin-bottom:16px" onclick="openPay(${d.id})">‚úì Beitrag erfassen</button>`:""}${done?`<div class="card" style="background:var(--emG);border:1px solid var(--ba);text-align:center;margin-bottom:16px;padding:20px"><p style="font-size:24px;margin:0 0 4px">üéâ</p><p style="font-size:16px;font-weight:700;color:var(--em);margin:0">Ziel erreicht!</p></div>`:""}
<div class="card" style="margin-bottom:16px"><h3 style="font-size:15px;font-weight:700;margin:0 0 14px">Ratenplan</h3>${[{l:"Monatliche Rate",v:fmt(d.rate)},{l:"N√§chste F√§lligkeit",v:done?"‚Äì":fDL(effDue(d)||d.due)},{l:"Verbleibende Raten",v:done?"Keine":`${mL} Monate`}].map((r,i)=>`<div style="display:flex;justify-content:space-between;padding:10px 0;${i<2?"border-bottom:1px solid var(--b)":""}"><span style="font-size:13px;color:var(--tm)">${r.l}</span><span style="font-size:13px;font-weight:600">${r.v}</span></div>`).join("")}</div>
${d.notes?`<div class="card" style="margin-bottom:16px"><h3 style="font-size:15px;font-weight:700;margin:0 0 8px">Notizen</h3><p style="font-size:14px;color:var(--tm);margin:0;line-height:1.6">${d.notes}</p></div>`:""}
${(d.creditorName||d.creditorAddress||d.creditorPhone||d.creditorEmail)?`<div class="card" style="margin-bottom:16px"><h3 style="font-size:15px;font-weight:700;margin:0 0 14px">üè¢ Gl√§ubiger</h3>
${[{l:"Name",v:d.creditorName},{l:"Adresse",v:d.creditorAddress},{l:"Telefon",v:d.creditorPhone,link:d.creditorPhone?"tel:"+d.creditorPhone.replace(/[^+0-9]/g,""):""},{l:"E-Mail",v:d.creditorEmail,link:d.creditorEmail?"mailto:"+d.creditorEmail:""}].filter(r=>r.v).map((r,i,a)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;${i<a.length-1?"border-bottom:1px solid var(--b)":""}"><span style="font-size:13px;color:var(--tm)">${r.l}</span>${r.link?`<a href="${r.link}" style="font-size:13px;font-weight:600;color:var(--em);text-decoration:none">${r.v}</a>`:`<span style="font-size:13px;font-weight:600">${r.v}</span>`}</div>`).join("")}
</div>`:""} 
${(d.bankIban||d.bankRef)?`<div class="card" style="margin-bottom:16px"><h3 style="font-size:15px;font-weight:700;margin:0 0 14px">üè¶ Bankverbindung</h3>
${[{l:"Kontoinhaber",v:d.bankName},{l:"IBAN",v:maskIban(d.bankIban),mono:true},{l:"BIC",v:d.bankBic,mono:true},{l:"Verwendungszweck",v:d.bankRef,hl:true}].filter(r=>r.v).map((r,i,a)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;${i<a.length-1?"border-bottom:1px solid var(--b)":""}"><span style="font-size:13px;color:var(--tm)">${r.l}</span><span style="font-size:13px;font-weight:600;${r.mono?"font-family:monospace;letter-spacing:0.5px":""}${r.hl?";color:var(--am)":""}">${r.v}</span></div>`).join("")}
<button class="btn btn-ghost btn-sm btn-full" style="margin-top:12px" onclick="showTransfer(${d.id})">√úberweisung anzeigen</button>
</div>`:""}</div>
<div><div class="card" style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="font-size:15px;font-weight:700;margin:0">Zahlungshistorie</h3>${!done?`<button class="btn btn-ghost btn-sm" onclick="openPay(${d.id})">Ôºã Zahlung verbuchen</button>`:""}</div>${d.history.length===0?`<div style="text-align:center;padding:32px 0"><p style="font-size:32px;margin:0 0 8px">üìù</p><p style="font-size:14px;color:var(--tm);margin:0 0 14px">Noch keine Zahlungen.</p>${!done?`<button class="btn btn-ghost btn-sm" onclick="openPay(${d.id})">Erste Zahlung verbuchen</button>`:""}</div>`:`${d.history.map((h,i)=>`<div style="display:flex;align-items:flex-start;gap:12px;padding:12px 0;${i<d.history.length-1?"border-bottom:1px solid var(--b)":""}"><div style="width:32px;height:32px;border-radius:10px;flex-shrink:0;background:var(--emG);border:1px solid var(--ba);display:flex;align-items:center;justify-content:center;color:var(--em);font-size:13px;font-weight:700">‚úì</div><div style="flex:1"><div style="display:flex;justify-content:space-between;align-items:center;gap:10px"><div><span style=\"font-size:14px;font-weight:500\">${fD(h.date)}</span></div><div style=\"display:flex;align-items:center;gap:8px\"><span style=\"font-size:15px;font-weight:700;color:var(--em)\">${fmt(h.amount)}</span><button class=\"btn btn-outline btn-sm\" title=\"L√∂schen\" onclick=\"deletePayment(${d.id},${i})\">üóë</button></div></div>${h.note?`<p style="font-size:12px;color:var(--tm);margin:3px 0 0">${h.note}</p>`:""}</div></div>`).join("")}<div style="margin-top:16px;padding:14px 16px;border-radius:12px;background:var(--bgE);border:1px solid var(--b);display:flex;justify-content:space-between"><span style="font-size:13px;color:var(--tm)">${d.history.length} Zahlung${d.history.length!==1?"en":""}</span><span style="font-size:15px;font-weight:700;color:var(--em)">${fmt(hT)} gesamt</span></div>`}</div><div style="background:var(--bgE);border:1px solid var(--b);border-radius:14px;padding:14px 16px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">
  <div>
    <p style="font-size:13px;font-weight:700;margin:0">üìä In Ein-/Ausgaben √ºbernehmen</p>
    <p style="font-size:12px;color:var(--tm);margin:4px 0 0">Rate wird automatisch als monatliche Ausgabe gebucht</p>
  </div>
  <div onclick="toggleDebtTracking(${d.id})" style="position:relative;width:48px;height:26px;border-radius:13px;background:${d.trackInBudget?'var(--em)':'var(--b)'};cursor:pointer;transition:background 0.2s;flex-shrink:0">
    <div style="position:absolute;top:3px;left:${d.trackInBudget?'25px':'3px'};width:20px;height:20px;border-radius:50%;background:#fff;transition:left 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3)"></div>
  </div>
</div>
<button class="btn btn-danger btn-sm" onclick="deleteDebt(${d.id})">Position l√∂schen</button> <button class="btn btn-outline btn-sm" style="margin-left:8px" onclick="openEdit(${d.id})">‚úèÔ∏è Bearbeiten</button></div></div>`}

// ‚ïê‚ïê‚ïê VEREINBARUNGS-TOOL ‚ïê‚ïê‚ïê
const templates=[
  {id:"ratenzahlung",name:"Ratenzahlungsvereinbarung",icon:"üìã",desc:"Klassische Vereinbarung √ºber Ratenzahlung einer offenen Forderung",tags:["Standard","Raten"]},
  {id:"vergleich",name:"Vergleichsvereinbarung",icon:"ü§ù",desc:"Einigung auf einen reduzierten Betrag zur sofortigen oder schnellen Entlastung",tags:["Rabatt","Einigung"]},
  {id:"stundung",name:"Stundungsvereinbarung",icon:"‚è∏Ô∏è",desc:"Vor√ºbergehende Aussetzung der Zahlungspflicht mit Wiederaufnahme",tags:["Pause","Aufschub"]},
  {id:"teilzahlung",name:"Teilzahlungsangebot",icon:"‚úÇÔ∏è",desc:"Angebot einer einmaligen Teilzahlung zur vollst√§ndigen Erledigung",tags:["Einmalzahlung","Angebot"]},
  {id:"mahnung_antwort",name:"Antwort auf Mahnung",icon:"üì¨",desc:"H√∂fliche Antwort auf eine Mahnung mit Zahlungsvorschlag",tags:["Mahnung","Reaktion"]},
  {id:"haertefall",name:"H√§rtefallantrag",icon:"üõ°Ô∏è",desc:"Antrag auf besondere Ber√ºcksichtigung bei finanzieller Notlage",tags:["Notlage","Sozial"]},
];

let agreeForm={debt:null,template:null,style:"formell",showMoreTemplates:false,step:1,editBetreff:"",editBody:"",editClosing:"",data:{name:"",street:"",zip:"",city:"",creditor:"",creditorStreet:"",creditorZip:"",creditorCity:"",amount:"",rate:"",startDate:"",reason:"",offerAmount:"",pauseUntil:"",bankRef:""}};
function prefillAgreeFromUser(){const d=agreeForm.data||{};const fullName=(user.firstName||user.lastName)?[user.firstName||"",user.lastName||""].join(" ").trim():user.name;if(!d.name)d.name=fullName||"";if(!d.street)d.street=user.addressStreet||"";if(!d.zip)d.zip=user.addressZip||"";if(!d.city)d.city=user.addressCity||"";agreeForm.data=d}

function rAgree(){
  if(agreeForm.step===3) return rAgreePreview();
  if(agreeForm.step===2) return rAgreeForm();
  const activeDebts=debts.filter(d=>d.paid<d.original);
  const styles=[
    {id:"formell",icon:"‚öñÔ∏è",label:"Formell",desc:"Sachlich und juristisch pr√§zise ‚Äì klassischer Beh√∂rdenstil"},
    {id:"kooperativ",icon:"ü§ù",label:"Kooperativ",desc:"L√∂sungsorientiert und freundlich ‚Äì signalisiert guten Willen"},
    {id:"bestimmt",icon:"‚ö°",label:"Bestimmt",desc:"Mit Nachdruck und klaren Fristen ‚Äì zeigt Entschlossenheit"},
  ];
  const selectedDebt=agreeForm.debt;
  const selectedTemplate=templates.find(t=>t.id===agreeForm.template)||null;
  const styleObj=styles.find(s=>s.id===agreeForm.style)||styles[0];
  const primaryTemplatesOrder=["ratenzahlung","vergleich","stundung"];
  const primary=templates.filter(t=>primaryTemplatesOrder.includes(t.id));
  const secondary=templates.filter(t=>!primaryTemplatesOrder.includes(t.id));
  const shownTemplates=agreeForm.showMoreTemplates?[...primary,...secondary]:primary;

  return`
    <h1 style="font-size:24px;font-weight:800;margin:0 0 6px">Zahlungsvereinbarung</h1>
    <p style="font-size:13px;color:var(--tm);margin:0 0 18px">W√§hle Position, Stil und Vorlage ‚Äì Details folgen im n√§chsten Schritt.</p>

    <div style="display:grid;grid-template-columns:minmax(260px,1fr) 320px;gap:16px;align-items:start">
      <div>
        <div class="card" style="padding:14px 16px;margin-bottom:14px;background:var(--bgE)">
          <div style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">1. Position</div>
          ${activeDebts.length>0?`<div style="display:flex;flex-direction:column;gap:8px">
            ${activeDebts.map(d=>`<button class="card clickable" onclick="selectAgreeDebt(${d.id})" style="padding:12px;display:flex;align-items:center;gap:10px;${selectedDebt&&selectedDebt.id===d.id?'border-color:var(--ba);background:var(--emG2);box-shadow:0 0 0 3px rgba(34,197,94,0.15)':''}">
              <span style="font-size:24px">${d.emoji}</span>
              <div style="text-align:left">
                <p style="font-size:14px;font-weight:700;margin:0;color:${selectedDebt&&selectedDebt.id===d.id?'var(--em)':'var(--t)'}">${d.name}</p>
                <p style="font-size:12px;color:var(--tm);margin:2px 0 0">${fmt(d.original-d.paid)} offen</p>
              </div>
            </button>`).join("")}
          </div>`:`<div style="padding:20px;text-align:center"><p style="margin:0 0 6px;font-size:26px">‚úÖ</p><p style="font-size:13px;color:var(--tm);margin:0">Keine offenen Verbindlichkeiten</p></div>`}
        </div>

        <div class="card" style="padding:14px 16px;margin-bottom:14px;background:var(--bgE)">
          <div style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">2. Briefstil</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            ${styles.map(s=>`<button class="card clickable" onclick="agreeForm.style='${s.id}';renderPage()" style="padding:10px 12px;display:flex;align-items:center;gap:8px;${agreeForm.style===s.id?'border-color:var(--ba);background:var(--emG2);box-shadow:0 0 0 3px rgba(34,197,94,0.15)':''}">
              <span style="font-size:22px">${s.icon}</span>
              <span style="font-size:13px;font-weight:700;color:${agreeForm.style===s.id?'var(--em)':'var(--t)'}">${s.label}</span>
            </button>`).join("")}
          </div>
        </div>

        <div class="card" style="padding:14px 16px;background:var(--bgE)">
          <div style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">3. Vorlage</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            ${shownTemplates.map(t=>`<button class="card clickable" onclick="selectTemplate('${t.id}')" style="padding:12px;display:flex;align-items:center;gap:12px;justify-content:flex-start;${agreeForm.template===t.id?'border-color:var(--ba);background:var(--emG2);box-shadow:0 0 0 3px rgba(34,197,94,0.15)':''}">
              <span style="font-size:28px">${t.icon}</span>
              <div style="text-align:left">
                <p style="font-size:14px;font-weight:700;margin:0;color:${agreeForm.template===t.id?'var(--em)':'var(--t)'}">${t.name}</p>
                <p style="font-size:12px;color:var(--tm);margin:2px 0 0">${t.tags.slice(0,2).join(" ¬∑ ")}</p>
              </div>
            </button>`).join("")}
          </div>
          ${secondary.length?`<div style="margin-top:10px;text-align:center">
            <button class="btn btn-ghost btn-sm" onclick="agreeToggleMoreTemplates()">${agreeForm.showMoreTemplates?"Weniger Vorlagen anzeigen":"Weitere Vorlagen anzeigen"}</button>
          </div>`:""}
        </div>

        <div style="position:sticky;bottom:0;z-index:5;margin-top:14px">
          <div style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1px solid var(--b);border-radius:12px;padding:10px 12px;box-shadow:0 -6px 16px rgba(0,0,0,0.04)">
            <div style="flex:1">
              <p style="font-size:12px;color:var(--tm);margin:0">Ausgew√§hlt</p>
              <p style="font-size:13px;font-weight:700;margin:2px 0 0">${selectedDebt?selectedDebt.name:"‚Äì"} ¬∑ ${styleObj.label} ¬∑ ${selectedTemplate?selectedTemplate.name:"‚Äì"}</p>
            </div>
            <button class="btn btn-primary" ${selectedTemplate?"":"disabled"} onclick="agreeForm.step=2;renderPage()">Weiter ‚Üí</button>
          </div>
        </div>
      </div>

      <aside class="card" style="padding:14px 16px;background:var(--bgE);position:sticky;top:8px">
        ${selectedTemplate?`
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <span style="font-size:28px">${selectedTemplate.icon}</span>
            <div><p style="font-size:14px;font-weight:800;margin:0">${selectedTemplate.name}</p><p style="font-size:12px;color:var(--tm);margin:2px 0 0">${selectedTemplate.desc}</p></div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">${selectedTemplate.tags.map(tag=>`<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg);color:var(--ts);font-weight:700">${tag}</span>`).join("")}</div>
        `:selectedDebt?`
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <span style="font-size:28px">${selectedDebt.emoji}</span>
            <div><p style="font-size:14px;font-weight:800;margin:0">${selectedDebt.name}</p><p style="font-size:12px;color:var(--tm);margin:2px 0 0">${fmt(selectedDebt.original-selectedDebt.paid)} offen</p></div>
          </div>
          ${selectedDebt.due?`<p style="font-size:12px;color:var(--tm);margin:0 0 8px">F√§llig am ${fD(selectedDebt.due)}</p>`:""}
        `:`
          <p style="font-size:12px;color:var(--tm);margin:0">Details erscheinen nach Auswahl.</p>
        `}
        <div style="margin-top:10px;padding:10px;border-radius:10px;background:var(--bg);border:1px solid var(--b)">
          <p style="font-size:12px;color:var(--tm);margin:0"><strong>Stil:</strong> ${styleObj.label}</p>
          <p style="font-size:12px;color:var(--tm);margin:4px 0 0">${styleObj.desc}</p>
        </div>
      </aside>
    </div>
  `;
}

function selectAgreeDebt(id){
  const d=debts.find(x=>x.id===id);
  agreeForm.debt=d;
  agreeForm.data.creditor=d.creditorName||d.name;
  // Try to split "Stra√üe Nr, PLZ Ort" into parts
  const ca=d.creditorAddress||"";
  const caParts=ca.split(",").map(s=>s.trim());
  if(caParts.length>=2){agreeForm.data.creditorStreet=caParts[0];const plzOrt=caParts[1].match(/^(\d{5})\s+(.+)/);if(plzOrt){agreeForm.data.creditorZip=d.creditorZip||plzOrt[1];agreeForm.data.creditorCity=d.creditorCity||plzOrt[2]}else{agreeForm.data.creditorZip=d.creditorZip||"";agreeForm.data.creditorCity=d.creditorCity||caParts[1]}}else{agreeForm.data.creditorStreet=ca;agreeForm.data.creditorZip=d.creditorZip||"";agreeForm.data.creditorCity=d.creditorCity||""}agreeForm.data.bankRef=agreeForm.data.bankRef||d.bankRef||"";
  agreeForm.data.amount=String(d.original-d.paid);
  agreeForm.data.rate=String(d.rate);
  renderPage();
}
function selectTemplate(tid){agreeForm.template=tid;renderPage();}

function agreeToggleMoreTemplates(){agreeForm.showMoreTemplates=!agreeForm.showMoreTemplates;renderPage();}

function rAgreeForm(){
  prefillAgreeFromUser();
  const t=templates.find(x=>x.id===agreeForm.template);
  const d=agreeForm.data;
  const showRate=["ratenzahlung","mahnung_antwort"].includes(agreeForm.template);
  const showOffer=["vergleich","teilzahlung"].includes(agreeForm.template);
  const showPause=agreeForm.template==="stundung";
  const showReason=["stundung","haertefall","mahnung_antwort"].includes(agreeForm.template);
  
  return`
    <button onclick="agreeForm.step=1;renderPage()" style="background:none;border:none;color:var(--tm);font-size:13px;display:flex;align-items:center;gap:6px;margin-bottom:24px;padding:0">‚Üê Zur√ºck zur Vorlagenauswahl</button>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
      <span style="font-size:32px">${t.icon}</span>
      <div><h2 style="font-size:20px;font-weight:800;margin:0">${t.name}</h2><p style="font-size:13px;color:var(--tm);margin:2px 0 0">${t.desc}</p></div>
    </div>
    
    <div class="grid2" style="gap:16px;margin-bottom:8px">
      <div>
        <div class="card" style="margin-bottom:16px">
          <h3 style="font-size:15px;font-weight:700;margin:0 0 16px">üìç Deine Angaben</h3>
          <div class="field"><label>Dein vollst√§ndiger Name</label><div class="input-wrap"><input id="agN" value="${d.name}" oninput="agreeForm.data.name=this.value" placeholder="Max Mustermann"></div></div>
          <div class="field"><label>Stra√üe und Hausnummer</label><div class="input-wrap"><input id="agSt" value="${d.street}" oninput="agreeForm.data.street=this.value" placeholder="Musterstra√üe 1"></div></div>
          <div style="display:grid;grid-template-columns:120px 1fr;gap:12px"><div class="field"><label>PLZ</label><div class="input-wrap"><input id="agZip" value="${d.zip}" oninput="agreeForm.data.zip=this.value" placeholder="12345" maxlength="5"></div></div><div class="field"><label>Ort</label><div class="input-wrap"><input id="agCity" value="${d.city}" oninput="agreeForm.data.city=this.value" placeholder="Berlin"></div></div></div>
        </div>
        <div class="card">
          <h3 style="font-size:15px;font-weight:700;margin:0 0 16px">üè¢ Gl√§ubiger</h3>
          <div class="field"><label>Name des Gl√§ubigers</label><div class="input-wrap"><input id="agC" value="${d.creditor}" oninput="agreeForm.data.creditor=this.value" placeholder="Firma / Person"></div></div>
          <div class="field"><label>Stra√üe und Hausnummer</label><div class="input-wrap"><input id="agCSt" value="${d.creditorStreet}" oninput="agreeForm.data.creditorStreet=this.value" placeholder="Leopoldstr. 88"></div></div>
          <div style="display:grid;grid-template-columns:120px 1fr;gap:12px"><div class="field"><label>PLZ</label><div class="input-wrap"><input id="agCZip" value="${d.creditorZip}" oninput="agreeForm.data.creditorZip=this.value" placeholder="80802" maxlength="5"></div></div><div class="field"><label>Ort</label><div class="input-wrap"><input id="agCCity" value="${d.creditorCity}" oninput="agreeForm.data.creditorCity=this.value" placeholder="M√ºnchen"></div></div></div>
          <div class="field"><label>Verwendungszweck / Referenz <span style="font-weight:400;color:var(--tf)">(optional)</span></label><div class="input-wrap"><input id="agRef" value="${d.bankRef||''}" oninput="agreeForm.data.bankRef=this.value" placeholder="z.B. Kunden-Nr., Vertragsnummer..."></div></div>
        </div>
      </div>
      <div>
        <div class="card">
          <h3 style="font-size:15px;font-weight:700;margin:0 0 16px">üí∞ Zahlungsdetails</h3>
          <div class="field"><label>Offener Gesamtbetrag</label><div class="input-wrap"><input id="agAm" type="number" value="${d.amount}" oninput="agreeForm.data.amount=this.value" placeholder="0"><span class="suffix">‚Ç¨</span></div></div>
          ${showRate?`<div class="field"><label>Vorgeschlagene Monatsrate</label><div class="input-wrap"><input id="agR" type="number" value="${d.rate}" oninput="agreeForm.data.rate=this.value;calcRate()" placeholder="0"><span class="suffix">‚Ç¨</span></div></div>

          <div style="background:var(--bgC);border:1px solid var(--b);border-radius:12px;padding:14px;margin-bottom:14px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <span style="font-size:14px">üßÆ</span>
              <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Ratenrechner</span>
            </div>
            <p style="font-size:12px;color:var(--tm);margin:0 0 10px">Laufzeit w√§hlen ‚Äì Rate wird automatisch berechnet:</p>
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
              ${[3,6,12,18,24,36].map(m=>`<button type="button" id="agCalcBtn${m}" onclick="applyCalcMonths(${m})" style="font-size:12px;padding:5px 10px;border-radius:8px;border:1px solid var(--b);background:var(--bgE);color:var(--tm);cursor:pointer;transition:all 0.15s">${m} Mo.</button>`).join("")}
            </div>
            <input type="range" id="agCalcSlider" min="1" max="48" value="${Math.round((d.amount||0)/(d.rate||1))||12}" oninput="applyCalcMonths(+this.value)" style="width:100%;accent-color:var(--em);margin-bottom:8px">
            <div id="agCalcResult" style="border-radius:10px;background:var(--emG);border:1px solid var(--ba);overflow:hidden">
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--ba)">
                <div style="padding:10px 12px;background:var(--emG2)">
                  <p style="font-size:10px;color:var(--tm);margin:0;text-transform:uppercase;letter-spacing:0.6px">Monatsrate</p>
                  <p id="agCalcRate" style="font-size:18px;font-weight:800;color:var(--em);margin:3px 0 0;line-height:1">‚Äì</p>
                </div>
                <div style="padding:10px 12px;background:var(--emG2)">
                  <p style="font-size:10px;color:var(--tm);margin:0;text-transform:uppercase;letter-spacing:0.6px">Laufzeit</p>
                  <p id="agCalcMonths" style="font-size:18px;font-weight:800;margin:3px 0 0;line-height:1">‚Äì</p>
                </div>
                <div style="padding:10px 12px;background:var(--emG2)">
                  <p style="font-size:10px;color:var(--tm);margin:0;text-transform:uppercase;letter-spacing:0.6px">Gesamtbetrag</p>
                  <p id="agCalcTotal" style="font-size:18px;font-weight:800;margin:3px 0 0;line-height:1">‚Äì</p>
                </div>
              </div>
              <div style="padding:8px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px">
                <p id="agCalcHint" style="font-size:11px;color:var(--tm);margin:0"></p>
                <button type="button" onclick="adoptCalcRate()" style="background:var(--em);color:#000;font-size:12px;font-weight:700;padding:7px 14px;border-radius:8px;border:none;cursor:pointer;white-space:nowrap;flex-shrink:0">‚Üë √úbernehmen</button>
              </div>
            </div>
          </div>

          <div class="field"><label>Beginn der Ratenzahlung</label><div class="input-wrap"><input id="agSD" type="date" value="${d.startDate}" oninput="agreeForm.data.startDate=this.value"></div></div>`:""}
          ${showOffer?`<div class="field"><label>Angebotener Betrag (reduziert)</label><div class="input-wrap"><input id="agOA" type="number" value="${d.offerAmount}" oninput="agreeForm.data.offerAmount=this.value" placeholder="0"><span class="suffix">‚Ç¨</span></div></div>
          <p style="font-size:12px;color:var(--am);margin:-8px 0 16px">üí° Tipp: 60‚Äì80% der Forderung sind oft verhandelbar</p>`:""}
          ${showPause?`<div class="field"><label>Stundung bis (Datum)</label><div class="input-wrap"><input id="agPU" type="date" value="${d.pauseUntil}" oninput="agreeForm.data.pauseUntil=this.value"></div></div>`:""}
          ${showReason?`<div class="field"><label>Begr√ºndung</label><div class="input-wrap"><input id="agRs" value="${d.reason}" oninput="agreeForm.data.reason=this.value" placeholder="z.B. Arbeitslosigkeit, Krankheit..."></div></div>`:""}
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end">
      <button class="btn btn-outline" onclick="agreeForm.step=1;renderPage()">Zur√ºck</button>
      <button class="btn btn-primary btn-lg" onclick="generateAgreement()">‚ú® Vereinbarung generieren</button>
    </div>`;
}

function generateAgreement(){
  const d=agreeForm.data;
  if(!d.name||!d.creditor||!d.amount){flash("Bitte mindestens Name, Gl√§ubiger und Betrag ausf√ºllen");return;}
  const doc=getDocContent();
  agreeForm.editBetreff=doc.betreff;
  agreeForm.editBody=doc.body;
  agreeForm.editClosing=doc.closing;
  agreeForm.step=3;renderPage();
}
function rAgreePreview(){
  const d=agreeForm.data;
  const t=templates.find(x=>x.id===agreeForm.template);
  const today=new Date().toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"});
  const styleLabels={formell:"‚öñÔ∏è Formell",kooperativ:"ü§ù Kooperativ",bestimmt:"‚ö° Bestimmt"};

  return`
    <button onclick="agreeForm.step=2;renderPage()" style="background:none;border:none;color:var(--tm);font-size:13px;display:flex;align-items:center;gap:6px;margin-bottom:20px;padding:0;cursor:pointer">‚Üê Zur√ºck zur Bearbeitung</button>

    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:46px;height:46px;border-radius:14px;background:var(--emG);border:1px solid var(--ba);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${t.icon}</div>
        <div>
          <h2 style="font-size:20px;font-weight:800;margin:0">${t.name}</h2>
          <p style="font-size:12px;color:var(--tm);margin:3px 0 0">Stil: <span style="color:var(--em);font-weight:600">${styleLabels[agreeForm.style]||"‚öñÔ∏è Formell"}</span> ¬∑ Pr√ºfe und passe den Text an</p>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" onclick="navigator.clipboard.writeText((document.getElementById('agEditBetreff')?.value||agreeForm.editBetreff)+'\n\nSehr geehrte Damen und Herren,\n\n'+(document.getElementById('agEditBody')?.value||agreeForm.editBody)+'\n\n'+(document.getElementById('agEditClosing')?.value||agreeForm.editClosing)+'\n\nMit freundlichen Gr√º√üen\n${d.name}').then(()=>flash('Text kopiert üìã'))">üìã Kopieren</button>
        <button class="btn btn-outline btn-sm" onclick="sendAgreeMail()">‚úâÔ∏è E-Mail</button>
        <button class="btn btn-primary btn-sm" onclick="agreeForm.editBetreff=document.getElementById('agEditBetreff')?.value||agreeForm.editBetreff;agreeForm.editBody=document.getElementById('agEditBody')?.value||agreeForm.editBody;agreeForm.editClosing=document.getElementById('agEditClosing')?.value||agreeForm.editClosing;openAgreementPdfPreview()" style="background:linear-gradient(135deg,#7C3AED,#6D28D9)">üìÑ PDF</button>
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:12px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;gap:10px">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Absender</span>
      </div>
      <div style="padding:14px 18px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
        <div style="font-size:13px;line-height:1.7;color:var(--t)">
          <strong>${d.name||""}</strong><br>
          ${d.street||""}<br>
          ${d.zip||""} ${d.city||""}
        </div>
        <div style="font-size:13px;color:var(--tm)">${d.city||""}, ${today}</div>
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:12px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b)">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Empf√§nger</span>
      </div>
      <div style="padding:14px 18px;font-size:13px;line-height:1.7;color:var(--t)">
        <strong>${d.creditor||""}</strong><br>
        ${d.creditorStreet||""}<br>
        ${d.creditorZip||""} ${d.creditorCity||""}
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:12px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Betreff</span>
        <span style="font-size:11px;color:var(--tm)">Bearbeitbar</span>
      </div>
      <div style="padding:10px 18px">
        <input id="agEditBetreff" value="${(agreeForm.editBetreff||"").replace(/"/g,'&quot;')}" oninput="agreeForm.editBetreff=this.value" style="width:100%;border:none;border-bottom:2px solid var(--b);outline:none;background:transparent;color:var(--t);font-size:14px;font-weight:700;padding:6px 0;transition:border-color 0.2s" onfocus="this.style.borderColor='var(--ba)'" onblur="this.style.borderColor='var(--b)'">
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:12px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Brieftext</span>
        <span style="font-size:11px;color:var(--tm)">Bearbeitbar</span>
      </div>
      <div style="padding:14px 18px">
        <p style="font-size:13px;color:var(--tm);margin:0 0 10px">Sehr geehrte Damen und Herren,</p>
        <textarea id="agEditBody" oninput="agreeForm.editBody=this.value" style="width:100%;min-height:220px;background:var(--bgE);border:1px solid var(--b);border-radius:10px;padding:12px 14px;color:var(--t);font-size:13px;line-height:1.6;font-family:inherit;resize:vertical;outline:none;transition:border-color 0.2s" onfocus="this.style.borderColor='var(--ba)'" onblur="this.style.borderColor='var(--b)'">${agreeForm.editBody||""}</textarea>
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:20px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Abschlusssatz</span>
        <span style="font-size:11px;color:var(--tm)">Bearbeitbar</span>
      </div>
      <div style="padding:10px 18px">
        <input id="agEditClosing" value="${(agreeForm.editClosing||"").replace(/"/g,'&quot;')}" oninput="agreeForm.editClosing=this.value" style="width:100%;border:none;border-bottom:2px solid var(--b);outline:none;background:transparent;color:var(--t);font-size:13px;padding:6px 0;transition:border-color 0.2s" onfocus="this.style.borderColor='var(--ba)'" onblur="this.style.borderColor='var(--b)'">
      </div>
      <div style="padding:10px 18px 14px;font-size:13px;color:var(--tm)">
        Mit freundlichen Gr√º√üen<br>
        <span style="color:var(--t);font-weight:600">${d.name||""}</span>
      </div>
    </div>


    <div class="card" style="padding:0;overflow:hidden;margin-bottom:20px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">‚úçÔ∏è Unterschrift</span>
        <div style="display:flex;gap:6px">
          <button onclick="sigSetMode('agree','draw')" id="agSigTabDraw" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--ba);background:var(--emG);color:var(--em);font-weight:600;cursor:pointer">‚úèÔ∏è Zeichnen</button>
          <button onclick="sigSetMode('agree','upload')" id="agSigTabUpload" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--b);background:transparent;color:var(--tm);cursor:pointer">üìÅ Hochladen</button>
          <button onclick="sigClear('agree')" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--b);background:transparent;color:var(--co);cursor:pointer">‚úï L√∂schen</button>
        </div>
      </div>
      <div style="padding:16px 18px">
        <div id="agSigDraw">
          <p style="font-size:12px;color:var(--tm);margin:0 0 8px">Mit Maus oder Finger unterschreiben:</p>
          <canvas id="agSigCanvas" style="width:100%;height:120px;border:2px dashed var(--b);border-radius:10px;background:#fff;cursor:crosshair;touch-action:none;display:block" onmouseenter="sigInitCanvas('agree')" ontouchstart="sigInitCanvas('agree')"></canvas>
        </div>
        <div id="agSigUpload" style="display:none">
          <p style="font-size:12px;color:var(--tm);margin:0 0 8px">Unterschriftsdatei hochladen (PNG, JPG):</p>
          <label style="display:flex;align-items:center;gap:10px;padding:12px 16px;border:2px dashed var(--b);border-radius:10px;cursor:pointer;background:var(--bgE)">
            <span style="font-size:22px">üìÅ</span>
            <span style="font-size:13px;color:var(--tm)">Datei ausw√§hlen oder hierher ziehen</span>
            <input type="file" accept="image/*" onchange="sigLoadFile('agree',this)" style="display:none">
          </label>
        </div>
        <div id="agSigPreview" style="display:none;margin-top:10px">
          <p style="font-size:11px;color:var(--em);margin:0 0 6px">‚úì Unterschrift gespeichert</p>
          <img id="agSigImg" style="max-height:80px;border-radius:8px;border:1px solid var(--b)">
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;padding-top:4px">
      <button class="btn btn-outline" onclick="agreeForm.step=2;renderPage()">‚úèÔ∏è Daten bearbeiten</button>
      <button class="btn btn-outline" onclick="agreeForm={debt:null,template:null,style:'formell',step:1,editBetreff:'',editBody:'',editClosing:'',data:{name:'',street:'',zip:'',city:'',creditor:'',creditorStreet:'',creditorZip:'',creditorCity:'',amount:'',rate:'',startDate:'',reason:'',offerAmount:'',pauseUntil:'',bankRef:''}};renderPage()">üîÑ Neue Vereinbarung</button>
      <button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="navigator.clipboard.writeText((document.getElementById('agEditBetreff')?.value||agreeForm.editBetreff)+'\n\nSehr geehrte Damen und Herren,\n\n'+(document.getElementById('agEditBody')?.value||agreeForm.editBody)+'\n\n'+(document.getElementById('agEditClosing')?.value||agreeForm.editClosing)+'\n\nMit freundlichen Gr√º√üen\n${d.name}').then(()=>flash('Text kopiert üìã'))">üìã Kopieren</button>
      <button class="btn btn-outline" onclick="sendAgreeMail()">‚úâÔ∏è E-Mail</button>
      <button class="btn btn-primary" onclick="agreeForm.editBetreff=document.getElementById('agEditBetreff')?.value||agreeForm.editBetreff;agreeForm.editBody=document.getElementById('agEditBody')?.value||agreeForm.editBody;agreeForm.editClosing=document.getElementById('agEditClosing')?.value||agreeForm.editClosing;openAgreementPdfPreview()" style="background:linear-gradient(135deg,#7C3AED,#6D28D9)">üìÑ PDF generieren</button>
    </div>`;
  setTimeout(()=>sigSetMode('agree','draw'), 200);
}

function copyAgreement(){
  const doc=getDocContent();
  const d=agreeForm.data;
  const text=`${d.name}\n${d.street}\n${d.zip} ${d.city}\n\n${doc.today}\n\n${d.creditor}\n${d.creditorStreet}\n${d.creditorZip} ${d.creditorCity}\n\nBetreff: ${doc.betreff}\n\nSehr geehrte Damen und Herren,\n\n${doc.body}\n\n${doc.closing}\n\nMit freundlichen Gr√º√üen\n${d.name}`;
  navigator.clipboard.writeText(text).then(()=>flash("Text in Zwischenablage kopiert! üìã")).catch(()=>flash("Kopieren fehlgeschlagen"));
}

function printAgreement(){
  const doc=getDocContent();
  const d=agreeForm.data;
  const w=window.open("","_blank");
  w.document.write(`<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"><title>${doc.betreff}</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial,sans-serif;font-size:11pt;line-height:1.7;color:#1a1a1a;background:#fff}
  .page{max-width:800px;margin:0 auto;padding:25mm 22mm 20mm 25mm}
  @media print{.page{padding:14mm 18mm 14mm 22mm}}
  .letterhead{display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:12px;border-bottom:2px solid #1a1a1a;margin-bottom:20px}
  .sender .name{font-size:13pt;font-weight:700;margin-bottom:4px}
  .sender-small{font-size:8.5pt;color:#777;border-bottom:1px solid #ccc;padding-bottom:4px;margin-bottom:8px}
  .date-block{text-align:right;font-size:10.5pt;color:#444}
  .recipient{margin-bottom:22px;line-height:1.8}
  .subject{font-size:12pt;font-weight:700;text-decoration:underline;text-underline-offset:3px;margin:22px 0 18px}
  .body-text{white-space:pre-wrap;margin-bottom:16px;text-align:justify}
  .closing-text{text-align:justify;margin-bottom:30px}
  .sig-area{margin-top:52px}
  .sig-line{border-top:1px solid #1a1a1a;width:240px;margin-bottom:4px}
  .footer{margin-top:44px;padding-top:8px;border-top:1px solid #ccc;font-size:8pt;color:#999;text-align:center}
</style></head><body>
<div class="page">
  <div class="letterhead">
    <div class="sender">
      <div class="sender-small">${d.name||""} ¬∑ ${d.street||""} ¬∑ ${d.zip||""} ${d.city||""}</div>
      <div class="name">${d.name||"[Name]"}</div>
      <div>${d.street||"[Stra√üe Hausnummer]"}</div>
      <div>${d.zip||"[PLZ]"} ${d.city||"[Ort]"}</div>
    </div>
    <div class="date-block">${d.city||"[Ort]"}, ${doc.today}</div>
  </div>
  <div class="recipient">
    <strong>${d.creditor||"[Gl√§ubiger]"}</strong><br>
    ${d.creditorStreet||"[Stra√üe Hausnummer]"}<br>
    ${d.creditorZip||"[PLZ]"} ${d.creditorCity||"[Ort]"}
  </div>
  <div class="subject">Betreff: ${doc.betreff}</div>
  <p style="margin-bottom:14px">Sehr geehrte Damen und Herren,</p>
  <div class="body-text">${doc.body}</div>
  <div class="closing-text">${doc.closing}</div>
  <div class="sig-area">
    <p style="margin-bottom:44px">Mit freundlichen Gr√º√üen</p>
    <div class="sig-line"></div>
    <strong>${d.name||""}</strong>
    <div style="font-size:9.5pt;color:#555;margin-top:3px">${d.street||""}, ${d.zip||""} ${d.city||""}</div>
  </div>
  <div class="footer">Erstellt mit Ratenova ¬∑ ratenova.de</div>
</div></div>
</div></body></html>`);
  w.document.close();
  setTimeout(()=>w.print(),350);
}


function getDocContent(){
  const d=agreeForm.data;
  const today=new Date().toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"});
  const amt=parseFloat(d.amount)||0;
  const rate=parseFloat(d.rate)||0;
  const offer=parseFloat(d.offerAmount)||0;
  const months=rate>0?Math.ceil(amt/rate):0;
  const t=agreeForm.template;
  const s=agreeForm.style||"formell";
  const debtName=agreeForm.debt?agreeForm.debt.name:"die offene Forderung";
  const iban=agreeForm.debt?.bankIban||"";
  const bic=agreeForm.debt?.bankBic||"";
  const bankRef=agreeForm.data?.bankRef||agreeForm.debt?.bankRef||"";
  const nextFirst=(()=>{const n=new Date();n.setMonth(n.getMonth()+1);n.setDate(1);return n.toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"})})();
  const zahlungsblock=(extra="")=>`    Offene Gesamtforderung:      ${fmt(amt)}
    Vorgeschlagene Monatsrate:   ${fmt(rate)}
    Voraussichtliche Laufzeit:   ${months} Monate
    Zahlungsbeginn:              ${d.startDate?fDL(d.startDate):nextFirst}
    Zahlungsweg:                 monatliche √úberweisung${bankRef?`\n    Verwendungszweck:            ${bankRef}`:""}${extra}`;

  let betreff="",body="",closing="";

  // ‚îÄ‚îÄ‚îÄ RATENZAHLUNG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(t==="ratenzahlung"){
    betreff=`Ratenzahlungsvereinbarung ‚Äì ${debtName}${bankRef?" ¬∑ Ref.: "+bankRef:""}`;
    if(s==="kooperativ"){
      body=`ich hoffe, dieses Schreiben erreicht Sie gut. Ich m√∂chte mich wegen der offenen Forderung √ºber ${fmt(amt)} aus ${debtName} bei Ihnen melden ‚Äì und zwar mit einem konkreten L√∂sungsvorschlag.

Ich stehe zu meiner Zahlungsverpflichtung und m√∂chte alles daf√ºr tun, diese zu erf√ºllen. Meine aktuelle Situation${d.reason?` ‚Äì ${d.reason} ‚Äì`:""} macht eine Einmalzahlung leider schwierig. Daher schlage ich folgenden Ratenplan vor, mit dem ich die Forderung zuverl√§ssig abtragen kann:

${zahlungsblock()}

Ich bin zuversichtlich, dass wir gemeinsam eine gute L√∂sung finden. Falls Sie Anpassungsw√ºnsche haben, spreche ich gerne dar√ºber.`;
      closing=`Bitte lassen Sie mich wissen, ob Sie mit dem Ratenplan einverstanden sind ‚Äì am liebsten kurz schriftlich, damit wir direkt starten k√∂nnen. Ich freue mich auf Ihre R√ºckmeldung und danke Ihnen herzlich f√ºr Ihre Offenheit.`;
    } else if(s==="bestimmt"){
      body=`hiermit stelle ich Ihnen einen verbindlichen Ratenplan zur Begleichung der offenen Forderung von ${fmt(amt)} aus ${debtName} vor.

Ich bin zahlungswillig und -f√§hig im Rahmen der unten genannten Konditionen. Eine Einmalzahlung ist${d.reason?` aufgrund von ${d.reason}`:" aus finanziellen Gr√ºnden"} nicht m√∂glich. Ich erwarte, dass Sie diesen Vorschlag ernsthaft pr√ºfen:

${zahlungsblock()}

Die Raten werden p√ºnktlich zum 1. Werktag des Monats √ºberwiesen. Ich weise ausdr√ºcklich darauf hin, dass dieser Plan das Maximum meiner aktuellen Leistungsf√§higkeit darstellt. Eine Ablehnung ohne Gegenangebot w√ºrde die Angelegenheit f√ºr beide Seiten unn√∂tig verkomplizieren.`;
      closing=`Ich bitte um schriftliche Best√§tigung Ihres Einverst√§ndnisses innerhalb von 10 Werktagen. Nur so kann die Ratenzahlung plangem√§√ü aufgenommen werden.`;
    } else {
      body=`mit diesem Schreiben wende ich mich an Sie in der Angelegenheit der oben bezeichneten offenen Forderung in H√∂he von ${fmt(amt)} betreffend ${debtName}.

Ich bin mir meiner Zahlungsverpflichtung Ihnen gegen√ºber vollst√§ndig bewusst und m√∂chte diese in jedem Fall erf√ºllen. Meine derzeitige finanzielle Situation${d.reason?` ‚Äì bedingt durch ${d.reason} ‚Äì`:""} erlaubt es mir jedoch nicht, den Gesamtbetrag in einer Summe zu begleichen. Um eine einvernehmliche und f√ºr beide Seiten tragf√§hige L√∂sung zu finden, erlaube ich mir, folgenden Ratenplan vorzuschlagen:

${zahlungsblock()}

Die Raten werden jeweils sp√§testens zum 1. Werktag des Monats auf Ihr Konto √ºberwiesen. Ich versichere ausdr√ºcklich, die vereinbarten Betr√§ge p√ºnktlich und vollst√§ndig zu leisten.`;
      closing=`Ich ersuche Sie, mir Ihr Einverst√§ndnis schriftlich zu best√§tigen, damit die vereinbarte Ratenzahlung planm√§√üig aufgenommen werden kann. F√ºr Ihre Kooperationsbereitschaft in dieser Angelegenheit bedanke ich mich im Voraus.`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ VERGLEICH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  else if(t==="vergleich"){
    const pct=amt>0?Math.round(offer/amt*100):0;
    betreff=`${s==="bestimmt"?"Letztes Vergleichsangebot":"Au√üergerichtlicher Vergleich"} ‚Äì ${debtName}${bankRef?" ¬∑ Ref.: "+bankRef:""}`;
    const vergleichsblock=`    Urspr√ºngliche Forderung:     ${fmt(amt)}
    Mein Vergleichsangebot:      ${fmt(offer)} (${pct}% der Gesamtforderung)
    Restforderungserlass:        ${fmt(amt-offer)}
    Zahlungsfrist:               ${s==="bestimmt"?"7":"14"} Tage nach schriftlicher Annahme
    Zahlungsweg:                 √úberweisung${bankRef?`\n    Verwendungszweck:            ${bankRef}`:""}`;
    if(s==="kooperativ"){
      body=`ich m√∂chte Ihnen heute ein konkretes Vergleichsangebot unterbreiten, mit dem wir die offene Forderung von ${fmt(amt)} aus ${debtName} gemeinsam und f√ºr beide Seiten abschlie√üend l√∂sen k√∂nnen.

Meine finanzielle Situation${d.reason?`, bedingt durch ${d.reason},`:""} l√§sst leider keine vollst√§ndige Begleichung zu. Daf√ºr bin ich in der Lage, folgende Einmalzahlung anzubieten:

${vergleichsblock}

Im Gegenzug bitte ich Sie, die Restforderung als erledigt zu betrachten und alle laufenden Ma√ünahmen einzustellen. Ich denke, das ist f√ºr uns beide die praktischste L√∂sung.`;
      closing=`Ich w√ºrde mich sehr freuen, wenn Sie dieses Angebot annehmen. Bitte best√§tigen Sie mir kurz schriftlich ‚Äì dann √ºberweise ich den Betrag umgehend.`;
    } else if(s==="bestimmt"){
      body=`ich unterbreite Ihnen hiermit ein letztes Vergleichsangebot zur Forderung von ${fmt(amt)} aus ${debtName}. Dies ist mein abschlie√üendes Angebot.

${vergleichsblock}

Bei Annahme erlosche ich s√§mtliche Restforderungen als beglichen. Bei Ablehnung sehe ich mich gezwungen, andere rechtliche Wege zu pr√ºfen. Ich weise darauf hin, dass ${fmt(offer)} das absolute Maximum meiner finanziellen Leistungsf√§higkeit ist.`;
      closing=`Bitte teilen Sie mir Ihre Entscheidung innerhalb von 7 Werktagen schriftlich mit. Nach Ablauf dieser Frist gilt das Angebot als zur√ºckgezogen.`;
    } else {
      body=`mit diesem Schreiben unterbreite ich Ihnen ein formelles Vergleichsangebot zur einvernehmlichen Beilegung der zwischen uns bestehenden Forderung in H√∂he von ${fmt(amt)} aus ${debtName}.

Meine aktuelle finanzielle Situation${d.reason?`, die durch ${d.reason} entstanden ist,`:""} macht es mir leider unm√∂glich, den vollst√§ndigen Forderungsbetrag zu begleichen. Ich schlage daher folgende Einigung vor:

${vergleichsblock}

Im Gegenzug bitte ich Sie, die Restforderung dauerhaft zu erlassen und die Angelegenheit als vollst√§ndig erledigt zu betrachten.`;
      closing=`Falls Sie dieses Vergleichsangebot annehmen, ersuche ich Sie um eine schriftliche Best√§tigung. Bei Annahme werde ich die vereinbarte Summe unverz√ºglich √ºberweisen.`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ STUNDUNG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  else if(t==="stundung"){
    betreff=`Stundungsantrag ‚Äì ${debtName}${bankRef?" ¬∑ Ref.: "+bankRef:""}`;
    const stundungsblock=`    Offene Forderung:            ${fmt(amt)}
    Beantragte Stundung bis:     ${d.pauseUntil?fDL(d.pauseUntil):"[Datum bitte erg√§nzen]"}
    Wiederaufnahme der Zahlung:  ${d.pauseUntil?`ab ${fDL(d.pauseUntil)}`:"nach Ablauf der Stundungsfrist"}${rate>0?`\n    Monatliche Rate danach:      ${fmt(rate)}`:""}`;
    if(s==="kooperativ"){
      body=`ich wende mich heute mit einer Bitte an Sie ‚Äì und ich hoffe auf Ihr Verst√§ndnis.

Durch ${d.reason||"unvorhergesehene Umst√§nde"} bin ich vor√ºbergehend nicht in der Lage, die Forderung von ${fmt(amt)} aus ${debtName} zu bedienen. Diese Situation ist zeitlich begrenzt, und ich m√∂chte transparent mit Ihnen dar√ºber kommunizieren.

Ich bitte daher um eine kurze Stundung nach folgendem Rahmen:

${stundungsblock}

Ich werde die Stundungszeit nutzen, um meine Situation zu stabilisieren, und danach zuverl√§ssig zahlen.`;
      closing=`Ich w√§re Ihnen sehr dankbar, wenn Sie meiner Bitte entsprechen. Gerne best√§tige ich Ihnen auf Anfrage meine Situation durch entsprechende Unterlagen.`;
    } else if(s==="bestimmt"){
      body=`hiermit beantrage ich formell die Stundung der Forderung von ${fmt(amt)} aus ${debtName}.

Grund: ${d.reason||"tempor√§re finanzielle Einschr√§nkung"}. Die Stundung ist sachlich begr√ºndet und zeitlich klar befristet:

${stundungsblock}

Ich weise darauf hin, dass ich nach Ablauf der Stundungsfrist vollst√§ndig zahlungsf√§hig sein werde. Eine Ablehnung ohne Alternative w√ºrde die Situation f√ºr beide Seiten verschlechtern.`;
      closing=`Bitte best√§tigen Sie die Stundung schriftlich innerhalb von 5 Werktagen. Ich stehe f√ºr R√ºckfragen zur Verf√ºgung.`;
    } else {
      body=`mit diesem Schreiben bitte ich Sie formell um eine vor√ºbergehende Stundung der bestehenden Forderung in H√∂he von ${fmt(amt)} aus ${debtName}.

${d.reason?`Durch ${d.reason} befinde ich mich derzeit in einer unverschuldeten finanziellen Ausnahmesituation.`:"Aufgrund unvorhergesehener Umst√§nde befinde ich mich derzeit in einer tempor√§ren finanziellen Notlage."} Ich beantrage daher folgende Stundungsregelung:

${stundungsblock}

Ich versichere Ihnen, dass ich w√§hrend der Stundungszeit alle notwendigen Schritte zur Verbesserung meiner finanziellen Lage unternehmen werde.`;
      closing=`Ich bitte Sie, meinem Stundungsantrag stattzugeben und mir Ihre Entscheidung schriftlich mitzuteilen. Ich danke Ihnen f√ºr Ihr Verst√§ndnis.`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ TEILZAHLUNG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  else if(t==="teilzahlung"){
    betreff=`Teilzahlungsangebot ‚Äì ${debtName}${bankRef?" ¬∑ Ref.: "+bankRef:""}`;
    const teilblock=`    Urspr√ºngliche Forderung:     ${fmt(amt)}
    Angebotene Einmalzahlung:    ${fmt(offer)}
    Zahlungsfrist:               7 Werktage nach schriftlicher Annahme
    Zahlungsweg:                 √úberweisung${bankRef?`\n    Verwendungszweck:            ${bankRef}`:""}`;
    if(s==="kooperativ"){
      body=`ich m√∂chte Ihnen heute eine praktische L√∂sung f√ºr die offene Forderung von ${fmt(amt)} aus ${debtName} anbieten.

Nach ehrlicher Pr√ºfung meiner M√∂glichkeiten kann ich Ihnen folgende Einmalzahlung anbieten, die die Angelegenheit f√ºr uns beide abschlie√üend l√∂st:

${teilblock}

Ich bitte Sie, diese Zahlung als vollst√§ndige Erf√ºllung zu akzeptieren. ${d.reason?`Hintergrund: ${d.reason}.`:""}Ich wei√ü, dass das den Gesamtbetrag unterschreitet ‚Äì aber es ist das Beste, was ich tun kann.`;
      closing=`Ich freue mich auf Ihre Zustimmung. Bei Annahme √ºberweise ich sofort. Vielen Dank f√ºr Ihre Bereitschaft, gemeinsam eine L√∂sung zu finden.`;
    } else if(s==="bestimmt"){
      body=`hiermit unterbreite ich Ihnen mein abschlie√üendes Angebot zur Forderung von ${fmt(amt)} aus ${debtName}:

${teilblock}

${d.reason?`Aufgrund von ${d.reason} ist`:"Es ist"} dies das Maximum meiner finanziellen Leistungsf√§higkeit. Ich erwarte eine sachliche Pr√ºfung dieses Angebots. Bei Annahme ist die Forderung vollst√§ndig und endg√ºltig erledigt ‚Äì weitere Geltendmachung w√§re ausgeschlossen.`;
      closing=`Bitte teilen Sie mir Ihre Entscheidung innerhalb von 7 Werktagen mit. Ohne R√ºckmeldung behalte ich mir vor, rechtliche Beratung einzuholen.`;
    } else {
      body=`mit diesem Schreiben wende ich mich an Sie bez√ºglich der offenen Forderung in H√∂he von ${fmt(amt)} aus ${debtName}.

Nach eingehender Pr√ºfung meiner finanziellen Verh√§ltnisse bin ich in der Lage, folgende einmalige Teilzahlung als abschlie√üende Regelung anzubieten:

${teilblock}

${d.reason?`Der Grund f√ºr die Beschr√§nkung meiner Zahlungsf√§higkeit liegt in: ${d.reason}.`:""} Ich bitte Sie, diese Zahlung als vollst√§ndige und endg√ºltige Erf√ºllung der Forderung zu akzeptieren.`;
      closing=`F√ºr eine z√ºgige schriftliche R√ºckmeldung w√§re ich sehr dankbar. Bei Annahme stelle ich die Zahlung unverz√ºglich sicher.`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ MAHNUNG ANTWORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  else if(t==="mahnung_antwort"){
    betreff=`Stellungnahme zu Ihrer Mahnung ‚Äì ${debtName}${bankRef?" ¬∑ Ref.: "+bankRef:""}`;
    const mahnblock=`    Offene Forderung:            ${fmt(amt)}
    Vorgeschlagene Monatsrate:   ${fmt(rate)}
    Voraussichtliche Laufzeit:   ${months} Monate
    Zahlungsbeginn:              ${d.startDate?fDL(d.startDate):"ab sofort"}
    Zahlungsweg:                 monatliche √úberweisung${bankRef?`\n    Verwendungszweck:            ${bankRef}`:""}`;
    if(s==="kooperativ"){
      body=`ich habe Ihr Mahnschreiben erhalten und m√∂chte mich zun√§chst aufrichtig f√ºr die entstandene Verz√∂gerung entschuldigen ‚Äì das war nicht meine Absicht.

Ich stehe voll zu meiner Verpflichtung und m√∂chte die Angelegenheit schnellstm√∂glich kl√§ren. ${d.reason?`Aufgrund von ${d.reason} ist`:"Eine"} eine Sofortzahlung aktuell leider nicht m√∂glich. Daf√ºr kann ich Ihnen folgenden zuverl√§ssigen Ratenplan anbieten:

${mahnblock}

Ich bin zuversichtlich, dass wir so zu einer guten L√∂sung kommen, und danke Ihnen f√ºr Ihre Geduld.`;
      closing=`Bitte geben Sie mir kurz Bescheid, ob Sie mit dem Plan einverstanden sind. Ich bin jederzeit ansprechbar und freue mich auf eine konstruktive R√ºckmeldung.`;
    } else if(s==="bestimmt"){
      body=`Ihr Mahnschreiben habe ich zur Kenntnis genommen. Ich bin zahlungswillig und lege Ihnen hiermit einen verbindlichen Ratenplan vor:

${mahnblock}

Ich fordere Sie auf, von weiteren Ma√ünahmen abzusehen, solange dieser Plan eingehalten wird. ${d.reason?`Die Verz√∂gerung ist auf ${d.reason} zur√ºckzuf√ºhren`:"Die Verz√∂gerung hat nachvollziehbare Gr√ºnde"} und stellt keine Zahlungsverweigerung dar.`;
      closing=`Best√§tigen Sie bitte schriftlich den Ratenplan. Ich werde die erste Rate fristgerecht leisten.`;
    } else {
      body=`Ihr Mahnschreiben habe ich erhalten und zur Kenntnis genommen. Ich m√∂chte mich f√ºr die entstandene Verz√∂gerung entschuldigen und Ihnen versichern, dass ich gewillt bin, meinen Verpflichtungen nachzukommen.

${d.reason?`Leider befinde ich mich derzeit aufgrund von ${d.reason} in einer finanziellen Engpasssituation.`:"Eine sofortige vollst√§ndige Begleichung ist mir derzeit nicht m√∂glich."} Ich unterbreite Ihnen folgenden L√∂sungsvorschlag:

${mahnblock}

Ich bitte Sie, von der Einleitung weiterer Ma√ünahmen abzusehen und mir die M√∂glichkeit zu geben, die Forderung in Raten abzutragen.`;
      closing=`Ich danke Ihnen f√ºr Ihr Verst√§ndnis und erwarte Ihre baldige R√ºckmeldung.`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ H√ÑRTEFALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  else if(t==="haertefall"){
    betreff=`H√§rtefallantrag ‚Äì ${debtName}${bankRef?" ¬∑ Ref.: "+bankRef:""}`;
    const haerteblock=`${d.reason?`    Ursache der Notlage:         ${d.reason}`:"    Ursache der Notlage:         [bitte erg√§nzen]"}
    Betroffene Forderung:        ${fmt(amt)}
    M√∂gliche monatliche Leistung:${rate>0?` ${fmt(rate)}`:" derzeit nicht m√∂glich"}
    Nachweis:                    liegt auf Anfrage vor`;
    if(s==="kooperativ"){
      body=`ich wende mich heute mit einem sehr pers√∂nlichen Anliegen an Sie und bitte Sie von Herzen um Ihr Verst√§ndnis.

${d.reason?`Durch ${d.reason} befinde ich`:"Ich befinde"} mich in einer ernsthaften finanziellen Notlage, die ich so nicht vorhergesehen habe. Ich m√∂chte transparent mit Ihnen sein:

${haerteblock}

Ich bin nicht in der Lage, die Forderung von ${fmt(amt)} derzeit zu begleichen ‚Äì aber ich gebe nicht auf und suche aktiv nach Wegen. Ich w√ºrde mich sehr freuen, wenn Sie mir entgegenkommen k√∂nnten.`;
      closing=`Jede Form der Kulanz ‚Äì ob Erlass, Stundung oder individuelle Rate ‚Äì w√ºrde mir in dieser schwierigen Zeit enorm helfen. Ich danke Ihnen von Herzen f√ºr Ihre Menschlichkeit.`;
    } else if(s==="bestimmt"){
      body=`hiermit beantrage ich formell eine H√§rtefallregelung f√ºr die Forderung von ${fmt(amt)} aus ${debtName}.

Sachverhalt:
${haerteblock}

Ich bin vollst√§ndig bereit, alle erforderlichen Nachweise einzureichen. Ich erwarte, dass mein Antrag ernsthaft gepr√ºft wird. Eine schematische Ablehnung ohne individuelle Pr√ºfung w√ºrde ich nicht akzeptieren.`;
      closing=`Bitte teilen Sie mir innerhalb von 10 Werktagen mit, welche Regelung Sie anbieten k√∂nnen. Ich bin f√ºr ein kl√§rendes Gespr√§ch jederzeit verf√ºgbar.`;
    } else {
      body=`mit diesem Schreiben wende ich mich in einer dringenden pers√∂nlichen Angelegenheit an Sie und bitte um Pr√ºfung eines besonderen H√§rtefalls bez√ºglich der offenen Forderung in H√∂he von ${fmt(amt)} aus ${debtName}.

${d.reason?`Aufgrund von ${d.reason} befinde ich mich`:"Ich befinde mich"} gegenw√§rtig in einer au√üergew√∂hnlichen und unverschuldeten Notlage.

Zusammenfassung meiner Situation:
${haerteblock}

Ich bin vollst√§ndig bereit, alle erforderlichen Belege vorzulegen, um den H√§rtefall zu dokumentieren. Ich ersuche Sie, mir entgegenzukommen ‚Äì sei es durch Erlass, Stundung oder individuelle Vereinbarung.`;
      closing=`Ich hoffe auf Ihr Einf√ºhlungsverm√∂gen und Ihre Bereitschaft, eine menschlich vertretbare L√∂sung zu finden. Ich danke Ihnen im Voraus f√ºr Ihre R√ºcksichtnahme.`;
    }
  }

  return{betreff,body,closing,today};
}

function rTime(){const T=gT(),allP=debts.flatMap(d=>d.history.map(h=>({...h,dn:d.name,e:d.emoji}))).sort((a,b)=>new Date(b.date)-new Date(a.date));
return`<h1 style="font-size:24px;font-weight:800;margin:0 0 24px">Verlauf & Statistiken</h1><div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px">${[{l:"Fortschritt",v:fmt2(T.p),c:"var(--em)"},{l:"Offen",v:fmt2(T.r),c:"var(--co)"},{l:"Zahlungen",v:debts.reduce((s,d)=>s+d.history.length,0),c:"var(--sk)"},{l:"Streak",v:"6 Mo üî•",c:"var(--am)"}].map(s=>`<div class="card" style="flex:1;min-width:130px;padding:16px"><p style="font-size:11px;font-weight:600;color:var(--tm);text-transform:uppercase;letter-spacing:1px;margin:0 0 10px">${s.l}</p><p style="font-size:24px;font-weight:700;margin:0;color:${s.c};line-height:1">${s.v}</p></div>`).join("")}</div><div class="card" style="padding:22px"><h3 style="font-size:15px;font-weight:700;margin:0 0 16px">Letzte Zahlungen</h3>${allP.slice(0,12).map((h,i)=>`<div style="display:flex;align-items:center;gap:12px;padding:10px 0;${i<11?"border-bottom:1px solid var(--b)":""}"><span style="font-size:18px">${h.e}</span><div style="flex:1"><span style="font-size:13px;font-weight:500">${h.dn}</span>${h.note?`<span style="font-size:12px;color:var(--tm)"> ¬∑ ${h.note}</span>`:""}</div><span style="font-size:12px;color:var(--tm)">${fD(h.date)}</span><span style="font-size:14px;font-weight:700;color:var(--em);min-width:60px;text-align:right">${fmt2(h.amount)}</span></div>`).join("")}</div>`}

let budgetItems=[];
let currentBudgetMonth=(new Date().toISOString().slice(0,7));
let dashboardCompact=(function(){try{return JSON.parse(localStorage.getItem("dashboardCompact")||"true")}catch(e){return true}})();
function toggleDashboardCompact(){dashboardCompact=!dashboardCompact;try{localStorage.setItem("dashboardCompact",JSON.stringify(dashboardCompact))}catch(e){};renderPage()}
let contracts=[];
function calcBudgetStats(month=currentBudgetMonth){
  const manualItems=budgetItems.filter(i=>i.date&&i.date.startsWith(month));
  const monthEnd=`${month}-31`;
  const plannedDebtExpenses=debts.filter(d=>d.paid<d.original).flatMap(d=>{
    const ps=getPaymentStatus(d),remaining=Math.max(d.original-d.paid,0),dueDay=((d.due||"").split("-")[2]||"01");
    const pDate=`${month}-${dueDay}`;
    if(ps==="ratenplan_aktiv")return [{amount:Math.min(d.rate||0,remaining)}];
    if(ps==="faellig_einmalig"&&(d.due||"").startsWith(month))return [{amount:remaining}];
    if(ps==="ueberfaellig"&&((d.due||"")<=monthEnd))return [{amount:remaining}];
    return [];
  });
  const inc=manualItems.filter(i=>i.type==="income").reduce((s,i)=>s+(i.amount||0),0);
  const debtExp=plannedDebtExpenses.reduce((s,i)=>s+(i.amount||0),0);
  const exp=manualItems.filter(i=>i.type==="expense").reduce((s,i)=>s+(i.amount||0),0)+debtExp;
  const bal=inc-exp;
  const monthLabel=new Date(month+"-01T00:00:00").toLocaleDateString("de-DE",{month:"long",year:"numeric"});
  return{inc,exp,bal,monthLabel,debtExp};
}
const cancelTemplates=[
  {id:"ordentlich",name:"Ordentliche K√ºndigung",icon:"üìÑ",desc:"Fristgerechte K√ºndigung zum n√§chstm√∂glichen Termin",tags:["Standard","Frist"]},
  {id:"ausserordentlich",name:"Au√üerordentliche K√ºndigung",icon:"‚ö†Ô∏è",desc:"K√ºndigung aus wichtigem Grund",tags:["Sonderfall","Sofort"]},
  {id:"preissteigerung",name:"K√ºndigung wegen Preiserh√∂hung",icon:"üìà",desc:"Beendigung wegen nicht akzeptierter Preis√§nderung",tags:["Kosten","Sonderrecht"]},
  {id:"widerruf",name:"Widerruf (14 Tage)",icon:"‚Ü©Ô∏è",desc:"Widerruf bei Neuabschluss innerhalb der Frist",tags:["Widerruf","Neuvertrag"]},
];
let cancelForm={contractId:null,template:null,style:"formell",showMoreTemplates:false,step:1,editSubject:"",editBody:"",editClosing:"",data:{senderName:"",senderStreet:"",senderZip:"",senderCity:"",senderEmail:"",reason:"",effectiveDate:"",customNote:""}};
function contractAnnualCost(c){const m=+c.monthlyCost||0,y=+c.yearlyCost||0;return y>0?y:m*12}
function contractIncreasePct(c){const prev=+c.previousAnnualCost||0,cur=contractAnnualCost(c);if(prev<=0)return 0;return Math.round(((cur-prev)/prev)*100)}
function contractDelta(c){const prev=+c.previousAnnualCost||0;return prev>0?contractAnnualCost(c)-prev:0}
function contractEffectiveDeadline(c){
  if(c.cancelBy)return c.cancelBy;
  if(!c.startDate||!(+c.minTermMonths>0)||!(+c.noticeDays>0))return "";
  const d=new Date(c.startDate+"T00:00:00");
  d.setMonth(d.getMonth()+(+c.minTermMonths));
  d.setDate(d.getDate()-(+c.noticeDays));
  return d.toISOString().slice(0,10);
}
function contractDaysLeft(c){const dead=contractEffectiveDeadline(c);if(!dead)return null;return Math.ceil((new Date(dead+"T00:00:00")-new Date())/864e5)}
function contractStatusBadge(c){const days=contractDaysLeft(c);if(c.status==="cancelled")return `<span class="badge" style="background:rgba(160,163,177,0.16);color:var(--ts)"><span class="badge-dot" style="background:var(--ts)"></span>Gek√ºndigt</span>`;if(days!==null&&days<=14)return `<span class="badge" style="background:var(--coG);color:var(--co)"><span class="badge-dot" style="background:var(--co)"></span>Frist akut</span>`;if(days!==null&&days<=45)return `<span class="badge" style="background:var(--amG);color:var(--am)"><span class="badge-dot" style="background:var(--am)"></span>Frist bald</span>`;return `<span class="badge" style="background:var(--emG);color:var(--em)"><span class="badge-dot" style="background:var(--em)"></span>Aktiv</span>`}
function contractLetter(c){const name=[user.firstName||"",user.lastName||""].join(" ").trim()||user.name||"",deadline=contractEffectiveDeadline(c),contractNo=c.contractNo?`\nVertragsnummer: ${c.contractNo}`:"";return`Betreff: K√ºndigung ${c.name||"Vertrag"}${contractNo}\n\nSehr geehrte Damen und Herren,\n\nhiermit k√ºndige ich meinen Vertrag \"${c.name||""}\" fristgerecht zum n√§chstm√∂glichen Termin.${deadline?`\nNach meiner Berechnung muss die K√ºndigung bis zum ${fDL(deadline)} eingehen.`:""}\n\nBitte best√§tigen Sie mir schriftlich den Erhalt sowie das Vertragsende.\n\nKundendaten:\nName: ${name}\nE-Mail: ${user.email||""}\n${c.paymentMethod?`Zahlungsart: ${c.paymentMethod}\n`:""}\nMit freundlichen Gr√º√üen\n${name}`;}
function contractCategorySummary(){
  const map={};
  contracts.forEach(c=>{const k=(c.category||"Sonstiges").trim()||"Sonstiges";map[k]=(map[k]||0)+contractAnnualCost(c)});
  return Object.entries(map).sort((a,b)=>b[1]-a[1]);
}
function rContracts(){
  if(window._contractDetail){return rContractDetail(window._contractDetail);}
  const filter=window._contractFilter||'all';
  const totalAnnual=contracts.reduce((s,c)=>s+contractAnnualCost(c),0);
  const raised=contracts.filter(c=>contractIncreasePct(c)>=10);
  const urgent=contracts.filter(c=>{const d=contractDaysLeft(c);return d!==null&&d<=30&&c.status!=='cancelled';});
  const totalDelta=contracts.reduce((s,c)=>s+contractDelta(c),0);
  const monthlyCost=totalAnnual/12;
  const mode=window._contractCostMode||'year';
  const costFor=(c)=>mode==='month'?contractAnnualCost(c)/12:contractAnnualCost(c);
  const byCat=(()=>{const map={};contracts.forEach(c=>{const k=(c.category||'Sonstiges').trim()||'Sonstiges';map[k]=(map[k]||0)+costFor(c)});return Object.entries(map).sort((a,b)=>b[1]-a[1])})();
  const view=window._contractView||'list';

  // Filter logic
  let filtered=contracts;
  if(filter==='active') filtered=contracts.filter(c=>c.status!=='cancelled'&&(contractDaysLeft(c)===null||contractDaysLeft(c)>30));
  else if(filter==='urgent') filtered=contracts.filter(c=>{const d=contractDaysLeft(c);return d!==null&&d<=30&&c.status!=='cancelled';});
  else if(filter==='cancelled') filtered=contracts.filter(c=>c.status==='cancelled');

  // Category icons
  const catIcon=(cat)=>{const m={'Versicherung':'üõ°Ô∏è','Streaming':'üé¨','Internet':'üåê','Strom':'‚ö°','Gas':'üî•','Handy':'üì±','Fitness':'üí™','Software':'üíª','Bank':'üè¶','Miete':'üè†','Auto':'üöó','Sonstiges':'üìÑ'};return m[cat]||m[Object.keys(m).find(k=>cat&&cat.toLowerCase().includes(k.toLowerCase()))||'']||'üìÑ';};

  // Savings potential
  const cancelledSavings=contracts.filter(c=>c.status!=='cancelled').reduce((s,c)=>s+contractAnnualCost(c),0);

  const card=(c)=>{
    const ann=contractAnnualCost(c);
    const days=contractDaysLeft(c);
    const pct=contractIncreasePct(c);
    const dl=contractEffectiveDeadline(c);
    const icon=catIcon(c.category);
    const isUrgent=days!==null&&days<=30&&c.status!=='cancelled';
    const isAcute=days!==null&&days<=14&&c.status!=='cancelled';
    const isCancelled=c.status==='cancelled';

    let borderColor='var(--b)';
    if(isAcute) borderColor='var(--co)';
    else if(isUrgent) borderColor='var(--am)';

    return `<div onclick="window._contractDetail=${c.id};renderPage()" style="background:var(--bgD);border:1px solid ${borderColor};border-radius:16px;padding:18px;cursor:pointer;transition:all 0.15s;position:relative;overflow:hidden" onmouseover="this.style.borderColor='var(--ba)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='${borderColor}';this.style.transform='none'">
      ${isUrgent?`<div style="position:absolute;top:0;left:0;right:0;height:3px;background:${isAcute?'var(--co)':'var(--am)'}"></div>`:''}
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:40px;height:40px;border-radius:12px;background:var(--bgE);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">${icon}</div>
          <div>
            <p style="font-size:14px;font-weight:700;margin:0;line-height:1.2">${c.name||'Unbenannter Vertrag'}</p>
            <p style="font-size:12px;color:var(--tm);margin:2px 0 0">${c.provider||''}${c.category?' ¬∑ '+c.category:''}</p>
          </div>
        </div>
        ${contractStatusBadge(c)}
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
        <div style="background:var(--bgE);border-radius:10px;padding:10px">
          <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.6px">Pro Monat</p>
          <p style="font-size:17px;font-weight:800;margin:3px 0 0;color:${isCancelled?'var(--ts)':'var(--t)'}">${fmt(ann/12)}</p>
        </div>
        <div style="background:var(--bgE);border-radius:10px;padding:10px">
          <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.6px">Pro Jahr</p>
          <p style="font-size:17px;font-weight:800;margin:3px 0 0">${fmt(ann)}</p>
        </div>
      </div>
      ${isUrgent?`<div style="background:${isAcute?'var(--coG)':'var(--amG)'};border:1px solid ${isAcute?'var(--co)':'var(--am)'};border-radius:10px;padding:8px 12px;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <span style="font-size:16px">${isAcute?'üö®':'‚ö†Ô∏è'}</span>
        <div>
          <p style="font-size:12px;font-weight:700;color:${isAcute?'var(--co)':'var(--am)'};margin:0">K√ºndigungsfrist ${days<=0?'abgelaufen':days+' Tage'}</p>
          ${dl?`<p style="font-size:11px;color:var(--tm);margin:2px 0 0">Deadline: ${fDL(dl)}</p>`:''}
        </div>
      </div>`:''}
      ${pct>=10?`<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:11px;background:var(--coG);color:var(--co);padding:2px 8px;border-radius:6px;font-weight:700">+${pct}% Preiserh√∂hung</span></div>`:''}
      <div style="display:flex;gap:6px;justify-content:flex-end;padding-top:10px;border-top:1px solid var(--b)">
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();goToCancelAssist(${c.id})">‚úâÔ∏è K√ºndigen</button>
        <button class="btn btn-outline btn-sm" onclick="event.stopPropagation();openContractAdd(${c.id})">‚úèÔ∏è Bearbeiten</button>
      </div>
    </div>`;
  };

  const filterBtn=(id,label,count)=>`<button onclick="window._contractFilter='${id}';renderPage()" style="padding:7px 14px;border-radius:10px;border:1px solid ${filter===id?'var(--ba)':'var(--b)'};background:${filter===id?'var(--emG)':'transparent'};color:${filter===id?'var(--em)':'var(--tm)'};font-size:13px;font-weight:${filter===id?'700':'400'};cursor:pointer;transition:all 0.15s">${label}${count!=null?` <span style="font-size:11px;opacity:0.7">(${count})</span>`:''}</button>`;

  return `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:12px">
    <div>
      <h1 style="font-size:28px;font-weight:800;margin:0 0 4px">Vertragsverwaltung</h1>
      <p style="font-size:13px;color:var(--tm);margin:0">${contracts.length} Vertr√§ge ¬∑ ${fmt(monthlyCost)}/Monat ¬∑ ${fmt(totalAnnual)}/Jahr</p>
    </div>
    <button class="btn btn-primary" onclick="openContractAdd()">Ôºã Vertrag</button>
  </div>

  <!-- KPI Zeile -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px">
    <div class="card" style="padding:16px">
      <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.8px">Jahreskosten</p>
      <p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:6px 0 2px">${fmt(totalAnnual)}</p>
      <p style="font-size:12px;color:var(--tm);margin:0">${fmt(monthlyCost)}/Monat</p>
    </div>
    <div class="card" style="padding:16px">
      <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.8px">Ver√§nderung</p>
      <p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:6px 0 2px;color:${totalDelta>0?'var(--co)':totalDelta<0?'var(--em)':'var(--t)'}">${totalDelta>0?'+':''}${fmt(totalDelta)}</p>
      <p style="font-size:12px;color:var(--tm);margin:0">zum Vorjahr</p>
    </div>
    <div class="card" style="padding:16px;${urgent.length?'border-color:var(--am)':''}">
      <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.8px">Fristen aktiv</p>
      <p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:6px 0 2px;color:${urgent.length?'var(--am)':'var(--t)'}">${urgent.length}</p>
      <p style="font-size:12px;color:var(--tm);margin:0">in 30 Tagen</p>
    </div>
    <div class="card" style="padding:16px;${raised.length?'border-color:rgba(239,68,68,0.3)':''}">
      <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.8px">Preiserh√∂hungen</p>
      <p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:6px 0 2px;color:${raised.length?'var(--co)':'var(--t)'}">${raised.length}</p>
      <p style="font-size:12px;color:var(--tm);margin:0">‚â• 10% Anstieg</p>
    </div>
  </div>

  <!-- Kategorie √úbersicht -->
  ${byCat.length>1?`<div class="card" style="padding:14px 18px;margin-bottom:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px">
      <p style="font-size:11px;font-weight:700;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.8px">Kosten nach Kategorie</p>
      <div style="display:flex;gap:6px">
        <button onclick="window._contractCostMode='month';renderPage()" style="padding:6px 10px;border-radius:10px;border:1px solid ${mode==='month'?'var(--ba)':'var(--b)'};background:${mode==='month'?'var(--emG)':'transparent'};color:${mode==='month'?'var(--em)':'var(--tm)'};font-size:12px;cursor:pointer">Monat</button>
        <button onclick="window._contractCostMode='year';renderPage()" style="padding:6px 10px;border-radius:10px;border:1px solid ${mode==='year'?'var(--ba)':'var(--b)'};background:${mode==='year'?'var(--emG)':'transparent'};color:${mode==='year'?'var(--em)':'var(--tm)'};font-size:12px;cursor:pointer">Jahr</button>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      ${byCat.map(([k,v])=>`<div style="background:var(--bgE);border:1px solid var(--b);border-radius:10px;padding:8px 12px;display:flex;align-items:center;gap:8px">
        <span style="font-size:16px">${catIcon(k)}</span>
        <div><p style="font-size:12px;font-weight:600;margin:0">${k}</p><p style="font-size:13px;font-weight:800;color:var(--em);margin:1px 0 0">${fmt(v)}${mode==='month'?'/Monat':'/Jahr'}</p></div>
      </div>`).join('')}
    </div>
  </div>`:''}

  <!-- Sparrechner Banner -->
  ${contracts.filter(c=>c.status!=='cancelled').length>2?`<div class="card" style="padding:14px 18px;margin-bottom:16px;background:linear-gradient(135deg,rgba(22,163,74,0.16),rgba(22,163,74,0.05));border-color:var(--ba)">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:24px">üí°</span>
        <div>
          <p style="font-size:13px;font-weight:700;margin:0">Sparpotenzial</p>
          <p style="font-size:12px;color:var(--tm);margin:2px 0 0">Wenn du alle aktiven Vertr√§ge k√ºndigen w√ºrdest, sparst du <strong style="color:var(--em)">${fmt(cancelledSavings)}/Jahr</strong></p>
        </div>
      </div>
      <button class="btn btn-outline btn-sm" onclick="window._contractFilter='urgent';renderPage()">Fristen pr√ºfen ‚Üí</button>
    </div>
  </div>`:''}

  <!-- Filter Tabs -->
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
    ${filterBtn('all','Alle',contracts.length)}
    ${filterBtn('active','Aktiv',contracts.filter(c=>c.status!=='cancelled').length)}
    ${filterBtn('urgent','Frist bald',urgent.length)}
    ${filterBtn('cancelled','Gek√ºndigt',contracts.filter(c=>c.status==='cancelled').length)}
    <span style="margin:0 6px;color:var(--tf)">¬∑</span>
    <button onclick="window._contractView='list';renderPage()" style="padding:7px 12px;border-radius:10px;border:1px solid ${view==='list'?'var(--ba)':'var(--b)'};background:${view==='list'?'var(--emG)':'transparent'};color:${view==='list'?'var(--em)':'var(--tm)'};font-size:12px;cursor:pointer">Liste</button>
    <button onclick="window._contractView='grid';renderPage()" style="padding:7px 12px;border-radius:10px;border:1px solid ${view==='grid'?'var(--ba)':'var(--b)'};background:${view==='grid'?'var(--emG)':'transparent'};color:${view==='grid'?'var(--em)':'var(--tm)'};font-size:12px;cursor:pointer">Karten</button>
  </div>

  ${filtered.length?(view==='grid'
  ?`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px">${filtered.map(card).join('')}</div>`
  :(()=>{const groups={};filtered.forEach(c=>{const k=(c.category||'Sonstiges').trim()||'Sonstiges';(groups[k]=groups[k]||[]).push(c)});const rows=(arr)=>arr.map((c,i,ar)=>{const isUrg=(()=>{const d=contractDaysLeft(c);return d!==null&&d<=14&&c.status!=='cancelled'})(),amt=costFor(c);return `<div style="display:flex;align-items:center;gap:12px;padding:12px 0;${i<ar.length-1?'border-bottom:1px solid var(--b)':''}"><div style="width:36px;height:36px;border-radius:10px;background:var(--bgE);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:18px">`+(function(cat){const m={'Versicherung':'üõ°Ô∏è','Streaming':'üé¨','Internet':'üåê','Strom':'‚ö°','Gas':'üî•','Handy':'üì±','Fitness':'üí™','Software':'üíª','Bank':'üè¶','Miete':'üè†','Auto':'üöó','Sonstiges':'üìÑ'};return m[cat]||'üìÑ'})(c.category)+`</div><div style="flex:1;min-width:0"><p style="font-size:13px;font-weight:700;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.name||'Vertrag'}</p><p style="font-size:12px;color:var(--tm);margin:2px 0 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.provider||''}</p></div><div style="text-align:right;min-width:110px"><div style="font-size:14px;font-weight:800;color:${c.status==='cancelled'?'var(--ts)':'var(--t)'}">${fmt(amt)}</div><div style="font-size:10px;color:var(--ts)">${mode==='month'?'/Monat':'/Jahr'}</div></div><div style="display:flex;gap:6px;margin-left:8px"><button class="btn btn-ghost btn-sm" title="K√ºndigen" onclick="goToCancelAssist(${c.id})">‚úâÔ∏è</button><button class="btn btn-outline btn-sm" title="Bearbeiten" onclick="openContractAdd(${c.id})">‚úèÔ∏è</button></div>${isUrg?'<span style="margin-left:6px;font-size:11px;background:var(--amG);color:var(--am);padding:3px 8px;border-radius:8px">Frist</span>':''}</div>`}).join('');return Object.entries(groups).sort(([a],[b])=>a.localeCompare(b,'de')).map(([cat,arr])=>{const sum=arr.reduce((s,c)=>s+costFor(c),0);return `<div class="card" style="padding:14px 16px;margin-bottom:12px"><div style="display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:16px">`+(function(cat){const m={'Versicherung':'üõ°Ô∏è','Streaming':'üé¨','Internet':'üåê','Strom':'‚ö°','Gas':'üî•','Handy':'üì±','Fitness':'üí™','Software':'üíª','Bank':'üè¶','Miete':'üè†','Auto':'üöó','Sonstiges':'üìÑ'};return m[cat]||'üìÑ'})(cat)+`</span><h3 style="font-size:14px;font-weight:700;margin:0">${cat}</h3></div><div style="font-size:12px;color:var(--tm)">${fmt(sum)}${mode==='month'?'/Monat':'/Jahr'}</div></div>${rows(arr)}</div>`}).join('')})()):`<div class="card" style="text-align:center;padding:48px 24px">
    <p style="font-size:40px;margin:0 0 12px">üìÑ</p>
    <p style="font-size:16px;font-weight:700;margin:0 0 8px">${filter==='all'?'Noch keine Eintr√§ge':'Keine Vertr√§ge in dieser Kategorie'}</p>
    <p style="font-size:13px;color:var(--tm);margin:0 0 16px">Lege Vertr√§ge an um Fristen, Preiserh√∂hungen und Jahreskosten im Blick zu behalten.</p>
    ${filter==='all'?`<button class="btn btn-primary btn-sm" onclick="openContractAdd()">Ersten Vertrag anlegen</button>`:`<button class="btn btn-outline btn-sm" onclick="window._contractFilter='all';renderPage()">Alle anzeigen</button>`}
  </div>`}`;
}

// ‚îÄ‚îÄ‚îÄ Vertragsdetail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rContractDetail(id){
  const c=contracts.find(x=>x.id===id);
  if(!c){window._contractDetail=null;renderPage();return '';}
  const ann=contractAnnualCost(c);
  const days=contractDaysLeft(c);
  const pct=contractIncreasePct(c);
  const delta=contractDelta(c);
  const dl=contractEffectiveDeadline(c);
  const catIcon=(cat)=>{const m={'Versicherung':'üõ°Ô∏è','Streaming':'üé¨','Internet':'üåê','Strom':'‚ö°','Gas':'üî•','Handy':'üì±','Fitness':'üí™','Software':'üíª','Bank':'üè¶','Miete':'üè†','Auto':'üöó','Sonstiges':'üìÑ'};return m[cat]||m[Object.keys(m).find(k=>cat&&cat.toLowerCase().includes(k.toLowerCase()))||'']||'üìÑ';};
  const isUrgent=days!==null&&days<=30&&c.status!=='cancelled';
  const isAcute=days!==null&&days<=14&&c.status!=='cancelled';

  return `
  <button onclick="window._contractDetail=null;renderPage()" style="background:none;border:none;color:var(--tm);cursor:pointer;font-size:13px;padding:0;margin-bottom:18px;display:flex;align-items:center;gap:6px">‚Üê Zur√ºck zur √úbersicht</button>

  ${isUrgent?`<div style="background:${isAcute?'var(--coG)':'var(--amG)'};border:1px solid ${isAcute?'var(--co)':'var(--am)'};border-radius:14px;padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px">
    <span style="font-size:24px">${isAcute?'üö®':'‚ö†Ô∏è'}</span>
    <div style="flex:1">
      <p style="font-size:14px;font-weight:700;color:${isAcute?'var(--co)':'var(--am)'};margin:0">K√ºndigungsfrist l√§uft ${days<=0?'ab!':'in '+days+' Tagen ab!'}</p>
      <p style="font-size:12px;color:var(--tm);margin:4px 0 0">${dl?'Deadline: '+fDL(dl)+' ¬∑ ':''}Jetzt k√ºndigen um Verl√§ngerung zu vermeiden.</p>
    </div>
    <button class="btn btn-sm" style="background:${isAcute?'var(--co)':'var(--am)'};color:#fff;border:none;white-space:nowrap" onclick="goToCancelAssist(${c.id})">Jetzt k√ºndigen</button>
  </div>`:''}

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
    <!-- Linke Spalte: Vertragsinfo -->
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="card" style="padding:20px">
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px">
          <div style="width:52px;height:52px;border-radius:14px;background:var(--bgE);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:26px">${catIcon(c.category)}</div>
          <div>
            <h2 style="font-size:20px;font-weight:800;margin:0 0 4px">${c.name}</h2>
            <p style="font-size:13px;color:var(--tm);margin:0">${c.provider||''}${c.category?' ¬∑ '+c.category:''}</p>
          </div>
          ${contractStatusBadge(c)}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div style="background:var(--bgE);border-radius:12px;padding:12px">
            <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.6px">Monatlich</p>
            <p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:4px 0 0">${fmt(ann/12)}</p>
          </div>
          <div style="background:var(--bgE);border-radius:12px;padding:12px">
            <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.6px">J√§hrlich</p>
            <p style="font-size:22px;font-weight:800;font-family:\'Bricolage Grotesque\',sans-serif;margin:4px 0 0">${fmt(ann)}</p>
          </div>
          ${delta?`<div style="background:${delta>0?'var(--coG)':'var(--emG)'};border:1px solid ${delta>0?'var(--co)':'var(--ba)'};border-radius:12px;padding:12px;grid-column:1/-1">
            <p style="font-size:10px;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.6px">Preisver√§nderung</p>
            <p style="font-size:18px;font-weight:800;margin:4px 0 0;color:${delta>0?'var(--co)':'var(--em)'}">${delta>0?'+':''}${fmt(delta)}/Jahr (${pct>0?'+':''}${pct}%)</p>
          </div>`:''}
        </div>
      </div>

      <div class="card" style="padding:18px">
        <p style="font-size:12px;font-weight:700;color:var(--ts);margin:0 0 12px;text-transform:uppercase;letter-spacing:0.8px">Vertragsdetails</p>
        ${[
          ['Vertragsnummer', c.contractNo],
          ['Kategorie', c.category],
          ['Abrechnungszyklus', c.billingCycle],
          ['Zahlungsart', c.paymentMethod],
          ['Startdatum', c.startDate?new Date(c.startDate+'T00:00:00').toLocaleDateString('de-DE'):''],
          ['Mindestlaufzeit', c.minTermMonths?c.minTermMonths+' Monate':''],
          ['K√ºndigungsfrist', c.noticeDays?c.noticeDays+' Tage':''],
          ['N√§chste Preisanpassung', c.nextPriceDate?new Date(c.nextPriceDate+'T00:00:00').toLocaleDateString('de-DE')+(c.nextPriceAmount?' ‚Üí '+fmt(c.nextPriceAmount/12)+'/Mon.':''):''],
          ['Kontakt Anbieter', c.providerPhone||c.providerEmail?(c.providerPhone||'')+(c.providerPhone&&c.providerEmail?' ¬∑ ':'')+(c.providerEmail||''):''],
        ].filter(([,v])=>v).map(([k,v])=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--b);gap:12px">
          <span style="font-size:12px;color:var(--tm)">${k}</span>
          <span style="font-size:13px;font-weight:600;text-align:right">${v}</span>
        </div>`).join('')}
        ${c.notes?`<p style="font-size:12px;color:var(--tm);margin:10px 0 0;padding:10px;background:var(--bgE);border-radius:8px">${c.notes}</p>`:''}
      </div>
    </div>

    <!-- Rechte Spalte: Frist + Dokumente + Aktionen -->
    <div style="display:flex;flex-direction:column;gap:14px">
      <!-- Fristen-Card -->
      <div class="card" style="padding:18px;${isUrgent?'border-color:'+(isAcute?'var(--co)':'var(--am)'):''}">
        <p style="font-size:12px;font-weight:700;color:var(--ts);margin:0 0 12px;text-transform:uppercase;letter-spacing:0.8px">‚è∞ K√ºndigungsfrist</p>
        ${days!==null?`<div style="text-align:center;padding:16px 0">
          <p style="font-size:48px;font-weight:900;margin:0;color:${isAcute?'var(--co)':isUrgent?'var(--am)':'var(--t)'};line-height:1">${Math.max(0,days)}</p>
          <p style="font-size:14px;color:var(--tm);margin:4px 0 0">Tage verbleibend</p>
          ${dl?`<p style="font-size:12px;color:var(--ts);margin:8px 0 0">Deadline: <strong>${fDL(dl)}</strong></p>`:''}
        </div>
        <div style="background:var(--bgE);border-radius:10px;height:8px;margin:8px 0">
          <div style="height:8px;border-radius:10px;background:${isAcute?'var(--co)':isUrgent?'var(--am)':'var(--em)'};width:${Math.min(100,Math.max(5,days<=0?100:100-Math.min(100,days/90*100)))}%"></div>
        </div>`:`<p style="font-size:14px;color:var(--tm);text-align:center;padding:16px 0">Keine Frist hinterlegt</p>`}
      </div>

      <!-- Dokumente -->
      <div class="card" style="padding:18px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <p style="font-size:12px;font-weight:700;color:var(--ts);margin:0;text-transform:uppercase;letter-spacing:0.8px">üìé Dokumente</p>
          <label class="btn btn-ghost btn-sm" style="cursor:pointer">+ Hinzuf√ºgen<input type="file" multiple style="display:none" onchange="attachContractDocs(${c.id},event)"></label>
        </div>
        ${(c.documents||[]).length?`<div style="display:flex;flex-direction:column;gap:6px">
          ${c.documents.map(d=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bgE);border-radius:8px">
            <div style="display:flex;align-items:center;gap:8px">
              <span style="font-size:16px">üìÑ</span>
              <div><p style="font-size:12px;font-weight:600;margin:0">${d.name}</p><p style="font-size:11px;color:var(--tm);margin:1px 0 0">${new Date(d.uploadedAt).toLocaleDateString('de-DE')}</p></div>
            </div>
          </div>`).join('')}
        </div>`:`<div style="text-align:center;padding:20px 0;color:var(--tm)">
          <p style="font-size:24px;margin:0 0 6px">üìÇ</p>
          <p style="font-size:12px;margin:0">Noch keine Dokumente</p>
        </div>`}
      </div>

      <!-- Aktionen -->
      <div class="card" style="padding:18px">
        <p style="font-size:12px;font-weight:700;color:var(--ts);margin:0 0 12px;text-transform:uppercase;letter-spacing:0.8px">Aktionen</p>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-outline" style="width:100%;justify-content:flex-start;gap:10px" onclick="goToCancelAssist(${c.id})">‚úâÔ∏è K√ºndigungsschreiben erstellen</button>
          <button class="btn btn-outline" style="width:100%;justify-content:flex-start;gap:10px" onclick="openContractAdd(${c.id})">‚úèÔ∏è Vertrag bearbeiten</button>
          <button class="btn btn-outline" style="width:100%;justify-content:flex-start;gap:10px;color:var(--am);border-color:var(--am)" onclick="markContractCancelled(${c.id})">${c.status==='cancelled'?'‚úÖ Als aktiv markieren':'üî¥ Als gek√ºndigt markieren'}</button>
          <button class="btn btn-danger" style="width:100%;justify-content:flex-start;gap:10px" onclick="deleteContract(${c.id})">üóëÔ∏è Vertrag l√∂schen</button>
        </div>
      </div>
    </div>
  </div>`;
}

function markContractCancelled(id){
  const c=contracts.find(x=>x.id===id);
  if(!c)return;
  autoSnapshot("contract_status",true);
  c.status=c.status==='cancelled'?'active':'cancelled';
  scheduleCloudSave();
  renderPage();
  flash(c.status==='cancelled'?'Als gek√ºndigt markiert':'Wieder auf aktiv gesetzt');
}

function openContractAdd(id=null){
  const c=id?contracts.find(x=>x.id===id):null;
  const cats=CONTRACT_CATS;
  const cycles=['monatlich','viertelj√§hrlich','halbj√§hrlich','j√§hrlich','einmalig'];
  const secHdr=(icon,title,color='var(--em)')=>`<div style="display:flex;align-items:center;gap:8px;margin:18px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--b)"><span style="font-size:18px">${icon}</span><p style="font-size:12px;font-weight:700;color:${color};text-transform:uppercase;letter-spacing:0.8px;margin:0">${title}</p></div>`;
  document.getElementById("modalContainer").innerHTML=`<div class="overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()" style="max-width:880px;max-height:90vh;overflow-y:auto">
  <div class="modal-head" style="position:sticky;top:0;background:var(--bgD);z-index:10;margin:-20px -20px 0;padding:18px 20px;border-bottom:1px solid var(--b)">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:36px;height:36px;border-radius:10px;background:var(--emG);display:flex;align-items:center;justify-content:center;font-size:18px">üìÑ</div>
      <div><h3 style="margin:0;font-size:16px;font-weight:800">${c?'Vertrag bearbeiten':'Neuen Vertrag erfassen'}</h3>
      <p style="margin:0;font-size:12px;color:var(--tm)">${c?c.name+' ¬∑ '+c.provider:'Nur Basis‚ÄëDaten n√∂tig ‚Äì Details optional'}</p></div>
    </div>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>

  <div style="padding-top:8px">
  ${secHdr('üìã','Basis‚ÄëVertrag')}
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="field"><label>Vertragsname *</label><div class="input-wrap"><input id="ctName" value="${c?.name||''}" placeholder="z.B. Kfz-Haftpflicht"></div></div>
    <div class="field"><label>Anbieter / Unternehmen</label><div class="input-wrap"><input id="ctProvider" value="${c?.provider||''}" placeholder="z.B. Allianz, Netflix..."></div></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
    <div class="field"><label>Monatlicher Betrag</label><div class="input-wrap"><input id="ctMonthly" type="number" step="0.01" value="${c?.monthlyCost||''}" placeholder="0.00"><span class="suffix">‚Ç¨</span></div></div>
    <div class="field"><label>Abrechnungszyklus</label><div class="input-wrap"><select id="ctCycle">
      ${cycles.map(k=>`<option value="${k}" ${(c?.billingCycle||'monatlich')===k?'selected':''}>${k}</option>`).join('')}
    </select></div></div>
  </div>
  <p style="font-size:12px;color:var(--tm);margin:8px 0 0">Weitere Details sind optional und k√∂nnen sp√§ter erg√§nzt werden.</p>

  <details id="ctMore" style="margin-top:14px;border:1px solid var(--b);border-radius:12px;background:var(--bgE)">
    <summary style="cursor:pointer;list-style:none;padding:12px 14px;display:flex;align-items:center;gap:8px">
      <span style="font-size:14px">‚ûï</span><span style="font-size:13px;font-weight:700;color:var(--ts)">Weitere Vertragsdetails</span>
    </summary>
    <div style="padding:12px 14px">
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
    <div class="field"><label>Kategorie</label><div class="input-wrap"><select id="ctCategory" style="padding-left:10px">
      ${cats.map(k=>`<option value="${k.v}" ${c?.category===k.v?'selected':''}>${k.i} ${k.v}</option>`).join('')}
    </select></div></div>
    <div class="field"><label>Vertragsnummer</label><div class="input-wrap"><input id="ctNo" value="${c?.contractNo||''}" placeholder="z.B. VN-2024-001"></div></div>
    <div class="field"><label>Zahlungsart</label><div class="input-wrap"><select id="ctPayMethod">
      ${['SEPA-Lastschrift','√úberweisung','Kreditkarte','PayPal','Bar'].map(k=>`<option value="${k}" ${c?.paymentMethod===k?'selected':''}>${k}</option>`).join('')}
    </select></div></div>
  </div>

  ${secHdr('üí∞','Weitere Kosten','var(--em)')}
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="field"><label>J√§hrlich <span style="font-size:10px;color:var(--tm)">(alternativ)</span></label><div class="input-wrap"><input id="ctYearly" type="number" step="0.01" value="${c?.yearlyCost||''}" placeholder="0.00"><span class="suffix">‚Ç¨</span></div></div>
    <div class="field"><label>Vorjahreskosten</label><div class="input-wrap"><input id="ctPrevAnnual" type="number" step="0.01" value="${c?.previousAnnualCost||''}" placeholder="0.00"><span class="suffix">‚Ç¨</span></div></div>
  </div>
  <div style="background:var(--bgD);border:1px solid var(--b);border-radius:10px;padding:10px;margin-top:8px">
    <p style="font-size:12px;color:var(--tm);margin:0">Entweder <strong>Monatlich</strong> oder <strong>J√§hrlich</strong> pflegen ‚Äì beide Felder sind optional.</p>
  </div>

  ${secHdr('‚è∞','Laufzeit & Fristen','#F59E0B')}
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
    <div class="field"><label>Startdatum</label><div class="input-wrap"><input id="ctStart" type="date" value="${c?.startDate||''}"></div></div>
    <div class="field"><label>Mindestlaufzeit</label><div class="input-wrap"><input id="ctTerm" type="number" value="${c?.minTermMonths||12}" min="0"><span class="suffix">Mon.</span></div></div>
    <div class="field"><label>K√ºndigungsfrist</label><div class="input-wrap"><input id="ctNotice" type="number" value="${c?.noticeDays||30}" min="0"><span class="suffix">Tage</span></div></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="field"><label>Feste K√ºndigungsdeadline</label><div class="input-wrap"><input id="ctCancelBy" type="date" value="${c?.cancelBy||''}"></div></div>
    <div class="field"><label>Auto-Verl√§ngerung</label><div class="input-wrap"><select id="ctAutoRenew">
      <option value="1" ${(c?.autoRenew!==false)?'selected':''}>Ja ‚Äì verl√§ngert sich automatisch</option>
      <option value="0" ${c?.autoRenew===false?'selected':''}>Nein ‚Äì endet automatisch</option>
    </select></div></div>
  </div>

  ${secHdr('üìà','N√§chste Preisanpassung','#F87171')}
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="field"><label>Datum der Anpassung</label><div class="input-wrap"><input id="ctNextPriceDate" type="date" value="${c?.nextPriceDate||''}"></div></div>
    <div class="field"><label>Neuer Monatsbetrag (erwartet)</label><div class="input-wrap"><input id="ctNextPriceAmt" type="number" step="0.01" value="${c?.nextPriceAmount||''}" placeholder="0.00"><span class="suffix">‚Ç¨</span></div></div>
  </div>

  ${secHdr('üìû','Anbieter Kontakt')}
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="field"><label>üì± Telefon</label><div class="input-wrap"><input id="ctPhone" value="${c?.providerPhone||''}" placeholder="0800 000 0000"></div></div>
    <div class="field"><label>‚úâÔ∏è E-Mail</label><div class="input-wrap"><input id="ctEmail" value="${c?.providerEmail||''}" placeholder="service@anbieter.de"></div></div>
  </div>

  ${secHdr('üìù','Notizen')}
  <div class="field" style="margin-bottom:0"><div class="input-wrap"><input id="ctNotes" value="${(c?.notes||'').replace(/"/g,'&quot;')}" placeholder="Wichtige Details, Sondervereinbarungen..."></div></div>
    </div>
  </details>

  <div style="display:flex;gap:12px;margin-top:20px;padding-top:16px;border-top:1px solid var(--b)">
    <button class="btn btn-outline" style="flex:1" onclick="closeModal()">Abbrechen</button>
    <button class="btn btn-primary" style="flex:2" onclick="saveContract(${c?c.id:0})">${c?'‚úì √Ñnderungen speichern':'‚úì Vertrag anlegen'}</button>
  </div>
  </div>
</div></div>`;
}

async function saveContract(id=0){
  const name=(document.getElementById("ctName")?.value||"").trim();
  if(!name){flash("Vertragsname fehlt");return;}
  await autoSnapshot(id?"contract_change":"contract_create",true);
  const item={
    id:id||Date.now(),name,
    provider:(document.getElementById("ctProvider")?.value||"").trim(),
    contractNo:(document.getElementById("ctNo")?.value||"").trim(),
    category:document.getElementById("ctCategory")?.value||"Sonstiges",
    status:(id?contracts.find(c=>c.id===id)?.status:null)||"active",
    autoRenew:document.getElementById("ctAutoRenew")?.value!=="0",
    monthlyCost:parseFloat(document.getElementById("ctMonthly")?.value)||0,
    yearlyCost:parseFloat(document.getElementById("ctYearly")?.value)||0,
    previousAnnualCost:parseFloat(document.getElementById("ctPrevAnnual")?.value)||0,
    paymentMethod:(document.getElementById("ctPayMethod")?.value||"").trim(),
    startDate:document.getElementById("ctStart")?.value||"",
    minTermMonths:parseInt(document.getElementById("ctTerm")?.value||"0",10)||0,
    noticeDays:parseInt(document.getElementById("ctNotice")?.value||"0",10)||0,
    cancelBy:document.getElementById("ctCancelBy")?.value||"",
    billingCycle:document.getElementById("ctCycle")?.value||"monatlich",
    nextPriceDate:document.getElementById("ctNextPriceDate")?.value||"",
    nextPriceAmount:parseFloat(document.getElementById("ctNextPriceAmt")?.value)||0,
    providerPhone:(document.getElementById("ctPhone")?.value||"").trim(),
    providerEmail:(document.getElementById("ctEmail")?.value||"").trim(),
    notes:(document.getElementById("ctNotes")?.value||"").trim(),
    documents:id?(contracts.find(c=>c.id===id)?.documents||[]):[]
  };
  if(id){contracts=contracts.map(c=>c.id===id?item:c);}else{contracts.unshift(item);}
  scheduleCloudSave();
  closeModal();
  flash(id?"Vertrag aktualisiert ‚úì":"Vertrag angelegt ‚úì");
  if(id&&window._contractDetail===id) renderPage();
  else renderPage();
}


function goToCancelAssist(id){
  if(id)cancelForm.contractId=id;
  cancelForm.step=1;
  goTo("cancelAssist");
}
function selectedCancelContract(){return contracts.find(c=>c.id===cancelForm.contractId)||contracts[0]||null}
function selectCancelContract(id){
  cancelForm.contractId=id;
  const c=selectedCancelContract();
  if(!c)return;
  cancelForm.data.senderName=[user.firstName||"",user.lastName||""].join(" ").trim()||user.name||"";
  cancelForm.data.senderStreet=user.addressStreet||"";
  cancelForm.data.senderZip=user.addressZip||"";
  cancelForm.data.senderCity=user.addressCity||"";
  cancelForm.data.senderEmail=user.email||"";
  cancelForm.data.effectiveDate=contractEffectiveDeadline(c)||"";
}
function selectCancelTemplate(tid){cancelForm.template=tid;renderPage()}

function cancelToggleMoreTemplates(){cancelForm.showMoreTemplates=!cancelForm.showMoreTemplates;renderPage()}
function rCancelAssistant(){
  if(cancelForm.step===3)return rCancelPreview();
  if(cancelForm.step===2)return rCancelForm();
  const c=selectedCancelContract();
  if(c&&!cancelForm.contractId)cancelForm.contractId=c.id;
  const cancelStyles=[
    {id:"formell",icon:"‚öñÔ∏è",label:"Formell",desc:"Sachlich und juristisch pr√§zise"},
    {id:"energisch",icon:"üî•",label:"Energisch",desc:"Mit Nachdruck und Fristen"},
    {id:"knapp",icon:"üïäÔ∏è",label:"Sachlich-knapp",desc:"Kurz und direkt"},
  ];
  const primaryTemplatesOrder=["ordentlich","ausserordentlich","preissteigerung"];
  const primary=cancelTemplates.filter(t=>primaryTemplatesOrder.includes(t.id));
  const secondary=cancelTemplates.filter(t=>!primaryTemplatesOrder.includes(t.id));
  const shownTemplates=cancelForm.showMoreTemplates?[...primary,...secondary]:primary;
  const selectedTemplate=cancelTemplates.find(t=>t.id===cancelForm.template)||null;
  const styleObj=cancelStyles.find(s=>s.id===cancelForm.style)||cancelStyles[0];
  return `<h1 style="font-size:24px;font-weight:800;margin:0 0 6px">K√ºndigungsassistent</h1>
  <p style="font-size:13px;color:var(--tm);margin:0 0 18px">W√§hle Vertrag, Stil und Vorlage ‚Äì Details folgen anschlie√üend.</p>

  <div style="display:grid;grid-template-columns:minmax(260px,1fr) 320px;gap:16px;align-items:start">
    <div>
      <div class="card" style="padding:14px 16px;margin-bottom:14px;background:var(--bgE)">
        <div style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">1. Vertrag</div>
        ${contracts.length?`
        <div class="dd-container" id="ddContract">
          <button class="dd-trigger" onclick="toggleDropdown('ddContract')">
            ${c ? `
              <div style="display:flex;align-items:center;gap:10px">
                <span style="font-size:18px">${getContractIcon(c.category)}</span>
                <div style="text-align:left;line-height:1.2">
                  <span style="font-weight:600;display:block;font-size:14px">${c.name}</span>
                  <span style="font-size:11px;color:var(--tm)">${c.provider||"Anbieter"}</span>
                </div>
              </div>
            ` : `<span style="color:var(--tm)">Bitte w√§hlen...</span>`}
            <span style="font-size:10px;color:var(--tm)">‚ñº</span>
          </button>
          <div class="dd-menu">
            ${contracts.map(x=>`
              <button class="dd-item ${c&&c.id===x.id?'selected':''}" onclick="selectCancelContract(${x.id});renderPage()">
                <span class="dd-icon">${getContractIcon(x.category)}</span>
                <div class="dd-info">
                  <span class="dd-title">${x.name}</span>
                  <span class="dd-sub">${x.provider||"Anbieter"}</span>
                </div>
                ${c&&c.id===x.id?'<span style="margin-left:auto;color:var(--em)">‚úì</span>':''}
              </button>
            `).join("")}
          </div>
        </div>
        `:`<div style="padding:20px;text-align:center"><p style="margin:0 0 6px;font-size:26px">üìÑ</p><p style="font-size:13px;color:var(--tm);margin:0">Keine Vertr√§ge vorhanden</p><div style="margin-top:8px"><button class="btn btn-primary btn-sm" onclick="goTo('contracts')">Vertrag anlegen</button></div></div>`}
      </div>

      <div class="card" style="padding:14px 16px;margin-bottom:14px;background:var(--bgE)">
        <div style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">2. Briefstil</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${cancelStyles.map(st=>`<button class="card clickable" onclick="cancelForm.style='${st.id}';renderPage()" style="padding:10px 12px;display:flex;align-items:center;gap:8px;${cancelForm.style===st.id?'border-color:var(--ba);background:var(--emG2);box-shadow:0 0 0 3px rgba(34,197,94,0.15)':''}">
            <span style="font-size:22px">${st.icon}</span>
            <span style="font-size:13px;font-weight:700;color:${cancelForm.style===st.id?'var(--em)':'var(--t)'}">${st.label}</span>
          </button>`).join("")}
        </div>
      </div>

      <div class="card" style="padding:14px 16px;background:var(--bgE)">
        <div style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">3. Vorlage</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          ${shownTemplates.map(t=>`<button class="card clickable" onclick="selectCancelTemplate('${t.id}')" style="padding:12px;display:flex;align-items:center;gap:12px;justify-content:flex-start;${cancelForm.template===t.id?'border-color:var(--ba);background:var(--emG2);box-shadow:0 0 0 3px rgba(34,197,94,0.15)':''}">
            <span style="font-size:28px">${t.icon}</span>
            <div style="text-align:left">
              <p style="font-size:14px;font-weight:700;margin:0;color:${cancelForm.template===t.id?'var(--em)':'var(--t)'}">${t.name}</p>
              <p style="font-size:12px;color:var(--tm);margin:2px 0 0">${t.tags.slice(0,2).join(" ¬∑ ")}</p>
            </div>
          </button>`).join("")}
        </div>
        ${secondary.length?`<div style="margin-top:10px;text-align:center">
          <button class="btn btn-ghost btn-sm" onclick="cancelToggleMoreTemplates()">${cancelForm.showMoreTemplates?"Weniger Vorlagen anzeigen":"Weitere Vorlagen anzeigen"}</button>
        </div>`:""}
      </div>

      <div style="position:sticky;bottom:0;z-index:5;margin-top:14px">
        <div style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1px solid var(--b);border-radius:12px;padding:10px 12px;box-shadow:0 -6px 16px rgba(0,0,0,0.04)">
          <div style="flex:1">
            <p style="font-size:12px;color:var(--tm);margin:0">Ausgew√§hlt</p>
            <p style="font-size:13px;font-weight:700;margin:2px 0 0">${c?c.name:"‚Äì"} ¬∑ ${styleObj.label} ¬∑ ${selectedTemplate?selectedTemplate.name:"‚Äì"}</p>
          </div>
          <button class="btn btn-primary" ${(c&&selectedTemplate)?"":"disabled"} onclick="cancelForm.step=2;renderPage()">Weiter ‚Üí</button>
        </div>
      </div>
    </div>

    <aside class="card" style="padding:14px 16px;background:var(--bgE);position:sticky;top:8px">
      ${selectedTemplate?`
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <span style="font-size:28px">${selectedTemplate.icon}</span>
          <div><p style="font-size:14px;font-weight:800;margin:0">${selectedTemplate.name}</p><p style="font-size:12px;color:var(--tm);margin:2px 0 0">${selectedTemplate.desc}</p></div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">${selectedTemplate.tags.map(tag=>`<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:var(--bg);color:var(--ts);font-weight:700">${tag}</span>`).join("")}</div>
      `:c?`
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <span style="font-size:28px">üìÑ</span>
          <div><p style="font-size:14px;font-weight:800;margin:0">${c.name}</p><p style="font-size:12px;color:var(--tm);margin:2px 0 0">${c.provider||"Anbieter"} ¬∑ ${fmt(contractAnnualCost(c))}/Jahr</p></div>
        </div>
        ${contractEffectiveDeadline(c)?`<p style="font-size:12px;color:var(--tm);margin:0 0 8px">Frist: ${fDL(contractEffectiveDeadline(c))}</p>`:""}
      `:`
        <p style="font-size:12px;color:var(--tm);margin:0">Details erscheinen nach Auswahl.</p>
      `}
      <div style="margin-top:10px;padding:10px;border-radius:10px;background:var(--bg);border:1px solid var(--b)">
        <p style="font-size:12px;color:var(--tm);margin:0"><strong>Stil:</strong> ${styleObj.label}</p>
        <p style="font-size:12px;color:var(--tm);margin:4px 0 0">${styleObj.desc}</p>
      </div>
    </aside>
  </div>`;
}
function rCancelForm(){
  const c=selectedCancelContract(),t=cancelTemplates.find(x=>x.id===cancelForm.template);
  if(!c||!t){cancelForm.step=1;return rCancelAssistant();}
  if(!cancelForm.contractId)cancelForm.contractId=c.id;
  return `<button onclick="cancelForm.step=1;renderPage()" style="background:none;border:none;color:var(--tm);font-size:13px;display:flex;align-items:center;gap:6px;margin-bottom:24px;padding:0">‚Üê Zur√ºck zur Vorlagenauswahl</button>
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px"><span style="font-size:32px">${t.icon}</span><div><h2 style="font-size:20px;font-weight:800;margin:0">${t.name}</h2><p style="font-size:13px;color:var(--tm);margin:2px 0 0">${t.desc}</p></div></div>
  <div class="grid2" style="gap:16px"><div class="card"><h3 style="font-size:15px;font-weight:700;margin:0 0 16px">üìç Deine Angaben</h3><div class="field"><label>Vollst√§ndiger Name</label><div class="input-wrap"><input value="${(cancelForm.data.senderName||"").replace(/"/g,'&quot;')}" oninput="cancelForm.data.senderName=this.value"></div></div><div class="field"><label>Stra√üe und Hausnummer</label><div class="input-wrap"><input value="${(cancelForm.data.senderStreet||"").replace(/"/g,'&quot;')}" oninput="cancelForm.data.senderStreet=this.value"></div></div><div style="display:grid;grid-template-columns:120px 1fr;gap:12px"><div class="field"><label>PLZ</label><div class="input-wrap"><input value="${(cancelForm.data.senderZip||"").replace(/"/g,'&quot;')}" oninput="cancelForm.data.senderZip=this.value"></div></div><div class="field"><label>Ort</label><div class="input-wrap"><input value="${(cancelForm.data.senderCity||"").replace(/"/g,'&quot;')}" oninput="cancelForm.data.senderCity=this.value"></div></div></div><div class="field"><label>E-Mail</label><div class="input-wrap"><input value="${(cancelForm.data.senderEmail||"").replace(/"/g,'&quot;')}" oninput="cancelForm.data.senderEmail=this.value"></div></div></div>
  <div class="card"><h3 style="font-size:15px;font-weight:700;margin:0 0 16px">üìÑ Vertrags- & K√ºndigungsdaten</h3><div style="padding:10px 12px;border:1px solid var(--b);border-radius:10px;background:var(--bgE);margin-bottom:14px"><p style="font-size:13px;font-weight:700;margin:0">${c.name}</p><p style="font-size:12px;color:var(--tm);margin:4px 0 0">${c.provider||"Anbieter"}${c.contractNo?` ¬∑ Nr. ${c.contractNo}`:""}${contractEffectiveDeadline(c)?` ¬∑ Deadline ${fDL(contractEffectiveDeadline(c))}`:""}</p></div><div class="field"><label>K√ºndigung wirksam zum (optional)</label><div class="input-wrap"><input type="date" value="${cancelForm.data.effectiveDate||""}" oninput="cancelForm.data.effectiveDate=this.value"></div></div><div class="field"><label>Begr√ºndung / Grund</label><div class="input-wrap"><input value="${(cancelForm.data.reason||"").replace(/"/g,'&quot;')}" oninput="cancelForm.data.reason=this.value" placeholder="z.B. Umzug, Leistung unzureichend, Preissteigerung"></div></div><div class="field"><label>Zusatzhinweis</label><div class="input-wrap"><input value="${(cancelForm.data.customNote||"").replace(/"/g,'&quot;')}" oninput="cancelForm.data.customNote=this.value" placeholder="z.B. Bitte um Best√§tigung per E-Mail"></div></div></div></div>
  <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end"><button class="btn btn-outline" onclick="cancelForm.step=1;renderPage()">Zur√ºck</button><button class="btn btn-primary btn-lg" onclick="generateCancel()">‚ú® K√ºndigung generieren</button></div>`;
}
function generateCancel(){
  if(!cancelForm.data.senderName||!cancelForm.contractId||!cancelForm.template){flash("Bitte Vertrag, Vorlage und Name ausf√ºllen");return;}
  const doc=getCancelDocContent();
  cancelForm.editSubject=doc.subject;
  cancelForm.editBody=doc.body;
  cancelForm.editClosing=doc.closing;
  cancelForm.step=3;renderPage();
}
function getCancelDocContent(){
  const c=selectedCancelContract(),d=cancelForm.data,t=cancelForm.template;
  const s=cancelForm.style||"formell";
  const today=new Date().toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"});
  if(!c)return{subject:"",body:"",closing:"",today};
  const dl=contractEffectiveDeadline(c);
  const contractName=c.name||"den Vertrag";
  const contractNo=c.contractNo?`\n    Vertragsnummer:               ${c.contractNo}`:"";
  const provider=c.provider||"Ihrem Unternehmen";
  let subject="",body="",closing="";

  // Closing variiert je nach Stil
  if(s==="energisch"){
    closing=`Ich erwarte die schriftliche K√ºndigungsbest√§tigung sowie das verbindliche Vertragsenddatum innerhalb von 5 Werktagen. Sollte ich keine R√ºckmeldung erhalten, behalte ich mir rechtliche Schritte vor.`;
  } else if(s==="knapp"){
    closing=`Bitte best√§tigen Sie K√ºndigung und Vertragsende kurz schriftlich.`;
  } else {
    closing=`Ich bitte um eine schriftliche Eingangs- und K√ºndigungsbest√§tigung sowie um Mitteilung des verbindlichen Vertragsenddatums.`;
  }

  const baseBlock=(extra="")=>`    Vertragsname:                ${contractName}${contractNo}
    Vertragspartner:             ${provider}${extra}`;

  // ‚îÄ‚îÄ‚îÄ ORDENTLICHE K√úNDIGUNG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(t==="ordentlich"){
    subject=`K√ºndigung ‚Äì ${contractName}${contractNo?", Vtr.-Nr. "+c.contractNo:""}`;
    if(s==="energisch"){
      body=`hiermit k√ºndige ich den Vertrag √ºber ‚Äû${contractName}" bei ${provider} fristgerecht und mit sofortiger Wirkung zum n√§chstm√∂glichen Termin.

${baseBlock(`${d.effectiveDate?`\n    Gew√ºnschtes Vertragsende:    ${fDL(d.effectiveDate)}`:""}${dl?`\n    Fristablauf:                 ${fDL(dl)}`:""}`)}

${d.reason?`Grund: ${d.reason}\n\n`:""}Ich erwarte keine R√ºckfragen zu meiner Entscheidung. Die K√ºndigung ist endg√ºltig. Alle Leistungen sind zum Vertragsende einzustellen und Guthaben unverz√ºglich zu erstatten.${d.customNote?`\n\n${d.customNote}`:""}`;
    } else if(s==="knapp"){
      body=`ich k√ºndige hiermit den Vertrag ‚Äû${contractName}" bei ${provider} zum n√§chstm√∂glichen Termin.

${baseBlock(`${d.effectiveDate?`\n    Zum:                         ${fDL(d.effectiveDate)}`:""}`)}
${d.reason?`\nGrund: ${d.reason}`:""}${d.customNote?`\n${d.customNote}`:""}`;
    } else {
      body=`hiermit k√ºndige ich den mit ${provider} bestehenden Vertrag √ºber ${contractName} ordentlich und fristgerecht zum n√§chstm√∂glichen Termin.

${baseBlock(`${d.effectiveDate?`\n    Gew√ºnschtes Vertragsende:    ${fDL(d.effectiveDate)}`:""}${dl?`\n    K√ºndigungsfrist l√§uft ab:    ${fDL(dl)}`:""}`)}

${d.reason?`Ich m√∂chte auf eine Begr√ºndung nicht n√§her eingehen und bitte um Akzeptanz meiner K√ºndigung ohne weitere R√ºckfragen.\n\n`:""}Ich bitte Sie, mir das Vertragsende schriftlich zu best√§tigen und meine Daten nach Vertragsende gem√§√ü DSGVO zu l√∂schen.${d.customNote?`\n\nZus√§tzlicher Hinweis: ${d.customNote}`:""}`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ AUSSERORDENTLICHE K√úNDIGUNG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  else if(t==="ausserordentlich"){
    subject=`${s==="energisch"?"Fristlose K√ºndigung":"Au√üerordentliche K√ºndigung"} ‚Äì ${contractName}${contractNo?", Vtr.-Nr. "+c.contractNo:""}`;
    if(s==="energisch"){
      body=`hiermit k√ºndige ich den Vertrag ‚Äû${contractName}" mit ${provider} fristlos und mit sofortiger Wirkung. Rechtsgrundlage: ¬ß 314 BGB.

${baseBlock(`\n    Wirksamkeit:                 sofort`)}

K√ºndigungsgrund: ${d.reason||"[Grund liegt vor und wird auf Anfrage mitgeteilt]"}

Dieser K√ºndigungsgrund ist nach ¬ß 314 Abs. 1 BGB eindeutig. Ich fordere Sie auf, alle Leistungen mit sofortiger Wirkung einzustellen und zu Unrecht erhobene Betr√§ge innerhalb von 7 Tagen zu erstatten. Eine Fortsetzung des Vertragsverh√§ltnisses ist f√ºr mich unzumutbar.${d.customNote?`\n\n${d.customNote}`:""}`;
    } else if(s==="knapp"){
      body=`hiermit k√ºndige ich den Vertrag ‚Äû${contractName}" bei ${provider} fristlos aus wichtigem Grund (¬ß 314 BGB) mit Wirkung ab sofort.

${baseBlock()}

Grund: ${d.reason||"[Wichtiger Grund liegt vor]"}${d.customNote?`\n${d.customNote}`:""}`;
    } else {
      body=`hiermit k√ºndige ich den mit ${provider} bestehenden Vertrag √ºber ${contractName} au√üerordentlich und fristlos aus wichtigem Grund gem√§√ü ¬ß 314 BGB.

${baseBlock(`\n    Datum der K√ºndigung:         ${today}\n    Wirksamkeit:                 sofort (fristlos)`)}

Wichtiger K√ºndigungsgrund: ${d.reason||"[bitte Grund erg√§nzen]"}

Aufgrund des vorstehend genannten wichtigen Grundes ist mir eine Fortsetzung des Vertragsverh√§ltnisses nicht zumutbar. Ich fordere Sie auf, alle Leistungen einzustellen und √úberzahlungen unverz√ºglich zu erstatten.${d.customNote?`\n\nZus√§tzlicher Hinweis: ${d.customNote}`:""}`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ PREISERH√ñHUNG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  else if(t==="preissteigerung"){
    subject=`K√ºndigung ‚Äì Sonderk√ºndigungsrecht ‚Äì ${contractName}${contractNo?", Vtr.-Nr. "+c.contractNo:""}`;
    if(s==="energisch"){
      body=`ich mache hiermit ausdr√ºcklich von meinem Sonderk√ºndigungsrecht gem. ¬ß 315 BGB Gebrauch und k√ºndige den Vertrag ‚Äû${contractName}" bei ${provider} fristlos infolge der nicht akzeptierten Preiserh√∂hung.

${baseBlock(`\n    K√ºndigung zum:               ${d.effectiveDate?fDL(d.effectiveDate):"sofort / n√§chstm√∂glicher Termin"}`)}

Die Preiserh√∂hung ist f√ºr mich unakzeptabel. Ich dulde keine einseitige Vertrags√§nderung zu meinen Lasten. Bereits √ºberzahlte Betr√§ge sind mir innerhalb von 7 Werktagen zur√ºckzuerstatten.${d.customNote?`\n\n${d.customNote}`:""}`;
    } else if(s==="knapp"){
      body=`ich k√ºndige den Vertrag ‚Äû${contractName}" bei ${provider} zum ${d.effectiveDate?fDL(d.effectiveDate):"n√§chstm√∂glichen Termin"} via Sonderk√ºndigungsrecht (¬ß 315 BGB) wegen Preiserh√∂hung.

${baseBlock()}
${d.customNote?`\n${d.customNote}`:""}`;
    } else {
      body=`hiermit mache ich von meinem gesetzlichen Sonderk√ºndigungsrecht Gebrauch und k√ºndige den mit ${provider} bestehenden Vertrag √ºber ${contractName} infolge der angek√ºndigten Preiserh√∂hung.

${baseBlock(`\n    Grundlage:                   Sonderk√ºndigungsrecht gem. ¬ß 315 BGB\n    K√ºndigung zum:               ${d.effectiveDate?fDL(d.effectiveDate):"n√§chstm√∂glichen Zeitpunkt nach der Preiserh√∂hung"}`)}

Die angek√ºndigte Preiserh√∂hung ist f√ºr mich nicht akzeptabel. Ich bitte Sie zu best√§tigen, dass meine K√ºndigung fristgerecht eingegangen ist und zu viel entrichtete Beitr√§ge anteilig erstattet werden.${d.customNote?`\n\nZus√§tzlicher Hinweis: ${d.customNote}`:""}`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ WIDERRUF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  else if(t==="widerruf"){
    subject=`Widerruf ‚Äì ${contractName}${contractNo?", Vtr.-Nr. "+c.contractNo:""}`;
    if(s==="energisch"){
      body=`hiermit widerrufe ich den Vertrag ‚Äû${contractName}" mit ${provider} fristgerecht innerhalb der 14-t√§gigen Widerrufsfrist (¬ß 355 BGB). Widerrufsdatum: ${today}.

${baseBlock()}

Der Widerruf ist rechtswirksam. Ich fordere die vollst√§ndige R√ºckerstattung bereits geleisteter Zahlungen innerhalb von 14 Tagen nach Eingang dieses Widerrufs (¬ß 357 BGB). Bitte stellen Sie alle Leistungen sofort ein.${d.customNote?`\n\n${d.customNote}`:""}`;
    } else if(s==="knapp"){
      body=`ich widerrufe hiermit den Vertrag ‚Äû${contractName}" bei ${provider} gem. ¬ß 355 BGB innerhalb der Widerrufsfrist. Datum: ${today}.

${baseBlock()}

Bitte erstatten Sie geleistete Zahlungen innerhalb von 14 Tagen.${d.customNote?`\n${d.customNote}`:""}`;
    } else {
      body=`hiermit widerrufe ich den mit ${provider} abgeschlossenen Vertrag √ºber ${contractName} fristgerecht innerhalb der gesetzlichen 14-t√§gigen Widerrufsfrist gem√§√ü ¬ß 355 BGB.

${baseBlock(`\n    Widerrufsfrist:              14 Tage ab Vertragsschluss (¬ß 355 BGB)\n    Datum des Widerrufs:         ${today}`)}

Das Widerrufsrecht steht mir als Verbraucher gem√§√ü ¬ß 355 BGB ausdr√ºcklich zu. Ich verlange die R√ºckabwicklung des Vertrags und bitte um unverz√ºgliche Erstattung bereits geleisteter Zahlungen.${d.customNote?`\n\nZus√§tzlicher Hinweis: ${d.customNote}`:""}`;
    }
  }

  else{
    subject=`K√ºndigung ‚Äì ${contractName}${contractNo?", Vtr.-Nr. "+c.contractNo:""}`;
    body=`hiermit k√ºndige ich den mit ${provider} bestehenden Vertrag √ºber ${contractName} fristgerecht zum n√§chstm√∂glichen Termin.${contractNo}${dl?`\n\nDie K√ºndigung muss sp√§testens bis zum ${fDL(dl)} eingehen.`:""}${d.effectiveDate?`\n\nGew√ºnschtes Vertragsende: ${fDL(d.effectiveDate)}`:""}${d.reason?`\nBegr√ºndung: ${d.reason}`:""}${d.customNote?`\n\n${d.customNote}`:""}`;
  }

  return{subject,body,closing,today};
}

function rCancelPreview(){
  const c=selectedCancelContract();
  if(!c){cancelForm.step=1;return rCancelAssistant();}
  const d=cancelForm.data;
  const t=cancelTemplates.find(x=>x.id===cancelForm.template)||{icon:"üìÑ",name:"K√ºndigung"};
  const today=new Date().toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"});
  const styleLabels={formell:"‚öñÔ∏è Formell",energisch:"üî• Energisch",knapp:"üïäÔ∏è Sachlich-knapp"};

  return`
    <button onclick="cancelForm.step=2;renderPage()" style="background:none;border:none;color:var(--tm);font-size:13px;display:flex;align-items:center;gap:6px;margin-bottom:20px;padding:0;cursor:pointer">‚Üê Zur√ºck zur Bearbeitung</button>

    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:46px;height:46px;border-radius:14px;background:var(--emG);border:1px solid var(--ba);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${t.icon}</div>
        <div>
          <h2 style="font-size:20px;font-weight:800;margin:0">${t.name}</h2>
          <p style="font-size:12px;color:var(--tm);margin:3px 0 0">Stil: <span style="color:var(--em);font-weight:600">${styleLabels[cancelForm.style]||"‚öñÔ∏è Formell"}</span> ¬∑ Pr√ºfe und passe den Text an</p>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" onclick="navigator.clipboard.writeText((document.getElementById('caEditSubject')?.value||cancelForm.editSubject)+'\n\nSehr geehrte Damen und Herren,\n\n'+(document.getElementById('caEditBody')?.value||cancelForm.editBody)+'\n\n'+(document.getElementById('caEditClosing')?.value||cancelForm.editClosing)+'\n\nMit freundlichen Gr√º√üen\n${d.senderName}').then(()=>flash('Text kopiert üìã'))">üìã Kopieren</button>
        <button class="btn btn-outline btn-sm" onclick="sendCancelMail()">‚úâÔ∏è E-Mail</button>
        <button class="btn btn-primary btn-sm" onclick="cancelForm.editSubject=document.getElementById('caEditSubject')?.value||cancelForm.editSubject;cancelForm.editBody=document.getElementById('caEditBody')?.value||cancelForm.editBody;cancelForm.editClosing=document.getElementById('caEditClosing')?.value||cancelForm.editClosing;openCancelPdfPreview()" style="background:linear-gradient(135deg,#7C3AED,#6D28D9)">üìÑ PDF</button>
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:12px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b)">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Absender</span>
      </div>
      <div style="padding:14px 18px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
        <div style="font-size:13px;line-height:1.7;color:var(--t)">
          <strong>${d.senderName||""}</strong><br>
          ${d.senderStreet||""}<br>
          ${d.senderZip||""} ${d.senderCity||""}
          ${d.senderEmail?`<br><span style="color:var(--tm)">${d.senderEmail}</span>`:""}
        </div>
        <div style="font-size:13px;color:var(--tm)">${d.senderCity||""}, ${today}</div>
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:12px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b)">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Empf√§nger</span>
      </div>
      <div style="padding:14px 18px;font-size:13px;line-height:1.7;color:var(--t)">
        <strong>${c.provider||""}</strong>
        ${c.contractNo?`<br><span style="font-size:12px;color:var(--tm)">Vertragsnummer: ${c.contractNo}</span>`:""}
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:12px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Betreff</span>
        <span style="font-size:11px;color:var(--tm)">Bearbeitbar</span>
      </div>
      <div style="padding:4px 14px">
        <input id="caEditSubject" value="${(cancelForm.editSubject||"").replace(/"/g,'&quot;')}" oninput="cancelForm.editSubject=this.value" style="width:100%;border:none;border-bottom:2px solid var(--b);outline:none;background:transparent;color:var(--t);font-size:14px;font-weight:700;padding:6px 0;transition:border-color 0.2s" onfocus="this.style.borderColor='var(--ba)'" onblur="this.style.borderColor='var(--b)'">
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:12px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Brieftext</span>
        <span style="font-size:11px;color:var(--tm)">Bearbeitbar</span>
      </div>
      <div style="padding:14px 18px">
        <p style="font-size:13px;color:var(--tm);margin:0 0 10px">Sehr geehrte Damen und Herren,</p>
        <textarea id="caEditBody" oninput="cancelForm.editBody=this.value" style="width:100%;min-height:220px;background:var(--bgE);border:1px solid var(--b);border-radius:10px;padding:12px 14px;color:var(--t);font-size:13px;line-height:1.6;font-family:inherit;resize:vertical;outline:none;transition:border-color 0.2s" onfocus="this.style.borderColor='var(--ba)'" onblur="this.style.borderColor='var(--b)'">${cancelForm.editBody||""}</textarea>
      </div>
    </div>

    <div class="card" style="padding:0;overflow:hidden;margin-bottom:20px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">Abschlusssatz</span>
        <span style="font-size:11px;color:var(--tm)">Bearbeitbar</span>
      </div>
      <div style="padding:4px 14px">
        <input id="caEditClosing" value="${(cancelForm.editClosing||"").replace(/"/g,'&quot;')}" oninput="cancelForm.editClosing=this.value" style="width:100%;border:none;border-bottom:2px solid var(--b);outline:none;background:transparent;color:var(--t);font-size:13px;padding:6px 0;transition:border-color 0.2s" onfocus="this.style.borderColor='var(--ba)'" onblur="this.style.borderColor='var(--b)'">
      </div>
      <div style="padding:10px 18px 14px;font-size:13px;color:var(--tm)">
        Mit freundlichen Gr√º√üen<br>
        <span style="color:var(--t);font-weight:600">${d.senderName||""}</span>
      </div>
    </div>


    <div class="card" style="padding:0;overflow:hidden;margin-bottom:20px">
      <div style="padding:12px 18px;background:var(--bgE);border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <span style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px">‚úçÔ∏è Unterschrift</span>
        <div style="display:flex;gap:6px">
          <button onclick="sigSetMode('cancel','draw')" id="caSigTabDraw" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--ba);background:var(--emG);color:var(--em);font-weight:600;cursor:pointer">‚úèÔ∏è Zeichnen</button>
          <button onclick="sigSetMode('cancel','upload')" id="caSigTabUpload" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--b);background:transparent;color:var(--tm);cursor:pointer">üìÅ Hochladen</button>
          <button onclick="sigClear('cancel')" style="font-size:11px;padding:4px 10px;border-radius:6px;border:1px solid var(--b);background:transparent;color:var(--co);cursor:pointer">‚úï L√∂schen</button>
        </div>
      </div>
      <div style="padding:16px 18px">
        <div id="caSigDraw">
          <p style="font-size:12px;color:var(--tm);margin:0 0 8px">Mit Maus oder Finger unterschreiben:</p>
          <canvas id="caSigCanvas" style="width:100%;height:120px;border:2px dashed var(--b);border-radius:10px;background:#fff;cursor:crosshair;touch-action:none;display:block" onmouseenter="sigInitCanvas('cancel')" ontouchstart="sigInitCanvas('cancel')"></canvas>
        </div>
        <div id="caSigUpload" style="display:none">
          <p style="font-size:12px;color:var(--tm);margin:0 0 8px">Unterschriftsdatei hochladen (PNG, JPG):</p>
          <label style="display:flex;align-items:center;gap:10px;padding:12px 16px;border:2px dashed var(--b);border-radius:10px;cursor:pointer;background:var(--bgE)">
            <span style="font-size:22px">üìÅ</span>
            <span style="font-size:13px;color:var(--tm)">Datei ausw√§hlen oder hierher ziehen</span>
            <input type="file" accept="image/*" onchange="sigLoadFile('cancel',this)" style="display:none">
          </label>
        </div>
        <div id="caSigPreview" style="display:none;margin-top:10px">
          <p style="font-size:11px;color:var(--em);margin:0 0 6px">‚úì Unterschrift gespeichert</p>
          <img id="caSigImg" style="max-height:80px;border-radius:8px;border:1px solid var(--b)">
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;padding-top:4px">
      <button class="btn btn-outline" onclick="cancelForm.step=2;renderPage()">‚úèÔ∏è Daten bearbeiten</button>
      <button class="btn btn-outline" onclick="cancelForm={contractId:null,template:null,style:'formell',step:1,editSubject:'',editBody:'',editClosing:'',data:{senderName:'',senderStreet:'',senderZip:'',senderCity:'',senderEmail:'',reason:'',effectiveDate:'',customNote:''}};renderPage()">üîÑ Neue K√ºndigung</button>
      <button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="navigator.clipboard.writeText((document.getElementById('caEditSubject')?.value||cancelForm.editSubject)+'\n\nSehr geehrte Damen und Herren,\n\n'+(document.getElementById('caEditBody')?.value||cancelForm.editBody)+'\n\n'+(document.getElementById('caEditClosing')?.value||cancelForm.editClosing)+'\n\nMit freundlichen Gr√º√üen\n${d.senderName}').then(()=>flash('Text kopiert üìã'))">üìã Kopieren</button>
      <button class="btn btn-outline" onclick="sendCancelMail()">‚úâÔ∏è E-Mail</button>
      <button class="btn btn-primary" onclick="cancelForm.editSubject=document.getElementById('caEditSubject')?.value||cancelForm.editSubject;cancelForm.editBody=document.getElementById('caEditBody')?.value||cancelForm.editBody;cancelForm.editClosing=document.getElementById('caEditClosing')?.value||cancelForm.editClosing;openCancelPdfPreview()" style="background:linear-gradient(135deg,#7C3AED,#6D28D9)">üìÑ PDF generieren</button>
    </div>`;
  setTimeout(()=>{sigSetMode('cancel','draw');if(sigState.cancel)sigShowPreview('cancel',sigState.cancel);},200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNTERSCHRIFTS-SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const sigState = { agree: null, cancel: null };

function sigSetMode(form, mode){
  const p = form==="agree" ? "ag" : "ca";
  const drawDiv   = document.getElementById(p+"SigDraw");
  const uploadDiv = document.getElementById(p+"SigUpload");
  const drawBtn   = document.getElementById(p+"SigTabDraw");
  const uploadBtn = document.getElementById(p+"SigTabUpload");
  if(drawDiv)   drawDiv.style.display   = mode==="draw"   ? "" : "none";
  if(uploadDiv) uploadDiv.style.display = mode==="upload" ? "" : "none";
  const active   = "border:1px solid var(--ba);background:var(--emG);color:var(--em);font-weight:600;cursor:pointer;font-size:11px;padding:4px 10px;border-radius:6px";
  const inactive = "border:1px solid var(--b);background:transparent;color:var(--tm);cursor:pointer;font-size:11px;padding:4px 10px;border-radius:6px";
  if(drawBtn)   drawBtn.style.cssText   = mode==="draw"   ? active : inactive;
  if(uploadBtn) uploadBtn.style.cssText = mode==="upload" ? active : inactive;
  if(mode==="draw"){
    // Retry bis Canvas gerendert ist
    function tryInit(attempts){
      const c = document.getElementById((form==="agree"?"ag":"ca")+"SigCanvas");
      if(!c) return;
      const r = c.getBoundingClientRect();
      if(r.width > 0){ sigInitCanvas(form); }
      else if(attempts > 0){ setTimeout(()=>tryInit(attempts-1), 50); }
    }
    tryInit(10);
  }
}

function sigInitCanvas(form){
  const p = form==="agree" ? "ag" : "ca";
  const canvas = document.getElementById(p+"SigCanvas");
  if(!canvas) return;

  // Always resize canvas pixels to match rendered CSS size
  const rect = canvas.getBoundingClientRect();
  if(rect.width === 0) { setTimeout(()=>sigInitCanvas(form), 50); return; }

  canvas.width  = rect.width;
  canvas.height = rect.height;

  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Remove old listeners by replacing with clone, keep reference
  if(canvas._sigHandler){
    canvas.removeEventListener("mousedown",  canvas._sigHandler.md);
    canvas.removeEventListener("mousemove",  canvas._sigHandler.mm);
    canvas.removeEventListener("mouseup",    canvas._sigHandler.mu);
    canvas.removeEventListener("mouseleave", canvas._sigHandler.ml);
    canvas.removeEventListener("touchstart", canvas._sigHandler.ts);
    canvas.removeEventListener("touchmove",  canvas._sigHandler.tm);
    canvas.removeEventListener("touchend",   canvas._sigHandler.te);
  }

  let drawing = false, lx = 0, ly = 0;

  function xy(e){
    const r = canvas.getBoundingClientRect();
    const s = e.touches ? e.touches[0] : e;
    return { x: s.clientX - r.left, y: s.clientY - r.top };
  }

  function save(){
    // Auto-crop: nur den tats√§chlich beschriebenen Bereich speichern
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const d = imgData.data;
    let minX=canvas.width, minY=canvas.height, maxX=0, maxY=0;
    for(let y=0;y<canvas.height;y++){
      for(let x=0;x<canvas.width;x++){
        const i=(y*canvas.width+x)*4;
        // Pixel ist nicht wei√ü/transparent
        if(d[i]<240 || d[i+1]<240 || d[i+2]<240){
          if(x<minX)minX=x; if(x>maxX)maxX=x;
          if(y<minY)minY=y; if(y>maxY)maxY=y;
        }
      }
    }
    if(maxX<=minX || maxY<=minY){
      // Nichts gezeichnet
      sigState[form]=null; return;
    }
    // Padding um die Unterschrift
    const pad=12;
    minX=Math.max(0,minX-pad); minY=Math.max(0,minY-pad);
    maxX=Math.min(canvas.width,maxX+pad); maxY=Math.min(canvas.height,maxY+pad);
    const crop=document.createElement("canvas");
    crop.width=maxX-minX; crop.height=maxY-minY;
    crop.getContext("2d").drawImage(canvas,minX,minY,crop.width,crop.height,0,0,crop.width,crop.height);
    sigState[form] = crop.toDataURL("image/png");
    sigShowPreview(form, sigState[form]);
  }

  const md = e => { drawing=true; const c=xy(e); lx=c.x; ly=c.y;
    ctx.fillStyle="#000"; ctx.beginPath(); ctx.arc(lx,ly,1,0,Math.PI*2); ctx.fill(); };
  const mm = e => { if(!drawing) return; const c=xy(e);
    ctx.strokeStyle="#000"; ctx.lineWidth=2.5; ctx.lineCap="round"; ctx.lineJoin="round";
    ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(c.x,c.y); ctx.stroke();
    lx=c.x; ly=c.y; };
  const mu = e => { if(!drawing) return; drawing=false; save(); };
  const ml = e => { if(!drawing) return; drawing=false; save(); };
  const ts = e => { e.preventDefault(); drawing=true; const c=xy(e); lx=c.x; ly=c.y; };
  const tm = e => { e.preventDefault(); if(!drawing) return; const c=xy(e);
    ctx.strokeStyle="#000"; ctx.lineWidth=2.5; ctx.lineCap="round"; ctx.lineJoin="round";
    ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(c.x,c.y); ctx.stroke();
    lx=c.x; ly=c.y; };
  const te = e => { e.preventDefault(); drawing=false; save(); };

  canvas.addEventListener("mousedown",  md);
  canvas.addEventListener("mousemove",  mm);
  canvas.addEventListener("mouseup",    mu);
  canvas.addEventListener("mouseleave", ml);
  canvas.addEventListener("touchstart", ts, {passive:false});
  canvas.addEventListener("touchmove",  tm, {passive:false});
  canvas.addEventListener("touchend",   te, {passive:false});
  canvas._sigHandler = {md,mm,mu,ml,ts,tm,te};
}

function sigLoadFile(form, input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    sigState[form] = e.target.result;
    sigShowPreview(form, e.target.result);
    flash("Unterschrift geladen ‚úì");
  };
  reader.readAsDataURL(file);
}

function sigShowPreview(form, dataUrl){
  const p = form==="agree" ? "ag" : "ca";
  const preview = document.getElementById(p+"SigPreview");
  const img     = document.getElementById(p+"SigImg");
  if(preview && img && dataUrl){ img.src=dataUrl; preview.style.display=""; }
}

function sigClear(form){
  sigState[form] = null;
  const p = form==="agree" ? "ag" : "ca";
  const canvas = document.getElementById(p+"SigCanvas");
  if(canvas){
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  const preview = document.getElementById(p+"SigPreview");
  if(preview) preview.style.display="none";
  flash("Unterschrift gel√∂scht");
}

function sigMaybeInit(form){ setTimeout(()=>sigInitCanvas(form), 200); }

// ‚îÄ‚îÄ‚îÄ Ratenrechner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _calcMonths = 12;

function calcRate(){
  const amt = parseFloat(document.getElementById("agAm")?.value || agreeForm.data.amount || 0);
  const rate = parseFloat(document.getElementById("agR")?.value || agreeForm.data.rate || 0);
  if(amt > 0 && rate > 0){
    _calcMonths = Math.ceil(amt / rate);
    const slider = document.getElementById("agCalcSlider");
    if(slider) slider.value = Math.min(48, _calcMonths);
    updateCalcDisplay(amt, _calcMonths);
  }
}

function applyCalcMonths(months){
  _calcMonths = months;
  const slider = document.getElementById("agCalcSlider");
  if(slider) slider.value = months;
  const amt = parseFloat(document.getElementById("agAm")?.value || agreeForm.data.amount || 0);
  updateCalcDisplay(amt, months);
  // Highlight active quick-button
  [3,6,12,18,24,36].forEach(m => {
    const btn = document.getElementById("agCalcBtn"+m);
    if(btn){
      btn.style.background   = m===months ? "var(--emG)" : "var(--bgE)";
      btn.style.color        = m===months ? "var(--em)"  : "var(--tm)";
      btn.style.borderColor  = m===months ? "var(--ba)"  : "var(--b)";
      btn.style.fontWeight   = m===months ? "700"        : "400";
    }
  });
}

function updateCalcDisplay(amt, months){
  const rate  = amt > 0 && months > 0 ? Math.ceil((amt / months) * 100) / 100 : 0;
  const total = rate * months;
  const diff  = total - amt;
  const fmt2  = n => n.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2});
  const rEl   = document.getElementById("agCalcRate");
  const mEl   = document.getElementById("agCalcMonths");
  const tEl   = document.getElementById("agCalcTotal");
  const hEl   = document.getElementById("agCalcHint");
  if(rEl) rEl.textContent  = rate  > 0 ? fmt2(rate)  + " ‚Ç¨" : "‚Äì";
  if(mEl) mEl.textContent  = months > 0 ? months + " Mo." : "‚Äì";
  if(tEl){
    tEl.textContent = total > 0 ? fmt2(total) + " ‚Ç¨" : "‚Äì";
    tEl.style.color = diff > 0.01 ? "var(--co)" : "var(--em)";
  }
  if(hEl){
    if(diff > 0.01) hEl.textContent = "+" + fmt2(diff) + " ‚Ç¨ Rundungsaufschlag";
    else if(amt > 0) hEl.textContent = "‚úì Geht genau auf";
    else hEl.textContent = "";
  }
}

function adoptCalcRate(){
  const amt = parseFloat(document.getElementById("agAm")?.value || agreeForm.data.amount || 0);
  if(!amt || !_calcMonths){ flash("Bitte zuerst Betrag eingeben"); return; }
  const rate = Math.ceil((amt / _calcMonths) * 100) / 100;
  agreeForm.data.rate = rate;
  const rateInput = document.getElementById("agR");
  if(rateInput){ rateInput.value = rate; }
  flash("Rate von " + rate.toLocaleString("de-DE",{minimumFractionDigits:2}) + " ‚Ç¨ √ºbernommen ‚úì");
}

function sendAgreeMail(){
  const d=agreeForm.data;
  const betreff=document.getElementById("agEditBetreff")?.value||agreeForm.editBetreff||getDocContent().betreff;
  const body=document.getElementById("agEditBody")?.value||agreeForm.editBody||getDocContent().body;
  const closing=document.getElementById("agEditClosing")?.value||agreeForm.editClosing||getDocContent().closing;
  const creditorEmail=agreeForm.debt?.creditorEmail||"";
  const senderName=d.name||user.name||"";
  const fullText="Sehr geehrte Damen und Herren,\n\n"+body+"\n\n"+closing+"\n\nMit freundlichen Gr√º√üen\n"+senderName;
  const mailto="mailto:"+creditorEmail+"?subject="+encodeURIComponent(betreff)+"&body="+encodeURIComponent(fullText);
  if(!creditorEmail){flash("E-Mail-Client wird ge√∂ffnet ‚Äì bitte Empf√§nger eintragen");}
  window.location.href=mailto;
}
function sendCancelMail(){
  const c=selectedCancelContract();
  const d=cancelForm.data;
  const subject=document.getElementById("caEditSubject")?.value||cancelForm.editSubject||getCancelDocContent().subject;
  const bodyText=document.getElementById("caEditBody")?.value||cancelForm.editBody||getCancelDocContent().body;
  const closing=document.getElementById("caEditClosing")?.value||cancelForm.editClosing||getCancelDocContent().closing;
  const senderName=d.senderName||user.name||"";
  const fullBody="Sehr geehrte Damen und Herren,\n\n"+bodyText+"\n\n"+closing+"\n\nMit freundlichen Gr√º√üen\n"+senderName;
  // Vertr√§ge haben selten eine hinterlegte E-Mail ‚Äì trotzdem √∂ffnen, Nutzer tr√§gt Empf√§nger ein
  const to=c?.email||c?.creditorEmail||"";
  const mailto="mailto:"+to+"?subject="+encodeURIComponent(subject)+"&body="+encodeURIComponent(fullBody);
  if(!to){flash("E-Mail-Client wird ge√∂ffnet ‚Äì bitte Empf√§nger eintragen");}
  window.location.href=mailto;
}
function printContractLetter(){
  const c=selectedCancelContract();
  const d=cancelForm.data;
  const doc=getCancelDocContent();
  const today=doc.today;
  const provider=c?.provider||"[Vertragspartner]";
  const contractNo=c?.contractNo?`Vertragsnummer: ${c.contractNo}`:"";
  const w=window.open("","_blank");
  w.document.write(`<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"><title>${doc.subject}</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial,sans-serif;font-size:11pt;line-height:1.7;color:#1a1a1a}
  .page{max-width:800px;margin:0 auto;padding:25mm 22mm 20mm 25mm}
  @media print{.page{padding:14mm 18mm 14mm 22mm}}
  .letterhead{display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:2px solid #1a1a1a;margin-bottom:20px}
  .sender .name{font-size:13pt;font-weight:700;margin-bottom:4px}
  .sender-small{font-size:8.5pt;color:#777;border-bottom:1px solid #ccc;padding-bottom:4px;margin-bottom:8px}
  .subject{font-size:12pt;font-weight:700;text-decoration:underline;text-underline-offset:3px;margin:22px 0 18px}
  .body-text{white-space:pre-wrap;text-align:justify;margin-bottom:16px}
  .sig-line{border-top:1px solid #1a1a1a;width:240px;margin-top:52px;margin-bottom:4px}
  .footer{margin-top:44px;padding-top:8px;border-top:1px solid #ccc;font-size:8pt;color:#999;text-align:center}
</style></head><body><div class="page">
  <div class="letterhead">
    <div class="sender">
      <div class="sender-small">${d.senderName||""} ¬∑ ${d.senderStreet||""} ¬∑ ${d.senderZip||""} ${d.senderCity||""}</div>
      <div class="name">${d.senderName||"[Name]"}</div>
      <div>${d.senderStreet||""}</div>
      <div>${d.senderZip||""} ${d.senderCity||""}</div>
      ${d.senderEmail?`<div style="margin-top:4px">${d.senderEmail}</div>`:""}
    </div>
    <div style="text-align:right;font-size:10.5pt;color:#444">${d.senderCity||""}, ${today}</div>
  </div>
  <div style="margin-bottom:22px;line-height:1.8"><strong>${provider}</strong>${contractNo?`<br><span style="font-size:10pt;color:#555">${contractNo}</span>`:""}</div>
  <div class="subject">Betreff: ${doc.subject}</div>
  <p style="margin-bottom:14px">Sehr geehrte Damen und Herren,</p>
  <div class="body-text">${doc.body}</div>
  <p style="text-align:justify;margin-bottom:30px">${doc.closing}</p>
  <p style="margin-bottom:44px">Mit freundlichen Gr√º√üen</p>
  <div class="sig-line"></div>
  <strong>${d.senderName||""}</strong>
  <div class="footer">Erstellt mit Ratenova ¬∑ ratenova.de</div>
</div></div>
</div></body></html>`);
  w.document.close();
  setTimeout(()=>w.print(),350);
}
// ‚îÄ‚îÄ‚îÄ PDF Vorschau: Vereinbarungsbrief ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openAgreementPdfPreview(){
  const d   = agreeForm.data;
  const today = new Date().toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"});
  const subject = agreeForm.editBetreff || getDocContent().betreff;
  const body    = agreeForm.editBody    || getDocContent().body;
  const closing = agreeForm.editClosing || getDocContent().closing;
  const payload = {
    senderName:    d.name    || "",
    senderStreet:  d.street  || "",
    senderZip:     d.zip     || "",
    senderCity:    d.city    || "",
    senderEmail:   "",
    recipientName:   d.creditor       || "",
    recipientStreet: d.creditorStreet || "",
    recipientZip:    d.creditorZip    || "",
    recipientCity:   d.creditorCity   || "",
    date:    today,
    subject,
    salutation: "Sehr geehrte Damen und Herren,",
    body,
    closing,
    signatureName: d.name || "",
    signatureImage: sigState.agree || "",
  };
  await generateLetterPdf(payload, subject);
}

// ‚îÄ‚îÄ‚îÄ PDF Vorschau: K√ºndigungsbrief ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openCancelPdfPreview(){
  const d   = cancelForm.data;
  const c   = selectedCancelContract();
  const today = new Date().toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"});
  const subject = cancelForm.editSubject || getCancelDocContent().subject;
  const body    = cancelForm.editBody    || getCancelDocContent().body;
  const closing = cancelForm.editClosing || getCancelDocContent().closing;
  const payload = {
    senderName:   d.senderName   || "",
    senderStreet: d.senderStreet || "",
    senderZip:    d.senderZip    || "",
    senderCity:   d.senderCity   || "",
    senderEmail:  d.senderEmail  || "",
    recipientName:   c?.provider || "",
    recipientStreet: "",
    recipientZip:    "",
    recipientCity:   "",
    date:    today,
    subject,
    salutation: "Sehr geehrte Damen und Herren,",
    body,
    closing,
    signatureName: d.senderName || "",
    signatureImage: sigState.cancel || "",
  };
  await generateLetterPdf(payload, subject);
}

// ‚îÄ‚îÄ‚îÄ Gemeinsame Funktion: Browser-seitige PDF-Generierung mit jsPDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateLetterPdf(payload, title){
  flash("üìÑ PDF wird erstellt‚Ä¶");
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ format: "a4", unit: "mm" });

    // ‚îÄ‚îÄ Seitenma√üe & R√§nder (DIN 5008) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const mL = 25, mR = 22, mT = 20;
    const pageW = 210, pageH = 297;
    const contentW = pageW - mL - mR;
    let y = mT;

    // ‚îÄ‚îÄ Hilfsfunktionen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const checkPage = (needed = 8) => {
      if (y + needed > pageH - 20) { doc.addPage(); y = mT; }
    };

    const writeLine = (text, x, fontSize = 10.5, style = "normal", color = [26,26,26]) => {
      doc.setFontSize(fontSize);
      doc.setFont("helvetica", style);
      doc.setTextColor(...color);
      doc.text(String(text || ""), x, y);
    };

    const writeBlock = (lines, x, fontSize = 10.5, style = "normal", color = [26,26,26], lineH = 5.5) => {
      doc.setFontSize(fontSize);
      doc.setFont("helvetica", style);
      doc.setTextColor(...color);
      for (const line of lines) {
        checkPage(lineH);
        doc.text(String(line || ""), x, y);
        y += lineH;
      }
    };

    const writeWrapped = (text, x, maxW, fontSize = 10.5, style = "normal", color = [26,26,26], lineH = 5.5) => {
      doc.setFontSize(fontSize);
      doc.setFont("helvetica", style);
      doc.setTextColor(...color);
      const lines = doc.splitTextToSize(String(text || ""), maxW);
      for (const line of lines) {
        checkPage(lineH);
        doc.text(line, x, y);
        y += lineH;
      }
    };

    const {
      senderName="", senderStreet="", senderZip="", senderCity="", senderEmail="",
      recipientName="", recipientStreet="", recipientZip="", recipientCity="",
      date="", subject="", salutation="Sehr geehrte Damen und Herren,",
      body="", closing="", signatureName="", signatureImage=""
    } = payload;

    // ‚îÄ‚îÄ Seite 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // Absenderblock oben links
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(26,26,26);
    doc.text(senderName, mL, y);

    // Datum oben rechts
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(51,51,51);
    const dateText = (senderCity ? senderCity + ", " : "") + date;
    doc.text(dateText, pageW - mR, y + 10, { align: "right" });

    y += 5.5;
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(34,34,34);
    doc.text(senderStreet, mL, y); y += 5.5;
    doc.text(senderZip + " " + senderCity, mL, y); y += 5.5;
    if (senderEmail) {
      doc.setTextColor(85,85,85);
      doc.setFontSize(9.5);
      doc.text(senderEmail, mL, y); y += 5;
    }

    // Trennlinie
    y += 3;
    doc.setDrawColor(26,26,26);
    doc.setLineWidth(0.5);
    doc.line(mL, y, pageW - mR, y);
    y += 8;

    // R√ºcksendeadresse (klein, √ºber Empf√§nger)
    const senderLine = [senderName, senderStreet, senderZip + " " + senderCity].filter(Boolean).join(" ¬∑ ");
    doc.setFontSize(7);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(136,136,136);
    doc.text(senderLine, mL, y);
    y += 3;
    doc.setDrawColor(187,187,187);
    doc.setLineWidth(0.3);
    doc.line(mL, y, mL + 85, y);
    y += 4;

    // Empf√§ngerblock
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(26,26,26);
    doc.text(recipientName, mL, y); y += 6;
    doc.setFontSize(10.5);
    doc.setFont("helvetica", "normal");
    if (recipientStreet) { doc.text(recipientStreet, mL, y); y += 5.5; }
    if (recipientZip || recipientCity) { doc.text((recipientZip + " " + recipientCity).trim(), mL, y); y += 5.5; }

    y += 14; // Abstand vor Betreff

    // Betreff (fett, unterstrichen)
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(26,26,26);
    const betreffText = "Betreff: " + subject;
    const betreffLines = doc.splitTextToSize(betreffText, contentW);
    for (const line of betreffLines) {
      doc.text(line, mL, y);
      const tw = doc.getTextWidth(line);
      doc.setDrawColor(26,26,26);
      doc.setLineWidth(0.3);
      doc.line(mL, y + 0.8, mL + tw, y + 0.8);
      y += 6;
    }
    y += 6;

    // Anrede
    writeWrapped(salutation, mL, contentW, 10.5, "normal", [26,26,26], 5.5);
    y += 6;

    // Brieftext ‚Äì Zahlungsblock erkennen (Zeilen mit 4+ Spaces = Tabellenzeilen)
    const bodyLines = (body || "").split("\n");
    let i = 0;
    while (i < bodyLines.length) {
      const line = bodyLines[i];
      if (/^ {4}/.test(line) && line.trim().length > 0) {
        // Zahlungsblock sammeln
        const tableLines = [];
        while (i < bodyLines.length && /^ {4}/.test(bodyLines[i]) && bodyLines[i].trim().length > 0) {
          tableLines.push(bodyLines[i].trim());
          i++;
        }
        // Tabelle zeichnen
        y += 2;
        for (const tl of tableLines) {
          checkPage(6);
          const match = tl.match(/^(.+?)\s{2,}(.+)$/);
          if (match) {
            doc.setFontSize(10.5); doc.setFont("helvetica","normal"); doc.setTextColor(51,51,51);
            doc.text(match[1], mL + 8, y);
            doc.setFont("helvetica","bold"); doc.setTextColor(26,26,26);
            doc.text(match[2], mL + 72, y);
            y += 6;
          } else {
            doc.setFontSize(10.5); doc.setFont("helvetica","normal"); doc.setTextColor(26,26,26);
            doc.text(tl, mL + 8, y); y += 6;
          }
        }
        y += 2;
      } else {
        // Normaler Text
        if (line.trim() === "") {
          y += 4;
        } else {
          const wrapped = doc.splitTextToSize(line, contentW);
          doc.setFontSize(10.5); doc.setFont("helvetica","normal"); doc.setTextColor(26,26,26);
          for (const wl of wrapped) {
            checkPage(5.5);
            doc.text(wl, mL, y); y += 5.5;
          }
        }
        i++;
      }
    }

    // Abschlusstext
    if (closing) {
      y += 4;
      writeWrapped(closing, mL, contentW, 10.5, "normal", [26,26,26], 5.5);
    }

    y += 10;
    checkPage(40);

    // Mit freundlichen Gr√º√üen
    doc.setFontSize(10.5); doc.setFont("helvetica","normal"); doc.setTextColor(26,26,26);
    doc.text("Mit freundlichen Gr√º√üen", mL, y); y += 14;

    // Unterschrift oder Linie
    if (signatureImage && signatureImage.startsWith("data:image")) {
      try {
        const imgFormat = signatureImage.includes("data:image/png") ? "PNG" : "JPEG";
        // 52px ‚Üí ~18mm bei 72dpi
        doc.addImage(signatureImage, imgFormat, mL, y, 52, 18, undefined, "FAST");
        y += 20;
      } catch(e) {
        doc.setDrawColor(26,26,26); doc.setLineWidth(0.4);
        doc.line(mL, y, mL + 52, y); y += 4;
      }
    } else {
      doc.setDrawColor(26,26,26); doc.setLineWidth(0.4);
      doc.line(mL, y, mL + 52, y); y += 4;
    }

    // Name fett
    doc.setFontSize(10.5); doc.setFont("helvetica","bold"); doc.setTextColor(26,26,26);
    doc.text(signatureName || senderName, mL, y); y += 5.5;
    // Adresse
    doc.setFontSize(9); doc.setFont("helvetica","normal"); doc.setTextColor(85,85,85);
    doc.text(senderStreet + ", " + senderZip + " " + senderCity, mL, y);

    // ‚îÄ‚îÄ Speichern & √ñffnen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const filename = (title || "Brief").replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü _-]/g, "") + ".pdf";
    doc.save(filename);
    flash("‚úì PDF gespeichert");
  } catch (err) {
    console.error("PDF generation failed:", err);
    flash("PDF-Fehler: " + (err.message || "Unbekannter Fehler"));
  }
}

async function deleteContract(id){if(!await confirmModal.show("Vertrag wirklich l√∂schen? Dieser Schritt kann nicht r√ºckg√§ngig gemacht werden.",{title:"Vertrag l√∂schen",okText:"L√∂schen",icon:"üóëÔ∏è"}))return;await autoSnapshot("contract_delete",true);contracts=contracts.filter(c=>c.id!==id);scheduleCloudSave();renderPage();flash("Vertrag gel√∂scht")}
function attachContractDocs(id,e){const c=contracts.find(x=>x.id===id);if(!c)return;const files=[...(e?.target?.files||[])];if(!files.length)return;c.documents=[...(c.documents||[]),...files.map(f=>({name:f.name,size:f.size,uploadedAt:new Date().toISOString()}))];scheduleCloudSave();renderPage();flash("Dokument(e) hinzugef√ºgt")}
function loadBudget(){try{const raw=localStorage.getItem("budgetItems");if(raw){const arr=JSON.parse(raw);if(Array.isArray(arr))budgetItems=arr}else{budgetItems=[];saveBudget()}}catch(e){}}
function isSeedBudgetItem(i){
  const ids=[101,102,103,104];
  if(ids.includes(i?.id))return true;
  const S=[
    {type:"income",category:"Gehalt",note:"Teilzeit",amount:1800},
    {type:"expense",category:"Miete",note:"Warmmiete",amount:650},
    {type:"expense",category:"Strom/Gas",note:"Abschlag",amount:120},
    {type:"expense",category:"Lebensmittel",note:"W√∂chentlich",amount:240}
  ];
  return S.some(s=>String(i?.type)===s.type&&String(i?.category||"")===s.category&&String(i?.note||"")===s.note&&Number(i?.amount)===s.amount);
}
function purgeCurrentUserSeedBudget(){
  const before=Array.isArray(budgetItems)?budgetItems.length:0;
  budgetItems=(Array.isArray(budgetItems)?budgetItems:[]).filter(i=>!isSeedBudgetItem(i));
  if(budgetItems.length!==before){
    saveBudget();
    scheduleCloudSave();
    try{localStorage.setItem("budgetItems",JSON.stringify(budgetItems))}catch(e){}
    flash("Beispiel‚ÄëEin/Ausgaben entfernt ‚úì");
  }
}
function saveBudget(){scheduleCloudSave();try{localStorage.setItem("budgetItems",JSON.stringify(budgetItems))}catch(e){}}

// ‚ïê‚ïê‚ïê BUDGET STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._bFilter = window._bFilter || {
  mode:     'month',   // 'month' | 'quarter' | 'year' | 'custom'
  month:    null,      // YYYY-MM (null = currentBudgetMonth)
  quarter:  null,      // 'YYYY-Q1'
  year:     null,      // 'YYYY'
  from:     '',        // custom from YYYY-MM-DD
  to:       '',        // custom to YYYY-MM-DD
  type:     'all',     // 'all' | 'income' | 'expense'
  category: '',        // '' = all categories
  search:   '',        // free text
  view:     'list',    // 'list' | 'categories' | 'chart'
};

function bfGet()  { return window._bFilter; }
function bfSet(k,v){ window._bFilter[k]=v; renderPage(); }

// ‚îÄ‚îÄ‚îÄ Date range from filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bfDateRange(){
  const f=bfGet();
  if(f.mode==='month'){
    const m=f.month||currentBudgetMonth;
    // last day of month
    const ld=new Date(parseInt(m.slice(0,4)),parseInt(m.slice(5,7)),0).getDate();
    return {from:`${m}-01`,to:`${m}-${String(ld).padStart(2,'0')}`,label:new Date(m+'-01T00:00:00').toLocaleDateString('de-DE',{month:'long',year:'numeric'})};
  }
  if(f.mode==='quarter'){
    const yr=parseInt(f.quarter)||new Date().getFullYear();
    const q=parseInt((f.quarter||'').split('-Q')[1])||Math.ceil((new Date().getMonth()+1)/3);
    const mStart=(q-1)*3+1;
    const mEnd=q*3;
    const lastDay=new Date(yr,mEnd,0).getDate();
    const from=`${yr}-${String(mStart).padStart(2,'0')}-01`;
    const to=`${yr}-${String(mEnd).padStart(2,'0')}-${String(lastDay).padStart(2,'0')}`;
    return {from,to,label:`Q${q} ${yr}`};
  }
  if(f.mode==='year'){
    const yr=f.year||String(new Date().getFullYear());
    return {from:`${yr}-01-01`,to:`${yr}-12-31`,label:`Jahr ${yr}`};
  }
  if(f.mode==='custom'&&f.from&&f.to){
    const fd=new Date(f.from+'T00:00:00').toLocaleDateString('de-DE',{day:'numeric',month:'short',year:'numeric'});
    const td=new Date(f.to+'T00:00:00').toLocaleDateString('de-DE',{day:'numeric',month:'short',year:'numeric'});
    return {from:f.from,to:f.to,label:`${fd} ‚Äì ${td}`};
  }
  // fallback
  const m=currentBudgetMonth;
  const ld=new Date(parseInt(m.slice(0,4)),parseInt(m.slice(5,7)),0).getDate();
  return {from:`${m}-01`,to:`${m}-${String(ld).padStart(2,'0')}`,label:m};
}

// ‚îÄ‚îÄ‚îÄ Get all budget items for current filter range ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bfItems(){
  const f=bfGet();
  const {from,to}=bfDateRange();

  // Gather manual + auto items across the range
  let items=[];

  // For month mode: use existing logic per month
  // For wider ranges: iterate months
  const months=bfMonthsInRange(from,to);

  months.forEach(function(mo){
    // manual
    const manual=budgetItems.filter(function(i){return i.date&&i.date>=from&&i.date<=to;});
    // auto debt items for this month
    const monthEnd=`${mo}-31`;
    const autoDebt=debts.filter(function(d){return d.paid<d.original;}).flatMap(function(d){
      const ps=getPaymentStatus(d),remaining=Math.max(d.original-d.paid,0),dueDay=((d.due||'').split('-')[2]||'01');
      const pDate=`${mo}-${dueDay}`;
      if(ps==='ratenplan_aktiv'&&d.trackInBudget!==false&&pDate>=from&&pDate<=to)
        return [{id:`auto-${d.id}-${mo}`,type:'expense',date:pDate,amount:Math.min(d.rate||0,remaining),category:'Position',note:`Automatisch: ${d.name}`,auto:true,debtId:d.id}];
      if(ps==='ueberfaellig'&&((d.due||'')<=monthEnd)&&d.trackInBudget!==false&&pDate>=from&&pDate<=to)
        return [{id:`auto-${d.id}-${mo}-ue`,type:'expense',date:pDate,amount:remaining,category:'Position',note:`Automatisch √ºberf√§llig: ${d.name}`,auto:true,debtId:d.id}];
      return [];
    });
    items=[...items,...manual,...autoDebt];
  });

  // Dedup by id
  const seen=new Set();
  items=items.filter(function(i){if(seen.has(String(i.id)))return false;seen.add(String(i.id));return true;});

  // Apply type filter
  if(f.type==='income') items=items.filter(function(i){return i.type==='income';});
  if(f.type==='expense') items=items.filter(function(i){return i.type==='expense';});

  // Apply category filter
  if(f.category) items=items.filter(function(i){return (i.category||'').toLowerCase()===f.category.toLowerCase();});

  // Apply search
  if(f.search){
    const q=f.search.toLowerCase();
    items=items.filter(function(i){return (i.note||'').toLowerCase().includes(q)||(i.category||'').toLowerCase().includes(q);});
  }

  return items.sort(function(a,b){return new Date(a.date)-new Date(b.date);});
}

function bfMonthsInRange(from,to){
  const months=[];
  let cur=from.slice(0,7);
  const end=to.slice(0,7);
  let safety=0;
  while(cur<=end&&safety++<36){
    months.push(cur);
    const [yr,mo]=cur.split('-').map(Number);
    const next=mo===12?`${yr+1}-01`:`${yr}-${String(mo+1).padStart(2,'0')}`;
    cur=next;
  }
  return months;
}

// ‚îÄ‚îÄ‚îÄ All categories in current range ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bfCategories(){
  const f=bfGet();
  const all=window._bFilter;
  const saved=f.category;
  all.category='';
  all.type='all';
  const items=bfItems();
  all.category=saved;
  all.type=f.type;
  const cats={};
  items.forEach(function(i){
    const k=i.category||'Sonstiges';
    if(!cats[k]) cats[k]={income:0,expense:0,count:0};
    cats[k][i.type]=(cats[k][i.type]||0)+(i.amount||0);
    cats[k].count++;
  });
  return cats;
}

// ‚îÄ‚îÄ‚îÄ Month-by-month data for chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bfChartData(){
  const {from,to}=bfDateRange();
  const months=bfMonthsInRange(from,to);
  const f=bfGet();
  return months.map(function(mo){
    const monthEnd=`${mo}-31`;
    const moFrom=`${mo}-01`;
    const moTo=monthEnd;
    const manual=budgetItems.filter(function(i){return i.date&&i.date>=moFrom&&i.date<=moTo;});
    const autoDebt=debts.filter(function(d){return d.paid<d.original;}).flatMap(function(d){
      const ps=getPaymentStatus(d),remaining=Math.max(d.original-d.paid,0),dueDay=((d.due||'').split('-')[2]||'01');
      const pDate=`${mo}-${dueDay}`;
      if(ps==='ratenplan_aktiv'&&d.trackInBudget!==false)return [{type:'expense',date:pDate,amount:Math.min(d.rate||0,remaining),category:'Position'}];
      return [];
    });
    const all=[...manual,...autoDebt];
    let inc=0,exp=0;
    all.forEach(function(i){
      if(f.category&&(i.category||'').toLowerCase()!==f.category.toLowerCase())return;
      if(f.type==='income'&&i.type!=='income')return;
      if(f.type==='expense'&&i.type!=='expense')return;
      if(i.type==='income')inc+=(i.amount||0);
      else exp+=(i.amount||0);
    });
    return {mo,label:new Date(mo+'-01T00:00:00').toLocaleDateString('de-DE',{month:'short',year:'2-digit'}),inc,exp,bal:inc-exp};
  });
}

// ‚ïê‚ïê‚ïê MAIN rBudget ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rBudget(){
  // Inject recurring items for current month
  injectRecurringForMonth(currentBudgetMonth);

  const f=bfGet();
  const range=bfDateRange();
  const items=bfItems();
  const catMap=bfCategories();
  const allCats=Object.keys(catMap).sort();

  const inc=items.filter(function(i){return i.type==='income';}).reduce(function(s,i){return s+(i.amount||0);},0);
  const exp=items.filter(function(i){return i.type==='expense';}).reduce(function(s,i){return s+(i.amount||0);},0);
  const bal=inc-exp;
  const avgMonths=Math.max(1,bfMonthsInRange(range.from,range.to).length);
  const isFiltered=f.type!=='all'||f.category||f.search;

  // ‚îÄ‚îÄ Month nav
  const navMonth=f.month||currentBudgetMonth;
  const navParts=navMonth.split('-').map(Number);
  const navY=navParts[0],navM=navParts[1];
  const prevM=navM===1?(navY-1)+'-12':navY+'-'+String(navM-1).padStart(2,'0');
  const nextM=navM===12?(navY+1)+'-01':navY+'-'+String(navM+1).padStart(2,'0');
  const curYear=new Date().getFullYear();
  const years=[curYear-2,curYear-1,curYear,curYear+1].map(String);
  const quarters=['Q1','Q2','Q3','Q4'].map(function(q){return curYear+'-'+q;});

  // ‚îÄ‚îÄ Helpers
  const tabBtn=function(label,active,onclick){
    return '<button onclick="'+onclick+'" style="padding:6px 14px;border-radius:9px;border:1px solid '+(active?'var(--ba)':'var(--b)')+';background:'+(active?'var(--emG)':'transparent')+';color:'+(active?'var(--em)':'var(--tm)')+';font-size:13px;font-weight:'+(active?'700':'400')+';cursor:pointer;white-space:nowrap;transition:all 0.15s">'+label+'</button>';
  };

  const viewBtn=function(icon,title,view){
    const active=f.view===view;
    return '<button title="'+title+'" onclick="bfSet(\'view\',\''+view+'\')" style="width:34px;height:34px;border-radius:9px;border:1px solid '+(active?'var(--ba)':'var(--b)')+';background:'+(active?'var(--emG)':'var(--bgE)')+';color:'+(active?'var(--em)':'var(--tm)')+';cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center">'+icon+'</button>';
  };

  // ‚îÄ‚îÄ Row renderer ‚Äì compact, clean
  const row=function(i,type){
    const isInc=type==='income';
    const catLetter=(i.category||'?').charAt(0).toUpperCase();
    const catColors=isInc
      ? 'background:var(--incG);border:1px solid rgba(251,146,60,0.25);color:var(--inc)'
      : 'background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.25);color:var(--co)';
    const actions=i.auto
      ? '<span style="font-size:11px;color:var(--ts);padding:3px 8px;background:var(--bgE);border-radius:6px;border:1px solid var(--b)">Auto</span>'
      : '<div style="display:flex;gap:4px;opacity:0;transition:opacity 0.15s" class="row-actions">'
        +(i.recurring?'<span style="font-size:13px" title="Wiederkehrend">üîÅ</span>':'')
        +'<button class="btn btn-ghost btn-sm" onclick="openBudgetEdit_new('+i.id+')" style="padding:3px 8px">‚úèÔ∏è</button>'
        +'<button class="btn btn-outline btn-sm" onclick="deleteBudgetItem('+i.id+')" style="padding:3px 8px;color:var(--co);border-color:rgba(248,113,113,0.3)">‚úï</button>'
        +'</div>';
    return '<div class="budget-row" onmouseover="this.querySelector(\'.row-actions\')&&(this.querySelector(\'.row-actions\').style.opacity=\'1\')" onmouseout="this.querySelector(\'.row-actions\')&&(this.querySelector(\'.row-actions\').style.opacity=\'0\')" style="display:grid;grid-template-columns:80px 36px 1fr auto auto;gap:10px;align-items:center;padding:10px 16px;border-top:1px solid var(--b);transition:background 0.1s" onmouseover="this.style.background=\'var(--bgE)\'" onmouseout="this.style.background=\'transparent\'">'
      +'<span style="font-size:12px;color:var(--ts)">'+fD(i.date)+'</span>'
      +'<div style="width:28px;height:28px;border-radius:8px;'+catColors+';display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">'+catLetter+'</div>'
      +'<div><p style="font-size:13px;font-weight:600;margin:0;line-height:1.2">'+(i.category||'‚Äì')+'</p>'+(i.note?'<p style="font-size:11px;color:var(--ts);margin:1px 0 0">'+i.note+'</p>':'')+'</div>'
      +'<span style="font-size:14px;font-weight:800;color:'+(isInc?'var(--inc)':'var(--co)')+'">'+( isInc?'+':'-')+fmt(i.amount||0)+'</span>'
      +actions
      +'</div>';
  };

  // ‚îÄ‚îÄ TABLE HEADER
  const tableHead='<div style="display:grid;grid-template-columns:80px 36px 1fr auto auto;gap:10px;padding:8px 16px;background:var(--bgE);border-bottom:1px solid var(--b)">'
    +'<span style="font-size:10px;color:var(--ts);text-transform:uppercase;letter-spacing:0.7px;font-weight:700">Datum</span>'
    +'<span></span>'
    +'<span style="font-size:10px;color:var(--ts);text-transform:uppercase;letter-spacing:0.7px;font-weight:700">Kategorie / Beschreibung</span>'
    +'<span style="font-size:10px;color:var(--ts);text-transform:uppercase;letter-spacing:0.7px;font-weight:700">Betrag</span>'
    +'<span></span>'
    +'</div>';

  // ‚îÄ‚îÄ TABLE FOOTER (sum row)
  const tableFoot=function(total,type,count){
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 16px;background:var(--bgE);border-top:1px solid var(--b)">'
      +'<span style="font-size:12px;color:var(--ts)">'+count+' Eintr'+( count!==1?'√§ge':'ag')+'</span>'
      +'<span style="font-size:15px;font-weight:800;color:'+(type==='income'?'var(--inc)':'var(--co)')+'">'+( type==='income'?'+':'-')+fmt(total)+'</span>'
      +'</div>';
  };

  const incItems=items.filter(function(i){return i.type==='income';});
  const expItems=items.filter(function(i){return i.type==='expense';});

  // ‚îÄ‚îÄ VIEW: CATEGORIES
  const viewCategories=function(){
    const entries=Object.entries(catMap).sort(function(a,b){return (b[1].expense+b[1].income)-(a[1].expense+a[1].income);});
    if(!entries.length) return '<div class="card" style="text-align:center;padding:40px;grid-column:1/-1"><p style="font-size:32px;margin:0 0 10px">üîç</p><p style="color:var(--tm)">Keine Eintr√§ge im gew√§hlten Zeitraum</p></div>';
    const maxVal=Math.max.apply(null,entries.map(function(e){return e[1].expense+e[1].income;}));
    return entries.map(function(entry){
      const cat=entry[0],v=entry[1];
      const total=v.expense+v.income;
      const barW=Math.round((total/maxVal)*100);
      return '<div class="card" style="padding:14px 16px;cursor:pointer;transition:border-color 0.15s" onclick="bfSet(\'category\',\''+cat.replace(/'/g,"\\'")+'\')" onmouseover="this.style.borderColor=\'var(--ba)\'" onmouseout="this.style.borderColor=\'var(--b)\'">'
        +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
        +'<span style="font-size:13px;font-weight:700">'+cat+'</span>'
        +'<div style="display:flex;gap:12px;align-items:center">'
        +(v.income?'<span style="font-size:12px;color:var(--em);font-weight:700">+'+fmt(v.income)+'</span>':'')
        +(v.expense?'<span style="font-size:12px;color:var(--co);font-weight:700">‚àí'+fmt(v.expense)+'</span>':'')
        +'<span style="font-size:11px;color:var(--ts)">'+v.count+'√ó</span></div></div>'
        +'<div style="background:var(--b);border-radius:4px;height:4px"><div style="height:4px;border-radius:4px;width:'+barW+'%;background:'+(v.expense>v.income?'var(--co)':'var(--em)')+'"></div></div>'
        +'</div>';
    }).join('');
  };

  // ‚îÄ‚îÄ VIEW: CHART
  const viewChart=function(){
    const data=bfChartData();
    if(data.length<=1) return '<div class="card" style="text-align:center;padding:40px;grid-column:1/-1;color:var(--tm)">Verlauf ben√∂tigt mindestens 2 Monate.</div>';
    const maxVal=Math.max.apply(null,data.map(function(d){return Math.max(d.inc,d.exp);}),1)||1;
    const chartH=180;
    return '<div class="card" style="padding:20px 16px;grid-column:1/-1">'
      +'<p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px;margin:0 0 16px">Monatsverlauf</p>'
      +'<div style="display:flex;gap:4px;align-items:flex-end;height:'+(chartH+28)+'px;overflow-x:auto;padding-bottom:2px">'
      +data.map(function(d){
        const incH=Math.round((d.inc/maxVal)*chartH)||0;
        const expH=Math.round((d.exp/maxVal)*chartH)||0;
        return '<div style="display:flex;flex-direction:column;align-items:center;gap:3px;min-width:40px;flex:1">'
          +'<div style="display:flex;align-items:flex-end;gap:2px;height:'+chartH+'px">'
          +(d.inc?'<div title="'+fmt(d.inc)+'" style="width:16px;height:'+Math.max(2,incH)+'px;background:var(--em);border-radius:3px 3px 0 0;opacity:0.85"></div>':'<div style="width:16px"></div>')
          +(d.exp?'<div title="'+fmt(d.exp)+'" style="width:16px;height:'+Math.max(2,expH)+'px;background:var(--co);border-radius:3px 3px 0 0;opacity:0.85"></div>':'<div style="width:16px"></div>')
          +'</div>'
          +'<span style="font-size:10px;color:var(--ts);white-space:nowrap">'+d.label+'</span>'
          +'<span style="font-size:9px;font-weight:700;color:'+(d.bal>=0?'var(--em)':'var(--co)')+'">'+( d.bal>=0?'+':'')+fmt(d.bal)+'</span>'
          +'</div>';
      }).join('')
      +'</div>'
      +'<div style="display:flex;gap:16px;margin-top:12px;justify-content:center">'
      +'<div style="display:flex;align-items:center;gap:5px"><div style="width:10px;height:10px;border-radius:2px;background:var(--em)"></div><span style="font-size:11px;color:var(--tm)">Einnahmen</span></div>'
      +'<div style="display:flex;align-items:center;gap:5px"><div style="width:10px;height:10px;border-radius:2px;background:var(--co)"></div><span style="font-size:11px;color:var(--tm)">Ausgaben</span></div>'
      +'</div></div>';
  };

  // ‚îÄ‚îÄ ZEITRAUM selector content
  const zeitraumContent=function(){
    if(f.mode==='month'){
      return '<div style="display:flex;align-items:center;gap:8px">'
        +'<button onclick="bfSet(\'month\',\''+prevM+'\')" style="background:var(--bgE);border:1px solid var(--b);border-radius:9px;width:32px;height:32px;cursor:pointer;color:var(--t);font-size:16px;display:flex;align-items:center;justify-content:center">‚Äπ</button>'
        +'<input type="month" value="'+navMonth+'" oninput="bfSet(\'month\',this.value||\''+navMonth+'\')" style="background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:6px 10px;border-radius:9px;font-size:13px;font-weight:600">'
        +'<button onclick="bfSet(\'month\',\''+nextM+'\')" style="background:var(--bgE);border:1px solid var(--b);border-radius:9px;width:32px;height:32px;cursor:pointer;color:var(--t);font-size:16px;display:flex;align-items:center;justify-content:center">‚Ä∫</button>'
        +(navMonth!==currentBudgetMonth?'<button onclick="bfSet(\'month\',\''+currentBudgetMonth+'\')" style="background:var(--bgE);border:1px solid var(--b);border-radius:9px;padding:5px 10px;cursor:pointer;color:var(--tm);font-size:12px">Heute</button>':'')
        +'</div>';
    }
    if(f.mode==='quarter'){
      return '<div style="display:flex;gap:6px;flex-wrap:wrap">'
        +quarters.map(function(q){return tabBtn(q.split('-')[1]+' '+curYear,f.quarter===q,"bfSet('quarter','"+q+"')");}).join('')
        +'<select onchange="bfSet(\'quarter\',this.value)" style="background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:5px 8px;border-radius:9px;font-size:12px">'
        +years.map(function(y){return quarters.map(function(q){const v=y+'-'+q.split('-')[1];return '<option value="'+v+'" '+(f.quarter===v?'selected':'')+'>'+q.split('-')[1]+' '+y+'</option>';}).join('');}).join('')
        +'</select></div>';
    }
    if(f.mode==='year'){
      return '<div style="display:flex;gap:6px;flex-wrap:wrap">'+years.map(function(y){return tabBtn(y,f.year===y,"bfSet('year','"+y+"')");}).join('')+'</div>';
    }
    if(f.mode==='custom'){
      return '<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">'
        +'<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--tm)">Von</span><input type="date" value="'+f.from+'" oninput="window._bFilter.from=this.value;renderPage()" style="background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:5px 8px;border-radius:9px;font-size:13px"></div>'
        +'<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--tm)">Bis</span><input type="date" value="'+f.to+'" oninput="window._bFilter.to=this.value;renderPage()" style="background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:5px 8px;border-radius:9px;font-size:13px"></div>'
        +'</div>';
    }
    return '';
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var html='<div style="display:flex;flex-direction:column;gap:14px">';

  // ‚îÄ‚îÄ KOPFZEILE: Titel + Ansicht-Icons + Aktionen
  html+='<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">'
    +'<div>'
    +'<h1 style="font-size:26px;font-weight:800;margin:0 0 3px">Ein & Ausgaben</h1>'
    +'<p style="font-size:13px;color:var(--tm);margin:0">'+range.label+(isFiltered?' ¬∑ <span style="color:var(--em);font-weight:600">gefiltert</span>':'')+'</p>'
    +'</div>'
    +'<div style="display:flex;gap:8px;align-items:center">'
    +viewBtn('‚â°','Liste','list')
    +viewBtn('‚ñ¶','Kategorien','categories')
    +viewBtn('üìä','Verlauf','chart')
    +'<div style="width:1px;height:24px;background:var(--b)"></div>'
    +'<button class="btn btn-ghost btn-sm" onclick="printBudget()" title="Drucken">üñ®Ô∏è</button>'
    +'<button class="btn btn-primary btn-sm" onclick="openBudgetAdd()" style="white-space:nowrap">+ Eintrag</button>'
    +'</div>'
    +'</div>';

  // ‚îÄ‚îÄ KOMPAKTER TOOLBAR: Zeitraum-Modus + Nav + Filter ‚Äì ALLES in einer Card
  html+='<div class="card" style="padding:12px 16px">'
    // Zeile 1: Modus-Tabs links, Zeitraum-Nav rechts
    +'<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:'+(f.mode!=='month'?'10':'0')+'px">'
    +'<div style="display:flex;gap:5px">'
    +tabBtn('Monat',f.mode==='month',"bfSet('mode','month')")
    +tabBtn('Quartal',f.mode==='quarter',"bfSet('mode','quarter')")
    +tabBtn('Jahr',f.mode==='year',"bfSet('mode','year')")
    +tabBtn('Zeitraum',f.mode==='custom',"bfSet('mode','custom')")
    +'</div>'
    +(f.mode==='month'?zeitraumContent():'')
    +'</div>'
    +(f.mode!=='month'?'<div style="margin-bottom:10px">'+zeitraumContent()+'</div>':'')
    // Zeile 2 (nur wenn Quartal/Jahr/Custom): Trennlinie
    +(f.mode!=='month'?'<div style="height:1px;background:var(--b);margin:8px 0 10px"></div>':'<div style="height:1px;background:var(--b);margin:10px 0"></div>')
    // Filter-Zeile: Typ + Kategorie + Suche
    +'<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">'
    +'<div style="display:flex;gap:4px">'
    +tabBtn('Alle',f.type==='all',"bfSet('type','all')")
    +tabBtn('‚Üë Ein',f.type==='income',"bfSet('type','income')")
    +tabBtn('‚Üì Aus',f.type==='expense',"bfSet('type','expense')")
    +'</div>'
    +'<select onchange="bfSet(\'category\',this.value)" style="background:var(--bgE);border:1px solid '+(f.category?'var(--ba)':'var(--b)')+';color:var(--t);padding:5px 10px;border-radius:9px;font-size:13px;flex:1;min-width:140px">'
    +'<option value="">Alle Kategorien</option>'
    +allCats.map(function(c){return '<option value="'+c+'" '+(f.category===c?'selected':'')+'>'+c+'</option>';}).join('')
    +'</select>'
    +'<div style="position:relative;flex:2;min-width:160px">'
    +'<input value="'+f.search+'" oninput="window._bFilter.search=this.value;renderPage()" placeholder="üîç Suchen..." style="background:var(--bgE);border:1px solid '+(f.search?'var(--ba)':'var(--b)')+';color:var(--t);padding:5px 10px;border-radius:9px;font-size:13px;width:100%;box-sizing:border-box">'
    +(f.search?'<button onclick="bfSet(\'search\',\'\')" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--tm);font-size:13px">‚úï</button>':'')
    +'</div>'
    +(isFiltered?'<button onclick="window._bFilter.type=\'all\';window._bFilter.category=\'\';window._bFilter.search=\'\';renderPage()" style="background:none;border:1px solid var(--ba);color:var(--em);padding:5px 10px;border-radius:9px;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap">‚úï Reset</button>':'')
    +'</div>'
    +'</div>';

  // ‚îÄ‚îÄ INLINE KPI-LEISTE ‚Äì kompakt, keine separaten Karten
  html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--b);border-radius:14px;overflow:hidden;border:1px solid var(--b)">'
    +'<div style="background:var(--bgD);padding:12px 16px">'
    +'<p style="font-size:10px;color:var(--ts);text-transform:uppercase;letter-spacing:0.7px;margin:0">Einnahmen</p>'
    +'<p style="font-size:20px;font-weight:800;margin:4px 0 0;font-family:\'Bricolage Grotesque\',sans-serif;color:var(--inc)">+'+fmt(inc)+'</p>'
    +(avgMonths>1?'<p style="font-size:11px;color:var(--ts);margin:2px 0 0">√ò '+fmt(inc/avgMonths)+'/Mo.</p>':'')
    +'</div>'
    +'<div style="background:var(--bgD);padding:12px 16px">'
    +'<p style="font-size:10px;color:var(--ts);text-transform:uppercase;letter-spacing:0.7px;margin:0">Ausgaben</p>'
    +'<p style="font-size:20px;font-weight:800;margin:4px 0 0;font-family:\'Bricolage Grotesque\',sans-serif;color:var(--co)">‚àí'+fmt(exp)+'</p>'
    +(avgMonths>1?'<p style="font-size:11px;color:var(--ts);margin:2px 0 0">√ò '+fmt(exp/avgMonths)+'/Mo.</p>':'')
    +'</div>'
    +'<div style="background:'+(bal>=0?'var(--emG)':'rgba(248,113,113,0.07)')+';padding:12px 16px">'
    +'<p style="font-size:10px;color:var(--ts);text-transform:uppercase;letter-spacing:0.7px;margin:0">Saldo</p>'
    +'<p style="font-size:20px;font-weight:800;margin:4px 0 0;font-family:\'Bricolage Grotesque\',sans-serif;color:'+(bal>=0?'var(--em)':'var(--co)')+'">'+( bal>=0?'+':'')+fmt(bal)+'</p>'
    +'<p style="font-size:11px;color:var(--ts);margin:2px 0 0">'+items.length+' Eintr√§ge</p>'
    +'</div>'
    +'</div>';

  // ‚îÄ‚îÄ Filter-Info wenn aktiv
  if(isFiltered){
    html+='<div style="background:var(--emG);border:1px solid var(--ba);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">'
      +'<p style="font-size:12px;font-weight:600;color:var(--em);margin:0">'
      +(f.category?'üìÇ '+f.category:'')
      +(f.type!=='all'?' ¬∑ '+(f.type==='income'?'Einnahmen':'Ausgaben'):'')
      +(f.search?' ¬∑ "'+f.search+'"':'')
      +' ‚Äî '+items.length+' Eintr'+(items.length!==1?'√§ge':'ag')+', '+(exp?'Ausgaben: '+fmt(exp):'')+(inc?' / Einnahmen: '+fmt(inc):'')
      +'</p>'
      +'<button onclick="window._bFilter.type=\'all\';window._bFilter.category=\'\';window._bFilter.search=\'\';renderPage()" style="font-size:12px;color:var(--em);background:none;border:1px solid var(--ba);border-radius:7px;padding:3px 10px;cursor:pointer;font-weight:600">‚úï</button>'
      +'</div>';
  }

  // ‚îÄ‚îÄ HAUPTINHALT je nach Ansicht
  if(f.view==='categories'){
    html+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px">'+viewCategories()+'</div>';
  } else if(f.view==='chart'){
    html+='<div>'+viewChart()+'</div>';
  } else {
    // LIST VIEW ‚Äì zwei Spalten nebeneinander
    if(items.length===0){
      html+='<div class="card" style="text-align:center;padding:48px 24px">'
        +'<p style="font-size:38px;margin:0 0 12px">üßæ</p>'
        +'<p style="font-size:15px;font-weight:700;margin:0 0 6px">Keine Eintr√§ge</p>'
        +'<p style="font-size:13px;color:var(--tm);margin:0 0 16px">'+(isFiltered?'F√ºr diesen Filter gibt es keine Eintr√§ge.':'Noch keine Buchungen f√ºr diesen Zeitraum.')+'</p>'
        +'<button class="btn btn-primary btn-sm" onclick="openBudgetAdd()">Ersten Eintrag erfassen</button>'
        +'</div>';
    } else {
      // zwei Spalten: Einnahmen | Ausgaben
      html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start">';

      // Einnahmen
      if(f.type!=='expense'){
        html+='<div class="card" style="padding:0;overflow:hidden">'
          +'<div style="padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--b)">'
          +'<div style="display:flex;align-items:center;gap:8px">'
          +'<div style="width:8px;height:8px;border-radius:50%;background:var(--inc)"></div>'
          +'<span style="font-size:14px;font-weight:700">Einnahmen</span>'
          +'</div>'
          +'<button class="btn btn-ghost btn-sm" onclick="openBudgetAdd(\'income\')" style="font-size:12px">+ Hinzuf√ºgen</button>'
          +'</div>'
          +tableHead
          +(incItems.length
            ? incItems.map(function(i){return row(i,'income');}).join('')
            :'<div style="padding:20px;text-align:center;color:var(--ts);font-size:13px">Keine Einnahmen</div>')
          +(incItems.length?tableFoot(inc,'income',incItems.length):'')
          +'</div>';
      }

      // Ausgaben
      if(f.type!=='income'){
        html+='<div class="card" style="padding:0;overflow:hidden">'
          +'<div style="padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--b)">'
          +'<div style="display:flex;align-items:center;gap:8px">'
          +'<div style="width:8px;height:8px;border-radius:50%;background:var(--co)"></div>'
          +'<span style="font-size:14px;font-weight:700">Ausgaben</span>'
          +'</div>'
          +'<button class="btn btn-outline btn-sm" onclick="openBudgetAdd(\'expense\')" style="font-size:12px">+ Hinzuf√ºgen</button>'
          +'</div>'
          +tableHead
          +(expItems.length
            ? expItems.map(function(i){return row(i,'expense');}).join('')
            :'<div style="padding:20px;text-align:center;color:var(--ts);font-size:13px">Keine Ausgaben</div>')
          +(expItems.length?tableFoot(exp,'expense',expItems.length):'')
          +'</div>';
      }

      // Wenn nur ein Typ gefiltert: volle Breite
      if(f.type!=='all'){
        html=html.replace(
          'grid-template-columns:1fr 1fr',
          'grid-template-columns:1fr'
        );
      }

      html+='</div>';
    }
  }

  html+='</div>';
  return html;
}


const BUDGET_CATS = {
  expense: [
    {id:'miete',    icon:'üè†', label:'Miete'},
    {id:'strom',    icon:'‚ö°', label:'Strom'},
    {id:'einkauf',  icon:'üõí', label:'Einkauf'},
    {id:'auto',     icon:'üöó', label:'Auto'},
    {id:'essen',    icon:'üçï', label:'Essen & Trinken'},
    {id:'gesund',   icon:'üíä', label:'Gesundheit'},
    {id:'streaming',icon:'üé¨', label:'Streaming'},
    {id:'handy',    icon:'üì±', label:'Handy'},
    {id:'internet', icon:'üåê', label:'Internet'},
    {id:'versich',  icon:'üõ°Ô∏è', label:'Versicherung'},
    {id:'kleidung', icon:'üëï', label:'Kleidung'},
    {id:'freizeit', icon:'üéØ', label:'Freizeit'},
  ],
  income: [
    {id:'gehalt',   icon:'üí∂', label:'Gehalt'},
    {id:'nebenjob', icon:'üíº', label:'Nebenjob'},
    {id:'rente',    icon:'üè¶', label:'Rente / Pension'},
    {id:'miete_e',  icon:'üè†', label:'Mieteinnahmen'},
    {id:'zinsen',   icon:'üìà', label:'Zinsen / Kapital'},
    {id:'erstatt',  icon:'‚Ü©Ô∏è', label:'Erstattung'},
    {id:'geschenk', icon:'üéÅ', label:'Geschenk'},
    {id:'sonstig',  icon:'üí∞', label:'Sonstiges'},
  ]
};
const QUICK_AMOUNTS = [20, 50, 100, 200, 500, 1000];
const RECUR_OPTIONS = [
  {v:'none',     l:'Einmalig'},
  {v:'weekly',   l:'W√∂chentlich'},
  {v:'monthly',  l:'Monatlich'},
  {v:'quarterly',l:'Quartalsweise'},
  {v:'yearly',   l:'J√§hrlich'},
];


function saveCustomCategory(type, label){
  try{
    const key='customCats_'+type;
    const existing=JSON.parse(localStorage.getItem(key)||'[]');
    if(!existing.includes(label)){
      existing.unshift(label);
      localStorage.setItem(key, JSON.stringify(existing.slice(0,20)));
    }
  }catch(e){}
}

function loadCustomCategories(type){
  try{
    return JSON.parse(localStorage.getItem('customCats_'+type)||'[]');
  }catch(e){return [];}
}

function buildBudgetModal(opts){
  // opts: {type, category, note, amount, date, recurring, recurringCycle, contractId, editId, splits}
  const o = opts || {};
  const type     = o.type     || 'expense';
  const category = o.category || '';
  const note     = o.note     || '';
  const amount   = o.amount   || '';
  const date     = o.date     || tdy();
  const recCycle = o.recurringCycle || 'monthly';
  const isRec    = o.recurring || false;
  const contractId = o.contractId || '';
  const editId   = o.editId || null;
  const splits   = o.splits || [];

  const cats = BUDGET_CATS[type] || BUDGET_CATS.expense;
  const customCats = loadCustomCategories(type);

  // Recent categories from budgetItems for suggestions
  const recentCats = [...new Set(
    [...customCats,
     ...budgetItems.filter(function(i){return i.type===type;})
       .sort(function(a,b){return new Date(b.date)-new Date(a.date);})
       .map(function(i){return i.category;})
       .filter(Boolean)
    ].filter(function(c){return !cats.some(function(x){return x.label===c;})})
  )].slice(0,8);

  // Build category grid
  const catGrid = cats.map(function(c){
    const active = category === c.label;
    return '<button type="button" onclick="bModalSetCat(\''+c.label+'\')" style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border-radius:12px;border:1px solid '+(active?'var(--ba)':'var(--b)')+';background:'+(active?'var(--emG)':'var(--bgE)')+';cursor:pointer;transition:all 0.15s;min-width:0" onmouseover="this.style.borderColor=\'var(--ba)\'" onmouseout="if(!this.classList.contains(\'active-cat\'))this.style.borderColor=\''+(active?'var(--ba)':'var(--b)')+'\'"><span style="font-size:20px">'+c.icon+'</span><span style="font-size:10px;color:'+(active?'var(--em)':'var(--ts)')+';font-weight:'+(active?'700':'400')+';white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:56px;text-align:center">'+c.label+'</span></button>';
  }).join('');

  // Contracts dropdown
  const contractOptions = contracts.filter(function(c){return c.status!=='cancelled';}).map(function(c){
    const ann = contractAnnualCost(c);
    return '<option value="'+c.id+'" '+(contractId==c.id?'selected':'')+'>'+c.name+(c.provider?' ¬∑ '+c.provider:'')+(ann?' ¬∑ '+fmt(ann/12)+'/Mo.':'')+'</option>';
  }).join('');

  // Splits HTML
  const splitsHtml = splits.length > 0
    ? splits.map(function(s,i){
        return '<div style="display:flex;gap:8px;align-items:center;padding:6px 0;border-top:1px solid var(--b)">'
          +'<input value="'+s.cat+'" placeholder="Kategorie" oninput="bModalSplitCat('+i+',this.value)" style="flex:1;background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:6px 10px;border-radius:8px;font-size:13px">'
          +'<div style="position:relative"><span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--ts)">‚Ç¨</span><input type="number" value="'+s.amount+'" step="0.01" oninput="bModalSplitAmt('+i+',this.value)" style="width:90px;background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:6px 10px 6px 24px;border-radius:8px;font-size:13px"></div>'
          +'<button onclick="bModalRemoveSplit('+i+')" style="background:none;border:none;cursor:pointer;color:var(--ts);font-size:16px;padding:0 4px">‚úï</button>'
          +'</div>';
      }).join('')
    : '';

  const splitTotal = splits.reduce(function(s,x){return s+(parseFloat(x.amount)||0);},0);
  const splitRemain = (parseFloat(amount)||0) - splitTotal;

  const modal = '<div class="overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()" style="max-width:560px">'

    // ‚îÄ‚îÄ Header
    +'<div class="modal-head" style="padding-bottom:12px">'
    +'<div style="display:flex;align-items:center;gap:10px">'
    +'<div style="width:36px;height:36px;border-radius:10px;background:'+(type==='income'?'var(--emG)':'rgba(248,113,113,0.1)')+';display:flex;align-items:center;justify-content:center;font-size:18px">'+(type==='income'?'üìà':'üìâ')+'</div>'
    +'<h3 style="margin:0;font-size:16px;font-weight:800">'+(editId?'Eintrag bearbeiten':'Beitrag erfassen')+'</h3>'
    +'</div>'
    +'<button class="modal-close" onclick="closeModal()">‚úï</button>'
    +'</div>'

    // ‚îÄ‚îÄ Typ Toggle
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:18px">'
    +'<button type="button" id="bModalTypeIncome" onclick="bModalSetType(\'income\')" style="padding:11px;border-radius:11px;border:2px solid '+(type==='income'?'rgba(251,146,60,0.3)':'var(--b)')+';background:'+(type==='income'?'var(--incG)':'transparent')+';color:'+(type==='income'?'var(--inc)':'var(--ts)')+';font-size:14px;font-weight:700;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:8px">‚Üë Einnahme</button>'
    +'<button type="button" id="bModalTypeExpense" onclick="bModalSetType(\'expense\')" style="padding:11px;border-radius:11px;border:2px solid '+(type==='expense'?'rgba(248,113,113,0.5)':'var(--b)')+';background:'+(type==='expense'?'rgba(248,113,113,0.1)':'transparent')+';color:'+(type==='expense'?'var(--co)':'var(--tm)')+';font-size:14px;font-weight:700;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;gap:8px">‚Üì Ausgabe</button>'
    +'</div>'

    // ‚îÄ‚îÄ Kategorie Grid
    +'<div style="margin-bottom:16px">'
    +'<p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px">Kategorie</p>'
    +'<div id="bModalCatGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px">'+catGrid+'</div>'
    +'<div style="position:relative">'
    +'<input id="bModalCatInput" value="'+category+'" oninput="bModalCatType(this.value)" placeholder="Eigene Kategorie eingeben..." style="width:100%;background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:8px 12px;border-radius:10px;font-size:13px;box-sizing:border-box">'
    +(recentCats.length ? '<div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:6px">'+recentCats.map(function(c){return '<button onclick="bModalSetCat(\''+c+'\')" style="font-size:11px;padding:3px 9px;border-radius:7px;border:1px solid var(--b);background:var(--bgE);color:var(--ts);cursor:pointer">'+c+'</button>';}).join('')+'</div>' : '')
    +'</div>'
    +'</div>'

    // ‚îÄ‚îÄ Betrag
    +'<div style="margin-bottom:16px">'
    +'<p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px">Betrag</p>'
    +'<div style="display:flex;align-items:center;border:2px solid '+(type==='income'?'var(--ba)':'rgba(248,113,113,0.4)')+';border-radius:12px;overflow:hidden;background:var(--bgE)">'
    +'<span style="padding:0 14px;font-size:20px;font-weight:800;color:'+(type==='income'?'var(--inc)':'var(--co)')+'">‚Ç¨</span>'
    +'<input type="number" id="bModalAmt" value="'+amount+'" step="0.01" placeholder="0,00" oninput="bModalAmtChange(this.value)" style="flex:1;background:transparent;border:none;color:var(--t);font-size:26px;font-weight:800;padding:12px 0;outline:none;letter-spacing:-0.5px;font-family:\'Bricolage Grotesque\',sans-serif">'
    +'</div>'
    +'<div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">'
    +QUICK_AMOUNTS.map(function(a){
      return '<button type="button" onclick="bModalQuickAmt('+a+')" style="padding:5px 12px;border-radius:8px;border:1px solid var(--b);background:var(--bgE);color:var(--tm);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s" onmouseover="this.style.borderColor=\'var(--ba)\';this.style.color=\'var(--em)\'" onmouseout="this.style.borderColor=\'var(--b)\';this.style.color=\'var(--tm)\'">'
        +a+'‚Ç¨</button>';
    }).join('')
    +'</div>'
    +'</div>'

    // ‚îÄ‚îÄ Beschreibung + Vertrag
    +'<div style="margin-bottom:16px">'
    +'<p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px">Beschreibung</p>'
    +'<input id="bModalNote" type="text" value="'+note+'" placeholder="Optional ‚Äì z.B. Rechnung Januar..." style="width:100%;background:var(--bgE);border:1px solid var(--b);border-radius:10px;color:var(--t);padding:10px 14px;font-size:14px;box-sizing:border-box;outline:none;transition:border-color 0.2s;font-family:inherit" onfocus="this.style.borderColor=\'var(--ba)\';this.style.boxShadow=\'0 0 0 3px var(--emG)\'" onblur="this.style.borderColor=\'var(--b)\';this.style.boxShadow=\'none\'">'
    +'</div>'

    // ‚îÄ‚îÄ Vertrag zuordnen (nur wenn Vertr√§ge vorhanden)
    +(contracts.length > 0
      ? '<div style="margin-bottom:16px">'
        +'<p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px">üîó Vertrag zuordnen <span style="font-weight:400;color:var(--ts)">(optional)</span></p>'
        +'<select id="bModalContract" onchange="bModalContractSelect(this.value)" style="width:100%;background:var(--bgE);border:1px solid var(--b);border-radius:10px;color:var(--t);padding:10px 14px;font-size:14px;box-sizing:border-box;outline:none;transition:border-color 0.2s;font-family:inherit;appearance:none">'
        +'<option value="">‚Äì Kein Vertrag ‚Äì</option>'
        +contractOptions
        +'</select>'
        +(contractId ? '<p style="font-size:11px;color:var(--em);margin:5px 0 0">‚úì Betrag und Kategorie wurden vom Vertrag √ºbernommen</p>' : '')
        +'</div>'
      : '')

    // ‚îÄ‚îÄ Datum + Wiederholung
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">'
    +'<div>'
    +'<p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px">Datum</p>'
    +'<input id="bModalDate" type="date" value="'+date+'" style="width:100%;background:var(--bgE);border:1px solid var(--b);border-radius:10px;color:var(--t);padding:10px 14px;font-size:14px;box-sizing:border-box;outline:none;transition:border-color 0.2s;font-family:inherit" onfocus="this.style.borderColor=\'var(--ba)\';this.style.boxShadow=\'0 0 0 3px var(--emG)\'" onblur="this.style.borderColor=\'var(--b)\';this.style.boxShadow=\'none\'">'
    +'</div>'
    +'<div>'
    +'<p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px;margin:0 0 8px">Wiederholung</p>'
    +'<select id="bModalRecur" onchange="bModalRecurChange(this.value)" style="width:100%;background:var(--bgE);border:1px solid var(--b);border-radius:10px;color:var(--t);padding:10px 14px;font-size:14px;box-sizing:border-box;outline:none;transition:border-color 0.2s;font-family:inherit;appearance:none">'
    +RECUR_OPTIONS.map(function(r){
      const active = isRec ? (r.v===recCycle) : (r.v==='none');
      return '<option value="'+r.v+'" '+(active?'selected':'')+'>'+r.l+'</option>';
    }).join('')
    +'</select>'
    +'</div>'
    +'</div>'
    +'<div id="bModalRecurHint" style="display:'+(isRec?'block':'none')+';background:var(--emG);border:1px solid var(--ba);border-radius:9px;padding:8px 12px;margin-bottom:14px;font-size:12px;color:var(--em)">üîÅ Wird automatisch wiederkehrend eingetragen ‚Äì bis du es manuell l√∂schst.</div>'

    // ‚îÄ‚îÄ Splitbuchung
    +'<div style="margin-bottom:16px">'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">'
    +'<p style="font-size:11px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:0.8px;margin:0">Splitbuchung <span style="font-weight:400">(optional)</span></p>'
    +'<button type="button" onclick="bModalAddSplit()" style="font-size:12px;color:var(--em);background:none;border:1px solid var(--ba);border-radius:7px;padding:3px 10px;cursor:pointer;font-weight:600">+ Split</button>'
    +'</div>'
    +'<div id="bModalSplits">'+splitsHtml+'</div>'
    +(splits.length > 0
      ? '<div style="display:flex;justify-content:space-between;padding:6px 0;border-top:1px solid var(--b);margin-top:4px"><span style="font-size:12px;color:var(--ts)">Verbleibend</span><span style="font-size:13px;font-weight:700;color:'+(splitRemain<0?'var(--co)':'var(--t)')+'">'+fmt(splitRemain)+'</span></div>'
      : '')
    +'</div>'

    // ‚îÄ‚îÄ Footer
    +'<div style="display:flex;gap:10px;padding-top:12px;border-top:1px solid var(--b)">'
    +'<button class="btn btn-outline" style="flex:1" onclick="closeModal()">Abbrechen</button>'
    +'<button class="btn btn-primary" style="flex:2" onclick="bModalSave('+(editId||0)+')">‚úì '+(editId?'Aktualisieren':'Speichern')+'</button>'
    +'</div>'

    +'</div></div>';

  return modal;
}

// ‚îÄ‚îÄ State management for modal
window._bModal = {type:'expense', category:'', note:'', amount:'', date:'', recurring:false, recurringCycle:'monthly', contractId:'', splits:[], editId:null};

function bModalOpen(opts){
  window._bModal = Object.assign({type:'expense',category:'',note:'',amount:'',date:tdy(),recurring:false,recurringCycle:'monthly',contractId:'',splits:[],editId:null}, opts||{});
  document.getElementById('modalContainer').innerHTML = buildBudgetModal(window._bModal);
}

function bModalSetType(type){
  window._bModal.type = type;
  // read current values before re-render
  window._bModal.category = (document.getElementById('bModalCatInput')||{}).value || window._bModal.category;
  window._bModal.note     = (document.getElementById('bModalNote')||{}).value    || window._bModal.note;
  window._bModal.amount   = (document.getElementById('bModalAmt')||{}).value     || window._bModal.amount;
  window._bModal.date     = (document.getElementById('bModalDate')||{}).value    || window._bModal.date;
  window._bModal.contractId = (document.getElementById('bModalContract')||{}).value || window._bModal.contractId;
  document.getElementById('modalContainer').innerHTML = buildBudgetModal(window._bModal);
}

function bModalSetCat(cat){
  window._bModal.category = cat;
  const input = document.getElementById('bModalCatInput');
  if(input) input.value = cat;
  // Re-render just the grid to show active state
  const grid = document.getElementById('bModalCatGrid');
  if(grid){
    const cats = BUDGET_CATS[window._bModal.type] || BUDGET_CATS.expense;
    grid.innerHTML = cats.map(function(c){
      const active = cat === c.label;
      return '<button type="button" onclick="bModalSetCat(\''+c.label+'\')" style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border-radius:12px;border:1px solid '+(active?'var(--ba)':'var(--b)')+';background:'+(active?'var(--emG)':'var(--bgE)')+';cursor:pointer;transition:all 0.15s;min-width:0"><span style="font-size:20px">'+c.icon+'</span><span style="font-size:10px;color:'+(active?'var(--em)':'var(--ts)')+';font-weight:'+(active?'700':'400')+';white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:56px;text-align:center">'+c.label+'</span></button>';
    }).join('');
  }
}

function bModalCatType(val){
  window._bModal.category = val;
  // deselect grid buttons visually
  const grid = document.getElementById('bModalCatGrid');
  if(grid){
    const cats = BUDGET_CATS[window._bModal.type] || BUDGET_CATS.expense;
    grid.innerHTML = cats.map(function(c){
      const active = val === c.label;
      return '<button type="button" onclick="bModalSetCat(\''+c.label+'\')" style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border-radius:12px;border:1px solid '+(active?'var(--ba)':'var(--b)')+';background:'+(active?'var(--emG)':'var(--bgE)')+';cursor:pointer;transition:all 0.15s;min-width:0"><span style="font-size:20px">'+c.icon+'</span><span style="font-size:10px;color:'+(active?'var(--em)':'var(--ts)')+';font-weight:'+(active?'700':'400')+';white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:56px;text-align:center">'+c.label+'</span></button>';
    }).join('');
  }
}

function bModalAmtChange(val){ window._bModal.amount = val; }

function bModalQuickAmt(amount){
  window._bModal.amount = amount;
  const inp = document.getElementById('bModalAmt');
  if(inp){ inp.value = amount; inp.focus(); }
}

function bModalContractSelect(contractId){
  window._bModal.contractId = contractId;
  if(!contractId) return;
  const c = contracts.find(function(x){return String(x.id)===String(contractId);});
  if(!c) return;
  // Auto-fill amount and category
  const monthly = contractAnnualCost(c)/12;
  if(monthly>0){
    window._bModal.amount = monthly.toFixed(2);
    const inp = document.getElementById('bModalAmt');
    if(inp) inp.value = monthly.toFixed(2);
  }
  if(c.category){
    window._bModal.category = c.category;
    bModalSetCat(c.category);
  }
  if(c.name){
    window._bModal.note = c.name;
    const noteInp = document.getElementById('bModalNote');
    if(noteInp) noteInp.value = c.name;
  }
  flash('Betrag & Kategorie von "'+c.name+'" √ºbernommen ‚úì');
}

function bModalRecurChange(val){
  window._bModal.recurring = (val !== 'none');
  window._bModal.recurringCycle = val;
  const hint = document.getElementById('bModalRecurHint');
  if(hint) hint.style.display = (val!=='none') ? 'block' : 'none';
}

function bModalAddSplit(){
  window._bModal.splits = window._bModal.splits || [];
  window._bModal.splits.push({cat:'', amount:''});
  _bModalReSplits();
}

function bModalRemoveSplit(idx){
  window._bModal.splits.splice(idx,1);
  _bModalReSplits();
}

function bModalSplitCat(idx,val){ if(window._bModal.splits[idx]) window._bModal.splits[idx].cat=val; }
function bModalSplitAmt(idx,val){ if(window._bModal.splits[idx]) window._bModal.splits[idx].amount=val; }

function _bModalReSplits(){
  const splits = window._bModal.splits;
  const container = document.getElementById('bModalSplits');
  if(!container) return;
  container.innerHTML = splits.map(function(s,i){
    return '<div style="display:flex;gap:8px;align-items:center;padding:6px 0;border-top:1px solid var(--b)">'
      +'<input value="'+s.cat+'" placeholder="Kategorie" oninput="bModalSplitCat('+i+',this.value)" style="flex:1;background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:6px 10px;border-radius:8px;font-size:13px">'
      +'<div style="position:relative"><span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--ts)">‚Ç¨</span><input type="number" value="'+s.amount+'" step="0.01" oninput="bModalSplitAmt('+i+',this.value)" style="width:90px;background:var(--bgE);border:1px solid var(--b);color:var(--t);padding:6px 10px 6px 24px;border-radius:8px;font-size:13px"></div>'
      +'<button onclick="bModalRemoveSplit('+i+')" style="background:none;border:none;cursor:pointer;color:var(--ts);font-size:16px;padding:0 4px">‚úï</button>'
      +'</div>';
  }).join('');
}

async function bModalSave(editId){
  await autoSnapshot("budget_change",true);
  // Collect current form values
  const type     = window._bModal.type || 'expense';
  const category = (document.getElementById('bModalCatInput')||{}).value || window._bModal.category || '';
  const note     = (document.getElementById('bModalNote')||{}).value    || '';
  const amount   = parseFloat((document.getElementById('bModalAmt')||{}).value || window._bModal.amount) || 0;
  const date     = (document.getElementById('bModalDate')||{}).value    || tdy();
  const recurVal = (document.getElementById('bModalRecur')||{}).value   || 'none';
  const recurring = recurVal !== 'none';
  const recurringCycle = recurring ? recurVal : null;
  const contractId = (document.getElementById('bModalContract')||{}).value || '';
  const splits   = window._bModal.splits || [];

  if(!amount || amount <= 0){ flash('Bitte einen Betrag eingeben'); return; }

  if(splits.length > 0){
    // Save as multiple split entries
    const splitTotal = splits.reduce(function(s,x){return s+(parseFloat(x.amount)||0);},0);
    // Main item with remainder
    const remain = amount - splitTotal;
    const mainCat = category || 'Sonstiges';

    if(remain > 0){
      const main = {id:Date.now(),type,category:mainCat,note,date,amount:remain,recurring,recurringCycle,contractId:contractId||null};
      if(editId) { const i=budgetItems.findIndex(function(x){return x.id===editId;}); if(i>=0) budgetItems[i]=Object.assign(budgetItems[i],main); }
      else budgetItems.unshift(main);
    }
    splits.forEach(function(s,idx){
      if(!s.cat||!s.amount) return;
      const si = {id:Date.now()+idx+1,type,category:s.cat,note:note||mainCat+' (Split)',date,amount:parseFloat(s.amount)||0,recurring:false,contractId:contractId||null};
      budgetItems.unshift(si);
    });
    saveBudget(); closeModal(); renderPage();
    flash('Splitbuchung gespeichert ('+( splits.length+( remain>0?1:0))+' Eintr√§ge) ‚úì');
    return;
  }

  const item = {id:editId||Date.now(),type,category,note,date,amount,recurring,recurringCycle:recurringCycle||null,contractId:contractId||null};

  if(editId){
    const idx = budgetItems.findIndex(function(x){return x.id===editId;});
    if(idx>=0) budgetItems[idx] = Object.assign(budgetItems[idx], item);
    else budgetItems.unshift(item);
    // Persist custom category on edit too
    if(category && !BUDGET_CATS[type].some(function(c){return c.label===category;})){
      saveCustomCategory(type, category);
    }
    flash('Eintrag aktualisiert ‚úì');
  } else {
    budgetItems.unshift(item);
    flash(recurring ? 'üîÅ Wiederkehrend gespeichert' : 'Beitrag gespeichert ‚úì');
  }
  // Persist custom category
  if(category && !BUDGET_CATS[type].some(function(c){return c.label===category;})){
    saveCustomCategory(type, category);
  }
  saveBudget(); closeModal(); renderPage();
}

// ‚îÄ‚îÄ PUBLIC API ‚Äì replaces old openBudgetAdd / openBudgetEdit_new ‚îÄ‚îÄ‚îÄ‚îÄ
function openBudgetAdd(defaultType){
  bModalOpen({type: defaultType||'expense'});
}

function openBudgetEdit_new(id){
  const item = budgetItems.find(function(i){return i.id===id;});
  if(!item) return;
  bModalOpen({
    editId:         item.id,
    type:           item.type,
    category:       item.category||'',
    note:           item.note||'',
    amount:         item.amount||'',
    date:           item.date||tdy(),
    recurring:      item.recurring||false,
    recurringCycle: item.recurringCycle||'monthly',
    contractId:     item.contractId||'',
    splits:         [],
  });
}

// ‚îÄ‚îÄ Recurring cycle injection (enhanced) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function injectRecurringForMonth(monthKey){
  const base = budgetItems.filter(function(i){return i.recurring && i.date;});
  base.forEach(function(r){
    const day  = (r.date.split('-')[2]||'01');
    const projDate = monthKey+'-'+day;
    const cycle = r.recurringCycle || 'monthly';

    // Check if should fire this month based on cycle
    const origDate = new Date(r.date+'T00:00:00');
    const targDate = new Date(monthKey+'-01T00:00:00');
    const monthsDiff = (targDate.getFullYear()-origDate.getFullYear())*12 + (targDate.getMonth()-origDate.getMonth());
    if(monthsDiff <= 0) return;

    let shouldFire = false;
    if(cycle==='monthly')    shouldFire = true;
    if(cycle==='weekly')     shouldFire = true; // weekly = every month
    if(cycle==='quarterly')  shouldFire = (monthsDiff % 3 === 0);
    if(cycle==='yearly')     shouldFire = (monthsDiff % 12 === 0);

    if(!shouldFire) return;
    const alreadyExists = budgetItems.some(function(i){return i.recurringFrom===r.id && i.date && i.date.startsWith(monthKey);});
    const isOriginalMonth = r.date.startsWith(monthKey);
    if(!alreadyExists && !isOriginalMonth){
      budgetItems.push({id:Date.now()+Math.random(),type:r.type,category:r.category,note:r.note,date:projDate,amount:r.amount,recurringFrom:r.id,recurringCycle:cycle,auto:false});
      saveBudget();
    }
  });
}

// Legacy compat
function toggleRecurring(){ /* replaced by select */ }
function setBudgetType(type){ bModalSetType(type); }
function sBudgetAdd(){ bModalSave(0); }
async function saveBudgetEdit(id){
  await autoSnapshot("budget_change",true);
  const item = budgetItems.find(function(i){return i.id===id;});
  if(!item) return;
  item.type     = (document.getElementById('beType')||{}).value     || item.type;
  item.category = (document.getElementById('beCat')||{}).value?.trim()  || item.category;
  item.note     = (document.getElementById('beNote')||{}).value?.trim() || item.note;
  item.amount   = parseFloat((document.getElementById('beAmt')||{}).value)||item.amount;
  item.date     = (document.getElementById('beDate')||{}).value     || item.date;
  saveBudget(); closeModal(); renderPage();
  flash('Eintrag aktualisiert ‚úì');
}



function printBudget(){
  const month=currentBudgetMonth;
  const label=new Date(month+'-01T00:00:00').toLocaleDateString('de-DE',{month:'long',year:'numeric'});
  const manualItems=budgetItems.filter(i=>i.date&&i.date.startsWith(month)).sort((a,b)=>new Date(a.date)-new Date(b.date));
  const monthEnd=`${month}-31`;
  const plannedDebtExpenses=debts.filter(d=>d.paid<d.original).flatMap(d=>{
    const ps=getPaymentStatus(d),remaining=Math.max(d.original-d.paid,0),dueDay=((d.due||"").split("-")[2]||"01");
    const pDate=`${month}-${dueDay}`;
    if(ps==="ratenplan_aktiv")return [{id:`auto-${d.id}-${month}`,type:"expense",date:pDate,amount:Math.min(d.rate||0,remaining),category:"Position",note:`Automatisch: ${d.name}`,auto:true,debtId:d.id}];
    if(ps==="faellig_einmalig"&&(d.due||"").startsWith(month))return [{id:`auto-${d.id}-${month}`,type:"expense",date:d.due,amount:remaining,category:"Position",note:`Automatisch: ${d.name}`,auto:true,debtId:d.id}];
    if(ps==="ueberfaellig"&&((d.due||"")<=monthEnd))return [{id:`auto-${d.id}-${month}`,type:"expense",date:pDate,amount:remaining,category:"Position",note:`Automatisch √ºberf√§llig: ${d.name}`,auto:true,debtId:d.id}];
    return [];
  });
  const items=[...manualItems,...plannedDebtExpenses].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const incItems=manualItems.filter(i=>i.type==="income");
  const expItems=[...manualItems.filter(i=>i.type==="expense"),...plannedDebtExpenses].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const inc=incItems.reduce((s,i)=>s+(i.amount||0),0);
  const exp=expItems.reduce((s,i)=>s+(i.amount||0),0);
  const bal=inc-exp;
  const w=window.open("","_blank");
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Meine Ein- und Ausgaben ${label}</title>
  <style>
    @page{size:A4;margin:18mm 16mm}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Helvetica Neue',sans-serif;color:#111827;font-size:11pt;background:#fff}
    .page{max-width:760px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:20px;border-bottom:3px solid var(--emD);padding-bottom:14px}
    .header h1{font-size:20pt;font-weight:800;margin:0}
    .sub{color:#6B7280;font-size:10pt}
    .date{color:#9CA3AF;font-size:10pt;text-align:right}
    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:18px 0}
    .card{background:#F9FAFB;border:1px solid #E5E7EB;border-radius:10px;padding:14px 16px}
    .label{font-size:9pt;color:#6B7280;text-transform:uppercase;letter-spacing:0.8px;font-weight:700;margin-bottom:4px}
    .value{font-size:18pt;font-weight:800}
    .green{color:var(--emD)}.red{color:#DC2626}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    thead th{background:#F3F4F6;color:#374151;font-weight:700;text-align:left;padding:10px 12px;font-size:9pt;text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid #E5E7EB}
    tbody td{padding:10px 12px;border-bottom:1px solid #F3F4F6;font-size:10pt}
    tfoot td{padding:12px;font-weight:700;background:#F0FDF4;border-top:2px solid var(--emD)}
    .right{text-align:right}
    .mono{font-family:'SF Mono','Fira Code',monospace}
    .section{margin-top:14px}
  </style></head><body><div class="page">
    <div class="header">
      <div><h1>Meine Ein- und Ausgaben</h1><div class="sub">Monat ${label}</div></div>
      <div class="date">Erstellt am<br><strong>${new Date().toLocaleDateString('de-DE',{day:'numeric',month:'long',year:'numeric'})}</strong></div>
    </div>
    <div class="summary">
      <div class="card"><div class="label">Einnahmen (Ist)</div><div class="value green">${fmt(inc)}</div></div>
      <div class="card"><div class="label">Ausgaben (Ist)</div><div class="value red">${fmt(exp)}</div></div>
      <div class="card"><div class="label">Saldo</div><div class="value ${bal>=0?'green':'red'}">${fmt(bal)}</div></div>
    </div>
    <div class="section">
      <div class="label" style="margin-bottom:6px">Einnahmen</div>
      <table>
        <thead><tr><th>Datum</th><th>Kategorie</th><th>Beschreibung</th><th class="right">Betrag</th></tr></thead>
        <tbody>${incItems.length?incItems.map(i=>`<tr><td>${fD(i.date)}</td><td>${i.category||"‚Äì"}</td><td>${i.note||""}</td><td class="right mono" style="color:var(--emD);font-weight:700">${fmt(i.amount||0)}</td></tr>`).join(""):`<tr><td colspan="4" style="color:#9CA3AF;font-style:italic">Keine Einnahmen</td></tr>`}</tbody>
        <tfoot><tr><td colspan="3">Summe Einnahmen</td><td class="right mono" style="font-weight:800;color:var(--emD)">${fmt(inc)}</td></tr></tfoot>
      </table>
    </div>
    <div class="section">
      <div class="label" style="margin-bottom:6px">Ausgaben</div>
      <table>
        <thead><tr><th>Datum</th><th>Kategorie</th><th>Beschreibung</th><th class="right">Betrag</th></tr></thead>
        <tbody>${expItems.length?expItems.map(i=>`<tr><td>${fD(i.date)}</td><td>${i.category||"‚Äì"}</td><td>${i.note||""}</td><td class="right mono" style="color:#DC2626;font-weight:700">${fmt(i.amount||0)}</td></tr>`).join(""):`<tr><td colspan="4" style="color:#9CA3AF;font-style:italic">Keine Ausgaben</td></tr>`}</tbody>
        <tfoot><tr><td colspan="3">Summe Ausgaben</td><td class="right mono" style="font-weight:800;color:#DC2626">${fmt(exp)}</td></tr></tfoot>
      </table>
    </div>
    <div class="section" style="margin-top:18px">
      <table>
        <thead><tr><th>Ergebnis</th><th class="right">Saldo</th></tr></thead>
        <tbody><tr><td>Monat ${label}</td><td class="right mono" style="font-weight:800;${bal>=0?'color:var(--emD)':'color:#DC2626'}">${fmt(bal)}</td></tr></tbody>
      </table>
    </div>
  </div></div>
</div></body></html>`);
  w.document.close();
  setTimeout(()=>w.print(),400);
}

function closeModal(){document.getElementById("modalContainer").innerHTML=""}
function openAdd(){if(!canAddDebt()){openUpgradeModal('Mehr als 3 Verbindlichkeiten');return;}document.getElementById("modalContainer").innerHTML=`<div class="overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()" style="max-width:620px">
<div class="modal-head"><h3>Neue Position</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>
<p style="font-size:13px;color:var(--tm);margin:0 0 20px">Name, Betrag und Rate sind Pflicht ‚Äì alles andere optional.</p>

<div style="margin-bottom:16px"><label style="display:block;font-size:12px;font-weight:600;color:var(--ts);margin-bottom:8px">Symbol</label><div style="display:flex;gap:6px;flex-wrap:wrap" id="ep">${["üìÑ","‚ö°","üè†","üöó","üè•","ü¶∑","ü™ë","üì±","üéì","üí≥","üè¶","üëï","üõí","üí°","üåä","üéµ","‚úàÔ∏è","üèãÔ∏è","üçï","üêï","üë∂","üíä","üîß","üì¶","üéÆ","üöø","üìö","üå±","üè´","‚öñÔ∏è","üîë"].map((e,i)=>`<button class="emoji-btn ${i===0?"active":""}" onclick="pE(this,'${e}')">${e}</button>`).join("")}</div></div>

<p style="font-size:12px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;padding-top:8px;border-top:1px solid var(--b)">Statusdefinition</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="field"><label>Kl√§rungsstatus</label><input id="aCS" type="hidden" value="neu"><div style="display:flex;flex-wrap:wrap;gap:6px">${clarificationOptions.map(([v,l])=>`<button type="button" data-status="aCS" data-value="${v}" class="btn btn-sm ${v==="neu"?"btn-ghost":"btn-outline"}" style="padding:7px 10px" onclick="setStatus('a','CS','${v}')">${l}</button>`).join("")}</div></div>
<div class="field"><label>Zahlungsstatus</label><input id="aPS" type="hidden" value="keine_zahlung_faellig"><div style="display:flex;flex-wrap:wrap;gap:6px">${paymentOptions.map(([v,l])=>`<button type="button" data-status="aPS" data-value="${v}" class="btn btn-sm ${v==="keine_zahlung_faellig"?"btn-ghost":"btn-outline"}" style="padding:7px 10px" onclick="setStatus('a','PS','${v}')">${l}</button>`).join("")}</div></div>
</div>

<p style="font-size:12px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;padding-top:8px;border-top:1px solid var(--b)">üí∞ Grunddaten</p>
<div class="field"><label>Bezeichnung / Gl√§ubiger</label><div class="input-wrap"><input id="aN" placeholder="z.B. Stadtwerke"></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label>Gesamtbetrag</label><div class="input-wrap"><input id="aA" placeholder="0,00" onblur="fmtEurField(this)"><span class="suffix">‚Ç¨</span></div></div><div class="field"><label>Rate/Monat</label><div class="input-wrap"><input id="aR" placeholder="0,00" onblur="fmtEurField(this)"><span class="suffix">‚Ç¨</span></div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label>F√§lligkeit</label><div class="input-wrap"><input id="aD" type="date"></div></div><div class="field"><label>Notizen</label><div class="input-wrap"><input id="aNt" placeholder="Optional..."></div></div></div>

<p style="font-size:12px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;padding-top:12px;border-top:1px solid var(--b)">üè¢ Gl√§ubiger-Kontakt <span style="font-weight:400;color:var(--tf)">(optional)</span></p>
<div class="field"><label>Gl√§ubiger‚ÄëTyp</label><div class="input-wrap"><select id="aCTY"><option value="firma" selected>Firma</option><option value="privat">Privatperson</option></select></div></div>
<div class="field"><label>Firmenname / vollst√§ndiger Name</label><div class="input-wrap"><input id="aCN" placeholder="z.B. Stadtwerke M√ºnchen GmbH"></div></div>
  <div class="field"><label>Adresse</label><div class="input-wrap"><input id="aCA" placeholder="Stra√üe Nr., PLZ Ort"></div></div>
  <div style="display:grid;grid-template-columns:120px 1fr;gap:12px"><div class="field"><label>PLZ</label><div class="input-wrap"><input id="aCZip" placeholder="12345" maxlength="5"></div></div><div class="field"><label>Ort</label><div class="input-wrap"><input id="aCCity" placeholder="Berlin"></div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label>Telefon</label><div class="input-wrap"><input id="aCT" placeholder="089 1234-0"></div></div><div class="field"><label>E-Mail</label><div class="input-wrap"><input id="aCE" placeholder="info@firma.de"></div></div></div>

<p style="font-size:12px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;padding-top:12px;border-top:1px solid var(--b)">üè¶ Bankverbindung <span style="font-weight:400;color:var(--tf)">(optional)</span></p>
<div class="field"><label>Kontoinhaber / Bank</label><div class="input-wrap"><input id="aBN" placeholder="z.B. Stadtwerke M√ºnchen"></div></div>
<div style="display:grid;grid-template-columns:2fr 1fr;gap:12px"><div class="field"><label>IBAN</label><div class="input-wrap"><input id="aBI" placeholder="DE00 0000 0000 0000 0000 00"></div></div><div class="field"><label>BIC</label><div class="input-wrap"><input id="aBB" placeholder="ABCDDEFFXXX"></div></div></div>
<div class="field"><label>Verwendungszweck</label><div class="input-wrap"><input id="aBR" placeholder="Kd-Nr. / Vertrags-Nr. / Rechnungs-Nr."></div></div>

<div style="display:flex;gap:12px;margin-top:16px"><button class="btn btn-outline" style="flex:1" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" style="flex:1" onclick="sAdd()">Hinzuf√ºgen</button></div>
</div></div>`}
function pE(b,e){selectedEmoji=e;document.querySelectorAll("#ep .emoji-btn").forEach(x=>x.classList.remove("active"));b.classList.add("active")}
async function sAdd(){const n=document.getElementById("aN").value,a=toNum(document.getElementById("aA").value),r=toNum(document.getElementById("aR").value),d=document.getElementById("aD").value,nt=document.getElementById("aNt").value;if(!n||!a||a<=0)return;await autoSnapshot("debt_create",true);const ct=(document.getElementById("aCTY")?.value)||"firma";const rawIban=document.getElementById("aBI").value||"";const norm=normIban(rawIban);let bankIban=norm,iban_enc="",iban_hint="";if(ct==="privat"&&norm){const head=norm.slice(0,4),last=norm.slice(-4);iban_hint=`${head}:${last}`;iban_enc=await encryptText(norm);bankIban=""}const item={id:Date.now(),name:n,emoji:selectedEmoji,original:a,paid:0,rate:r||0,due:d||"2026-03-01",notes:nt,clarificationStatus:document.getElementById("aCS").value||"neu",paymentStatus:document.getElementById("aPS").value||"keine_zahlung_faellig",creditorType:ct,creditorName:document.getElementById("aCN").value,creditorAddress:document.getElementById("aCA").value,creditorZip:document.getElementById("aCZip").value||"",creditorCity:document.getElementById("aCCity").value||"",creditorPhone:document.getElementById("aCT").value,creditorEmail:document.getElementById("aCE").value,bankName:document.getElementById("aBN").value,bankIban,iban_enc,iban_hint,bankBic:document.getElementById("aBB").value,bankRef:document.getElementById("aBR").value,history:[]};autoUpdateDebtStatuses(item,{respectManual:true});debts.push(item);scheduleCloudSave();selectedEmoji="üìÑ";closeModal();flash("Hinzugef√ºgt");renderPage()}
function openPay(id){const d=debts.find(x=>x.id===id);if(!d)return;const rem=d.original-d.paid,pr=[{l:"Rate",v:d.rate}];if(Math.round(rem/2)!==d.rate&&rem/2>0)pr.push({l:"H√§lfte",v:Math.round(rem/2)});if(rem!==d.rate&&rem>0)pr.push({l:"Alles",v:rem});
document.getElementById("modalContainer").innerHTML=`<div class="overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-head"><h3>Zahlung verbuchen</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div><div style="display:flex;align-items:center;gap:14px;padding:16px;margin-bottom:20px;background:var(--bgE);border-radius:14px;border:1px solid var(--b)"><div style="width:46px;height:46px;border-radius:13px;background:var(--bgC);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:22px">${d.emoji}</div><div><p style="font-size:15px;font-weight:700;margin:0">${d.name}</p><p style="font-size:13px;color:var(--tm);margin:2px 0 0">Offen: <strong style="color:var(--co)">${fmt(rem)}</strong> ¬∑ Rate: ${fmt(d.rate)}/Mo</p></div></div><div class="field"><label>Betrag</label><div class="input-wrap"><input id="pA" type="number" placeholder="0" value="${d.rate}" oninput="uPB(${id})"><span class="suffix">‚Ç¨</span></div></div><div style="display:flex;gap:6px;margin-top:-8px;margin-bottom:16px;flex-wrap:wrap">${pr.filter(p=>p.v>0).map(p=>`<button class="preset-btn" onclick="document.getElementById('pA').value=${p.v};uPB(${id})">${p.l}: ${fmt(p.v)}</button>`).join("")}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label>Datum</label><div class="input-wrap"><input id="pD" type="date" value="${tdy()}"></div></div><div class="field"><label>Notiz</label><div class="input-wrap"><input id="pN" placeholder="Optional..."></div></div></div><div id="pW"></div><div style="display:flex;gap:12px;margin-top:8px"><button class="btn btn-outline" style="flex:1" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" style="flex:1" id="pB" onclick="sPay(${id})">‚úì ${fmt(d.rate)} verbuchen</button></div></div></div>`}
function uPB(id){const d=debts.find(x=>x.id===id);if(!d)return;const a=parseFloat(document.getElementById("pA").value)||0,rem=d.original-d.paid;document.getElementById("pB").textContent=`‚úì ${fmt(a)} verbuchen`;document.getElementById("pW").innerHTML=a>rem?`<div style="padding:10px 14px;background:var(--amG);border:1px solid rgba(251,191,36,0.2);border-radius:10px;margin-bottom:14px;display:flex;align-items:center;gap:8px"><span>‚ö†Ô∏è</span><p style="font-size:13px;color:var(--am);margin:0">√úbersteigt offenen Betrag ‚Äì es wird maximal ${fmt(rem)} verbucht.</p></div>`:"";}
async function sPay(id){const a=parseFloat(document.getElementById("pA").value);if(!a||a<=0)return;const dt=document.getElementById("pD").value||tdy(),nt=document.getElementById("pN").value.trim(),d=debts.find(x=>x.id===id);if(!d)return;await autoSnapshot("payment_add",true);d.paid=Math.min(d.paid+a,d.original);d.history.unshift({date:dt,amount:a,note:nt});autoUpdateDebtStatuses(d);scheduleCloudSave();if(d.paid>=d.original)setTimeout(showConfetti,200);closeModal();flash(`${fmt(a)} erfolgreich erfasst`);renderPage()}
async function deletePayment(id,idx){const d=debts.find(x=>x.id===id);if(!d||!Array.isArray(d.history)||!d.history[idx])return;const h=d.history[idx];if(!await confirmModal.show("Zahlung wirklich l√∂schen?",{title:"Zahlung l√∂schen",okText:"L√∂schen",okColor:"#ef4444",icon:"üóëÔ∏è"}))return;await autoSnapshot("payment_delete",true);d.history.splice(idx,1);d.paid=Math.max(0,d.paid-((+h.amount)||0));autoUpdateDebtStatuses(d);scheduleCloudSave();renderPage();flash("Zahlung gel√∂scht ‚úì")}
function printOverview(){
  const T=gT();
  const today=new Date().toLocaleDateString("de-DE",{day:"numeric",month:"long",year:"numeric"});
  const activeDebts=debts.filter(d=>d.paid<d.original).sort((a,b)=>new Date(a.due)-new Date(b.due));
  const doneDebts=debts.filter(d=>d.paid>=d.original);
  const allPayments=debts.flatMap(d=>d.history.map(h=>({...h,dn:d.name,e:d.emoji}))).sort((a,b)=>new Date(b.date)-new Date(a.date));
  const totalPayCount=debts.reduce((s,d)=>s+d.history.length,0);
  
  // Build progress bar SVG inline
  const progBar=(pct,w=200)=>`<div style="display:flex;align-items:center;gap:8px"><div style="width:${w}px;height:6px;background:#E5E7EB;border-radius:3px;overflow:hidden"><div style="height:100%;width:${Math.min(pct,100)}%;background:linear-gradient(90deg,var(--emD),var(--em));border-radius:3px"></div></div><span style="font-size:11px;color:#6B7280;font-weight:600;min-width:36px">${pct}%</span></div>`;
  
  // Status label
  const stLabel=(d)=>{const s=gS(d);const map={ok:["Aktuell","var(--emD)","#ECFDF5"],soon:["Bald f√§llig","#D97706","#FFFBEB"],today:["Heute f√§llig","#DC2626","#FEF2F2"],overdue:["Handlungsbedarf","#DC2626","#FEF2F2"],done:["Erledigt","var(--emD)","#ECFDF5"]};const[l,c,bg]=map[s]||map.ok;return`<span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:10px;color:${c};background:${bg}">${l}</span>`};
  
  const w=window.open("","_blank");
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Ratenova ‚Äì √úbersicht ${today}</title>
<style>
  @page{size:A4;margin:20mm 18mm}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Helvetica Neue',sans-serif;color:#111827;font-size:11pt;line-height:1.5;background:#fff}
  .page{max-width:760px;margin:0 auto}
  
  /* Header */
  .header{display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:20px;border-bottom:3px solid var(--emD);margin-bottom:24px}
  .header h1{font-size:22pt;font-weight:800;color:#111827;letter-spacing:-0.5px}
  .header .sub{font-size:10pt;color:#6B7280;margin-top:2px}
  .header .logo{display:flex;align-items:center;gap:8px}
  .header .logo-dot{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--emD),var(--em));display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff}
  .header .date{font-size:10pt;color:#9CA3AF;text-align:right}
  
  /* KPI Cards */
  .kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
  .kpi{background:#F9FAFB;border:1px solid #E5E7EB;border-radius:10px;padding:14px 16px}
  .kpi .label{font-size:9pt;color:#6B7280;text-transform:uppercase;letter-spacing:0.8px;font-weight:600;margin-bottom:4px}
  .kpi .value{font-size:18pt;font-weight:800;color:#111827;line-height:1.2}
  .kpi .value.green{color:var(--emD)}
  .kpi .value.red{color:#DC2626}
  .kpi .value.amber{color:#D97706}
  .kpi .detail{font-size:9pt;color:#9CA3AF;margin-top:2px}
  
  /* Section */
  .section{margin-bottom:22px}
  .section-title{font-size:12pt;font-weight:700;color:#111827;margin-bottom:10px;display:flex;align-items:center;gap:8px}
  .section-title .dot{width:8px;height:8px;border-radius:2px;background:var(--emD)}
  
  /* Table */
  table{width:100%;border-collapse:collapse;font-size:10pt}
  thead th{background:#F3F4F6;color:#374151;font-weight:700;text-align:left;padding:10px 12px;font-size:9pt;text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid #E5E7EB}
  thead th:first-child{border-radius:8px 0 0 0}
  thead th:last-child{border-radius:0 8px 0 0}
  tbody td{padding:10px 12px;border-bottom:1px solid #F3F4F6;vertical-align:middle}
  tbody tr:last-child td{border-bottom:none}
  tbody tr:hover{background:#F9FAFB}
  .mono{font-family:'SF Mono','Fira Code',monospace;font-size:10pt}
  .right{text-align:right}
  .center{text-align:center}
  
  /* Footer row */
  tfoot td{padding:12px;font-weight:700;background:#F0FDF4;border-top:2px solid var(--emD);font-size:10pt}
  tfoot td:first-child{border-radius:0 0 0 8px}
  tfoot td:last-child{border-radius:0 0 8px 0}
  
  /* Progress ring for header */
  .ring-wrap{position:relative;display:inline-block}
  .ring-label{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .ring-label .pct{font-size:16pt;font-weight:800;color:var(--emD)}
  .ring-label .sub{font-size:8pt;color:#9CA3AF}
  
  /* Recent payments */
  .pay-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid #F3F4F6;font-size:10pt}
  .pay-row:last-child{border:none}
  .pay-emoji{font-size:14px}
  .pay-name{flex:1;color:#374151}
  .pay-date{color:#9CA3AF;font-size:9pt}
  .pay-amt{font-weight:700;color:var(--emD);min-width:70px;text-align:right}
  
  /* Footer */
  .footer{margin-top:28px;padding-top:14px;border-top:1px solid #E5E7EB;display:flex;justify-content:space-between;font-size:8pt;color:#9CA3AF}
  
  /* Summary box */
  .summary-box{background:linear-gradient(135deg,#F0FDF4,#ECFDF5);border:1px solid #BBF7D0;border-radius:12px;padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:20px}
  .summary-box .big{font-size:28pt;font-weight:800;color:var(--emD);line-height:1}
  .summary-box .info{flex:1}
  .summary-box .info p{margin:0;font-size:10pt;color:#374151}
  .summary-box .info .highlight{font-weight:700;color:var(--emD)}

  @media print{.page{max-width:100%} .kpi-row{break-inside:avoid} table{break-inside:avoid}}
</style></head><body><div class="page">

<!-- HEADER -->
<div class="header">
  <div>
    <div class="logo"><div class="logo-dot">üïäÔ∏è</div><h1>Ratenova</h1></div>
    <p class="sub">Pers√∂nlicher Verbindlichkeitsreport</p>
  </div>
  <div class="date">Erstellt am<br><strong>${today}</strong></div>
</div>

<!-- SUMMARY -->
<div class="summary-box">
  <div style="text-align:center">
    <svg width="80" height="80">
      <circle cx="40" cy="40" r="34" fill="none" stroke="#E5E7EB" stroke-width="7"/>
      <circle cx="40" cy="40" r="34" fill="none" stroke="var(--emD)" stroke-width="7" stroke-linecap="round"
        stroke-dasharray="${2*Math.PI*34}" stroke-dashoffset="${2*Math.PI*34-(T.pct/100)*2*Math.PI*34}" transform="rotate(-90 40 40)"/>
      <text x="40" y="38" text-anchor="middle" font-size="16" font-weight="800" fill="var(--emD)">${T.pct}%</text>
      <text x="40" y="50" text-anchor="middle" font-size="8" fill="#9CA3AF">getilgt</text>
    </svg>
  </div>
  <div class="info">
    <p style="font-size:13pt;font-weight:700;margin-bottom:4px">Gesamtfortschritt</p>
    <p>Offener Betrag: <span class="highlight">${fmt(T.r)}</span> von ${fmt(T.o)} ¬∑ Bereits bezahlt: <span class="highlight">${fmt(T.p)}</span></p>
    <p>Monatliche Belastung: <strong>${fmt(T.m)}</strong> ¬∑ Voraussichtlich schuldenfrei in <span class="highlight">~${Math.ceil(T.r/T.m)} Monaten</span></p>
  </div>
</div>

<!-- KPI CARDS -->
<div class="kpi-row">
  <div class="kpi"><div class="label">Gesamtpositionen</div><div class="value">${fmt(T.o)}</div><div class="detail">${debts.length} Position${debts.length!==1?"en":""}</div></div>
  <div class="kpi"><div class="label">Bereits bezahlt</div><div class="value green">${fmt(T.p)}</div><div class="detail">${T.pct}% getilgt</div></div>
  <div class="kpi"><div class="label">Offener Betrag</div><div class="value red">${fmt(T.r)}</div><div class="detail">${activeDebts.length} aktiv${doneDebts.length>0?` ¬∑ ${doneDebts.length} erledigt`:""}</div></div>
  <div class="kpi"><div class="label">Monatliche Rate</div><div class="value amber">${fmt(T.m)}</div><div class="detail">${totalPayCount} Zahlungen bisher</div></div>
</div>

<!-- ACTIVE DEBTS TABLE -->
${activeDebts.length>0?`<div class="section">
  <div class="section-title"><span class="dot"></span>Offene Verbindlichkeiten (${activeDebts.length})</div>
  <table>
    <thead><tr>
      <th style="width:28px"></th>
      <th>Gl√§ubiger</th>
      <th class="right">Gesamt</th>
      <th class="right">Bezahlt</th>
      <th class="right">Offen</th>
      <th class="right">Rate/Mo</th>
      <th>F√§llig</th>
      <th>Fortschritt</th>
      <th>Status</th>
    </tr></thead>
    <tbody>${activeDebts.map(d=>{const rem=d.original-d.paid,p=pc(d.paid,d.original),dy=dU(d.due);return`<tr>
      <td style="font-size:16px">${d.emoji}</td>
      <td><strong>${d.name}</strong>${d.creditorName&&d.creditorName!==d.name?`<br><span style="font-size:9pt;color:#9CA3AF">${d.creditorName}</span>`:""}</td>
      <td class="right mono">${fmt(d.original)}</td>
      <td class="right mono" style="color:var(--emD)">${fmt(d.paid)}</td>
      <td class="right mono" style="color:#DC2626;font-weight:600">${fmt(rem)}</td>
      <td class="right mono">${fmt(d.rate)}</td>
      <td>${fD(d.due)}${dy<=0?' ‚ö†Ô∏è':dy<=5?' ‚è∞':''}</td>
      <td>${progBar(p,100)}</td>
      <td>${stLabel(d)}</td>
    </tr>`}).join("")}</tbody>
    <tfoot><tr>
      <td></td>
      <td>Gesamt</td>
      <td class="right">${fmt(activeDebts.reduce((s,d)=>s+d.original,0))}</td>
      <td class="right" style="color:var(--emD)">${fmt(activeDebts.reduce((s,d)=>s+d.paid,0))}</td>
      <td class="right" style="color:#DC2626">${fmt(activeDebts.reduce((s,d)=>s+(d.original-d.paid),0))}</td>
      <td class="right">${fmt(activeDebts.reduce((s,d)=>s+d.rate,0))}</td>
      <td colspan="3"></td>
    </tr></tfoot>
  </table>
</div>`:""}

<!-- DONE DEBTS -->
${doneDebts.length>0?`<div class="section">
  <div class="section-title"><span class="dot" style="background:var(--em)"></span>Abgeschlossene Verbindlichkeiten (${doneDebts.length})</div>
  <table>
    <thead><tr><th style="width:28px"></th><th>Gl√§ubiger</th><th class="right">Betrag</th><th class="right">Zahlungen</th><th>Status</th></tr></thead>
    <tbody>${doneDebts.map(d=>`<tr>
      <td style="font-size:16px">${d.emoji}</td>
      <td>${d.name}</td>
      <td class="right mono">${fmt(d.original)}</td>
      <td class="right">${d.history.length}</td>
      <td>${stLabel(d)}</td>
    </tr>`).join("")}</tbody>
  </table>
</div>`:""}

<!-- PAYMENT SCHEDULE -->
${activeDebts.length>0?`<div class="section">
  <div class="section-title"><span class="dot" style="background:#D97706"></span>Fortschrittsplan ‚Äì N√§chste F√§lligkeiten</div>
  <table>
    <thead><tr><th>F√§lligkeit</th><th>Gl√§ubiger</th><th class="right">Rate</th><th class="right">Offener Betrag danach</th><th>Verbl. Raten</th></tr></thead>
    <tbody>${activeDebts.map(d=>{const rem=d.original-d.paid,afterPay=Math.max(rem-d.rate,0),mLeft=d.rate>0?Math.ceil(rem/d.rate):0;return`<tr>
      <td><strong>${fDL(effDue(d)||d.due)}</strong></td>
      <td>${d.emoji} ${d.name}</td>
      <td class="right mono">${fmt(d.rate)}</td>
      <td class="right mono">${fmt(afterPay)}</td>
      <td class="center">${mLeft} Monate</td>
    </tr>`}).join("")}</tbody>
  </table>
</div>`:""}

<!-- RECENT PAYMENTS -->
${allPayments.length>0?`<div class="section">
  <div class="section-title"><span class="dot" style="background:var(--emD)"></span>Letzte Zahlungen</div>
  <div style="background:#F9FAFB;border:1px solid #E5E7EB;border-radius:10px;padding:12px 16px">
    ${allPayments.slice(0,8).map(h=>`<div class="pay-row">
      <span class="pay-emoji">${h.e}</span>
      <span class="pay-name">${h.dn}${h.note?` ¬∑ <span style="color:#9CA3AF">${h.note}</span>`:""}</span>
      <span class="pay-date">${fD(h.date)}</span>
      <span class="pay-amt">${fmt(h.amount)}</span>
    </div>`).join("")}
  </div>
</div>`:""}

<!-- BANKVERBINDUNGEN -->
${activeDebts.some(d=>d.bankIban||d.iban_enc||d.iban_hint)?`<div class="section">
  <div class="section-title"><span class="dot" style="background:#6366F1"></span>Bankverbindungen f√ºr √úberweisungen</div>
  <table>
    <thead><tr><th>Gl√§ubiger</th><th>IBAN</th><th>BIC</th><th>Verwendungszweck</th></tr></thead>
    <tbody>${activeDebts.filter(d=>d.bankIban||d.iban_enc||d.iban_hint).map(d=>`<tr>
      <td>${d.emoji} <strong>${d.bankName||d.name}</strong></td>
      <td class="mono" style="font-size:9pt">${getMaskedIban(d)||"‚Äì"}</td>
      <td class="mono" style="font-size:9pt">${d.bankBic||"‚Äì"}</td>
      <td style="font-size:9pt;color:#6B7280">${d.bankRef||"‚Äì"}</td>
    </tr>`).join("")}</tbody>
  </table>
</div>`:""}

<!-- FOOTER -->
<div class="footer">
  <span>üïäÔ∏è Ratenova ‚Äì Pers√∂nlicher Verbindlichkeitsreport</span>
  <span>Generiert am ${today}</span>
  <span>Vertraulich ‚Äì Nur f√ºr den pers√∂nlichen Gebrauch</span>
</div>

</div></div>
</div></body></html>`);
  w.document.close();
  setTimeout(()=>w.print(),400);
}

function buildMonthlyChecklistData(month=currentBudgetMonth){
  const monthEnd=`${month}-31`;
  const rows=[];
  debts.filter(d=>d.paid<d.original).forEach(d=>{
    const ps=getPaymentStatus(d);
    const remaining=Math.max(d.original-d.paid,0);
    // Use effDue to get the next valid due date, then adjust to current month if needed
    let effectiveDate=effDue(d)||d.due||"";
    if(effectiveDate){
      // If effective date is in future months, backtrack to current month
      while(effectiveDate>monthEnd){
        effectiveDate=addMonthsISO(effectiveDate,-1);
      }
      // If effective date is way in the past but we want current month for active plan?
      // Actually, if it's overdue, we want to show the overdue date.
      // If it's a future installment (ratenplan_aktiv), we want the date in this month.
      if(ps==="ratenplan_aktiv" && effectiveDate < `${month}-01`){
         // It's an installment, should be due this month
         // But wait, if it's overdue, it stays overdue.
         // If it is 'ok' but previous month?
         // Let's stick to the heuristic: for active plans, show date in this month.
         // But use the day from effectiveDate (which comes from effDue -> stable)
         const day=effectiveDate.split("-")[2];
         effectiveDate=`${month}-${day}`;
      }
    } else {
       // Fallback
       const dueDay=((d.due||"").split("-")[2]||"01").padStart(2,"0");
       effectiveDate=`${month}-${dueDay}`;
    }

    const hint=d.iban_hint||"";
    const iban=d.bankIban||"";
    const enc=d.iban_enc||"";
    const common={title:d.name,creditor:d.creditorName||d.bankName||d.name,amount:Math.min(d.rate||0,remaining),remaining:remaining,iban,iban_enc:enc,iban_hint:hint,bic:d.bankBic||"",ref:d.bankRef||"",due:effectiveDate};

    if(ps==="ratenplan_aktiv"&&(d.rate||0)>0)rows.push(common);
    else if(ps==="faellig_einmalig"&&(d.due||"").startsWith(month))rows.push({...common,amount:remaining}); // Full amount for one-time
    else if(ps==="ueberfaellig"&&((d.due||"")<=monthEnd))rows.push({...common,amount:remaining});
    else if(ps==="keine_zahlung_faellig"&&getClarificationStatus(d)==="neu"){
       if((d.due||"").startsWith(month) || (d.due||"")<=monthEnd) {
          rows.push({...common, amount: remaining > 0 ? remaining : (d.rate||0)});
       }
    }
  });
  return rows.sort((a,b)=>new Date(a.due)-new Date(b.due));
}

function buildChecklistHTML(rows,month){
  const dt=new Date(month+"-01");
  const ml=dt.toLocaleDateString("de-DE",{month:"long",year:"numeric"});
  const head=`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><title>Monatliche Zahlungs‚ÄëCheckliste</title><style>
  *{box-sizing:border-box}body{font-family:Segoe UI,Arial,sans-serif;color:#0f172a;margin:0;background:#fff}
  .page{max-width:880px;margin:24px auto;padding:8px 24px}
  h1{font-size:22px;margin:8px 0 4px}
  .sub{color:#64748b;font-size:12px;margin:0 0 18px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;font-size:12px}
  thead th{font-size:11px;text-transform:uppercase;letter-spacing:0.9px;color:#334155;text-align:left;padding:0 10px}
  tbody tr{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px}
  tbody td{padding:10px;border-bottom:none;vertical-align:middle}
  tbody td:first-child{border-radius:12px 0 0 12px}
  tbody td:last-child{border-radius:0 12px 12px 0}
  .right{text-align:right}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;letter-spacing:0.3px}
  .check{width:28px;text-align:center}
  .chip{display:inline-block;padding:3px 8px;border-radius:10px;background:#e2e8f0;color:#0f172a;font-weight:700;font-size:10px}
  .chip.date{background:#dcfce7;color:#065f46}
  .chip.iban{background:#eef2ff;color:#3730a3}
  .purpose{color:#64748b;font-size:11px;margin-top:2px;max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .footer{display:flex;justify-content:space-between;color:#64748b;font-size:10px;margin-top:14px}
  @media print{.page{padding:0}}
  </style></head><body><div class="page"><h1>Monatliche Zahlungs‚ÄëCheckliste</h1><p class="sub">${ml}</p><table><thead><tr><th class="check"></th><th>Empf√§nger</th><th>F√§llig</th><th class="right">Rate</th><th class="right">Offen</th><th>IBAN</th><th>Verwendungszweck</th></tr></thead><tbody>`;
  const rowsHtml=rows.map(r=>{const ibanShown=r.iban?formatIbanSpaced(r.iban):(r.iban_hint?maskFromHint(r.iban_hint):"‚Äì");return `<tr>
    <td class="check">‚òê</td>
    <td><strong>${r.creditor}</strong><div class="purpose">${r.title}</div></td>
    <td><span class="chip date">${fD(r.due)}</span></td>
    <td class="right mono">${fmt(r.amount)}</td>
    <td class="right mono" style="color:#64748b">${fmt(r.remaining)}</td>
    <td class="mono"><span class="chip iban">${ibanShown}</span></td>
    <td>${r.ref||"‚Äì"}</td>
  </tr>`}).join("");
  const foot=`</tbody></table><div class="footer"><span>${rows.length} Zahlung${rows.length!==1?"en":""}</span><span>Erstellt am ${new Date().toLocaleDateString("de-DE")}</span></div></div></body></html>`;
  return head+rowsHtml+foot;
}

async function exportChecklistPDF(){
  const month=currentBudgetMonth;
  const rows=buildMonthlyChecklistData(month);
  if(rows.length===0){flash("Keine f√§lligen Zahlungen f√ºr diesen Monat");return;}
  const dt=new Date(month+"-01");
  const ml=dt.toLocaleDateString("de-DE",{month:"long",year:"numeric"});
  // Resolve IBANs: prefer Klartext; wenn verschl√ºsselt, entschl√ºsseln
  const resolvedRows=await Promise.all(rows.map(async r=>{
    if(r.iban&&r.iban.trim()) return r;
    if(r.iban_enc&&r.iban_enc.startsWith("v1:")){
      const plain=await decryptText(r.iban_enc);
      return {...r,iban:plain};
    }
    return r;
  }));
  if(window.supabaseClient&&window.supabaseClient.functions&&typeof window.supabaseClient.functions.invoke==="function"){
    try{
      const payload={month,monthLabel:ml,user:{name:user.name||""},rows:resolvedRows};
      const {data,error}=await window.supabaseClient.functions.invoke("checklist-pdf",{body:payload});
      if(error)throw error;
      const blob=data instanceof Blob?data:new Blob([data],{type:"application/pdf"});
      const url=URL.createObjectURL(blob);
      const w=window.open(url,"_blank");
      if(!w)flash("PDF konnte nicht ge√∂ffnet werden");
      return;
    }catch(e){
      const html=buildChecklistHTML(resolvedRows,month);
      const w=window.open("about:blank","_blank");
      if(!w){flash("Bitte Pop‚Äëups erlauben");return;}
      w.document.write(html);
      w.document.close();
      setTimeout(()=>w.print(),300);
      return;
    }
  }else{
    const html=buildChecklistHTML(resolvedRows,month);
    const w=window.open("about:blank","_blank");
    if(!w){flash("Bitte Pop‚Äëups erlauben");return;}
    w.document.write(html);
    w.document.close();
    setTimeout(()=>w.print(),300);
  }
}


function toggleDebtTracking(id){
  const d=debts.find(x=>x.id===id);
  if(!d)return;
  d.trackInBudget=!d.trackInBudget;
  scheduleCloudSave();
  renderPage();
  flash(d.trackInBudget?"Rate wird automatisch als Ausgabe gebucht üìä":"Automatische Buchung deaktiviert");
}

function openEdit(id){const d=debts.find(x=>x.id===id);if(!d)return;
document.getElementById("modalContainer").innerHTML=`<div class="overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()" style="max-width:620px">
<div class="modal-head"><h3>${d.emoji} ${d.name} bearbeiten</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div>

<p style="font-size:12px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px">Statusdefinition</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="field"><label>Kl√§rungsstatus</label><input id="eCS" type="hidden" value="${getClarificationStatus(d)}"><div style="display:flex;flex-wrap:wrap;gap:6px">${clarificationOptions.map(([v,l])=>`<button type="button" data-status="eCS" data-value="${v}" class="btn btn-sm ${getClarificationStatus(d)===v?"btn-ghost":"btn-outline"}" style="padding:7px 10px" onclick="setStatus('e','CS','${v}')">${l}</button>`).join("")}</div></div>
<div class="field"><label>Zahlungsstatus</label><input id="ePS" type="hidden" value="${getPaymentStatus(d)}"><div style="display:flex;flex-wrap:wrap;gap:6px">${paymentOptions.map(([v,l])=>`<button type="button" data-status="ePS" data-value="${v}" class="btn btn-sm ${getPaymentStatus(d)===v?"btn-ghost":"btn-outline"}" style="padding:7px 10px" onclick="setStatus('e','PS','${v}')">${l}</button>`).join("")}</div></div>
</div>

<p style="font-size:12px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px">üí∞ Grunddaten</p>
<div class="field"><label>Bezeichnung</label><div class="input-wrap"><input id="eN" value="${d.name||''}"></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label>Gesamtbetrag</label><div class="input-wrap"><input id="eA" value="${toEur(d.original||0)}" onblur="fmtEurField(this)"><span class="suffix">‚Ç¨</span></div></div><div class="field"><label>F√§lligkeit</label><div class="input-wrap"><input id="eD" type="date" value="${d.due||''}"></div></div></div>
<div class="field"><label>Rate/Monat</label><div class="input-wrap"><input id="eR" value="${toEur(d.rate||0)}" onblur="fmtEurField(this)"><span class="suffix">‚Ç¨</span></div></div>
<div class="field"><label>Notizen</label><div class="input-wrap"><input id="eNt" value="${(d.notes||'').replace(/"/g,'&quot;')}"></div></div>

<p style="font-size:12px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;padding-top:12px;border-top:1px solid var(--b)">üè¢ Gl√§ubiger-Kontakt</p>
<div class="field"><label>Gl√§ubiger‚ÄëTyp</label><div class="input-wrap"><select id="eCTY"><option value="firma" ${(!d.creditorType||d.creditorType==='firma')?'selected':''}>Firma</option><option value="privat" ${(d.creditorType==='privat')?'selected':''}>Privatperson</option></select></div></div>
<div class="field"><label>Firmenname / Name</label><div class="input-wrap"><input id="eCN" value="${(d.creditorName||'').replace(/"/g,'&quot;')}"></div></div>
<div class="field"><label>Adresse</label><div class="input-wrap"><input id="eCA" value="${(d.creditorAddress||'').replace(/"/g,'&quot;')}"></div></div>
<div style="display:grid;grid-template-columns:120px 1fr;gap:12px"><div class="field"><label>PLZ</label><div class="input-wrap"><input id="eCZip" value="${(d.creditorZip||'').replace(/"/g,'&quot;')}" maxlength="5"></div></div><div class="field"><label>Ort</label><div class="input-wrap"><input id="eCCity" value="${(d.creditorCity||'').replace(/"/g,'&quot;')}"></div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label>Telefon</label><div class="input-wrap"><input id="eCT" value="${d.creditorPhone||''}"></div></div><div class="field"><label>E-Mail</label><div class="input-wrap"><input id="eCE" value="${d.creditorEmail||''}"></div></div></div>

<p style="font-size:12px;font-weight:700;color:var(--ts);text-transform:uppercase;letter-spacing:1px;margin:0 0 12px;padding-top:12px;border-top:1px solid var(--b)">üè¶ Bankverbindung</p>
<div class="field"><label>Kontoinhaber / Bank</label><div class="input-wrap"><input id="eBN" value="${(d.bankName||'').replace(/"/g,'&quot;')}"></div></div>
<div style="display:grid;grid-template-columns:2fr 1fr;gap:12px"><div class="field"><label>IBAN</label><div class="input-wrap"><input id="eBI" value="${d.bankIban||''}"></div></div><div class="field"><label>BIC</label><div class="input-wrap"><input id="eBB" value="${d.bankBic||''}"></div></div></div>
<div class="field"><label>Verwendungszweck</label><div class="input-wrap"><input id="eBR" value="${(d.bankRef||'').replace(/"/g,'&quot;')}"></div></div>

<div style="display:flex;gap:12px;margin-top:16px"><button class="btn btn-outline" style="flex:1" onclick="closeModal()">Abbrechen</button><button class="btn btn-primary" style="flex:1" onclick="saveEdit(${d.id})">üíæ Speichern</button></div>
</div></div>`}
async function saveEdit(id){const d=debts.find(x=>x.id===id);if(!d)return;await autoSnapshot("debt_change",true);d.name=document.getElementById("eN").value||d.name;d.original=toNum(document.getElementById("eA").value)||d.original;d.rate=toNum(document.getElementById("eR").value);d.due=document.getElementById("eD").value||d.due;d.notes=document.getElementById("eNt").value;d.clarificationStatus=document.getElementById("eCS").value||d.clarificationStatus;d.paymentStatus=document.getElementById("ePS").value||d.paymentStatus;d.creditorType=(document.getElementById("eCTY")?.value)||d.creditorType||"firma";d.creditorName=document.getElementById("eCN").value;d.creditorAddress=document.getElementById("eCA").value;d.creditorZip=document.getElementById("eCZip").value;d.creditorCity=document.getElementById("eCCity").value;d.creditorPhone=document.getElementById("eCT").value;d.creditorEmail=document.getElementById("eCE").value;d.bankName=document.getElementById("eBN").value;const eIban=normIban(document.getElementById("eBI").value||"");if(d.creditorType==="privat"&&eIban){d.iban_hint=`${eIban.slice(0,4)}:${eIban.slice(-4)}`;d.iban_enc=await encryptText(eIban);d.bankIban=""}else{d.bankIban=eIban;d.iban_enc="";d.iban_hint=""}d.bankBic=document.getElementById("eBB").value;d.bankRef=document.getElementById("eBR").value;autoUpdateDebtStatuses(d,{respectManual:true});scheduleCloudSave();closeModal();flash("Gespeichert ‚úì");renderPage()}
async function deleteDebt(id){if(!await confirmModal.show("Eintrag wirklich l√∂schen? Dieser Schritt kann nicht r√ºckg√§ngig gemacht werden.",{title:"Eintrag l√∂schen",okText:"L√∂schen",icon:"üóëÔ∏è"}))return;await autoSnapshot("debt_delete",true);debts=debts.filter(d=>d.id!==id);scheduleCloudSave();selectedDebtId=null;currentPage="debts";renderNav();renderPage();flash("Gel√∂scht")}

// ‚îÄ‚îÄ‚îÄ Dropdown Logic ‚îÄ‚îÄ‚îÄ
function toggleDropdown(id){
  const el=document.getElementById(id);if(!el)return;
  const m=el.querySelector('.dd-menu');const t=el.querySelector('.dd-trigger');
  const isOpen=m.classList.contains('show');
  document.querySelectorAll('.dd-menu.show').forEach(x=>{
    if(x!==m){
      x.classList.remove('show');
      const p=x.closest('.dd-container');
      if(p)p.querySelector('.dd-trigger').classList.remove('active');
    }
  });
  if(isOpen){m.classList.remove('show');t.classList.remove('active');}
  else{m.classList.add('show');t.classList.add('active');}
}
window.addEventListener('click',e=>{
  if(!e.target.closest('.dd-container')){
    document.querySelectorAll('.dd-menu.show').forEach(m=>{
      m.classList.remove('show');
      const p=m.closest('.dd-container');
      if(p)p.querySelector('.dd-trigger').classList.remove('active');
    });
  }
});

normalizeDebtStatuses();
loadLocalState();
loadBudget();
loadUser();
if(!isMasterMode){
  initAuthUI();
  renderNav();
  renderUser();
  renderPage();
}else{
  const ar=document.getElementById("authRoot");if(ar)ar.style.display="none";
  const ly=document.querySelector(".layout");if(ly)ly.style.display="none";
  const mn=document.getElementById("mobileNav");if(mn)mn.style.display="none";
  const mr=document.getElementById("masterRoot");if(mr)mr.style.display="block";
}
// Dynamisch Paddle laden
function loadPaddleScript(){
  return new Promise((resolve,reject)=>{
    if(window.Paddle){resolve();return;}
    const s=document.createElement("script");
    s.src="https://cdn.paddle.com/paddle/v2/paddle.js";
    s.onload=()=>resolve();
    s.onerror=()=>reject(new Error("Paddle script blocked"));
    document.head.appendChild(s);
  });
}
function waitForPaddle(){
  loadPaddleScript()
    .then(()=>{initPaddle();console.log("Paddle ready ‚úì");})
    .catch(e=>{console.warn("Paddle konnte nicht geladen werden:",e.message);});
}
if(document.readyState==="loading"){
  document.addEventListener("DOMContentLoaded",waitForPaddle);
}else{
  waitForPaddle();
}
(async()=>{
  const sbReady=await initSupabaseClient();
  if(!sbReady){
    if(isMasterMode){
      const mr=document.getElementById("masterRoot");
      if(mr)mr.innerHTML=`<div class="master-shell"><div class="master-login"><div class="master-card"><h1 style="font-size:24px;font-weight:800;margin:0 0 8px">Admin Master Panel</h1><p style="font-size:13px;color:var(--co);margin:0">Supabase ist nicht konfiguriert. Bitte URL und Publishable Key setzen.</p></div></div></div>`;
    }else{
      showAuthPage("login");
      authShowNotice("Supabase ist nicht konfiguriert. Bitte URL und Anon Key im Code setzen.","err");
    }
    return;
  }
  if(isMasterMode){
    renderMasterStandalone();
    return;
  }
  const authed=await ensureAppAuth();
  if(!authed){showAuthPage("login");}
  else{hideAuthPage();ensureDailySnapshot();renderNav();renderUser();renderPage();}
})();
</script></div>
</div><!-- Custom Confirm Modal -->
<div id="confirmModal" onclick="if(event.target===this)confirmModal.reject()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:9999;align-items:center;justify-content:center;padding:20px">
  <div style="background:var(--bgD);border:1px solid var(--b);border-radius:18px;padding:28px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div id="confirmIcon" style="width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;background:rgba(239,68,68,0.15)">‚ö†Ô∏è</div>
      <h3 id="confirmTitle" style="font-size:16px;font-weight:700;margin:0">Best√§tigung</h3>
    </div>
    <p id="confirmMessage" style="font-size:14px;color:var(--tm);margin:0 0 24px;line-height:1.6"></p>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button onclick="confirmModal.reject()" style="padding:10px 20px;border-radius:10px;border:1px solid var(--b);background:transparent;color:var(--t);font-size:14px;font-weight:600;cursor:pointer">Abbrechen</button>
      <button id="confirmOkBtn" onclick="confirmModal.resolve()" style="padding:10px 20px;border-radius:10px;border:none;font-size:14px;font-weight:700;cursor:pointer;background:#ef4444;color:#fff">L√∂schen</button>
    </div>
  </div>
</div>
</body>
</html>
